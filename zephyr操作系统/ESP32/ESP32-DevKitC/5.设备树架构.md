# Zephyr è®¾å¤‡æ ‘ Overlay æ–‡ä»¶ç¼–å†™æŒ‡å—

æœ¬æ–‡æ¡£ä»¥ `blinky` ç¤ºä¾‹ç¨‹åºå’Œ `esp32_devkitc_esp32_procpu` æ¿ä¸ºä¾‹ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•ç¼–å†™ Overlay æ–‡ä»¶ï¼Œä»¥åŠ Zephyr è®¾å¤‡æ ‘ (Device Tree) çš„å±‚çº§ç»“æ„ã€‚

---

## ç›®å½•

1. [è®¾å¤‡æ ‘åŸºç¡€æ¦‚å¿µ](#1-è®¾å¤‡æ ‘åŸºç¡€æ¦‚å¿µ)
2. [DTS æ–‡ä»¶å±‚çº§ç»“æ„](#2-dts-æ–‡ä»¶å±‚çº§ç»“æ„)
3. [å„å±‚ DTS æ–‡ä»¶çš„ä½œç”¨è¯¦è§£](#3-å„å±‚-dts-æ–‡ä»¶çš„ä½œç”¨è¯¦è§£)
4. [YAML Binding æ–‡ä»¶è¯¦è§£](#4-yaml-binding-æ–‡ä»¶è¯¦è§£)
5. [å¦‚ä½•æŸ¥æ‰¾ç¡¬ä»¶æ ‡ç­¾](#5-å¦‚ä½•æŸ¥æ‰¾å¯¹åº”æ¿çº§æ‰€æœ‰ç¡¬ä»¶æ ‡ç­¾)
6. [æºç DTSæ ‡ç­¾è§„èŒƒéªŒè¯](#6æºç dtsæ ‡ç­¾è§„èŒƒéªŒè¯)
7. [ç¼–å†™ Overlay æ–‡ä»¶å®æˆ˜](#7-ç¼–å†™-overlay-æ–‡ä»¶å®æˆ˜)
8. [Blinky ç¤ºä¾‹ä»£ç åˆ†æ](#8-blinky-ç¤ºä¾‹ä»£ç åˆ†æ)
9. [å¸¸ç”¨ GPIO æ ‡å¿—ä½](#9-å¸¸ç”¨-gpio-æ ‡å¿—ä½)
10. [è°ƒè¯•æŠ€å·§](#10-è°ƒè¯•æŠ€å·§)

---

## 1. è®¾å¤‡æ ‘åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯è®¾å¤‡æ ‘ (Device Tree)

è®¾å¤‡æ ‘æ˜¯ä¸€ç§æè¿°ç¡¬ä»¶çš„æ•°æ®ç»“æ„ï¼Œå®ƒç‹¬ç«‹äºä»£ç ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼š
- ç³»ç»Ÿæœ‰å“ªäº›ç¡¬ä»¶è®¾å¤‡
- è¿™äº›è®¾å¤‡çš„åœ°å€ã€ä¸­æ–­ã€æ—¶é’Ÿç­‰é…ç½®
- è®¾å¤‡ä¹‹é—´çš„è¿æ¥å…³ç³»

### 1.2 æ ¸å¿ƒæœ¯è¯­

| æœ¯è¯­ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **èŠ‚ç‚¹ (Node)** | æè¿°ä¸€ä¸ªè®¾å¤‡æˆ–é€»è¾‘å•å…ƒ | `gpio0: gpio@3ff44000 { ... }` |
| **å±æ€§ (Property)** | èŠ‚ç‚¹çš„é…ç½®å‚æ•° | `reg = <0x3ff44000 0x800>;` |
| **æ ‡ç­¾ (Label)** | èŠ‚ç‚¹çš„åˆ«åï¼Œç”¨äºå¼•ç”¨ | `gpio0:` æ˜¯æ ‡ç­¾ï¼Œå¯ç”¨ `&gpio0` å¼•ç”¨ |
| **phandle** | å¯¹å…¶ä»–èŠ‚ç‚¹çš„å¼•ç”¨ | `gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;` |
| **compatible** | å£°æ˜è®¾å¤‡ç±»å‹ï¼Œé©±åŠ¨åŒ¹é…ç”¨ | `compatible = "gpio-leds";` |
| **aliases** | å…¨å±€åˆ«åï¼Œä»£ç é€šè¿‡å®ƒè®¿é—®è®¾å¤‡ | `led0 = &myled;` |
| **chosen** | ç³»ç»Ÿçº§é…ç½®é€‰é¡¹ | `zephyr,console = &uart0;` |

### 1.3 Overlay çš„ä½œç”¨

Overlay æ–‡ä»¶ (`.overlay`) ç”¨äº**å åŠ ä¿®æ”¹**åŸºç¡€è®¾å¤‡æ ‘ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åŸå§‹ DTS æ–‡ä»¶ã€‚å®ƒå¯ä»¥ï¼š
- æ·»åŠ æ–°è®¾å¤‡èŠ‚ç‚¹
- ä¿®æ”¹ç°æœ‰èŠ‚ç‚¹çš„å±æ€§
- å¯ç”¨/ç¦ç”¨è®¾å¤‡ (`status = "okay"` / `"disabled"`)
  - è¿™æ˜¯æŒ‡è½¯ä»¶åŠŸèƒ½APIå±‚é¢çš„ç¦ç”¨ï¼Ÿ
  - kconfigæ˜¯å†³å®šæ•´ä¸ªç¡¬ä»¶é©±åŠ¨ä»£ç æ˜¯å¦ç¼–è¯‘
    - æ•´ä¸ªGPIOå­ç³»ç»Ÿç¼–è¯‘è¿›ç³»ç»Ÿåï¼Œå†ä½¿ç”¨è®¾å¤‡æ ‘è¯´æ˜æˆ–è€…æè¿°å¼€å¯æˆ–è€…å…³é—­å…·ä½“é‚£ä¸ªGPIOæ§åˆ¶å™¨ç¡¬ä»¶


---

## 2. DTS æ–‡ä»¶å±‚çº§ç»“æ„

ä»¥ ESP32-DevKitC ä¸ºä¾‹ï¼Œè®¾å¤‡æ ‘çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬5å±‚: skeleton.dtsi (éª¨æ¶å±‚)                                       â”‚
â”‚  è·¯å¾„: zephyr/dts/common/skeleton.dtsi                              â”‚
â”‚  ä½œç”¨: å®šä¹‰æœ€åŸºç¡€çš„æ ¹èŠ‚ç‚¹ç»“æ„ - chosen{} å’Œ aliases{}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ #include
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬4å±‚: xtensa.dtsi (æ¶æ„å±‚)                                         â”‚
â”‚  è·¯å¾„: zephyr/dts/xtensa/xtensa.dtsi                                â”‚
â”‚  ä½œç”¨: å®šä¹‰ Xtensa æ¶æ„çš„ soc{} èŠ‚ç‚¹å®¹å™¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ #include
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬3å±‚: esp32_common.dtsi (SoCé€šç”¨å±‚)                                â”‚
â”‚  è·¯å¾„: zephyr/dts/xtensa/espressif/esp32/esp32_common.dtsi          â”‚
â”‚  ä½œç”¨: å®šä¹‰ ESP32 èŠ¯ç‰‡çš„æ‰€æœ‰å¤–è®¾ - GPIOã€UARTã€SPIã€I2C ç­‰           â”‚
â”‚       è¿™æ˜¯æœ€é‡è¦çš„ä¸€å±‚ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨ç¡¬ä»¶æ ‡ç­¾                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ #include
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬2å±‚: esp32_wrover_e_n4r8.dtsi (èŠ¯ç‰‡å°è£…å±‚)                        â”‚
â”‚  è·¯å¾„: zephyr/dts/xtensa/espressif/esp32/esp32_wrover_e_n4r8.dtsi   â”‚
â”‚  ä½œç”¨: å®šä¹‰å…·ä½“èŠ¯ç‰‡å°è£…çš„å‚æ•° - Flashå¤§å°ã€PSRAMå¤§å°ã€ä¿ç•™GPIO        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ #include
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1å±‚: esp32_devkitc_procpu.dts (æ¿çº§å±‚) â† ä½ çš„èµ·ç‚¹                  â”‚
â”‚  è·¯å¾„: zephyr/boards/espressif/esp32_devkitc/esp32_devkitc_procpu.dtsâ”‚
â”‚  ä½œç”¨: å®šä¹‰å¼€å‘æ¿çš„å…·ä½“é…ç½® - å¯ç”¨å“ªäº›å¤–è®¾ã€å¼•è„šå¤ç”¨ã€æŒ‰é”®å®šä¹‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ å åŠ 
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬0å±‚: ä½ çš„ Overlay æ–‡ä»¶ (åº”ç”¨å±‚)                                   â”‚
â”‚  è·¯å¾„: <app>/boards/esp32_devkitc_esp32_procpu.overlay               â”‚
â”‚  ä½œç”¨: æ·»åŠ åº”ç”¨æ‰€éœ€çš„è®¾å¤‡å®šä¹‰ï¼Œå¦‚ LEDã€ä¼ æ„Ÿå™¨ç­‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å„å±‚ DTS æ–‡ä»¶çš„ä½œç”¨è¯¦è§£

### 3.1 ç¬¬5å±‚: skeleton.dtsi (éª¨æ¶å±‚)

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/common/skeleton.dtsi`

```dts
/ {
    #address-cells = <1>;    /* åœ°å€å ç”¨1ä¸ª32ä½å•å…ƒ */
    #size-cells = <1>;       /* å¤§å°å ç”¨1ä¸ª32ä½å•å…ƒ */

    chosen {};    /* ç³»ç»Ÿçº§é…ç½®å®¹å™¨ */
    aliases {};   /* å…¨å±€åˆ«åå®¹å™¨ */
};
```

**ä½œç”¨:**
- å®šä¹‰è®¾å¤‡æ ‘çš„**æœ€åŸºç¡€éª¨æ¶**
- æä¾› `chosen` å’Œ `aliases` ç©ºèŠ‚ç‚¹
- æ‰€æœ‰è®¾å¤‡æ ‘æœ€ç»ˆéƒ½ç»§æ‰¿è‡ªæ­¤æ–‡ä»¶

### 3.2 ç¬¬4å±‚: xtensa.dtsi (æ¶æ„å±‚)

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/xtensa/xtensa.dtsi`

```dts
#include "skeleton.dtsi"

/ {
    soc {
        #address-cells = <1>;
        #size-cells = <1>;
        compatible = "simple-bus";
        ranges;
    };
};
```

**ä½œç”¨:**
- ç»§æ‰¿éª¨æ¶å±‚
- å®šä¹‰ `soc` èŠ‚ç‚¹ä½œä¸º**æ‰€æœ‰ç‰‡ä¸Šå¤–è®¾çš„å®¹å™¨**
- `simple-bus` è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç®€å•æ€»çº¿ï¼Œå­èŠ‚ç‚¹å¯ä»¥ç›´æ¥ä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„åœ°å€ç©ºé—´

### 3.3 ç¬¬3å±‚: esp32_common.dtsi (SoCé€šç”¨å±‚) - æœ€é‡è¦!

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/xtensa/espressif/esp32/esp32_common.dtsi`

è¿™æ˜¯**æœ€å…³é”®çš„ä¸€å±‚**ï¼Œå®šä¹‰äº† ESP32 èŠ¯ç‰‡çš„æ‰€æœ‰å¤–è®¾ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š

#### CPU å®šä¹‰
```dts
cpus {
    cpu0: cpu@0 {
        device_type = "cpu";
        compatible = "espressif,xtensa-lx6";
        reg = <0>;
        clock-frequency = <DT_FREQ_M(240)>;  /* 240MHz */
    };
    cpu1: cpu@1 { ... };
};
```

#### å†…å­˜åŒºåŸŸ
```dts
soc {
    sram0: memory@40070000 {
        compatible = "zephyr,memory-region", "mmio-sram";
        reg = <0x40070000 DT_SIZE_K(192)>;   /* 192KB */
    };
    sram1: memory@3ffe0000 { ... };
    /* æ›´å¤šå†…å­˜åŒºåŸŸ... */
};
```

#### GPIO æ§åˆ¶å™¨ - ç¼–å†™ Overlay æ—¶æœ€å¸¸ç”¨
```dts
gpio: gpio {
    compatible = "simple-bus";
    gpio-map = <0x00 0x0 &gpio0 0x0 0x0
                0x20 0x0 &gpio1 0x0 0x0>;
    #gpio-cells = <2>;    /* å¼•ç”¨GPIOéœ€è¦2ä¸ªå‚æ•°: å¼•è„šå·å’Œæ ‡å¿— */

    gpio0: gpio@3ff44000 {
        compatible = "espressif,esp32-gpio";
        gpio-controller;
        #gpio-cells = <2>;
        reg = <0x3ff44000 0x800>;
        ngpios = <32>;    /* GPIO0~31 */
    };

    gpio1: gpio@3ff44800 {
        compatible = "espressif,esp32-gpio";
        gpio-controller;
        #gpio-cells = <2>;
        reg = <0x3ff44800 0x800>;
        ngpios = <8>;     /* GPIO32~39 */
    };
};
```

#### å…¶ä»–å¤–è®¾
```dts
/* UART */
uart0: uart@3ff40000 {
    compatible = "espressif,esp32-uart";
    reg = <0x3ff40000 0x400>;
    status = "disabled";   /* é»˜è®¤ç¦ç”¨ï¼Œæ¿çº§DTSå¯ç”¨ */
};

/* I2C */
i2c0: i2c@3ff53000 {
    compatible = "espressif,esp32-i2c";
    #address-cells = <1>;
    #size-cells = <0>;
    status = "disabled";
};

/* SPI */
spi2: spi@3ff64000 {
    compatible = "espressif,esp32-spi";
    status = "disabled";
};

/* PWM (LEDC) */
ledc0: ledc@3ff59000 {
    compatible = "espressif,esp32-ledc";
    #pwm-cells = <3>;
    status = "disabled";
};
```

**ä½ å¯ä»¥ä½¿ç”¨çš„æ ‡ç­¾ (Labels):**

| æ ‡ç­¾ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `&gpio0` | GPIOæ§åˆ¶å™¨ | GPIO 0-31 |
| `&gpio1` | GPIOæ§åˆ¶å™¨ | GPIO 32-39 |
| `&uart0`, `&uart1`, `&uart2` | UART | ä¸²å£ |
| `&i2c0`, `&i2c1` | I2C | I2Cæ€»çº¿ |
| `&spi2`, `&spi3` | SPI | SPIæ€»çº¿ |
| `&ledc0` | PWM | LEDæ§åˆ¶å™¨ |
| `&adc0`, `&adc1` | ADC | æ¨¡æ•°è½¬æ¢å™¨ |
| `&timer0` ~ `&timer3` | Timer | å®šæ—¶å™¨ |
| `&wdt0`, `&wdt1` | Watchdog | çœ‹é—¨ç‹— |
| `&flash0` | Flash | å†…ç½®Flash |
| `&trng0` | TRNG | çœŸéšæœºæ•°å‘ç”Ÿå™¨ |

### 3.4 ç¬¬2å±‚: esp32_wrover_e_n4r8.dtsi (èŠ¯ç‰‡å°è£…å±‚)

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/xtensa/espressif/esp32/esp32_wrover_e_n4r8.dtsi`

```dts
#include "esp32_common.dtsi"

/* ä¿ç•™çš„GPIOå¼•è„š (è¢«Flash/PSRAMå ç”¨æˆ–æœªè¿å‡º) */
&gpio0 {
    gpio-reserved-ranges = <6 6>,     /* GPIO6-11: Flash */
                           <16 2>,    /* GPIO16-17: PSRAM */
                           <20 1>,    /* GPIO20: NC */
                           <24 1>,    /* GPIO24: NC */
                           <28 4>;    /* GPIO28-31: NC */
};

&gpio1 {
    gpio-reserved-ranges = <5 2>;     /* GPIO37-38: NC */
};

/* Flash å¤§å°: 4MB */
&flash0 {
    reg = <0x0 DT_SIZE_M(4)>;
};

/* PSRAM å¤§å°: 8MB */
&psram0 {
    size = <DT_SIZE_M(8)>;
};
```

**ä½œç”¨:**
- å®šä¹‰**å…·ä½“èŠ¯ç‰‡å°è£…**çš„å‚æ•°
- å£°æ˜**ä¿ç•™çš„ GPIO** (è¢« Flashã€PSRAM ç­‰å ç”¨ï¼Œä¸å¯ä½¿ç”¨)
- å®šä¹‰ Flash å’Œ PSRAM çš„å®é™…å¤§å°

**é‡è¦æç¤º:** `gpio-reserved-ranges` å‘Šè¯‰ä½ å“ªäº›å¼•è„š**ä¸èƒ½ä½¿ç”¨**ï¼

### 3.5 ç¬¬1å±‚: esp32_devkitc_procpu.dts (æ¿çº§å±‚)

**æ–‡ä»¶è·¯å¾„:** `zephyr/boards/espressif/esp32_devkitc/esp32_devkitc_procpu.dts`

```dts
/dts-v1/;

#include <espressif/esp32/esp32_wrover_e_n4r8.dtsi>
#include "esp32_devkitc-pinctrl.dtsi"
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <espressif/partitions_0x1000_amp.dtsi>

/ {
    model = "Espressif ESP32-DevkitC PROCPU";
    compatible = "espressif,esp32";

    /* å…¨å±€åˆ«å - ä»£ç é€šè¿‡è¿™äº›åç§°è®¿é—®è®¾å¤‡ */
    aliases {
        uart-0 = &uart0;
        i2c-0 = &i2c0;
        sw0 = &button0;      /* æŒ‰é”®åˆ«å */
        watchdog0 = &wdt0;
    };

    /* æŒ‰é”®å®šä¹‰ */
    buttons {
        compatible = "gpio-keys";
        button0: button_0 {
            gpios = <&gpio0 0 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
            label = "BOOT Button";
        };
    };

    /* ç³»ç»Ÿé…ç½® */
    chosen {
        zephyr,sram = &sram1;
        zephyr,console = &uart0;
        zephyr,shell-uart = &uart0;
        zephyr,flash = &flash0;
        zephyr,code-partition = &slot0_partition;
    };
};

/* å¯ç”¨å¤–è®¾å¹¶é…ç½® */
&uart0 {
    status = "okay";
    current-speed = <115200>;
    pinctrl-0 = <&uart0_default>;
    pinctrl-names = "default";
};

&gpio0 {
    status = "okay";
};

&gpio1 {
    status = "okay";
};

&i2c0 {
    status = "okay";
    clock-frequency = <I2C_BITRATE_STANDARD>;
    sda-gpios = <&gpio0 21 GPIO_OPEN_DRAIN>;
    scl-gpios = <&gpio0 22 GPIO_OPEN_DRAIN>;
};

&spi2 {
    status = "okay";
};
```

**ä½œç”¨:**
- **æœ€ç»ˆæ•´åˆ**æ‰€æœ‰ä¸‹å±‚é…ç½®
- å®šä¹‰**å¼€å‘æ¿ç‰¹æœ‰**çš„æŒ‰é”®ã€LEDç­‰
- **å¯ç”¨éœ€è¦çš„å¤–è®¾** (`status = "okay"`)
- é…ç½®**å¼•è„šå¤ç”¨** (pinctrl)
- å®šä¹‰ **aliases** ä¾›ä»£ç è®¿é—®

**æ³¨æ„:** ESP32-DevKitC æ¿çº§ DTS **æ²¡æœ‰å®šä¹‰ LED**ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ Overlay æ·»åŠ ï¼

---

## 4. YAML Binding æ–‡ä»¶è¯¦è§£

### 4.1 Binding æ˜¯ä»€ä¹ˆ

Binding æ˜¯ YAML æ ¼å¼çš„æ–‡ä»¶ï¼Œå®šä¹‰äº†æŸç§ `compatible` ç±»å‹çš„è®¾å¤‡**åº”è¯¥æœ‰å“ªäº›å±æ€§**ã€‚Zephyr æ„å»ºç³»ç»Ÿç”¨å®ƒæ¥ï¼š
- éªŒè¯ DTS å±æ€§æ˜¯å¦æ­£ç¡®
- ç”Ÿæˆå®ä¾› C ä»£ç ä½¿ç”¨

### 4.2 Binding æ–‡ä»¶ä½ç½®

æ‰€æœ‰ Binding æ–‡ä»¶ä½äº: `zephyr/dts/bindings/`

å¸¸ç”¨ç›®å½•:

- ä¸åŒèŠ¯ç‰‡çš„æ„å»ºæœ‰ä¸åŒçš„æ ‡ç­¾å¯ä»¥ä½¿ç”¨ã€‚

```
dts/bindings/
â”œâ”€â”€ base/
â”‚   â””â”€â”€ base.yaml           # åŸºç¡€å±æ€§ (status, compatible, regç­‰)
â”œâ”€â”€ gpio/
â”‚   â”œâ”€â”€ gpio-controller.yaml
â”‚   â””â”€â”€ espressif,esp32-gpio.yaml
â”œâ”€â”€ led/
â”‚   â”œâ”€â”€ gpio-leds.yaml      # gpio-leds çš„ binding
â”‚   â””â”€â”€ led-node.yaml
â”œâ”€â”€ input/
â”‚   â””â”€â”€ gpio-keys.yaml
â””â”€â”€ ...
```

### 4.3 gpio-leds.yaml è¯¦è§£

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/bindings/led/gpio-leds.yaml`

```yaml
description: |
  Group of GPIO-controlled LEDs.

  Each LED is defined in a child node of the gpio-leds node.

  Example:
  / {
      leds {
          compatible = "gpio-leds";
          led_0 {
              gpios = <&gpio0 1 GPIO_ACTIVE_LOW>;
          };
          led_1 {
              gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;
          };
      };
  };

compatible: "gpio-leds"    # è®¾å¤‡å…¼å®¹æ€§å­—ç¬¦ä¸²

child-binding:             # å­èŠ‚ç‚¹çš„ binding
  description: GPIO LED child node

  include:
    - name: led-node.yaml  # åŒ…å« LED é€šç”¨å±æ€§
      property-allowlist:
        - label

  properties:
    gpios:                 # å¿…é¡»æŒ‡å®š GPIO
      type: phandle-array
      required: true
```

**å…³é”®ç‚¹:**
- `compatible: "gpio-leds"` æ˜¯å›ºå®šçš„ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªå€¼
- `gpios` å±æ€§æ˜¯**å¿…éœ€çš„** (`required: true`)
- `gpios` ç±»å‹æ˜¯ `phandle-array`ï¼Œæ ¼å¼ä¸º `<&æ§åˆ¶å™¨ å¼•è„šå· æ ‡å¿—>`

### 4.4 espressif,esp32-gpio.yaml è¯¦è§£

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/bindings/gpio/espressif,esp32-gpio.yaml`

```yaml
description: ESP32 GPIO controller

compatible: "espressif,esp32-gpio"

include: [gpio-controller.yaml, base.yaml]

properties:
  reg:
    required: true

  "#gpio-cells":
    const: 2              # ESP32 GPIO éœ€è¦2ä¸ªå‚æ•°

gpio-cells:
  - pin                   # ç¬¬1ä¸ªå‚æ•°: å¼•è„šå·
  - flags                 # ç¬¬2ä¸ªå‚æ•°: æ ‡å¿—ä½
```

**è¿™å‘Šè¯‰æˆ‘ä»¬:**
- å¼•ç”¨ ESP32 GPIO æ—¶ï¼Œéœ€è¦æä¾› **2 ä¸ªå‚æ•°**
- æ ¼å¼: `<&gpioX å¼•è„šå· æ ‡å¿—ä½>`
- ä¾‹å¦‚: `<&gpio0 2 GPIO_ACTIVE_HIGH>`

---

## 5. å¦‚ä½•æŸ¥æ‰¾å¯¹åº”æ¿çº§æ‰€æœ‰ç¡¬ä»¶æ ‡ç­¾

### 5.1 æ–¹æ³•ä¸€: ä»æ¿çº§ DTS å‘ä¸Šè¿½æº¯ (ä½ ç›®å‰çš„æ–¹æ³•)

```
esp32_devkitc_procpu.dts
    â”‚
    â”œâ”€â”€ #include <espressif/esp32/esp32_wrover_e_n4r8.dtsi>
    â”‚       â”‚
    â”‚       â””â”€â”€ #include "esp32_common.dtsi"  â† æ‰€æœ‰æ ‡ç­¾åœ¨è¿™é‡Œå®šä¹‰!
    â”‚
    â””â”€â”€ #include "esp32_devkitc-pinctrl.dtsi"  â† å¼•è„šå¤ç”¨é…ç½®
```

### 5.2 æ–¹æ³•äºŒ: æŸ¥çœ‹æ„å»ºç”Ÿæˆçš„ zephyr.dts

æ„å»ºåæŸ¥çœ‹ `build/zephyr/zephyr.dts`ï¼Œè¿™æ˜¯**æ‰€æœ‰ DTS åˆå¹¶åçš„æœ€ç»ˆç»“æœ**ï¼š

```bash
west build -b esp32_devkitc/esp32/procpu samples/basic/blinky
cat build/zephyr/zephyr.dts
```

### 5.3 æ–¹æ³•ä¸‰: ç›´æ¥æŸ¥çœ‹ SoC é€šç”¨å±‚

**ESP32:** `zephyr/dts/xtensa/espressif/esp32/esp32_common.dtsi`

è¿™ä¸ªæ–‡ä»¶åˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨å¤–è®¾åŠå…¶æ ‡ç­¾ã€‚

### 5.4 æ–¹æ³•å››: ä½¿ç”¨ grep æœç´¢

```bash
# æœç´¢æ‰€æœ‰ GPIO ç›¸å…³æ ‡ç­¾
grep -r "gpio[0-9]*:" zephyr/dts/xtensa/espressif/

# æœç´¢ç‰¹å®š compatible
grep -r "espressif,esp32-gpio" zephyr/dts/
```

### 5.5 ESP32 å¯ç”¨ GPIO å¼•è„šä¸€è§ˆ

æ ¹æ® `esp32_wrover_e_n4r8.dtsi` ä¸­çš„ `gpio-reserved-ranges`:

| GPIO æ§åˆ¶å™¨ | å¯ç”¨å¼•è„š | ä¸å¯ç”¨å¼•è„š (ä¿ç•™) |
|-------------|---------|------------------|
| `&gpio0` | 0-5, 12-15, 18-19, 21-23, 25-27 | 6-11 (Flash), 16-17 (PSRAM), 20, 24, 28-31 |
| `&gpio1` | 32-34, 39 | 35-36, 37-38 (NC) |

**å¸¸ç”¨å¼•è„šå»ºè®®:**
- LED: GPIO2 (æ¿è½½æŒ‡ç¤ºç¯é€šå¸¸è¿æ¥è¿™é‡Œ)
- æŒ‰é”®: GPIO0 (BOOT æŒ‰é”®)
- I2C: GPIO21 (SDA), GPIO22 (SCL)
- SPI: GPIO12-15

## 6.æºç DTSæ ‡ç­¾è§„èŒƒéªŒè¯

### 6.1 GPIOçš„ç¡¬ä»¶DTSæ ‡ç­¾è§„èŒƒ

è§„èŒƒæœ‰ä¸¤ä¸ªï¼š

- `zephyr\dts\bindings\gpio\espressif,esp32-lpgpio.yaml`
- `zephyr\dts\bindings\gpio\espressif,esp32-gpio.yaml`

é¦–å…ˆ`zephyr\boards\espressif\esp32_devkitc\esp32_devkitc_procpu.yaml`è¯´æ˜äº†æ”¯æŒGPIOåŠŸèƒ½ã€‚å†è€…`zephyr\boards\espressif\esp32_devkitc\esp32_devkitc_procpu_defconfig`ä¸­ä¹ŸæŠŠGPIOå­ç³»ç»Ÿæ‰“å¼€äº†ã€‚æ˜¯ä¸æ˜¯æ„å‘³ç€æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•ï¼Œä¸€å®šå¯ä»¥æ‰¾åˆ°æœ‰å…³GPIOç¡¬ä»¶æ ‡ç­¾æè¿°ï¼Ÿè®©æˆ‘ä»¬ä»æ¿çº§ DTS æ–‡ä»¶é€å±‚å‘ä¸ŠéªŒè¯ã€‚

### 6.2 é€å±‚è¿½æº¯éªŒè¯è¿‡ç¨‹

#### ç¬¬1æ­¥ï¼šæ¿çº§å±‚ - esp32_devkitc_procpu.dts

**æ–‡ä»¶è·¯å¾„:** `zephyr\boards\espressif\esp32_devkitc\esp32_devkitc_procpu.dts`

**å…³é”®å†…å®¹:**

```dts
/dts-v1/;

#include <espressif/esp32/esp32_wrover_e_n4r8.dtsi>  // ç¬¬8è¡Œï¼šåŒ…å«èŠ¯ç‰‡å°è£…å±‚
#include "esp32_devkitc-pinctrl.dtsi"
// ... å…¶ä»–å¤´æ–‡ä»¶ ...

/ {
    // ... å…¶ä»–é…ç½® ...

    buttons {
        compatible = "gpio-keys";
        button0: button_0 {
            gpios = <&gpio0 0 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;  // ç¬¬29è¡Œï¼šå¼•ç”¨ &gpio0
            label = "BOOT Button";
        };
    };
};

&gpio0 {                // ç¬¬64-66è¡Œï¼šä½¿ç”¨ &gpio0 æ ‡ç­¾
    status = "okay";    // å¯ç”¨ GPIO0 æ§åˆ¶å™¨
};

&gpio1 {                // ç¬¬68-70è¡Œï¼šä½¿ç”¨ &gpio1 æ ‡ç­¾
    status = "okay";    // å¯ç”¨ GPIO1 æ§åˆ¶å™¨
};

&i2c0 {
    status = "okay";
    sda-gpios = <&gpio0 21 GPIO_OPEN_DRAIN>;  // ç¬¬87è¡Œï¼šå¼•ç”¨ &gpio0
    scl-gpios = <&gpio0 22 GPIO_OPEN_DRAIN>;  // ç¬¬88è¡Œï¼šå¼•ç”¨ &gpio0
};
```

**å‘ç°:**
- ä½¿ç”¨äº† `&gpio0` å’Œ `&gpio1` æ ‡ç­¾ï¼Œä½†**æ²¡æœ‰å®šä¹‰**è¿™äº›æ ‡ç­¾
- æ ‡ç­¾å®šä¹‰å¿…é¡»åœ¨æ›´ä¸Šå±‚çš„ dtsi æ–‡ä»¶ä¸­

---

#### ç¬¬2æ­¥ï¼šèŠ¯ç‰‡å°è£…å±‚ - esp32_wrover_e_n4r8.dtsi

**æ–‡ä»¶è·¯å¾„:** `zephyr\dts\xtensa\espressif\esp32\esp32_wrover_e_n4r8.dtsi`

**å…³é”®å†…å®¹:**

```dts
#include "esp32_common.dtsi"  // ç¬¬7è¡Œï¼šåŒ…å« SoC é€šç”¨å±‚

/* Reserved GPIO pins */
&gpio0 {                      // ç¬¬10-13è¡Œï¼šå¼•ç”¨ &gpio0ï¼ˆä»æœªå®šä¹‰ï¼Œåªæ˜¯ä¿®æ”¹ï¼‰
    gpio-reserved-ranges = <6 6>, <16 2>,  // Flash & PSRAM
                           <20 1>, <24 1>, <28 4>; // NC
};

&gpio1 {                      // ç¬¬15-17è¡Œï¼šå¼•ç”¨ &gpio1ï¼ˆä»æœªå®šä¹‰ï¼Œåªæ˜¯ä¿®æ”¹ï¼‰
    gpio-reserved-ranges = <5 2>; // GPIO37-38 NC
};

/* 4MB flash */
&flash0 {
    reg = <0x0 DT_SIZE_M(4)>;
};

/* 8MB psram */
&psram0 {
    size = <DT_SIZE_M(8)>;
};
```

**å‘ç°:**
- ä»ç„¶åªæ˜¯**å¼•ç”¨**äº† `&gpio0` å’Œ `&gpio1`ï¼Œç”¨äºä¿®æ”¹å±æ€§ï¼ˆæ·»åŠ ä¿ç•™èŒƒå›´ï¼‰
- æ ‡ç­¾å®šä¹‰å¿…é¡»åœ¨æ›´ä¸Šå±‚ï¼š`esp32_common.dtsi`

---

#### ç¬¬3æ­¥ï¼šSoCé€šç”¨å±‚ - esp32_common.dtsiï¼ˆå…³é”®å±‚ï¼ï¼‰

**æ–‡ä»¶è·¯å¾„:** `zephyr\dts\xtensa\espressif\esp32\esp32_common.dtsi`

**å…³é”®å†…å®¹:**

```dts
#include <xtensa/xtensa.dtsi>  // ç¬¬9è¡Œï¼šåŒ…å«æ¶æ„å±‚
// ... å…¶ä»–å¤´æ–‡ä»¶ ...

/ {
    // ... å…¶ä»–èŠ‚ç‚¹ ...

    soc {
        // ... å…¶ä»–å¤–è®¾ ...

        // ç¬¬302-337è¡Œï¼šGPIO æ ‡ç­¾å®šä¹‰çš„æ ¸å¿ƒä½ç½®ï¼
        gpio: gpio {                           // é¡¶å±‚ GPIO èŠ‚ç‚¹
            compatible = "simple-bus";
            gpio-map-mask = <0xffffffe0 0xffffffc0>;
            gpio-map-pass-thru = <0x1f 0x3f>;
            gpio-map = <0x00 0x0 &gpio0 0x0 0x0
                        0x20 0x0 &gpio1 0x0 0x0>;
            #gpio-cells = <2>;
            #address-cells = <1>;
            #size-cells = <1>;
            ranges;

            gpio0: gpio@3ff44000 {             // ç¬¬313è¡Œï¼šgpio0 æ ‡ç­¾å®šä¹‰ï¼
                compatible = "espressif,esp32-gpio";  // ç¬¬314è¡Œï¼šå…³é”®å…¼å®¹æ€§å­—ç¬¦ä¸²
                gpio-controller;               // ç¬¬315è¡Œï¼šå£°æ˜è¿™æ˜¯ GPIO æ§åˆ¶å™¨
                #gpio-cells = <2>;             // ç¬¬316è¡Œï¼šéœ€è¦2ä¸ªå‚æ•°
                reg = <0x3ff44000 0x800>;      // ç¬¬317è¡Œï¼šå¯„å­˜å™¨åœ°å€
                interrupts = <GPIO_INTR_SOURCE IRQ_DEFAULT_PRIORITY 0>;
                interrupt-parent = <&intc>;
                /* Maximum available pins (per port)
                 * Actual occupied pins are specified
                 * on part number dtsi level, using
                 * the `gpio-reserved-ranges` property.
                 */
                ngpios = <32>;                 // ç¬¬325è¡Œï¼šGPIO 0-31
            };

            gpio1: gpio@3ff44800 {             // ç¬¬328è¡Œï¼šgpio1 æ ‡ç­¾å®šä¹‰ï¼
                compatible = "espressif,esp32-gpio";  // ç¬¬329è¡Œï¼šç›¸åŒçš„å…¼å®¹æ€§å­—ç¬¦ä¸²
                gpio-controller;
                #gpio-cells = <2>;
                reg = <0x3ff44800 0x800>;
                interrupts = <GPIO_INTR_SOURCE IRQ_DEFAULT_PRIORITY 0>;
                interrupt-parent = <&intc>;
                ngpios = <8>;                  // ç¬¬335è¡Œï¼šGPIO 32-39
            };
        };

        // ... å…¶ä»–å¤–è®¾å®šä¹‰ ...
    };
};
```

**é‡å¤§å‘ç°ï¼è¿™é‡Œæ˜¯ GPIO æ ‡ç­¾çš„å®šä¹‰æºå¤´ï¼š**

1. **gpio0 æ ‡ç­¾å®šä¹‰**ï¼ˆç¬¬313è¡Œï¼‰:
   - æ ‡ç­¾å: `gpio0:`
   - èŠ‚ç‚¹å: `gpio@3ff44000`
   - å…¼å®¹æ€§: `compatible = "espressif,esp32-gpio"`
   - GPIOèŒƒå›´: 0-31

2. **gpio1 æ ‡ç­¾å®šä¹‰**ï¼ˆç¬¬328è¡Œï¼‰:
   - æ ‡ç­¾å: `gpio1:`
   - èŠ‚ç‚¹å: `gpio@3ff44800`
   - å…¼å®¹æ€§: `compatible = "espressif,esp32-gpio"`
   - GPIOèŒƒå›´: 32-39

---

#### ç¬¬4æ­¥ï¼šYAML Binding è§„èŒƒéªŒè¯

**æ–‡ä»¶è·¯å¾„:** `zephyr\dts\bindings\gpio\espressif,esp32-gpio.yaml`

**å…³é”®å†…å®¹:**

```yaml
description: ESP32 GPIO controller

compatible: "espressif,esp32-gpio"    # ç¬¬6è¡Œï¼šä¸ DTS ä¸­çš„ compatible åŒ¹é…ï¼

include: [gpio-controller.yaml, base.yaml]

properties:
  reg:
    required: true                    # å¿…é¡»æœ‰å¯„å­˜å™¨åœ°å€

  "#gpio-cells":
    const: 2                          # ç¬¬15è¡Œï¼šå¿…é¡»æ˜¯2ä¸ªå‚æ•°

gpio-cells:
  - pin                               # ç¬¬18è¡Œï¼šç¬¬1ä¸ªå‚æ•° = å¼•è„šå·
  - flags                             # ç¬¬19è¡Œï¼šç¬¬2ä¸ªå‚æ•° = æ ‡å¿—ä½
```

**éªŒè¯ç»“æœ:**

| é¡¹ç›® | esp32_common.dtsi ä¸­çš„å®šä¹‰ | YAML Binding è§„èŒƒ | æ˜¯å¦åŒ¹é… |
|------|---------------------------|------------------|---------|
| compatible | `"espressif,esp32-gpio"` | `"espressif,esp32-gpio"` | âœ… åŒ¹é… |
| #gpio-cells | `<2>` | `const: 2` | âœ… åŒ¹é… |
| å‚æ•°å«ä¹‰ | å¼•è„šå· + æ ‡å¿—ä½ | pin + flags | âœ… åŒ¹é… |
| å¯„å­˜å™¨åœ°å€ | `reg = <0x3ff44000 0x800>` | `required: true` | âœ… åŒ¹é… |
| gpio-controller | âœ… æœ‰ | ç»§æ‰¿è‡ª gpio-controller.yaml | âœ… åŒ¹é… |

### 6.3 å®Œæ•´è¿½æº¯è·¯å¾„æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YAML Binding (è§„èŒƒå±‚)                                                â”‚
â”‚  zephyr/dts/bindings/gpio/espressif,esp32-gpio.yaml                  â”‚
â”‚  â”œâ”€ compatible: "espressif,esp32-gpio"                               â”‚
â”‚  â”œâ”€ #gpio-cells: 2 (pin + flags)                                     â”‚
â”‚  â””â”€ å®šä¹‰äº† GPIO èŠ‚ç‚¹çš„å±æ€§è§„èŒƒ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ è§„èŒƒå®šä¹‰
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SoCé€šç”¨å±‚ (æ ‡ç­¾å®šä¹‰æºå¤´) â† æœ€é‡è¦!                                   â”‚
â”‚  zephyr/dts/xtensa/espressif/esp32/esp32_common.dtsi                 â”‚
â”‚  ç¬¬313-336è¡Œ:                                                        â”‚
â”‚  â”œâ”€ gpio0: gpio@3ff44000 { ... }  â† gpio0 æ ‡ç­¾åœ¨è¿™é‡Œå®šä¹‰!            â”‚
â”‚  â”‚    â”œâ”€ compatible = "espressif,esp32-gpio"                         â”‚
â”‚  â”‚    â”œâ”€ #gpio-cells = <2>                                           â”‚
â”‚  â”‚    â””â”€ ngpios = <32>  (GPIO 0-31)                                  â”‚
â”‚  â””â”€ gpio1: gpio@3ff44800 { ... }  â† gpio1 æ ‡ç­¾åœ¨è¿™é‡Œå®šä¹‰!            â”‚
â”‚       â”œâ”€ compatible = "espressif,esp32-gpio"                         â”‚
â”‚       â”œâ”€ #gpio-cells = <2>                                           â”‚
â”‚       â””â”€ ngpios = <8>   (GPIO 32-39)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ #include "esp32_common.dtsi"
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ¯ç‰‡å°è£…å±‚ (ä¿®æ”¹å±‚)                                                   â”‚
â”‚  zephyr/dts/xtensa/espressif/esp32/esp32_wrover_e_n4r8.dtsi          â”‚
â”‚  ç¬¬10-17è¡Œ:                                                          â”‚
â”‚  â”œâ”€ &gpio0 { gpio-reserved-ranges = ...; }  â† å¼•ç”¨å¹¶ä¿®æ”¹ gpio0      â”‚
â”‚  â””â”€ &gpio1 { gpio-reserved-ranges = ...; }  â† å¼•ç”¨å¹¶ä¿®æ”¹ gpio1      â”‚
â”‚  ä½œç”¨: å£°æ˜å“ªäº› GPIO å¼•è„šè¢« Flash/PSRAM å ç”¨ï¼Œä¸å¯ä½¿ç”¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ #include <espressif/esp32/esp32_wrover_e_n4r8.dtsi>
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¿çº§å±‚ (ä½¿èƒ½å±‚)                                                       â”‚
â”‚  zephyr/boards/espressif/esp32_devkitc/esp32_devkitc_procpu.dts     â”‚
â”‚  ç¬¬64-70è¡Œ:                                                          â”‚
â”‚  â”œâ”€ &gpio0 { status = "okay"; }  â† å¯ç”¨ GPIO0 æ§åˆ¶å™¨                â”‚
â”‚  â””â”€ &gpio1 { status = "okay"; }  â† å¯ç”¨ GPIO1 æ§åˆ¶å™¨                â”‚
â”‚  ç¬¬29è¡Œ:                                                             â”‚
â”‚  â””â”€ gpios = <&gpio0 0 ...>;      â† ä½¿ç”¨ gpio0 æ ‡ç­¾å¼•ç”¨å…·ä½“å¼•è„š      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 éªŒè¯ç»“è®º

**âœ… å®Œå…¨ç¬¦åˆé¢„æœŸï¼éªŒè¯æˆåŠŸï¼**

1. **æ ‡ç­¾å®šä¹‰ä½ç½®æ­£ç¡®:**
   - `gpio0` å’Œ `gpio1` æ ‡ç­¾ç¡®å®å®šä¹‰åœ¨ **SoCé€šç”¨å±‚** (`esp32_common.dtsi`)
   - è¿™æ˜¯ç¬¬3å±‚ DTS æ–‡ä»¶ï¼Œç¬¦åˆæ–‡æ¡£å‰é¢æè¿°çš„å±‚çº§ç»“æ„

2. **YAML Binding è§„èŒƒåŒ¹é…:**
   - `compatible = "espressif,esp32-gpio"` ä¸ YAML binding å®Œå…¨åŒ¹é…
   - `#gpio-cells = <2>` ç¬¦åˆè§„èŒƒè¦æ±‚
   - å‚æ•°å«ä¹‰ï¼ˆpin + flagsï¼‰ç¬¦åˆè§„èŒƒå®šä¹‰

3. **å±‚çº§èŒè´£æ¸…æ™°:**
   - **SoCé€šç”¨å±‚:** å®šä¹‰æ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶æ ‡ç­¾ï¼ˆgpio0, gpio1, uart0, i2c0ç­‰ï¼‰
   - **èŠ¯ç‰‡å°è£…å±‚:** ä¿®æ”¹æ ‡ç­¾å±æ€§ï¼ˆä¿ç•™èŒƒå›´ã€Flash/PSRAM å¤§å°ï¼‰
   - **æ¿çº§å±‚:** å¯ç”¨éœ€è¦çš„å¤–è®¾ï¼ˆstatus = "okay"ï¼‰å¹¶ä½¿ç”¨æ ‡ç­¾

4. **å¼•ç”¨é“¾å®Œæ•´:**
   ```
   æ¿çº§ DTS ä½¿ç”¨ &gpio0
        â†‘ å¼•ç”¨
   èŠ¯ç‰‡å°è£…å±‚ä¿®æ”¹ &gpio0
        â†‘ ç»§æ‰¿
   SoCé€šç”¨å±‚å®šä¹‰ gpio0: gpio@3ff44000
        â†‘ ç¬¦åˆ
   YAML Binding è§„èŒƒ espressif,esp32-gpio.yaml
   ```

### 6.5 DTSä¸­æ›´å¤šå±æ€§çš„å®Œæ•´éªŒè¯

æ–‡æ¡£å‰é¢éªŒè¯äº†åŸºç¡€å±æ€§ï¼Œä½†DTSä¸­è¿˜ä½¿ç”¨äº†å¾ˆå¤šå…¶ä»–å±æ€§ã€‚è®©æˆ‘ä»¬å®Œæ•´éªŒè¯å®ƒä»¬çš„æ¥æºã€‚

#### 6.5.1 GPIOæ§åˆ¶å™¨èŠ‚ç‚¹çš„å®Œæ•´å±æ€§è§£æ

å›é¡¾ `esp32_common.dtsi` ä¸­çš„ gpio0 èŠ‚ç‚¹ï¼š

```dts
gpio0: gpio@3ff44000 {
    compatible = "espressif,esp32-gpio";  // âœ“ å·²éªŒè¯
    gpio-controller;                      // â“ æ¥æº
    #gpio-cells = <2>;                    // âœ“ å·²éªŒè¯
    reg = <0x3ff44000 0x800>;             // âœ“ å·²éªŒè¯
    interrupts = <GPIO_INTR_SOURCE IRQ_DEFAULT_PRIORITY 0>;  // â“ æ¥æº
    interrupt-parent = <&intc>;           // â“ æ¥æº
    ngpios = <32>;                        // â“ æ¥æº
};
```

èŠ¯ç‰‡å°è£…å±‚è¿˜ä½¿ç”¨äº†ï¼š

```dts
&gpio0 {
    gpio-reserved-ranges = <6 6>, <16 2>, ...;  // â“ æ¥æº
};
```

#### 6.5.2 ç»§æ‰¿çš„YAML BindingéªŒè¯

**espressif,esp32-gpio.yaml åŒ…å«äº†å¤šä¸ªbinding:**

```yaml
compatible: "espressif,esp32-gpio"

include: [gpio-controller.yaml, base.yaml]  # åŒ…å«äº†ä¸¤ä¸ªåŸºç¡€binding
```

**â‘  gpio-controller.yaml æä¾›çš„å±æ€§:**

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/bindings/gpio/gpio-controller.yaml`

```yaml
properties:
  gpio-controller:
    type: boolean
    required: true
    description: Convey's this node is a GPIO controller

  "#gpio-cells":
    type: int
    required: true
    description: Number of items to expect in a GPIO specifier

  ngpios:
    type: int
    default: 32
    description: |
      This property indicates the number of in-use slots of available slots
      for GPIOs. The typical example is something like this: the hardware
      register is 32 bits wide, but only 18 of the bits have a physical
      counterpart.

  gpio-reserved-ranges:
    type: array
    description: |
      If not all the GPIOs at offsets 0...N-1 are usable for ngpios = <N>,
      then this property contains an additional set of tuples which specify
      which GPIOs are unusable. This property indicates the start and size
      of the GPIOs that can't be used.

      For example, setting "gpio-reserved-ranges = <3 2>, <10 1>;" means
      GPIO offsets 3, 4, and 10 are not usable, even if ngpios = <18>.
```

**â‘¡ base.yaml æä¾›çš„é€šç”¨å±æ€§:**

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/bindings/base/base.yaml`

```yaml
properties:
  status:
    type: string
    enum: ["okay", "disabled", "reserved", "fail", "fail-sss"]

  compatible:
    type: string-array
    required: true

  reg:
    type: array
    description: Information used to address the device

  interrupts:
    type: array
    description: |
      Information about interrupts generated by the device, encoded as
      an array of one or more interrupt specifiers.

  interrupt-parent:
    type: phandle
    description: |
      If present, this refers to the node which handles interrupts
      generated by this device.

  "#address-cells":
    type: int

  "#size-cells":
    type: int
```

#### 6.5.3 é¡¶å±‚GPIOèŠ‚ç‚¹çš„å±æ€§éªŒè¯

**esp32_common.dtsiä¸­çš„é¡¶å±‚gpioèŠ‚ç‚¹:**

```dts
gpio: gpio {
    compatible = "simple-bus";
    gpio-map-mask = <0xffffffe0 0xffffffc0>;      // â“ æ¥æº
    gpio-map-pass-thru = <0x1f 0x3f>;            // â“ æ¥æº
    gpio-map = <0x00 0x0 &gpio0 0x0 0x0           // â“ æ¥æº
                0x20 0x0 &gpio1 0x0 0x0>;
    #gpio-cells = <2>;
    #address-cells = <1>;
    #size-cells = <1>;
    ranges;
};
```

è¿™ä¸ªèŠ‚ç‚¹ä½¿ç”¨äº† **gpio-nexus** æ¨¡å¼ï¼ˆGPIOæ˜ å°„/è½¬å‘å™¨ï¼‰ã€‚

**gpio-nexus.yaml æä¾›çš„å±æ€§:**

**æ–‡ä»¶è·¯å¾„:** `zephyr/dts/bindings/gpio/gpio-nexus.yaml`

```yaml
properties:
  gpio-map:
    type: compound
    required: true
    description: |
      GPIOæ˜ å°„è¡¨ï¼Œå°†è™šæ‹ŸGPIOæ˜ å°„åˆ°å®é™…çš„GPIOæ§åˆ¶å™¨

  gpio-map-mask:
    type: array
    description: |
      åº”ç”¨äºå­GPIOå¼•ç”¨çš„æ©ç ï¼Œç”¨äºæå–æ˜ å°„è¡¨çš„ç´¢å¼•

  gpio-map-pass-thru:
    type: array
    description: |
      ä¸ç»è¿‡æ˜ å°„ç›´æ¥ä¼ é€’ç»™çˆ¶æ§åˆ¶å™¨çš„ä½
```

**è¿™ä¸ªé¡¶å±‚èŠ‚ç‚¹çš„ä½œç”¨:**
- ESP32æœ‰ä¸¤ä¸ªGPIOæ§åˆ¶å™¨ï¼šgpio0 (GPIO 0-31) å’Œ gpio1 (GPIO 32-39)
- é¡¶å±‚çš„ `gpio` èŠ‚ç‚¹æä¾›**ç»Ÿä¸€çš„è®¿é—®æ¥å£**
- `gpio-map` è‡ªåŠ¨å°†GPIOå¼•è„šå·è·¯ç”±åˆ°æ­£ç¡®çš„æ§åˆ¶å™¨ï¼š
  - GPIO 0-31 â†’ `&gpio0`
  - GPIO 32-39 â†’ `&gpio1`

#### 6.5.6 å¼•ç”¨å’Œä¿®æ”¹èŠ‚ç‚¹çš„è¯­æ³•è§„èŒƒéªŒè¯

**é—®é¢˜ï¼š** `&gpio0 { ... }` è¿™ç§è¯­æ³•æ˜¯è°æ¥è§„èŒƒçš„ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥å¤šæ¬¡å¼•ç”¨å¹¶ä¿®æ”¹ï¼Ÿ

**ç¤ºä¾‹ä»£ç ï¼š**

```dts
// ç¬¬ä¸€æ¬¡å¼•ç”¨ï¼šå¯ç”¨GPIO0æ§åˆ¶å™¨
&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

// ç¬¬äºŒæ¬¡å¼•ç”¨ï¼šæ·»åŠ ä¿ç•™èŒƒå›´å±æ€§
&gpio0 {
	gpio-reserved-ranges = <6 6>, <16 2>,  // flash&psram
			       <20 1>, <24 1>, <28 4>; // NC
};

&gpio1 {
	gpio-reserved-ranges = <5 2>; // GPIO37-38 NC
};
```

**ç­”æ¡ˆï¼šè¿™æ˜¯è®¾å¤‡æ ‘è¯­è¨€è§„èŒƒæœ¬èº«å®šä¹‰çš„ï¼Œä¸æ˜¯YAML Bindingï¼**

---

### ä¸‰ç§è§„èŒƒå±‚æ¬¡çš„åŒºåˆ†

| è§„èŒƒç±»å‹ | è§„èŒƒå†…å®¹ | è§„èŒƒæ–‡æ¡£ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **â‘ è®¾å¤‡æ ‘è¯­è¨€è§„èŒƒ<br>(DTS Syntax)** | DTSæ–‡ä»¶çš„è¯­æ³•ç»“æ„ã€<br>æ ‡ç­¾ã€å¼•ç”¨ã€è¦†ç›–æœºåˆ¶ | Devicetree Specification<br>(devicetree.org) | `&gpio0 { ... }`<br>`label: node@addr { ... }`<br>`#include <file.dtsi>` |
| **â‘¡YAML Bindingè§„èŒƒ<br>(Schema)** | ç‰¹å®šcompatibleè®¾å¤‡<br>åº”è¯¥æœ‰å“ªäº›å±æ€§ | `zephyr/dts/bindings/*.yaml` | `compatible: "espressif,esp32-gpio"`<br>éœ€è¦ `reg`, `#gpio-cells` ç­‰ |
| **â‘¢Cå¤´æ–‡ä»¶å¸¸é‡<br>(Macros)** | DTSä¸­ä½¿ç”¨çš„å¸¸é‡å®šä¹‰<br>(æ ‡å¿—ä½ã€é¢‘ç‡ç­‰) | `zephyr/include/zephyr/<br>dt-bindings/*.h` | `GPIO_ACTIVE_HIGH`<br>`DT_FREQ_M(240)` |

---

#### â‘  è®¾å¤‡æ ‘è¯­è¨€è§„èŒƒ (Devicetree Specification)

**è§„èŒƒæ¥æºï¼š** [Devicetree Specification v0.4](https://devicetree.org/specifications/)ï¼ˆå¼€æ”¾æ ‡å‡†ï¼Œç”±Devicetree.orgç»´æŠ¤ï¼‰

**å®šä¹‰çš„è¯­æ³•è§„åˆ™ï¼š**

##### 1. æ ‡ç­¾å®šä¹‰ä¸å¼•ç”¨ (Label and Reference)

```dts
// å®šä¹‰æ ‡ç­¾ï¼ˆåœ¨èŠ‚ç‚¹åå‰åŠ  "label:"ï¼‰
gpio0: gpio@3ff44000 {
    compatible = "espressif,esp32-gpio";
    reg = <0x3ff44000 0x800>;
};

// å¼•ç”¨æ ‡ç­¾ï¼ˆä½¿ç”¨ "&label" è¯­æ³•ï¼‰
&gpio0 {                    // å¼•ç”¨ä¹‹å‰å®šä¹‰çš„ gpio0 èŠ‚ç‚¹
    status = "okay";        // æ·»åŠ æˆ–ä¿®æ”¹å±æ€§
};
```

**è§„èŒƒå‡ºå¤„ï¼š** Devicetree Specification ç¬¬6.3èŠ‚ "Labels and References"

##### 2. èŠ‚ç‚¹è¦†ç›–/å åŠ æœºåˆ¶ (Node Overlay)

```dts
// ç¬¬ä¸€æ¬¡å®šä¹‰
gpio0: gpio@3ff44000 {
    compatible = "espressif,esp32-gpio";
    ngpios = <32>;
};

// ç¬¬äºŒæ¬¡å¼•ç”¨ï¼šæ·»åŠ æ–°å±æ€§
&gpio0 {
    status = "okay";
};

// ç¬¬ä¸‰æ¬¡å¼•ç”¨ï¼šç»§ç»­æ·»åŠ å±æ€§
&gpio0 {
    gpio-reserved-ranges = <6 6>, <16 2>;
};

// ç¼–è¯‘åçš„ç»“æœï¼ˆæ‰€æœ‰å¼•ç”¨ä¼šåˆå¹¶åˆ°ä¸€èµ·ï¼‰ï¼š
gpio0: gpio@3ff44000 {
    compatible = "espressif,esp32-gpio";
    ngpios = <32>;
    status = "okay";                      // æ¥è‡ªç¬¬äºŒæ¬¡å¼•ç”¨
    gpio-reserved-ranges = <6 6>, <16 2>; // æ¥è‡ªç¬¬ä¸‰æ¬¡å¼•ç”¨
};
```

**è§„èŒƒå‡ºå¤„ï¼š** Devicetree Specification ç¬¬6.4èŠ‚ "Overlay Syntax"

**å…³é”®è§„åˆ™ï¼š**
- åŒä¸€ä¸ªæ ‡ç­¾å¯ä»¥è¢«å¼•ç”¨**å¤šæ¬¡**
- æ¯æ¬¡å¼•ç”¨ä¼š**å åŠ **æ–°çš„å±æ€§
- å¦‚æœå±æ€§é‡å¤ï¼Œ**åé¢çš„è¦†ç›–å‰é¢çš„**
- æœ€ç»ˆæ‰€æœ‰å¼•ç”¨ä¼š**åˆå¹¶**æˆä¸€ä¸ªå®Œæ•´èŠ‚ç‚¹

##### 3. phandle å¼•ç”¨ (Phandle)

```dts
// åœ¨å±æ€§ä¸­å¼•ç”¨å…¶ä»–èŠ‚ç‚¹ï¼ˆä½¿ç”¨ "&label" ä½œä¸ºphandleï¼‰
myled: led_0 {
    gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;  // &gpio0 æ˜¯phandleå¼•ç”¨
            // â†‘ å¼•ç”¨gpio0èŠ‚ç‚¹
};

i2c0: i2c@3ff53000 {
    interrupt-parent = <&intc>;  // &intc æ˜¯phandleå¼•ç”¨
                       // â†‘ å¼•ç”¨ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹
};
```

**è§„èŒƒå‡ºå¤„ï¼š** Devicetree Specification ç¬¬2.4èŠ‚ "phandle"

##### 4. è·¯å¾„å¼•ç”¨ (Path Reference)

```dts
// é™¤äº†æ ‡ç­¾å¼•ç”¨ï¼Œè¿˜å¯ä»¥ç”¨ç»å¯¹è·¯å¾„å¼•ç”¨
aliases {
    led0 = &myled;              // æ ‡ç­¾å¼•ç”¨ï¼ˆå¸¸ç”¨ï¼‰
    uart0 = "/soc/uart@3ff40000"; // è·¯å¾„å¼•ç”¨ï¼ˆå°‘ç”¨ï¼‰
};
```

**è§„èŒƒå‡ºå¤„ï¼š** Devicetree Specification ç¬¬2.2.3èŠ‚ "Path Names"

---

#### â‘¡ YAML Bindingè§„èŒƒ (åªç®¡å±æ€§ï¼Œä¸ç®¡è¯­æ³•)

**YAML Bindingä¸å…³å¿ƒï¼š**
- âŒ ä½ ç”¨ä¸ç”¨æ ‡ç­¾
- âŒ ä½ ç”¨ `&gpio0` è¿˜æ˜¯è·¯å¾„å¼•ç”¨
- âŒ ä½ å¼•ç”¨äº†å‡ æ¬¡èŠ‚ç‚¹
- âŒ ä½ çš„èŠ‚ç‚¹åå«ä»€ä¹ˆ

**YAML Bindingåªå…³å¿ƒï¼š**
- âœ… ä½ çš„ `compatible` æ˜¯ä»€ä¹ˆ
- âœ… ä½ æœ‰æ²¡æœ‰å¿…éœ€çš„å±æ€§ï¼ˆå¦‚ `reg`, `#gpio-cells`ï¼‰
- âœ… å±æ€§çš„ç±»å‹å¯¹ä¸å¯¹ï¼ˆå¸ƒå°”ã€æ•´æ•°ã€æ•°ç»„ç­‰ï¼‰

**ä¸¾ä¾‹ï¼š**

```yaml
# espressif,esp32-gpio.yaml
compatible: "espressif,esp32-gpio"

properties:
  reg:
    required: true    # â† åªè§„èŒƒ"å¿…é¡»æœ‰regå±æ€§"
                      #   ä¸ç®¡ä½ åœ¨å“ªä¸ªæ–‡ä»¶å®šä¹‰ï¼Œå¼•ç”¨å‡ æ¬¡

  "#gpio-cells":
    const: 2          # â† åªè§„èŒƒ"è¿™ä¸ªå€¼å¿…é¡»æ˜¯2"
                      #   ä¸ç®¡ä½ ç”¨ä»€ä¹ˆè¯­æ³•å†™
```

---

#### â‘¢ Cå¤´æ–‡ä»¶å¸¸é‡ (æä¾›é¢„å®šä¹‰å€¼)

```c
// zephyr/include/zephyr/dt-bindings/gpio/gpio.h
#define GPIO_ACTIVE_HIGH  (0 << 0)
#define GPIO_ACTIVE_LOW   (1 << 0)

// DTSä¸­ä½¿ç”¨ï¼ˆé¢„å¤„ç†å™¨ä¼šæ›¿æ¢ï¼‰
gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;
        â†“ é¢„å¤„ç†å
gpios = <&gpio0 2 0>;
```

---

### å®Œæ•´çš„éªŒè¯é“¾æ¡

**ä»¥ `&gpio0 { status = "okay"; }` ä¸ºä¾‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘  DTSè¯­è¨€è§„èŒƒéªŒè¯ï¼ˆè¯­æ³•å±‚ï¼‰                                        â”‚
â”‚    Devicetree Specification v0.4                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ "&gpio0" æ˜¯åˆæ³•çš„æ ‡ç­¾å¼•ç”¨è¯­æ³•ï¼ˆç¬¬6.3èŠ‚ï¼‰                        â”‚
â”‚ âœ“ "{ ... }" æ˜¯åˆæ³•çš„èŠ‚ç‚¹å†…å®¹è¯­æ³•ï¼ˆç¬¬6.1èŠ‚ï¼‰                       â”‚
â”‚ âœ“ å¯ä»¥å¤šæ¬¡å¼•ç”¨åŒä¸€æ ‡ç­¾å¹¶å åŠ å±æ€§ï¼ˆç¬¬6.4èŠ‚ï¼‰                       â”‚
â”‚ âœ“ gpio0 æ ‡ç­¾å¿…é¡»åœ¨ä¹‹å‰æŸå¤„å®šä¹‰ï¼ˆåœ¨ esp32_common.dtsi ä¸­ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ è¯­æ³•æ­£ç¡®åï¼Œæ£€æŸ¥å±æ€§è§„èŒƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘¡ YAML BindingéªŒè¯ï¼ˆå±æ€§å±‚ï¼‰                                      â”‚
â”‚    espressif,esp32-gpio.yaml + gpio-controller.yaml + base.yaml  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ status å±æ€§åœ¨ base.yaml ä¸­å®šä¹‰ï¼ˆç±»å‹: stringï¼‰                 â”‚
â”‚ âœ“ "okay" æ˜¯åˆæ³•çš„æšä¸¾å€¼ï¼ˆenum: ["okay", "disabled", ...]ï¼‰       â”‚
â”‚ âœ“ gpio-reserved-ranges åœ¨ gpio-controller.yaml ä¸­å®šä¹‰ï¼ˆtype: arrayï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ å±æ€§éªŒè¯é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘¢ Cå¤´æ–‡ä»¶å®æ›¿æ¢ï¼ˆå¸¸é‡å±‚ï¼‰                                          â”‚
â”‚    é¢„å¤„ç†å™¨å°†å®æ›¿æ¢ä¸ºå®é™…å€¼                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPIO_ACTIVE_HIGH â†’ 0                                             â”‚
â”‚ DT_SIZE_K(192) â†’ 196608                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. ç¼–å†™ Overlay æ–‡ä»¶å®æˆ˜ - ä¸‰å±‚è§„èŒƒçš„åº”ç”¨

### 7.1 å®é™…å¼€å‘ä¸­éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

å¯¹äºå·²ç»æ”¯æŒçš„æ¿çº§å¼€å‘ï¼ˆä¸æ¶‰åŠæ–°æ¶æ„/æ–°SoC/æ–°æ¿çº§ï¼‰ï¼Œæ‰€æœ‰å±‚çº§DTSå·²ç»å®šä¹‰å¥½ï¼š
- âœ… SoCé€šç”¨å±‚å·²å®šä¹‰æ‰€æœ‰ç¡¬ä»¶æ ‡ç­¾ï¼ˆgpio0, uart0ç­‰ï¼‰
- âœ… èŠ¯ç‰‡å°è£…å±‚å·²é…ç½®ä¿ç•™å¼•è„šã€Flash/PSRAMå¤§å°
- âœ… æ¿çº§å±‚å·²å¯ç”¨åŸºç¡€å¤–è®¾ï¼ˆUARTã€GPIOæ§åˆ¶å™¨ç­‰ï¼‰

**å¼€å‘è€…åªéœ€è¦ï¼š**
- ğŸ“ åœ¨ **Overlay æ–‡ä»¶**ä¸­æ·»åŠ åº”ç”¨ç‰¹å®šçš„è®¾å¤‡ï¼ˆLEDã€ä¼ æ„Ÿå™¨ç­‰ï¼‰
- ğŸ”§ è¦†ç›–æŸäº›ç¡¬ä»¶é…ç½®ï¼ˆå¼•è„šå·ã€æ³¢ç‰¹ç‡ç­‰ï¼‰

**âš ï¸ ä¸€èˆ¬ä¸æ¨èç›´æ¥ä¿®æ”¹ Zephyr æºç çš„ DTS æ–‡ä»¶ï¼**

---

### 7.2 Overlay æ–‡ä»¶ç¤ºä¾‹åŠä¸‰å±‚è§„èŒƒè§£æ

**æ–‡ä»¶è·¯å¾„ï¼š** `blinky/boards/esp32_devkitc_esp32_procpu.overlay`

#### å®Œæ•´ä»£ç ï¼ˆå¸¦è§„èŒƒæ¥æºæ ‡æ³¨ï¼‰

```dts
/ {                             // â† â‘  DTSè¯­æ³•ï¼šæ ¹èŠ‚ç‚¹
    aliases {                   // â† â‘  DTSè¯­æ³•ï¼šèŠ‚ç‚¹å
        led0 = &myled0;         // â† â‘  DTSè¯­æ³•ï¼šå±æ€§èµ‹å€¼
                                //   â‘  DTSè¯­æ³•ï¼š&myled0 æ˜¯æ ‡ç­¾å¼•ç”¨
    };

    leds {                      // â† â‘  DTSè¯­æ³•ï¼šèŠ‚ç‚¹å
        compatible = "gpio-leds";  // â† â‘¡ YAMLè§„èŒƒï¼šå¿…é¡»æ˜¯è¿™ä¸ªå€¼
                                   //   â‘  DTSè¯­æ³•ï¼šå±æ€§èµ‹å€¼è¯­æ³•

        myled0: led_0 {         // â† â‘  DTSè¯­æ³•ï¼šmyled0 æ˜¯æ ‡ç­¾å®šä¹‰
                                //   â‘  DTSè¯­æ³•ï¼šled_0 æ˜¯èŠ‚ç‚¹å
            gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;
            // â†‘ æ‹†è§£è¿™ä¸€è¡Œï¼š
            // â€¢ gpios           â† â‘¡ YAMLè§„èŒƒï¼šgpio-leds.yamlè¦æ±‚çš„å¿…éœ€å±æ€§
            // â€¢ =               â† â‘  DTSè¯­æ³•ï¼šèµ‹å€¼è¿ç®—ç¬¦
            // â€¢ <...>           â† â‘  DTSè¯­æ³•ï¼šæ•°ç»„è¯­æ³•
            // â€¢ &gpio0          â† â‘  DTSè¯­æ³•ï¼šphandleå¼•ç”¨ï¼ˆå¼•ç”¨gpio0æ ‡ç­¾ï¼‰
            // â€¢ 2               â† â‘¡ YAMLè§„èŒƒï¼šç¬¬1ä¸ªcell = å¼•è„šå·
            // â€¢ GPIO_ACTIVE_HIGHâ† â‘¢ Cå®ï¼šç¬¬2ä¸ªcell = æ ‡å¿—ä½
            //                      å®šä¹‰åœ¨ dt-bindings/gpio/gpio.h

            label = "User LED"; // â† â‘¡ YAMLè§„èŒƒï¼šled-node.yamlçš„å¯é€‰å±æ€§
                                //   â‘  DTSè¯­æ³•ï¼šå±æ€§èµ‹å€¼è¯­æ³•
        };
    };
};
```

---

### 7.3 é€å±‚è§„èŒƒéªŒè¯è¡¨

| ä»£ç éƒ¨åˆ† | è§„èŒƒå±‚æ¬¡ | è§„èŒƒæ¥æº | éªŒè¯å†…å®¹ |
|---------|---------|---------|---------|
| **`/`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬2.2èŠ‚ | æ ¹èŠ‚ç‚¹çš„è¯­æ³• |
| **`{ }`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬6.1èŠ‚ | èŠ‚ç‚¹å†…å®¹çš„èŠ±æ‹¬å·è¯­æ³• |
| **`aliases`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬3.3èŠ‚ | èŠ‚ç‚¹åï¼ˆskeleton.dtsiå®šä¹‰ï¼‰ |
| **`leds`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬2.2.1èŠ‚ | èŠ‚ç‚¹åï¼ˆå¼€å‘è€…è‡ªå®šä¹‰ï¼‰ |
| **`myled0:`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬6.3èŠ‚ | æ ‡ç­¾å®šä¹‰è¯­æ³• |
| **`&myled0`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬6.3èŠ‚ | æ ‡ç­¾å¼•ç”¨è¯­æ³• |
| **`&gpio0`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬2.4èŠ‚ | phandleå¼•ç”¨è¯­æ³• |
| **`<...>`** | â‘  DTSè¯­æ³• | Devicetree Spec ç¬¬2.3.3èŠ‚ | æ•°ç»„å€¼è¯­æ³• |
| **`compatible = "gpio-leds"`** | â‘¡ YAMLè§„èŒƒ | gpio-leds.yaml ç¬¬27è¡Œ | å¿…é¡»æ˜¯å›ºå®šå€¼ "gpio-leds" |
| **`gpios`** | â‘¡ YAMLè§„èŒƒ | gpio-leds.yaml ç¬¬38-40è¡Œ | å­èŠ‚ç‚¹çš„å¿…éœ€å±æ€§ |
| **`label`** | â‘¡ YAMLè§„èŒƒ | led-node.yamlï¼ˆåŒ…å«çš„ï¼‰ | å¯é€‰å±æ€§ï¼Œå­—ç¬¦ä¸²ç±»å‹ |
| **å¼•è„šå· `2`** | â‘¡ YAMLè§„èŒƒ | espressif,esp32-gpio.yaml | ç¬¬1ä¸ªcell = pin |
| **æ ‡å¿—ä½éƒ¨åˆ†** | â‘¡ YAMLè§„èŒƒ | espressif,esp32-gpio.yaml | ç¬¬2ä¸ªcell = flags |
| **`GPIO_ACTIVE_HIGH`** | â‘¢ Cå® | dt-bindings/gpio/gpio.h ç¬¬26è¡Œ | `#define GPIO_ACTIVE_HIGH (0 << 0)` |

---

### 7.4 åˆ†å±‚ç†è§£ï¼šè°è§„å®šäº†ä»€ä¹ˆï¼Ÿ

#### â‘  DTSè¯­æ³•è§„èŒƒï¼ˆDevicetree Specificationï¼‰

**è§„å®šçš„å†…å®¹ï¼š**

- âœ… å¦‚ä½•å†™èŠ‚ç‚¹ï¼š`node_name { ... }`
- âœ… å¦‚ä½•å®šä¹‰æ ‡ç­¾ï¼š`label: node_name`
- âœ… å¦‚ä½•å¼•ç”¨æ ‡ç­¾ï¼š`&label`
- âœ… å¦‚ä½•å†™å±æ€§ï¼š`property = value;`
- âœ… å¦‚ä½•å†™æ•°ç»„ï¼š`<1 2 3>`
- âœ… å¦‚ä½•å†™å­—ç¬¦ä¸²ï¼š`"string"`

**ä¸è§„å®šçš„å†…å®¹ï¼š**

- âŒ èŠ‚ç‚¹åº”è¯¥æœ‰ä»€ä¹ˆå±æ€§ï¼ˆè¿™æ˜¯YAMLçš„äº‹ï¼‰
- âŒ å±æ€§åº”è¯¥æ˜¯ä»€ä¹ˆå€¼ï¼ˆè¿™æ˜¯YAMLçš„äº‹ï¼‰
- âŒ compatible åº”è¯¥å«ä»€ä¹ˆï¼ˆè¿™æ˜¯YAMLçš„äº‹ï¼‰

**ç±»æ¯”ï¼š** å°±åƒCè¯­è¨€è§„èŒƒå®šä¹‰äº†å¦‚ä½•å†™ `int a = 1;`ï¼Œä½†ä¸å®šä¹‰ `a` åº”è¯¥èµ‹ä»€ä¹ˆå€¼ã€‚

---

#### â‘¡ YAML Bindingè§„èŒƒï¼ˆè®¾å¤‡å±æ€§è§„èŒƒï¼‰

**è§„å®šçš„å†…å®¹ï¼š**
- âœ… `compatible = "gpio-leds"` å¿…é¡»æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²
- âœ… å­èŠ‚ç‚¹å¿…é¡»æœ‰ `gpios` å±æ€§
- âœ… `gpios` æ˜¯ phandle-array ç±»å‹
- âœ… `label` æ˜¯å¯é€‰çš„å­—ç¬¦ä¸²å±æ€§

**ä¸è§„å®šçš„å†…å®¹ï¼š**
- âŒ ä½ ç”¨ `&gpio0` è¿˜æ˜¯è·¯å¾„å¼•ç”¨ï¼ˆè¿™æ˜¯DTSè¯­æ³•çš„äº‹ï¼‰
- âŒ ä½ æ˜¯å¦å®šä¹‰æ ‡ç­¾ `myled0:`ï¼ˆè¿™æ˜¯DTSè¯­æ³•çš„äº‹ï¼‰
- âŒ GPIO_ACTIVE_HIGHçš„å…·ä½“å€¼ï¼ˆè¿™æ˜¯Cå¤´æ–‡ä»¶çš„äº‹ï¼‰

**YAMLè§„èŒƒçš„æŸ¥æ‰¾è·¯å¾„ï¼š**

```
compatible = "gpio-leds"
    â†“ æŸ¥æ‰¾å¯¹åº”çš„ binding
zephyr/dts/bindings/led/gpio-leds.yaml
    â†“ æŸ¥çœ‹ child-binding
å­èŠ‚ç‚¹å¿…é¡»æœ‰ gpios å±æ€§ï¼ˆrequired: trueï¼‰
    â†“ åŒ…å« led-node.yaml
å¯ä»¥æœ‰ label å±æ€§ï¼ˆå¯é€‰ï¼‰
```

**éªŒè¯å‘½ä»¤ï¼š**
```bash
cat zephyr/dts/bindings/led/gpio-leds.yaml
```

è¾“å‡ºï¼š
```yaml
compatible: "gpio-leds"

child-binding:
  properties:
    gpios:
      type: phandle-array
      required: true      # â† å¿…é¡»æœ‰è¿™ä¸ªå±æ€§ï¼
```

---

#### â‘¢ Cå¤´æ–‡ä»¶å®å®šä¹‰ï¼ˆå¸¸é‡å€¼ï¼‰

**å®šä¹‰çš„å†…å®¹ï¼š**
- âœ… `GPIO_ACTIVE_HIGH` = `(0 << 0)` = `0`
- âœ… `GPIO_ACTIVE_LOW` = `(1 << 0)` = `1`
- âœ… `GPIO_PULL_UP` = `(1 << 4)` = `16`

**é¢„å¤„ç†è¿‡ç¨‹ï¼š**

```dts
// ç¼–è¯‘å‰ï¼ˆæºç ï¼‰
gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;

// é¢„å¤„ç†åï¼ˆå±•å¼€å®ï¼‰
gpios = <&gpio0 2 0>;
```

**æŸ¥æ‰¾å®šä¹‰ï¼š**
```bash
cat zephyr/include/zephyr/dt-bindings/gpio/gpio.h
```

è¾“å‡ºï¼š
```c
#define GPIO_ACTIVE_HIGH  (0 << 0)
#define GPIO_ACTIVE_LOW   (1 << 0)
```

---

### 7.5 å®Œæ•´çš„éªŒè¯æµç¨‹

ä»¥ `gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;` ä¸ºä¾‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1æ­¥ï¼šCé¢„å¤„ç†å™¨ï¼ˆå®æ›¿æ¢ï¼‰                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;                        â”‚
â”‚                        â†“ å®æ›¿æ¢                             â”‚
â”‚ gpios = <&gpio0 2 0>;                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2æ­¥ï¼šDTSè¯­æ³•è§£æ                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ gpios = ... ;     â† åˆæ³•çš„å±æ€§èµ‹å€¼è¯­æ³•                    â”‚
â”‚ âœ“ <...>             â† åˆæ³•çš„æ•°ç»„è¯­æ³•                        â”‚
â”‚ âœ“ &gpio0            â† åˆæ³•çš„phandleå¼•ç”¨                     â”‚
â”‚ âœ“ æ£€æŸ¥ gpio0 æ ‡ç­¾æ˜¯å¦å®šä¹‰ï¼ˆåœ¨ esp32_common.dtsi ä¸­ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3æ­¥ï¼šYAML BindingéªŒè¯                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘  çˆ¶èŠ‚ç‚¹ compatible = "gpio-leds"                           â”‚
â”‚    â†’ æŸ¥æ‰¾ gpio-leds.yaml                                    â”‚
â”‚                                                             â”‚
â”‚ â‘¡ æ£€æŸ¥å­èŠ‚ç‚¹æ˜¯å¦æœ‰å¿…éœ€å±æ€§ gpios                            â”‚
â”‚    â†’ gpio-leds.yaml: gpios required: true âœ“                 â”‚
â”‚                                                             â”‚
â”‚ â‘¢ æ£€æŸ¥ gpios çš„æ ¼å¼                                         â”‚
â”‚    â†’ type: phandle-array âœ“                                  â”‚
â”‚                                                             â”‚
â”‚ â‘£ æ£€æŸ¥å¼•ç”¨çš„ gpio0 èŠ‚ç‚¹                                     â”‚
â”‚    â†’ compatible = "espressif,esp32-gpio"                    â”‚
â”‚    â†’ æŸ¥æ‰¾ espressif,esp32-gpio.yaml                         â”‚
â”‚    â†’ #gpio-cells = 2ï¼ˆéœ€è¦2ä¸ªå‚æ•°ï¼‰âœ“                        â”‚
â”‚    â†’ å‚æ•°1 = pin (å¼•è„šå· 2) âœ“                               â”‚
â”‚    â†’ å‚æ•°2 = flags (æ ‡å¿—ä½ 0) âœ“                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.6 å¸¸è§æ··æ·†ç‚¹æ¾„æ¸…

#### â“ é—®é¢˜1ï¼š`myled0:` æ˜¯DTSè¯­æ³•è¿˜æ˜¯YAMLè§„èŒƒï¼Ÿ

**ç­”æ¡ˆï¼š** â‘  **DTSè¯­æ³•**

- `myled0:` æ˜¯æ ‡ç­¾å®šä¹‰ï¼Œç”± Devicetree Specification è§„èŒƒ
- YAML Binding **ä¸å…³å¿ƒ**ä½ æ˜¯å¦å®šä¹‰æ ‡ç­¾
- ä½ å¯ä»¥å†™æˆï¼š
  ```dts
  led_0 {  // ä¸å®šä¹‰æ ‡ç­¾ä¹Ÿå¯ä»¥ï¼ˆåªæ˜¯ä»£ç é‡Œæ— æ³•é€šè¿‡ DT_ALIAS å¼•ç”¨ï¼‰
      gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;
  };
  ```

#### â“ é—®é¢˜2ï¼š`&gpio0` æ˜¯DTSè¯­æ³•è¿˜æ˜¯YAMLè§„èŒƒï¼Ÿ

**ç­”æ¡ˆï¼š** â‘  **DTSè¯­æ³•**

- `&label` å¼•ç”¨è¯­æ³•ç”± Devicetree Specification è§„èŒƒ
- YAML Binding åªå…³å¿ƒ"è¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ª GPIO æ§åˆ¶å™¨çš„ phandle"
- ä½ ä¹Ÿå¯ä»¥ç”¨è·¯å¾„å¼•ç”¨ï¼š
  ```dts
  gpios = </soc/gpio/gpio@3ff44000 2 GPIO_ACTIVE_HIGH>;  // ä¸å¸¸ç”¨
  ```

#### â“ é—®é¢˜3ï¼š`compatible = "gpio-leds"` ä¸­ï¼Œå“ªéƒ¨åˆ†æ˜¯å“ªä¸ªè§„èŒƒï¼Ÿ

**ç­”æ¡ˆï¼š** æ··åˆ

| éƒ¨åˆ† | è§„èŒƒ | è¯´æ˜ |
|------|------|------|
| `compatible` | â‘  DTSè¯­æ³• | å±æ€§åï¼ˆDevicetree Specå®šä¹‰äº†è¿™ä¸ªæ ‡å‡†å±æ€§ï¼‰ |
| `=` | â‘  DTSè¯­æ³• | èµ‹å€¼è¿ç®—ç¬¦ |
| `"gpio-leds"` | â‘¡ YAMLè§„èŒƒ | å¿…é¡»æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼ˆgpio-leds.yamlè§„å®šï¼‰ |
| `;` | â‘  DTSè¯­æ³• | è¯­å¥ç»“æŸç¬¦ |

#### â“ é—®é¢˜4ï¼š`gpios` å±æ€§åæ˜¯è°è§„å®šçš„ï¼Ÿ

**ç­”æ¡ˆï¼š** â‘¡ **YAML Bindingè§„èŒƒ**

- `gpio-leds.yaml` çš„ `child-binding` ä¸­å®šä¹‰äº†å­èŠ‚ç‚¹å¿…é¡»æœ‰ `gpios` å±æ€§
- å¦‚æœä½ å†™æˆ `gpio`ï¼ˆå•æ•°ï¼‰ï¼Œç¼–è¯‘ä¼šæŠ¥é”™ï¼š
  ```
  Error: 'gpio' property is missing (required by gpio-leds.yaml)
  ```

#### â“ é—®é¢˜5ï¼šå¼•è„šå· `2` æ˜¯è°è§„å®šçš„ï¼Ÿ

**ç­”æ¡ˆï¼š** â‘¡ **YAML Bindingè§„èŒƒ** + ğŸ‘¤ **å¼€å‘è€…é€‰æ‹©**

- `espressif,esp32-gpio.yaml` è§„å®šç¬¬1ä¸ªcellæ˜¯å¼•è„šå·
- å…·ä½“ç”¨å“ªä¸ªå¼•è„šå·ï¼ˆ2ã€5ã€18ç­‰ï¼‰ç”±å¼€å‘è€…æ ¹æ®ç¡¬ä»¶è¿æ¥å†³å®š
- ä½†å¿…é¡»é¿å¼€ `gpio-reserved-ranges` ä¸­çš„ä¿ç•™å¼•è„š

---

### 7.7 ç¼–å†™Overlayçš„æ­£ç¡®æ€è·¯

#### Step 1ï¸âƒ£ï¼šç¡®å®šè¦æ·»åŠ çš„è®¾å¤‡ç±»å‹

ä¾‹å¦‚ï¼šè¦æ·»åŠ GPIOæ§åˆ¶çš„LED

#### Step 2ï¸âƒ£ï¼šæŸ¥æ‰¾å¯¹åº”çš„YAML Binding

```bash
find zephyr/dts/bindings -name "*led*"
# æ‰¾åˆ°ï¼šzephyr/dts/bindings/led/gpio-leds.yaml
```

#### Step 3ï¸âƒ£ï¼šæŸ¥çœ‹YAMLè§„èŒƒè¦æ±‚

```yaml
# gpio-leds.yaml
compatible: "gpio-leds"   # â† å¿…é¡»ç”¨è¿™ä¸ªå€¼

child-binding:
  properties:
    gpios:
      type: phandle-array
      required: true      # â† å¿…é¡»æœ‰è¿™ä¸ªå±æ€§
```

#### Step 4ï¸âƒ£ï¼šç”¨DTSè¯­æ³•å†™å‡ºç¬¦åˆè§„èŒƒçš„ä»£ç 

```dts
leds {
    compatible = "gpio-leds";  // â† æ»¡è¶³YAMLè§„èŒƒ

    myled: led_0 {
        gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;  // â† æ»¡è¶³YAMLè§„èŒƒ
        // ä½¿ç”¨ DTSè¯­æ³•ï¼š&gpio0å¼•ç”¨ + Cå®ï¼šGPIO_ACTIVE_HIGH
    };
};
```

#### Step 5ï¸âƒ£ï¼šæ·»åŠ aliasä¾›ä»£ç è®¿é—®

```dts
aliases {
    led0 = &myled;  // â† DTSè¯­æ³•ï¼šæ ‡ç­¾å¼•ç”¨
};
```

### 7.8 å½“æ‰¾ä¸åˆ°å¯¹åº”çš„YAML Bindingæ—¶æ€ä¹ˆåŠï¼Ÿ

#### 7.8.1 compatibleçš„åŒ¹é…æœºåˆ¶

**æ ¸å¿ƒé—®é¢˜ï¼š** å½“ä½ åœ¨Overlayä¸­å®šä¹‰æ–°ç¡¬ä»¶æ—¶ï¼ŒZephyrå¦‚ä½•çŸ¥é“è¯¥ç”¨å“ªä¸ªYAMLè§„èŒƒéªŒè¯ï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡ `compatible` å±æ€§çš„å€¼ï¼

```
ä½ å†™çš„DTSä»£ç                    Zephyræ„å»ºç³»ç»Ÿçš„æŸ¥æ‰¾è¿‡ç¨‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
leds {                        â‘  è¯»å– compatible = "gpio-leds"
    compatible = "gpio-leds"; â‘¡ åœ¨ zephyr/dts/bindings/ ä¸­æœç´¢
    ...                       â‘¢ æ‰¾åˆ° led/gpio-leds.yaml
}                             â‘£ ç”¨è¿™ä¸ªYAMLè§„èŒƒéªŒè¯èŠ‚ç‚¹å±æ€§
                              â‘¤ éªŒè¯é€šè¿‡ â†’ ç¼–è¯‘æˆåŠŸ
                                 éªŒè¯å¤±è´¥ â†’ æŠ¥é”™
```

**åŒ¹é…è§„åˆ™ï¼š**

```
DTSä¸­çš„ compatible å€¼     â†’  æŸ¥æ‰¾çš„YAMLæ–‡ä»¶å
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"gpio-leds"               â†’  */gpio-leds.yaml
"pwm-leds"                â†’  */pwm-leds.yaml
"espressif,esp32-gpio"    â†’  */espressif,esp32-gpio.yaml
"power-switch"            â†’  */power-switch.yaml
```

**éªŒè¯å‘½ä»¤ï¼š**
```bash
# æŸ¥æ‰¾æŸä¸ª compatible å¯¹åº”çš„ YAML æ–‡ä»¶
find zephyr/dts/bindings -name "gpio-leds.yaml"
# è¾“å‡ºï¼šzephyr/dts/bindings/led/gpio-leds.yaml

find zephyr/dts/bindings -name "*esp32-gpio*"
# è¾“å‡ºï¼šzephyr/dts/bindings/gpio/espressif,esp32-gpio.yaml
```

---

#### 7.8.2 å››ç§è§£å†³æ–¹æ¡ˆ

**åœºæ™¯ï¼š** ä½ æƒ³åœ¨Overlayä¸­å®šä¹‰ä¸€ä¸ªæ–°ç¡¬ä»¶ï¼ˆå¦‚èˆµæœºã€ç»§ç”µå™¨ã€è‡ªå®šä¹‰ä¼ æ„Ÿå™¨ï¼‰ï¼Œä½†ä¸çŸ¥é“ `compatible` è¯¥å†™ä»€ä¹ˆã€‚

##### è§£å†³æ–¹æ¡ˆ1ï¸âƒ£ï¼šä½¿ç”¨é€šç”¨çš„Bindingï¼ˆæ¨èï¼‰

Zephyræä¾›äº†å¾ˆå¤š**é€šç”¨çš„binding**ï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç®€å•è®¾å¤‡ã€‚

**å¸¸è§é€šç”¨Bindingåˆ—è¡¨ï¼š**

| è®¾å¤‡ç±»å‹ | compatibleå€¼ | YAMLæ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|---------|-------------|-------------|------|
| **GPIOæ§åˆ¶çš„LED** | `"gpio-leds"` | led/gpio-leds.yaml | æœ€å¸¸ç”¨ |
| **PWMæ§åˆ¶çš„LED** | `"pwm-leds"` | led/pwm-leds.yaml | å¯è°ƒäº®åº¦LED |
| **GPIOæŒ‰é”®** | `"gpio-keys"` | input/gpio-keys.yaml | æŒ‰é”®ã€å¼€å…³ |
| **GPIOèœ‚é¸£å™¨** | `"gpio-leds"` | led/gpio-leds.yaml | å¤ç”¨LEDçš„binding |
| **ç»§ç”µå™¨** | `"gpio-leds"` | led/gpio-leds.yaml | å¤ç”¨LEDçš„binding |
| **PWMèˆµæœº** | `"pwm-servo"` âš ï¸ | éœ€è‡ªå®šä¹‰ | è§æ–¹æ¡ˆ3 |
| **å›ºå®šç”µå‹è°ƒèŠ‚å™¨** | `"regulator-fixed"` | regulator/... | ç”µæºç®¡ç† |

**ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªç»§ç”µå™¨ï¼ˆè™½ç„¶ä¸æ˜¯LEDï¼Œä½†å¯ä»¥å¤ç”¨gpio-ledsçš„bindingï¼‰**

```dts
/ {
    relays {
        compatible = "gpio-leds";  // â† å¤ç”¨gpio-ledsçš„binding

        relay0: relay_0 {
            gpios = <&gpio0 5 GPIO_ACTIVE_HIGH>;
            label = "Relay Channel 0";
        };
    };
};
```

**ä¸ºä»€ä¹ˆå¯ä»¥å¤ç”¨ï¼Ÿ**
- `gpio-leds.yaml` åªè¦æ±‚å­èŠ‚ç‚¹æœ‰ `gpios` å±æ€§
- ç»§ç”µå™¨å’ŒLEDçš„æ§åˆ¶é€»è¾‘ç›¸åŒï¼šGPIOé«˜/ä½ç”µå¹³æ§åˆ¶å¼€/å…³
- Cä»£ç ä¸­å¯ä»¥é€šè¿‡ `device_get_binding()` è®¿é—®ï¼Œä¸å…³å¿ƒèŠ‚ç‚¹å

---

##### è§£å†³æ–¹æ¡ˆ2ï¸âƒ£ï¼šæŸ¥æ‰¾ç°æœ‰çš„ç±»ä¼¼Binding

Zephyrå·²ç»æœ‰**3000+ä¸ªbindingæ–‡ä»¶**ï¼Œå¾ˆå¯èƒ½æœ‰ç±»ä¼¼çš„è®¾å¤‡ã€‚

**æŸ¥æ‰¾æ–¹æ³•ï¼š**

```bash
# æŒ‰è®¾å¤‡ç±»å‹æŸ¥æ‰¾
ls zephyr/dts/bindings/led/      # LEDç›¸å…³
ls zephyr/dts/bindings/sensor/   # ä¼ æ„Ÿå™¨ç›¸å…³
ls zephyr/dts/bindings/gpio/     # GPIOç›¸å…³
ls zephyr/dts/bindings/pwm/      # PWMç›¸å…³

# æŒ‰å…³é”®è¯æœç´¢
find zephyr/dts/bindings -name "*motor*"
find zephyr/dts/bindings -name "*servo*"
find zephyr/dts/bindings -name "*relay*"

# æŸ¥çœ‹æŸä¸ªbindingçš„å†…å®¹
cat zephyr/dts/bindings/led/pwm-leds.yaml
```

**ç¤ºä¾‹ï¼šä½ æƒ³å®šä¹‰ä¸€ä¸ªPWMé£æ‰‡**

```bash
# æŸ¥æ‰¾PWMç›¸å…³çš„binding
find zephyr/dts/bindings -name "*pwm*" | grep -v "pwm-controller"
# å¯èƒ½æ‰¾åˆ°ï¼špwm-leds.yaml

# æŸ¥çœ‹å®ƒçš„è¦æ±‚
cat zephyr/dts/bindings/led/pwm-leds.yaml
# å‘ç°å­èŠ‚ç‚¹éœ€è¦ pwms å±æ€§ï¼Œæ­£å¥½é€‚ç”¨äºé£æ‰‡ï¼
```

```dts
/ {
    fans {
        compatible = "pwm-leds";  // â† å¤ç”¨pwm-leds

        fan0: fan_0 {
            pwms = <&ledc0 0 PWM_HZ(25000) PWM_POLARITY_NORMAL>;
            label = "Cooling Fan";
        };
    };
};
```

---

##### è§£å†³æ–¹æ¡ˆ3ï¸âƒ£ï¼šåˆ›å»ºè‡ªå®šä¹‰Bindingï¼ˆé€‚ç”¨äºç‰¹æ®Šè®¾å¤‡ï¼‰

å¦‚æœä½ çš„è®¾å¤‡ç¡®å®ç‰¹æ®Šï¼Œéœ€è¦ä¸“æœ‰å±æ€§ï¼Œå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰bindingã€‚

**æ­¥éª¤ï¼š**

**â‘  åœ¨åº”ç”¨ç›®å½•ä¸‹åˆ›å»ºbindingæ–‡ä»¶**

```
ä½ çš„åº”ç”¨ç›®å½•/
â”œâ”€â”€ src/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ prj.conf
â”œâ”€â”€ boards/
â”‚   â””â”€â”€ esp32_devkitc_esp32_procpu.overlay
â””â”€â”€ dts/                    â† æ–°å»ºè¿™ä¸ªç›®å½•
    â””â”€â”€ bindings/           â† æ–°å»ºè¿™ä¸ªç›®å½•
        â””â”€â”€ my-device.yaml  â† è‡ªå®šä¹‰bindingæ–‡ä»¶
```

**â‘¡ ç¼–å†™YAMLæ–‡ä»¶**

**ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ä¼ æ„Ÿå™¨**

**æ–‡ä»¶ï¼š** `dts/bindings/my-custom-sensor.yaml`

```yaml
# æè¿°
description: My custom I2C sensor

# compatibleå€¼ï¼ˆå¿…é¡»å”¯ä¸€ï¼‰
compatible: "vendor,my-sensor"

# åŒ…å«åŸºç¡€å±æ€§
include: [i2c-device.yaml]

# è®¾å¤‡ç‰¹æœ‰å±æ€§
properties:
  # I2Cåœ°å€ï¼ˆç»§æ‰¿è‡ªi2c-device.yamlï¼Œè¿™é‡Œå¯è¦†ç›–ï¼‰
  reg:
    required: true
    description: I2C address of the sensor

  # è‡ªå®šä¹‰å±æ€§ï¼šé‡‡æ ·ç‡
  sample-rate:
    type: int
    default: 100
    description: Sampling rate in Hz

  # è‡ªå®šä¹‰å±æ€§ï¼šé‡ç¨‹
  range:
    type: int
    enum: [2, 4, 8, 16]
    default: 2
    description: Measurement range in g (for accelerometer)

  # å¯é€‰çš„ä¸­æ–­å¼•è„š
  int-gpios:
    type: phandle-array
    description: Interrupt GPIO pin
```

**â‘¢ åœ¨Overlayä¸­ä½¿ç”¨**

**æ–‡ä»¶ï¼š** `boards/esp32_devkitc_esp32_procpu.overlay`

```dts
&i2c0 {
    status = "okay";

    my_sensor: sensor@48 {
        compatible = "vendor,my-sensor";  // â† åŒ¹é…è‡ªå®šä¹‰binding
        reg = <0x48>;                     // â† å¿…éœ€å±æ€§
        sample-rate = <200>;              // â† è‡ªå®šä¹‰å±æ€§
        range = <4>;                      // â† è‡ªå®šä¹‰å±æ€§
        int-gpios = <&gpio0 15 GPIO_ACTIVE_HIGH>;  // â† å¯é€‰å±æ€§
    };
};
```

**â‘£ Zephyrä¼šè‡ªåŠ¨å‘ç°è‡ªå®šä¹‰binding**

Zephyræ„å»ºç³»ç»Ÿä¼š**è‡ªåŠ¨æœç´¢**ä»¥ä¸‹ä½ç½®çš„bindingæ–‡ä»¶ï¼š
- `zephyr/dts/bindings/` ï¼ˆZephyrå†…ç½®ï¼‰
- `<ä½ çš„åº”ç”¨>/dts/bindings/` ï¼ˆåº”ç”¨è‡ªå®šä¹‰ï¼‰
- `<module>/dts/bindings/` ï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

**âš ï¸ æ³¨æ„ï¼š**
- `compatible` å€¼å»ºè®®åŠ å‚å•†å‰ç¼€ï¼ˆå¦‚ `"vendor,device"`ï¼‰ï¼Œé¿å…ä¸Zephyrå†…ç½®çš„å†²çª
- è‡ªå®šä¹‰bindingåªå½±å“ç¼–è¯‘æ—¶éªŒè¯ï¼Œ**ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆé©±åŠ¨ä»£ç **
- ä½ ä»éœ€è¦åœ¨Cä»£ç ä¸­ç¼–å†™é©±åŠ¨

---

##### è§£å†³æ–¹æ¡ˆ4ï¸âƒ£ï¼šç®€å•é…ç½®å®¹å™¨ï¼ˆæ— éœ€é©±åŠ¨ï¼‰

æœ‰äº›èŠ‚ç‚¹åªæ˜¯ç”¨æ¥**å­˜å‚¨é…ç½®ä¿¡æ¯**ï¼Œä¸éœ€è¦é©±åŠ¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„compatibleã€‚

**ç¤ºä¾‹ï¼šå­˜å‚¨åº”ç”¨é…ç½®**

```dts
/ {
    app_config {
        compatible = "app,config";  // â† éšæ„å‘½åï¼Œåªè¦å”¯ä¸€å³å¯

        wifi_ssid = "MyNetwork";
        wifi_password = "password123";
        server_port = <8080>;
    };
};
```

**å¯¹åº”çš„ç®€å•YAMLï¼š**

**æ–‡ä»¶ï¼š** `dts/bindings/app,config.yaml`

```yaml
description: Application configuration container

compatible: "app,config"

properties:
  wifi_ssid:
    type: string
    description: WiFi SSID

  wifi_password:
    type: string
    description: WiFi password

  server_port:
    type: int
    default: 80
    description: Server port number
```

---

#### 7.8.3 å®æˆ˜ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªPWMèˆµæœº

Zephyr **æ²¡æœ‰å†…ç½®çš„èˆµæœºbinding**ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªã€‚

**â‘  åˆ›å»ºbindingæ–‡ä»¶**

**æ–‡ä»¶ï¼š** `my_app/dts/bindings/pwm-servo.yaml`

```yaml
# Copyright (c) 2024 Your Name
# SPDX-License-Identifier: Apache-2.0

description: PWM-driven servo motor

compatible: "pwm-servo"

include: base.yaml

properties:
  pwms:
    required: true
    type: phandle-array
    description: PWM specifier driving the servo motor

  min-pulse:
    required: true
    type: int
    description: Minimum pulse width (nanoseconds) for 0 degrees

  max-pulse:
    required: true
    type: int
    description: Maximum pulse width (nanoseconds) for 180 degrees
```

**â‘¡ åœ¨Overlayä¸­ä½¿ç”¨**

**æ–‡ä»¶ï¼š** `boards/esp32_devkitc_esp32_procpu.overlay`

```dts
/ {
    aliases {
        servo0 = &myservo;
    };

    servos {
        compatible = "pwm-leds";  // â† ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªé€šç”¨çš„
        // æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰çš„ï¼š
        // compatible = "pwm-servo";

        myservo: servo_0 {
            pwms = <&ledc0 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
            min-pulse = <1000000>;  // 1ms (0Â°)
            max-pulse = <2000000>;  // 2ms (180Â°)
            label = "Servo Motor";
        };
    };
};
```

**â‘¢ åœ¨Cä»£ç ä¸­è®¿é—®**

```c
#include <zephyr/devicetree.h>

#define SERVO_NODE DT_ALIAS(servo0)

#if DT_NODE_EXISTS(SERVO_NODE)
    uint32_t min_pulse = DT_PROP(SERVO_NODE, min_pulse);
    uint32_t max_pulse = DT_PROP(SERVO_NODE, max_pulse);

    printk("Servo min pulse: %u ns\n", min_pulse);
    printk("Servo max pulse: %u ns\n", max_pulse);
#else
    #error "Servo node not found in devicetree"
#endif
```

---

#### 7.8.4 æŸ¥æ‰¾Bindingçš„å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1æ­¥ï¼šæ˜ç¡®ä½ çš„è®¾å¤‡ç±»å‹                                      â”‚
â”‚ ä¾‹å¦‚ï¼šGPIO LED / PWMé£æ‰‡ / I2Cä¼ æ„Ÿå™¨ / èˆµæœº                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2æ­¥ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰ç°æˆçš„é€šç”¨Binding                            â”‚
â”‚ $ ls zephyr/dts/bindings/led/                               â”‚
â”‚ $ ls zephyr/dts/bindings/sensor/                            â”‚
â”‚ $ find zephyr/dts/bindings -name "*å…³é”®è¯*"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                   æ‰¾åˆ°äº†ï¼Ÿ
                    /    \
                  æ˜¯      å¦
                  â†“       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3æ­¥ï¼šä½¿ç”¨ç°æˆçš„    â”‚ â”‚ ç¬¬4æ­¥ï¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥å¤ç”¨          â”‚
â”‚ compatible = "xxx"   â”‚ â”‚ â€¢ LEDçš„bindingå¯ç”¨äºç»§ç”µå™¨        â”‚
â”‚                      â”‚ â”‚ â€¢ PWM-LEDçš„bindingå¯ç”¨äºé£æ‰‡     â”‚
â”‚ ä¾‹å¦‚ï¼š               â”‚ â”‚ â€¢ GPIO-keyså¯ç”¨äºå¼€å…³            â”‚
â”‚ "gpio-leds"          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ "pwm-leds"           â”‚          â†“
â”‚ "gpio-keys"          â”‚    å¯ä»¥å¤ç”¨ï¼Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      /    \
                            æ˜¯      å¦
                            â†“       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ä½¿ç”¨é€šç”¨binding  â”‚ â”‚ ç¬¬5æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰bindingâ”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚
                                   â”‚ â‘  æ–°å»º dts/bindings/   â”‚
                                   â”‚ â‘¡ ç¼–å†™ my-device.yaml  â”‚
                                   â”‚ â‘¢ åœ¨Overlayä¸­ä½¿ç”¨      â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 7.8.5 å¸¸è§è®¾å¤‡çš„Compatibleé€ŸæŸ¥è¡¨

| è®¾å¤‡ | æ¨ècompatible | æ–‡ä»¶è·¯å¾„ | å¤‡æ³¨ |
|------|---------------|---------|------|
| **GPIO LED** | `"gpio-leds"` | led/gpio-leds.yaml | æœ€å¸¸ç”¨ |
| **ç»§ç”µå™¨** | `"gpio-leds"` | led/gpio-leds.yaml | å¤ç”¨LED binding |
| **GPIOèœ‚é¸£å™¨** | `"gpio-leds"` | led/gpio-leds.yaml | å¤ç”¨LED binding |
| **PWM LED** | `"pwm-leds"` | led/pwm-leds.yaml | å¯è°ƒäº®åº¦ |
| **PWMé£æ‰‡** | `"pwm-leds"` | led/pwm-leds.yaml | å¤ç”¨PWM-LED |
| **æŒ‰é”®å¼€å…³** | `"gpio-keys"` | input/gpio-keys.yaml | æ ‡å‡†æŒ‰é”® |
| **PWMèˆµæœº** | è‡ªå®šä¹‰ | éœ€è‡ªå·±åˆ›å»º | è§7.8.3 |
| **I2Cä¼ æ„Ÿå™¨** | è‡ªå®šä¹‰ | éœ€è‡ªå·±åˆ›å»º | ç»§æ‰¿i2c-device.yaml |
| **SPIè®¾å¤‡** | è‡ªå®šä¹‰ | éœ€è‡ªå·±åˆ›å»º | ç»§æ‰¿spi-device.yaml |
| **ç”µå‹è°ƒèŠ‚å™¨** | `"regulator-fixed"` | regulator/... | ç”µæºç®¡ç† |

---

#### 7.8.6 éªŒè¯Bindingæ˜¯å¦ç”Ÿæ•ˆ

**ç¼–è¯‘æ—¶æ£€æŸ¥ï¼š**

```bash
# ç¼–è¯‘æ—¶ä¼šæ˜¾ç¤ºæ‰€æœ‰å‘ç°çš„bindingæ–‡ä»¶
west build -b esp32_devkitc/esp32/procpu my_app -v | grep "bindings"

# æŸ¥çœ‹æœ€ç»ˆç”Ÿæˆçš„è®¾å¤‡æ ‘ï¼ˆç¡®è®¤å±æ€§æ˜¯å¦æ­£ç¡®ï¼‰
cat build/zephyr/zephyr.dts | grep -A 10 "my-device"

# æŸ¥çœ‹ç”Ÿæˆçš„Cå®ï¼ˆdevicetree_generated.hï¼‰
cat build/zephyr/include/generated/zephyr/devicetree_generated.h | grep "MY_DEVICE"
```

**å¦‚æœbindingæ‰¾ä¸åˆ°ï¼Œä¼šæŠ¥é”™ï¼š**

```
ERROR: Binding not found for compatible: 'my-custom-device'
```

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ `dts/bindings/` ç›®å½•æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥YAMLæ–‡ä»¶åæ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ `compatible:` å€¼æ˜¯å¦ä¸DTSä¸­ä¸€è‡´

### 7.9 å…³é”®è¦ç‚¹æ€»ç»“

**Compatibleçš„ä½œç”¨ï¼š**
```
DTSä¸­çš„compatible â†â†’ YAML Bindingæ–‡ä»¶ â†â†’ ç¼–è¯‘æ—¶éªŒè¯
```

**é€‰æ‹©ç­–ç•¥ï¼š**
1. **ä¼˜å…ˆä½¿ç”¨é€šç”¨binding**ï¼ˆgpio-ledsã€pwm-ledsã€gpio-keysï¼‰
2. **å…¶æ¬¡å¤ç”¨ç±»ä¼¼binding**ï¼ˆç»§ç”µå™¨ç”¨gpio-ledsï¼‰
3. **å®åœ¨ä¸è¡Œæ‰è‡ªå®šä¹‰**ï¼ˆåˆ›å»º dts/bindings/xxx.yamlï¼‰

**è‡ªå®šä¹‰bindingçš„é»„é‡‘è§„åˆ™ï¼š**
- âœ… æ–‡ä»¶è·¯å¾„ï¼š`<app>/dts/bindings/xxx.yaml`
- âœ… Compatibleå€¼ï¼šåŠ å‚å•†å‰ç¼€ï¼ˆ`"vendor,device"`ï¼‰
- âœ… åŒ…å«åŸºç¡€YAMLï¼š`include: [base.yaml]` æˆ– `[i2c-device.yaml]`
- âœ… æ–‡æ¡£åŒ–ï¼šå†™æ¸…æ¥š `description` å’Œæ¯ä¸ªå±æ€§çš„è¯´æ˜

### 7.10 æ€»ç»“ï¼šä¸‰å±‚è§„èŒƒçš„åä½œå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ å†™çš„ Overlay ä»£ç                                            â”‚
â”‚                                                              â”‚
â”‚ leds {                                                       â”‚
â”‚     compatible = "gpio-leds";                                â”‚
â”‚     myled: led_0 {                                           â”‚
â”‚         gpios = <&gpio0 2 GPIO_ACTIVE_HIGH>;                 â”‚
â”‚     };                                                       â”‚
â”‚ };                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘  DTSè¯­æ³•è§„èŒƒ   â”‚ â”‚ â‘¡ YAML Binding  â”‚ â”‚ â‘¢ Cå¤´æ–‡ä»¶å®    â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚ â€¢ { } è¯­æ³•      â”‚ â”‚ â€¢ compatibleå€¼  â”‚ â”‚ â€¢ GPIO_ACTIVE_  â”‚
â”‚ â€¢ &gpio0 å¼•ç”¨   â”‚ â”‚ â€¢ å¿…éœ€å±æ€§      â”‚ â”‚   HIGH = 0      â”‚
â”‚ â€¢ myled: æ ‡ç­¾   â”‚ â”‚ â€¢ å±æ€§ç±»å‹      â”‚ â”‚ â€¢ DT_FREQ_M()   â”‚
â”‚ â€¢ <...> æ•°ç»„    â”‚ â”‚ â€¢ cellå«ä¹‰      â”‚ â”‚ â€¢ DT_SIZE_K()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  ç¼–è¯‘é€šè¿‡ï¼    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®°ä½ï¼š**
- **DTSè¯­æ³•**æ•™ä½ "æ€ä¹ˆå†™"
- **YAML Binding**å‘Šè¯‰ä½ "å†™ä»€ä¹ˆ"
- **Cå¤´æ–‡ä»¶**æä¾›"å¸¸é‡å€¼"

åªæœ‰ä¸‰è€…éƒ½æ»¡è¶³ï¼Œè®¾å¤‡æ ‘æ‰èƒ½ç¼–è¯‘é€šè¿‡å¹¶æ­£å¸¸å·¥ä½œï¼
