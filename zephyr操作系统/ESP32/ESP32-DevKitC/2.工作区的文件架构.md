# Zephyr 工作区结构说明

本文档介绍 Zephyr 工作区的目录结构，帮助你理解每个文件夹的作用。

---

## 工作区整体结构

```c
D:\Zephyr\workspace\zephyrproject\
│
├── .git/                    # Git 版本控制
├── .gitignore               # Git 忽略规则
├── .venv/                   # Python 虚拟环境
├── .vscode/                 # VS Code 配置
├── .west/                   # West 工具配置 //python工具
│
├── zephyr/                  # ★ Zephyr 内核源码 (核心)
├── bootloader/              # 引导加载程序
├── modules/                 # 外部模块 (HAL、库等)
├── tools/                   # 开发工具
│
├── blinky/                  # 你的应用程序 1
├── pwm/                     # 你的应用程序 2
```

- 一般工作区不常修改，都是在应用层程序（项目文件夹中修改），工作区都是公共的

## 1. 配置目录

### `.west/` - West 工具配置

```
.west/
└── config          # West 配置文件
```

**config 文件内容:**
```ini
[manifest]
path = zephyr       # 清单文件所在目录
file = west.yml     # 清单文件名

[zephyr]
base = zephyr       # Zephyr 基础目录
```

**作用:**
- West 是 Zephyr 的**多仓库管理工具**
  - 主要是外部模块的仓库管理，下载，下载各模块的依赖

- 此配置告诉 West 去哪里找项目清单 (`zephyr/west.yml`)
- `west.yml` 定义了所有需要的模块及其版本
  - 可以对yml进行裁剪。


**常用 West 命令:**
```bash
west update          # 更新所有模块到清单指定版本
west list            # 列出所有模块
west build           # 构建项目
west flash           # 烧录固件
```

---

### `.venv/` - Python 虚拟环境

```
.venv/
├── Include/         # C 头文件 (用于编译 Python 扩展)
├── Lib/             # Python 包安装目录
├── Scripts/         # 可执行脚本 (west, python, pip 等)
├── share/           # 共享数据
└── pyvenv.cfg       # 虚拟环境配置
```

**作用:**
- **隔离的 Python 环境，避免与系统 Python 冲突**
- 包含 Zephyr 所需的所有 Python 工具和依赖
- 包括: west, pyelftools, pyyaml, cmake 等

**激活虚拟环境:**
```bash
# Windows CMD
.venv\Scripts\activate.bat

# Windows PowerShell
.venv\Scripts\Activate.ps1

# Linux/macOS
source .venv/bin/activate
```

---

### `.vscode/` - VS Code 配置

```
.vscode/
├── compile_commands.json   # 编译命令数据库 (用于代码智能提示)
├── extensions.json         # 推荐扩展列表
├── launch.json             # 调试配置
├── settings.json           # 项目设置
└── zephyr-ide.json         # Zephyr IDE 扩展配置
```

**作用:**
- `compile_commands.json`: 让 VS Code 的 C/C++ 扩展理解代码结构
- `launch.json`: 配置 GDB 调试器连接开发板
- `settings.json`: 项目特定的编辑器设置

这个主要是vscode下载官方IDE插件后会自动配置的。

---

## 2. 核心目录

### `zephyr/` - Zephyr 内核源码 ★ 最重要

这是 Zephyr RTOS 的核心代码库。

```
zephyr/
│
├── arch/              # 架构相关代码
│   ├── arm/           #   ARM (Cortex-M, Cortex-A, Cortex-R)
│   ├── riscv/         #   RISC-V
│   ├── x86/           #   Intel x86
│   └── xtensa/        #   Xtensa (ESP32)
│
├── boards/            # 开发板定义
│   ├── espressif/     #   ESP32 系列开发板
│   ├── st/            #   STM32 开发板
│   ├── nordic/        #   Nordic nRF 开发板
│   └── ...
│
├── drivers/           # 设备驱动
│   ├── gpio/          #   GPIO 驱动
│   ├── uart/          #   串口驱动
│   ├── spi/           #   SPI 驱动
│   ├── i2c/           #   I2C 驱动
│   ├── pwm/           #   PWM 驱动
│   ├── adc/           #   ADC 驱动
│   ├── bluetooth/     #   蓝牙驱动
│   └── ...
│
├── dts/               # 设备树
│   ├── bindings/      #   YAML Binding 定义
│   ├── common/        #   通用 DTS (skeleton.dtsi)
│   ├── arm/           #   ARM 芯片 DTS
│   ├── xtensa/        #   Xtensa 芯片 DTS (ESP32)
│   └── ...
│
├── include/           # 公共头文件
│   └── zephyr/        #   Zephyr API 头文件
│       ├── kernel.h   #     内核 API
│       ├── device.h   #     设备模型 API
│       ├── drivers/   #     驱动 API
│       └── ...
│
├── kernel/            # 内核实现
│   ├── sched.c        #   调度器
│   ├── thread.c       #   线程管理
│   ├── sem.c          #   信号量
│   ├── mutex.c        #   互斥锁
│   └── ...
│
├── lib/               # 核心库
│   ├── libc/          #   C 标准库
│   ├── heap/          #   堆管理
│   └── ...
│
├── subsys/            # 子系统
│   ├── bluetooth/     #   蓝牙协议栈
│   ├── net/           #   网络协议栈
│   ├── usb/           #   USB 协议栈
│   ├── logging/       #   日志系统
│   ├── shell/         #   命令行 Shell
│   ├── fs/            #   文件系统
│   └── ...
│
├── samples/           # 示例程序 ★ 学习资源
│   ├── basic/         #   基础示例
│   │   ├── blinky/    #     LED 闪烁
│   │   ├── button/    #     按键输入
│   │   └── threads/   #     多线程
│   ├── bluetooth/     #   蓝牙示例
│   ├── net/           #   网络示例
│   └── ...
│
├── tests/             # 测试用例
│
├── scripts/           # 构建脚本
│   ├── twister        #   测试运行器
│   ├── west_commands/ #   West 命令扩展
│   └── ...
│
├── cmake/             # CMake 构建系统
│
├── doc/               # 文档源码 (Sphinx)
│
├── west.yml           # ★ 模块清单文件
├── Kconfig.zephyr     # 内核配置选项
├── CMakeLists.txt     # 主 CMake 文件
└── VERSION            # 版本号
```

**重点目录说明:**

| 目录 | 用途 | 你需要关注的场景 |
|------|------|----------------|
| `boards/` | 开发板定义 | 查看板级 DTS、添加新板支持 |
| `dts/bindings/` | 设备树属性定义 | 编写 Overlay 时查阅 |
| `drivers/` | 驱动实现 | 了解驱动 API、调试硬件问题 |
| `include/zephyr/` | API 头文件 | 编程时查阅 API |
| `samples/` | 示例程序 | 学习、参考代码 |
| `subsys/` | 子系统 | 使用蓝牙、网络等功能时 |

---

### `modules/` - 外部模块

Zephyr 依赖的外部代码，由 West 根据 `west.yml` **自动下载管理**。

```
modules/
│
├── hal/               # 硬件抽象层 (厂商提供的底层代码)
│   ├── espressif/     #   ESP32 HAL (ESP-IDF 组件)
│   ├── st/            #   STM32 HAL
│   ├── stm32/         #   STM32Cube HAL
│   ├── nordic/        #   nRF HAL
│   ├── nxp/           #   NXP HAL
│   ├── cmsis/         #   ARM CMSIS
│   └── ...            #   (30+ 厂商 HAL)
│
├── lib/               # 第三方库
│   ├── hostap/        #   WiFi WPA Supplicant
│   ├── openthread/    #   Thread 协议栈
│   ├── picolibc/      #   轻量级 C 库
│   ├── nanopb/        #   Protocol Buffers 编码
│   ├── gui/           #   LVGL 图形库
│   │   └── lvgl/
│   └── ...
│
├── crypto/            # 加密库
│   └── mbedtls/       #   Mbed TLS (SSL/TLS, 加密算法)
│
├── fs/                # 文件系统
│   ├── fatfs/         #   FAT 文件系统
│   └── littlefs/      #   LittleFS (适合 Flash)
│
├── debug/             # 调试工具
│   ├── segger/        #   SEGGER RTT, SystemView
│   ├── percepio/      #   Percepio Tracealyzer
│   └── mipi-sys-t/    #   MIPI System Trace
│
├── tee/               # 可信执行环境
│   ├── tf-m/          #   Trusted Firmware-M
│   └── tf-a/          #   Trusted Firmware-A
│
└── bsim_hw_models/    # BabbleSim 硬件模型 (仿真测试用)
```

**各子目录详解:**

#### `modules/hal/` - 硬件抽象层

| 目录 | 说明 |
|------|------|
| `espressif/` | ESP32 的底层驱动 (从 ESP-IDF 提取) |
| `st/` | STMicroelectronics 通用 HAL |
| `stm32/` | STM32Cube HAL 库 |
| `nordic/` | Nordic nRF 系列 HAL (nrfx) |
| `cmsis/` | ARM Cortex-M 软件接口标准 |
| `cmsis_6/` | CMSIS 6 版本 |

**为什么需要 HAL?**
- Zephyr 驱动调用 HAL 层操作寄存器
- HAL 由芯片厂商提供，封装了硬件细节
- 例如: `drivers/gpio/gpio_esp32.c` 调用 `modules/hal/espressif/` 中的函数

#### `modules/lib/` - 第三方库

| 目录 | 说明 |
|------|------|
| `openthread/` | Google 的 Thread 网状网络协议栈 |
| `hostap/` | WiFi WPA Supplicant (WiFi 认证) |
| `picolibc/` | 嵌入式优化的 C 标准库 |
| `nanopb/` | 嵌入式 Protocol Buffers |
| `gui/lvgl/` | LVGL 嵌入式图形库 |
| `liblc3/` | LC3 音频编解码器 (蓝牙 LE Audio) |

#### `modules/crypto/mbedtls/`

ARM 的开源加密库，提供:
- TLS/SSL 协议
- 对称加密 (AES, ChaCha20)
- 非对称加密 (RSA, ECDSA)
- 哈希算法 (SHA-256, SHA-3)
- 证书解析

#### `modules/fs/` - 文件系统

| 目录 | 说明 |
|------|------|
| `fatfs/` | FAT12/16/32 文件系统，兼容 Windows |
| `littlefs/` | 掉电安全的 Flash 文件系统 |

---

### `bootloader/` - 引导加载程序

```
bootloader/
└── mcuboot/           # MCUboot 安全引导加载程序
    ├── boot/          #   引导代码
    ├── sim/           #   模拟器
    └── scripts/       #   辅助脚本
```

**MCUboot 功能:**
- 安全启动 (验证固件签名)
- 固件升级 (OTA)
- 回滚保护
- 加密固件

**使用场景:**
- 产品需要安全启动
- 需要远程固件升级 (OTA/DFU)

---

### `tools/` - 开发工具

```
tools/
├── edtt/              # 嵌入式设备测试工具 (蓝牙测试)
└── net-tools/         # 网络调试工具 (虚拟网络接口)
```

**主要用于:**
- 自动化测试
- 蓝牙 HCI 测试
- 网络协议栈测试

---

## 3. 你的应用程序目录

### `blinky`

```c
blinky/
├── CMakeLists.txt                        # CMake 构建配置
├── prj.conf                              # Kconfig 配置
├── sample.yaml                           # 测试元数据
├── README.rst                            # 说明文档
├── esp32_devkitc_esp32_procpu.overlay    # 设备树 Overlay
├── boards/                               # 板级特定配置
├── src/
│   └── main.c                            # 主程序
└── build/                                # 构建输出目录
```

**文件说明:**

| 文件 | 作用 |
|------|------|
| `CMakeLists.txt` | 定义项目名、源文件 |
| `prj.conf` | 启用/禁用 Kconfig 选项 (如 `CONFIG_GPIO=y`) |
| `*.overlay` | 设备树覆盖文件 (添加 LED 定义) |
| `src/main.c` | 应用程序入口 |
| `build/` | 编译生成的文件 (固件、中间文件) |

### 构建输出 (`build` )

每个应用的 `build/` 目录包含:

```
build/
├── zephyr/
│   ├── zephyr.elf         # 可执行文件 (带调试信息)
│   ├── zephyr.bin         # 二进制固件
│   ├── zephyr.hex         # Intel HEX 格式
│   ├── zephyr.dts         # ★ 合并后的完整设备树
│   ├── zephyr.map         # 内存映射
│   ├── .config            # 最终 Kconfig 配置
│   └── include/generated/
│       └── zephyr/
│           └── devicetree_generated.h  # 设备树生成的宏
├── CMakeCache.txt         # CMake 缓存
└── compile_commands.json  # 编译命令 (用于 IDE)
```

**重要文件:**

| 文件 | 用途 |
|------|------|
| `zephyr.bin` | 烧录到设备的固件 |
| `zephyr.dts` | 调试设备树问题 (查看最终合并结果) |
| `.config` | 查看最终的 Kconfig 配置 |
| `devicetree_generated.h` | 查看生成的设备树宏 |

---

## 4. 关键配置文件

### `west.yml` - 模块清单

**位置:** `zephyr/west.yml`

定义了所有依赖模块及其版本:

```yaml
manifest:
  remotes:
    - name: upstream
      url-base: https://github.com/zephyrproject-rtos

  projects:
    - name: hal_espressif
      revision: xxx
      path: modules/hal/espressif
    - name: mbedtls
      revision: xxx
      path: modules/crypto/mbedtls
    # ... 100+ 模块
```

**更新模块:**
```bash
west update                  # 更新所有模块
west update hal_espressif    # 只更新指定模块
```

---

### `Kconfig` 系统

Zephyr 使用 Linux 风格的 Kconfig 配置系统。

**配置层级:**
```
zephyr/Kconfig.zephyr        # 顶层配置
    ↓
subsys/*/Kconfig             # 子系统配置
    ↓
drivers/*/Kconfig            # 驱动配置
    ↓
boards/*/<board>/Kconfig     # 板级默认配置
    ↓
<app>/prj.conf               # ★ 你的应用配置 (最高优先级)
```

**常用配置命令:**

```bash
# 图形化配置
west build -t menuconfig

# 查看当前配置
cat build/zephyr/.config

# 搜索配置项
west build -t menuconfig   # 然后按 / 搜索
```

---

## 6. 目录作用速查表

| 目录 | 类型 | 作用 | 你需要关注? |
|------|------|------|-----------|
| `.west/` | 配置 | West 工具配置 | 很少修改 |
| `.venv/` | 环境 | Python 虚拟环境 | 激活即可 |
| `.vscode/` | 配置 | VS Code 配置 | 插件自动管理 |
| `zephyr/` | 核心 | Zephyr 内核源码 | ★ 经常查阅 |
| `zephyr/boards/` | 核心 | 板级定义 | ★ 查看 DTS |
| `zephyr/samples/` | 示例 | 官方示例 | ★ 学习参考 |
| `zephyr/dts/` | 核心 | 设备树文件 | ★ 编写 Overlay |
| `zephyr/include/` | 核心 | API 头文件 | ★ 编程参考 |
| `modules/hal/` | 模块 | 芯片厂商 HAL | 调试底层问题 |
| `modules/lib/` | 模块 | 第三方库 | 使用特定功能时 |
| `modules/crypto/` | 模块 | 加密库 | 使用加密功能时 |
| `modules/fs/` | 模块 | 文件系统 | 使用文件系统时 |
| `bootloader/` | 模块 | 安全引导 | OTA 升级时 |
| `tools/` | 工具 | 测试工具 | 很少使用 |
| `blinky/`, `pwm/` | 应用 | 你的代码 | ★ 主要工作区 |

### 调试设备树问题

```bash
# 查看合并后的完整设备树
cat build/zephyr/zephyr.dts

# 查看生成的宏
cat build/zephyr/include/generated/zephyr/devicetree_generated.h
```

---

## 总结

```c
zephyrproject/
│
│  ┌─────────── 配置区 ───────────┐
├── .west/          West 配置
├── .venv/          Python 环境
├── .vscode/        编辑器配置
│  └─────────────────────────────┘
│
│  ┌─────────── 核心代码 ─────────┐
├── zephyr/         ★ Zephyr 内核
│  └─────────────────────────────┘
│
│  ┌─────────── 外部模块 ─────────┐
├── modules/        HAL + 库
├── bootloader/     MCUboot
├── tools/          测试工具
│  └─────────────────────────────┘
│
│  ┌─────────── 你的应用 ─────────┐
├── blinky/         ★ 应用程序 1
├── pwm/            ★ 应用程序 2
│  └─────────────────────────────┘
```

**核心理解:**
1. `zephyr/` 是操作系统源码，**只读参考，不要修改**
2. `modules/` 是依赖库，**由 West 管理，不要手动修改**
3. 你的应用在**独立目录**，通过 Overlay 和 prj.conf 定制
4. 所有配置通过 **Kconfig** 和 **设备树** 完成，无需修改内核代码
