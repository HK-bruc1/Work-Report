# SDK彩屏仓通信问题详细排查手册

## 概述
本文档详细分析了AC710N SDK中可能导致耳机无法与彩屏仓连接的所有问题点，并提供了逐步排查方案。

## 主要问题发现

### 1. 写死的测试MAC地址
- **位置**: `user_cfg.c:354`
- **问题**: 存在已注释的测试MAC地址 `{0x66,0x55,0x44,0x33,0x22,0x11}`
- **影响**: 虽已禁用，但可能在某些编译配置下被意外启用

### 2. DUT测试模式MAC地址
- **位置**: `user_cfg.c:359-361`  
- **问题**: DUT模式下使用固定MAC地址 `{0x12, 0x34, 0x56, 0x56, 0x34, 0x12}`
- **条件**: `#if (CONFIG_BT_MODE != BT_NORMAL)` 时生效
- **影响**: 如果蓝牙模式配置错误，会使用测试地址而非真实MAC

### 3. TWS共享配对地址
- **位置**: `tws_dual_share.c:52`
- **问题**: 固定的共享搜索配对地址 `{0x18, 0x28, 0xaa, 0x28, 0x33, 0x44}`
- **影响**: 可能与彩屏仓的预期配对地址冲突

### 4. 彩屏仓通信机制分析

**串口通信路径**:
```
sbox_uart_app.c:user_app_chargestore_data_deal()
├── 接收彩屏仓命令 (CMD_CUSTOM_DEAL = 0xAA)
├── 处理MAC地址请求 (cmd=0x10)
└── 发送耳机MAC (Send_Mac函数)
```

**BLE通信路径**:
```
sbox_protocol.c:sbox_demo_ble_event_callback()
├── 处理BLE连接事件
├── sbox_user_app.c:sys_smartstore_event_handle() 
└── 执行彩屏仓控制命令
```

## 详细问题排查清单

### 阶段一：基础配置检查

#### 1.1 蓝牙模式配置验证 🔴 **高优先级**
**检查位置**: `710_earbox/SDK/apps/earphone/board/br56/sdk_config.h:213`
```c
#define CONFIG_BT_MODE BT_NORMAL // 必须是BT_NORMAL模式
```

**检查位置**: `710_earbox/SDK/apps/earphone/board/br56/sdk_config.h:214`
```c  
#define TCFG_NORMAL_SET_DUT_MODE 0 // 必须是0，禁用DUT模式
```

**验证方法**:
- 确认编译时这两个宏定义的值
- 检查是否有其他地方重新定义了这些宏

#### 1.2 MAC地址获取函数检查 🔴 **高优先级**
**检查位置**: `710_earbox/SDK/apps/earphone/user_cfg.c:354-362`
```c
// 确认这行是注释状态
// u8 tmp_buf[6] = {0x66,0x55,0x44,0x33,0x22,0x11};  // 测试地址，已禁用
memcpy(bt_cfg.mac_addr, mac_buf, 6);  // 确保使用真实MAC地址

#if (CONFIG_BT_MODE != BT_NORMAL)  // 确认这个分支不会被执行
const u8 dut_addr[6] = {0x12, 0x34, 0x56, 0x56, 0x34, 0x12};
// ... DUT模式相关代码
#endif
```

**验证步骤**:
1. 在`bt_cfg.mac_addr`赋值后添加调试输出：
```c
memcpy(bt_cfg.mac_addr, mac_buf, 6);
printf("Final MAC address: ");
put_buf(bt_cfg.mac_addr, 6);
```

### 阶段二：彩屏仓通信协议检查

#### 2.1 串口通信协议验证 🟡 **中优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_uart_app.c`

**关键函数检查**:
```c
// 第16行：命令定义
#define CMD_CUSTOM_DEAL 0xAA // 彩屏仓自定义命令

// 第52行：数据处理函数
int user_app_chargestore_data_deal(u8 *buf, u8 len)

// 第31行：MAC地址发送函数  
void Send_Mac(u8 event,u8 *addr,u8 len)
```

**验证步骤**:
1. 在`user_app_chargestore_data_deal`函数开头添加调试：
```c
printf("Received from box: ");
printf_hexdump(buf, len);
```

2. 在`Send_Mac`函数中添加调试：
```c
printf("Sending MAC to box: ");
put_buf(addr, 6);
```

#### 2.2 BLE通信参数检查 🟡 **中优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_core_config.h`

**关键配置**:
```c
// 第22行：数据传输缓存大小
#define SEND_BUF_MAX_LEN 256 // 彩屏仓协议定义的数据传输buf大小

// 第28行：BLE特征值Handle
#define ATT_CHARACTERISTIC_ae99_01_VALUE_HANDLE 0x000d
```

**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_core_config.c:30`
```c
.sbox_ble_send_handle = ATT_CHARACTERISTIC_ae99_01_VALUE_HANDLE,
```

### 阶段三：TWS和配对机制检查

#### 3.1 TWS共享地址冲突排查 🟡 **中优先级**
**检查位置**: `710_earbox/SDK/apps/earphone/mode/bt/tws_dual_share.c:52`
```c
static const u8 tws_audio_share_pair_addr[6] = {0x18, 0x28, 0xaa, 0x28, 0x33, 0x44};
```

**排查步骤**:
1. 确认彩屏仓是否使用这个地址进行配对搜索
2. 如果冲突，需要修改这个地址或禁用TWS共享功能

#### 3.2 自动配对码检查 🟢 **低优先级**
**检查位置**: `710_earbox/SDK/apps/earphone/mode/bt/tws_dual_conn.c:1226`
```c
static u8 auto_pair_code[6] = {0x34, 0x66, 0x33, 0x87, 0x09, 0x42};
```

### 阶段四：调试和测试代码清理

#### 4.1 测试代码禁用检查 🟢 **低优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/edr_hid_user.c:32`
```c
#define TEST_USER_HID_EN 0 // 确保为0
```

**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_core_config.h:25`
```c
#define SBOX_CORE_DEBUG (BIT(0)) // 生产版本建议设为0
```

#### 4.2 测试函数清理
**检查并注释以下测试函数调用**:
- `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_key_setting.c:71` - `sbox_keysetting_test()`
- `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/edr_hid_user.c:653` - `edr_hid_key_deal_test()`

### 阶段五：高级排查

#### 5.1 BLE广播参数验证 🟡 **中优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_protocol.c`

**关键函数**:
```c
// 第341行：BLE广播控制
int sbox_demo_adv_enable(u8 enable)

// 第363行：广播启用函数
app_ble_adv_enable(sbox_demo_ble_hdl, enable);
```

**验证步骤**:
1. 确认BLE广播正常启动
2. 检查广播数据内容是否包含正确的服务UUID
3. 验证广播间隔和功率设置

#### 5.2 电源管理影响排查 🟢 **低优先级**
**检查位置**: `710_earbox/SDK/apps/earphone/include/app_config.h:295-296`
```c
#undef  TCFG_LOWPOWER_LOWPOWER_SEL
#define TCFG_LOWPOWER_LOWPOWER_SEL 0 // DUT模式下的低功耗设置
```

### 阶段六：通信时序和协议检查

#### 6.1 数据包格式验证 🔴 **高优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_uart_app.c:35-47`

**数据包结构**:
```c
temp[0] = CMD_CUSTOM_DEAL; // 0xAA 数据包头
temp[1] = event;           // 事件类型
memcpy(&temp[2], addr, 6); // MAC地址
temp[8] = (sum)&0xff;      // 校验和
```

**验证要点**:
1. 确认彩屏仓期望的数据包格式
2. 验证校验和算法是否正确
3. 检查字节序是否一致

#### 6.2 缓存机制检查 🟡 **中优先级**
**检查位置**: `710_earbox/SDK/apps/common/third_party_profile/jl_earbox/sbox_core_config.c:77-101`

**关键函数**: `sbox_tr_ibuf_to_cbuf()` 和 `sbox_tr_cbuf_read()`

**可能问题**:
- 缓存溢出导致数据丢失
- 多线程访问冲突
- 数据包分片处理错误

## 排查优先级建议

### 🔴 **第一优先级（必须检查）**
1. 蓝牙模式配置 (CONFIG_BT_MODE = BT_NORMAL)
2. MAC地址获取函数验证
3. 数据包格式和校验和验证

### 🟡 **第二优先级（重要检查）** 
1. BLE通信参数配置
2. 串口通信协议匹配
3. TWS共享地址冲突检查
4. BLE广播参数验证

### 🟢 **第三优先级（建议检查）**
1. 测试代码清理
2. 电源管理设置
3. 自动配对码检查

## 调试工具和方法

### 串口调试
```c
// 在关键位置添加调试输出
printf("彩屏仓通信调试: [位置描述]\n");
printf_hexdump(data, len);
put_buf(mac_addr, 6);
```

### BLE调试
```c
// 在BLE事件回调中添加调试
printf("BLE事件: %d, 连接状态: %d\n", event, connected);
```

### 编译时检查
```c
// 添加编译时断言验证配置
#if (CONFIG_BT_MODE != BT_NORMAL)
#error "错误：蓝牙模式必须配置为BT_NORMAL"
#endif
```

## 总结

如果MAC地址修复后仍然无法连接，请按照以上优先级顺序逐一排查。每个阶段完成后建议进行测试验证，确保问题定位的准确性。大部分连接问题都集中在前两个优先级的检查项目中。