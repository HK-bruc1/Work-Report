# 耳机与充电仓连接机制移植文档

## 概述

本文档分析了杰里(JieLi)700色彩盒耳机SDK和DHF彩屏仓SDK中耳机与充电仓的连接机制，重点关注耳机端的实现细节，用于移植到其他耳机SDK。

## 系统架构

### 硬件组成
- **耳机端**: BR36芯片，支持BLE连接
- **充电仓端**: BR28芯片，带彩屏UI，支持BLE和霍尔传感器
- **通信芯片**: 982芯片，用于耳机与仓之间的UART通信
- **霍尔传感器**: 检测充电仓开盖/合盖状态

### 连接流程概述

```mermaid
sequenceDiagram
    participant User as 用户
    participant Box as 充电仓
    participant UART as 982通信
    participant Ear as 耳机
    participant BLE as BLE连接

    User->>Box: 三击按键发起配对
    Box->>UART: 发送配对命令(55 AA 06 01 01 AC...)
    UART->>Ear: 转发配对命令
    Ear->>UART: 发送耳机BLE地址(55 AA 03 01 00...)
    UART->>Box: 转发耳机地址(65 c1 9e ea be 8a)
    Box->>Box: 存储耳机地址到VM
    Box->>UART: 发送仓BLE地址(55 AA 08 01 06...)
    UART->>Ear: 转发仓地址
    Ear->>Ear: 存储仓地址到VM
    Note over Box: 3秒后开启BLE扫描
    Box->>BLE: 根据存储地址主动连接耳机
```

## 详细实现分析

### 1. 配对按键触发机制

#### 仓端实现
- **文件位置**: `DHF_charge_box_sdk/apps/watch/task_manager/app_common.c`
- **触发条件**: 三击按键(key_event: 172)
- **关键代码段**:
```c
// 检测到按键配对事件
[02:50:54.946]->>>---    GZH    ---<<<- 发出按键配对
// 发送配对命令到982芯片
55 AA 06 01 01 AC 00 00 00 00 00 00 00 00 00
```

#### 耳机端响应
- **文件位置**: `700_color_box_ear_sdk/apps/earphone/earphone_data_analysis.c`
- **处理机制**: 通过UART接收仓的配对命令
- **关键变量**:
```c
u8 AC701_mac_addr[6] = {0}; // 存储仓的BLE地址
u8 connect_dev = 0; // 连接设备标识: 0:无 1:仓 2:APP
```

### 2. 982通信协议

#### 协议格式
```
55 AA [长度] [方向] [命令] [数据] [校验]
```

#### 关键命令定义
```c
// 充电仓通信命令 (app_chargestore.c)
#define CMD_BOX_TWS_CHANNEL_SEL     0x04  // 测试盒获取地址
#define CMD_BOX_TWS_REMOTE_ADDR     0x05  // 测试盒交换地址
#define CMD_POWER_LEVEL_OPEN        0x06  // 开盖充电舱报告/获取电量
#define CMD_POWER_LEVEL_CLOSE       0x07  // 合盖充电舱报告/获取电量
```

#### 地址交换过程
1. **仓发送配对命令**: `55 AA 06 01 01 AC 00 00 00 00 00 00 00 00 00`
2. **耳机响应地址**: `55 AA 03 01 00 65 c1 9e ea be 8a` (BLE地址: 65:c1:9e:ea:be:8a)
3. **仓发送自身地址**: `55 AA 08 01 06 FD 97 27 53 AE B4` (仓BLE地址: fd:97:27:53:ae:b4)

### 3. VM地址存储机制

#### 仓端存储
- **VM标识**: `VM_EAR_MAC_ADDR (54)`
- **存储位置**: `syscfg_write(VM_EAR_MAC_ADDR, ear_mac_addr, 6)`
- **读取方式**: `syscfg_read(VM_EAR_MAC_ADDR, ble_ear_mac_addr, 6)`

#### 耳机端存储
- **关键注释**: "每次连接后收到仓的地址都写一次vm"
- **存储位置**: `earphone_data_analysis.c`中的处理函数
- **配置宏**: `board_ac700n_demo_cfg.h`中需开启"对耳都会存仓的地址到vm"

### 4. 霍尔传感器开盖检测

#### 状态定义
```c
struct chargestore_info {
    u8 cover_status;  // 充电舱盖子状态 0:合盖 1:开盖
    u8 ear_number;    // 盒盖时耳机在线数
    // ... 其他状态
};
```

#### 开盖连接逻辑
- **检测到开盖**: `cover_status = 1`
- **读取VM地址**: 从VM中读取已存储的耳机BLE地址
- **启动BLE扫描**: 3秒定时器后开启BLE客户端模式
- **主动连接**: 根据存储的地址主动连接对应耳机

### 5. BLE连接实现

#### 仓端BLE客户端
- **模块启用**: `ble_client_module_enable()`
- **扫描启动**: `bt_ble_scan_enable()`
- **连接目标**: 使用VM中存储的耳机地址

#### 耳机端BLE服务端
- **文件位置**: `700_color_box_ear_sdk/apps/earphone/bt_ble.c`
- **广播模式**: 被动等待连接
- **地址匹配**: 验证连接请求来源

## 移植要点

### 1. 必需的硬件支持
- UART接口用于982通信
- BLE功能支持
- VM存储功能
- 霍尔传感器(可选，用于自动检测开盖)

### 2. 关键软件模块

#### 耳机端需要实现
```c
// 1. UART通信处理
void uart_982_handler(u8 *data, u16 len);

// 2. VM地址存储
void store_box_address(u8 *addr);
u8* read_box_address(void);

// 3. BLE地址交换
void send_earphone_ble_addr(void);
void receive_box_ble_addr(u8 *addr);

// 4. 配对状态管理
void set_pair_mode(bool enable);
bool is_paired_with_box(void);
```

#### 关键配置项
```c
// 开启仓地址存储功能
#define CONFIG_BOX_ADDR_STORAGE_ENABLE  1

// BLE连接相关配置
#define CONFIG_BLE_BOX_CONNECTION       1
#define CONFIG_UART_982_COMMUNICATION   1
```

### 3. 移植步骤

1. **移植UART 982通信模块**
   - 实现协议解析和封装
   - 处理地址交换命令
   - 实现应答机制

2. **移植BLE连接管理**
   - 实现BLE服务端功能
   - 支持特定地址的连接验证
   - 处理连接状态变化

3. **移植VM存储功能**
   - 实现仓地址的持久化存储
   - 开机时读取已配对的仓地址
   - 支持配对清除功能

4. **集成配对流程**
   - 监听UART配对命令
   - 执行地址交换过程
   - 更新连接状态

### 4. 调试要点

#### 关键日志监控
```
- UART数据收发: "55 AA XX XX XX..."
- 地址存储: "vm存储的耳机地址为: XX XX XX XX XX XX"
- BLE连接状态: "ble_client_module_enable"
- 配对流程: "发出按键配对"
```

#### 常见问题排查
1. **地址交换失败**: 检查UART通信和982芯片连接
2. **BLE连接不上**: 验证地址存储和BLE模块初始化
3. **开盖不自动连接**: 检查霍尔传感器和定时器机制

## 总结

耳机与仓的连接机制核心在于:
1. **982 UART通信**实现地址交换
2. **VM存储**保持配对关系
3. **BLE连接**建立数据通道
4. **霍尔传感器**触发自动连接

移植时需要重点关注UART协议的实现和BLE连接管理，确保地址交换的准确性和连接的稳定性。