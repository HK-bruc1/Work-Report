# å½©å±ä»“äº¤äº’åŠŸèƒ½æŠ€æœ¯åˆ†ææŠ¥å‘Š

## ç‰ˆæœ¬ä¿¡æ¯
- **æäº¤ç‰ˆæœ¬**: 553d35d (2025å¹´4æœˆ2æ—¥)
- **æäº¤æè¿°**: "é€šä¿¡æ­£å¸¸ï¼Œå®ŒæˆåŸºæœ¬æ’­æ”¾æš‚åœéŸ³é‡éŸ³ä¹çŠ¶æ€åŒæ­¥åŠŸèƒ½"
- **åˆ†ææ—¥æœŸ**: 2025å¹´9æœˆ9æ—¥

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸ºæ°ç†AC710Nè€³æœºé¡¹ç›®å¢åŠ äº†ä¸å½©å±ä»“ï¼ˆSmart Boxï¼‰çš„åŒå‘é€šä¿¡åŠŸèƒ½ï¼Œå®ç°äº†è€³æœºçŠ¶æ€çš„å®æ—¶åŒæ­¥å’Œè¿œç¨‹æ§åˆ¶èƒ½åŠ›ã€‚

## æ ¸å¿ƒæ¶æ„å˜æ›´

### 1. æ–°å¢æ¨¡å—ç»“æ„

```
SDK/apps/common/third_party_profile/jl_earbox/
â”œâ”€â”€ sbox_core_config.h/.c    # æ ¸å¿ƒé…ç½®å’Œç¼“å†²åŒºç®¡ç†
â”œâ”€â”€ sbox_protocol.h/.c       # BLEåè®®å®šä¹‰å’Œåº•å±‚é€šä¿¡
â”œâ”€â”€ sbox_user_app.h/.c       # ç”¨æˆ·åº”ç”¨å±‚æ¥å£
â”œâ”€â”€ sbox_uart_app.c          # ä¸²å£é€šä¿¡æ”¯æŒï¼ˆä¸982èŠ¯ç‰‡é€šä¿¡ï¼‰
â””â”€â”€ sbox_core_code.c         # åè®®æ ¸å¿ƒå¤„ç†é€»è¾‘
```

### 2. é…ç½®ç³»ç»Ÿé›†æˆ

åœ¨`app_config.h`ä¸­æ–°å¢å½©å±ä»“æ”¯æŒï¼š
```c
#define JL_SBOX_EN (1 << 31)
#define THIRD_PARTY_PROTOCOLS_SEL (ONLINE_DEBUG_EN|JL_SBOX_EN)
```

## BLEåè®®æ‰©å±•å®ç°

### 1. è‡ªå®šä¹‰BLE Serviceå®šä¹‰

åŸºäºæ ‡å‡†BLE GATTåè®®ï¼Œæ–°å¢äº†ä¸“ç”¨çš„å½©å±ä»“é€šä¿¡æœåŠ¡ï¼š

**Service UUID**: `0xAE00`

**ä¸»è¦ç‰¹å¾å€¼**ï¼š

- **0xAE01**: Write Without Response (å½©å±ä»“â†’è€³æœºå‘½ä»¤)
- **0xAE02**: Notify (è€³æœºâ†’å½©å±ä»“çŠ¶æ€åŒæ­¥) 
- **0xAE98**: Write Without Response (æ‰©å±•å‘½ä»¤é€šé“)
- **0xAE99**: Notify (æ‰©å±•çŠ¶æ€é€šé“)

### 2. åè®®æ ˆå±‚æ¬¡ç»“æ„

```
åº”ç”¨å±‚    â”‚ sbox_user_app.c (çŠ¶æ€åŒæ­¥/å‘½ä»¤å¤„ç†)
åè®®å±‚    â”‚ sbox_protocol.c (BLEæœåŠ¡å®šä¹‰/è¿æ¥ç®¡ç†)
ä¼ è¾“å±‚    â”‚ sbox_core_code.c (æ•°æ®åŒ…å¤„ç†/ç¼“å†²ç®¡ç†)
é…ç½®å±‚    â”‚ sbox_core_config.c (å‚æ•°é…ç½®/å†…å­˜ç®¡ç†)
ç¡¬ä»¶å±‚    â”‚ sbox_uart_app.c (ä¸²å£é€šä¿¡æ”¯æŒ)
```

### 3. æ•°æ®ä¼ è¾“æœºåˆ¶

- **ç¼“å†²åŒºå¤§å°**: 256å­—èŠ‚ï¼ˆå¿…é¡»ä¸º16çš„å€æ•°ï¼‰
- **ç¼“å­˜æœºåˆ¶**: æ”¯æŒæœ€å¤§5åŒ…æ•°æ®ç¼“å­˜ (SBOX_TR_BUF_LEN = 1360å­—èŠ‚)
- **æ•°æ®ä¿æŠ¤**: é‡‡ç”¨CBUFå¾ªç¯ç¼“å†²åŒºé˜²æ­¢æ•°æ®è¸©è¸
- **ä¼ è¾“æ–¹å¼**: BLE ATT Write Without Response + Notify

## æ”¯æŒçš„åŠŸèƒ½å‘½ä»¤

### çŠ¶æ€åŒæ­¥å‘½ä»¤ (è€³æœºâ†’å½©å±ä»“)å¹»è§‰

| å‘½ä»¤ID | åŠŸèƒ½æè¿° | å®ç°å‡½æ•° |
|--------|----------|----------|
| 0xFF | åŒæ­¥æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ | `custom_sync_all_info_to_box()` |
| 0x01 | ç»å…¸è“ç‰™è¿æ¥çŠ¶æ€ | `custom_sync_bt_connect_state()` |
| 0x02 | BLEè¿æ¥çŠ¶æ€ | `custom_sync_ble_connect_state()` |
| 0x03 | ç”µæ± ç”µé‡ä¿¡æ¯ | `custom_sync_vbat_percent_state()` |
| 0x04 | éŸ³é‡ä¿¡æ¯ | `custom_sync_volume_state()` |
| 0x05 | æ—¶é—´ä¿¡æ¯ | `custom_sync_time_info()` |
| 0x06 | EQæ¨¡å¼ä¿¡æ¯ | `custom_sync_eq_info_to_box()` |
| 0x07 | ANCé™å™ªçŠ¶æ€ | `custom_sync_anc_info_to_box()` |
| 0x08 | é€šè¯çŠ¶æ€ | `custom_sync_call_state()` |
| 0x09 | é€šè¯è®°å½•ä¿¡æ¯ | `custom_sync_phone_call_info()` |
| 0x0A | è‡ªå®šä¹‰æŒ‰é”®è®¾ç½® | `custom_sync_key_setting()` |

### æ§åˆ¶å‘½ä»¤ (å½©å±ä»“â†’è€³æœº)

| å‘½ä»¤ID | åŠŸèƒ½æè¿° | æ”¯æŒçŠ¶æ€ |
|--------|----------|----------|
| 0x32 | éŸ³é‡æ§åˆ¶ | âœ… å·²å®ç° |
| 0x33 | éŸ³ä¹æ’­æ”¾æ§åˆ¶ | âœ… å·²å®ç° |
| 0x34 | ANCæ¨¡å¼æ§åˆ¶ | âœ… å·²å®ç° |
| 0x35 | EQæ¨¡å¼æ§åˆ¶ | âœ… å·²å®ç° |
| 0x36 | æ’­æ”¾æ¨¡å¼è®¾ç½® | âœ… å·²å®ç° |
| 0x37 | é—¹é’Ÿè®¾ç½® | ğŸ”„ å¾…å®ç° |
| 0x38 | æŸ¥æ‰¾è€³æœº | ğŸ”„ å¾…å®ç° |
| 0x39 | æ‰‹ç”µç­’æ§åˆ¶ | ğŸ”„ å¾…å®ç° |
| 0x40 | è¯­è¨€åˆ‡æ¢ | ğŸ”„ å¾…å®ç° |
| 0x41 | é€šè¯æ§åˆ¶ | âœ… å·²å®ç° |

## ä¸åŸæœ‰BLEåè®®çš„å…³ç³»

### æ‰©å±•æ–¹å¼
1. **éä¾µå…¥å¼æ‰©å±•**: ä¿æŒåŸæœ‰BLEåè®®å®Œæ•´æ€§ï¼Œé€šè¿‡ç‹¬ç«‹Serviceå®ç°
2. **å¤šåè®®å…±å­˜**: ä¸RCSPã€GFPSç­‰å…¶ä»–åè®®å¹¶è¡Œè¿è¡Œ
3. **èµ„æºå…±äº«**: å¤ç”¨åŸæœ‰BLEåè®®æ ˆçš„ATTå±‚å’Œè¿æ¥ç®¡ç†

### è¿æ¥å‚æ•°ä¼˜åŒ–
```c
// è¿æ¥é—´éš”ä¼˜åŒ–è¡¨
static const struct conn_update_param_t connection_param_table[] = {
    {16, 24, 16, 600},  // æ ‡å‡†æ¨¡å¼
    {12, 28, 14, 600},  // å¹³è¡¡æ¨¡å¼  
    {8,  20, 20, 600},  // ä½å»¶æ—¶æ¨¡å¼
};

// iOSè®¾å¤‡ä¼˜åŒ–
{6, 12, 0, 400},  // iOSå¿«é€Ÿå“åº”æ¨¡å¼
```

## æ•°æ®ç»“æ„è®¾è®¡

### çŠ¶æ€ä¿¡æ¯ç»“æ„
```c
struct sbox_state_info {
    bool ble_conn_state;        // BLEè¿æ¥çŠ¶æ€
    bool bt_conn_state;         // ç»å…¸è“ç‰™è¿æ¥çŠ¶æ€
    bool ble_into_no_lantacy;   // ä½å»¶æ—¶æ¨¡å¼
    bool phone_call_mute;       // é€šè¯é™éŸ³
    bool music_states;          // éŸ³ä¹çŠ¶æ€
    bool game_mode;             // æ¸¸æˆæ¨¡å¼
    u8 box_addr[6];            // å½©å±ä»“è“ç‰™åœ°å€
};
```

### éŸ³ä¹ä¿¡æ¯ç»“æ„
```c
struct custom_music_info {
    u16 time;                   // æ’­æ”¾æ—¶é—´
    u8 type_artist_name;        // è‰ºæœ¯å®¶åç§°ç±»å‹
    u8 name_len;               // åç§°é•¿åº¦
    u8 type_album_name;        // ä¸“è¾‘åç§°ç±»å‹
    u8 album_len;              // ä¸“è¾‘é•¿åº¦
    u8 type_title;             // æ ‡é¢˜ç±»å‹
    u8 title_len;              // æ ‡é¢˜é•¿åº¦
    u8 artist_name[256];       // è‰ºæœ¯å®¶åç§°
    u8 album_name[256];        // ä¸“è¾‘åç§°
    u8 title[256];             // æ­Œæ›²æ ‡é¢˜
};
```

## TWSå¯¹è€³åŒæ­¥æœºåˆ¶

å®ç°äº†TWSå¯¹è€³ä¹‹é—´çš„çŠ¶æ€åŒæ­¥ï¼š

```c
enum {
    SYNC_CMD_EQ_SWITCH_0,       // EQæ¨¡å¼åŒæ­¥
    SYNC_CMD_EQ_SWITCH_1,
    SYNC_CMD_ANC_ON,           // ANCå¼€å¯åŒæ­¥
    SYNC_CMD_ANC_OFF,          // ANCå…³é—­åŒæ­¥
    SYNC_CMD_VOLUME_UP,        // éŸ³é‡å¢åŠ åŒæ­¥
    SYNC_CMD_VOLUME_DOWN,      // éŸ³é‡å‡å°‘åŒæ­¥
    SYNC_CMD_CALL_MUTE,        // é€šè¯é™éŸ³åŒæ­¥
    SYNC_CMD_SBOX_POWER_OFF_TOGETHER, // ååŒå…³æœº
};
```

## é›†æˆç‚¹åˆ†æ

### 1. åº”ç”¨å±‚é›†æˆ
- **app_main.c**: æ·»åŠ äº†`sbox_app_init()`åˆå§‹åŒ–è°ƒç”¨
- **vol_sync.c**: éŸ³é‡åŒæ­¥æ—¶è§¦å‘å½©å±ä»“çŠ¶æ€æ›´æ–°

### 2. ç¼–è¯‘ç³»ç»Ÿé›†æˆ
- **Makefile**: æ–°å¢sboxç›¸å…³æºæ–‡ä»¶ç¼–è¯‘
- **å·¥ç¨‹é…ç½®**: æ›´æ–°äº†é¡¹ç›®é…ç½®æ–‡ä»¶ä»¥åŒ…å«æ–°æ¨¡å—

### 3. é…ç½®æ–‡ä»¶æ›´æ–°
å¤šä¸ªJSONé…ç½®æ–‡ä»¶å¾—åˆ°æ›´æ–°ä»¥æ”¯æŒå½©å±ä»“åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯è“ç‰™é…ç½®å’ŒéŸ³é¢‘æµç¨‹é…ç½®ã€‚

## æŠ€æœ¯ç‰¹ç‚¹

### ä¼˜åŠ¿
1. **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **åè®®å¤ç”¨**: å……åˆ†åˆ©ç”¨ç°æœ‰BLEåè®®æ ˆ
3. **çŠ¶æ€ä¸€è‡´æ€§**: å®Œå–„çš„TWSå¯¹è€³åŒæ­¥æœºåˆ¶
4. **ä½åŠŸè€—ä¼˜åŒ–**: æ”¯æŒè¿æ¥å‚æ•°åŠ¨æ€è°ƒæ•´
5. **æ•°æ®ä¿æŠ¤**: CBUFç¼“å†²æœºåˆ¶é˜²æ­¢æ•°æ®ä¸¢å¤±

### æ½œåœ¨æŒ‘æˆ˜
1. **å†…å­˜å ç”¨**: æ–°å¢çº¦1.5KBç¼“å†²åŒºå ç”¨
2. **åŠŸèƒ½å®Œæ•´æ€§**: éƒ¨åˆ†é«˜çº§åŠŸèƒ½ä»éœ€å®Œå–„
3. **å…¼å®¹æ€§æµ‹è¯•**: éœ€è¦éªŒè¯ä¸ä¸åŒå½©å±ä»“å‹å·çš„å…¼å®¹æ€§

## æ€»ç»“

æœ¬æ¬¡æ›´æ–°æˆåŠŸä¸ºæ°ç†AC710Nè€³æœºæ·»åŠ äº†å®Œæ•´çš„å½©å±ä»“äº¤äº’èƒ½åŠ›ï¼Œé€šè¿‡è‡ªå®šä¹‰BLEåè®®å®ç°äº†åŒå‘é€šä¿¡ã€‚æ¶æ„è®¾è®¡åˆç†ï¼ŒåŸºç¡€åŠŸèƒ½å®Œå–„ï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚æ ¸å¿ƒçš„æ’­æ”¾æ§åˆ¶ã€éŸ³é‡è°ƒèŠ‚ã€çŠ¶æ€åŒæ­¥ç­‰åŠŸèƒ½å·²ç»å®ç°ï¼Œå¯ä»¥æ»¡è¶³åŸºæœ¬çš„å½©å±ä»“äº¤äº’éœ€æ±‚ã€‚

# `sbox_uart_app.c` ä¸²å£é€šä¿¡æ”¯æŒï¼ˆä¸982èŠ¯ç‰‡é€šä¿¡ï¼‰

## é€šä¿¡åè®®è§„èŒƒ

è€³æœºæ”¾å…¥å½©å±ä»“åï¼Œé€šè¿‡å•çº¿ä¸²å£ä¸982èŠ¯ç‰‡è¿›è¡Œé€šä¿¡ï¼Œé‡‡ç”¨è‡ªå®šä¹‰åè®®æ ¼å¼ï¼š

```
åè®®æ ¼å¼: [åŒ…å¤´(0xAA)] + [å‘½ä»¤ç±»å‹] + [æ•°æ®] + [æ ¡éªŒå’Œ]
- åŒ…å¤´: 0xAA (CMD_CUSTOM_DEAL)
- å‘½ä»¤ç±»å‹: 1å­—èŠ‚å‘½ä»¤æ ‡è¯†
- æ•°æ®: å¯å˜é•¿åº¦æ•°æ®
- æ ¡éªŒå’Œ: ç´¯åŠ å’Œçš„ä½8ä½
```

## ä¸»è¦é€šä¿¡åŠŸèƒ½

### 1. MACåœ°å€äº¤æ¢

**982â†’è€³æœº (å‘½ä»¤0x10)**ï¼š

```c
// 982å‘é€è¯·æ±‚MACåœ°å€å‘½ä»¤
[0xAA] + [0x10] + [æ ¡éªŒå’Œ]
```

**è€³æœºâ†’982 (äº‹ä»¶0x31)**ï¼š

```c
// è€³æœºå“åº”å‘é€MACåœ°å€
Send_Mac(EARPHONE_MAC_MSG, bt_get_mac_addr(), 6);
æ•°æ®åŒ…: [0xAA] + [0x31] + [6å­—èŠ‚MACåœ°å€] + [æ ¡éªŒå’Œ]
```

**å®ç°å‡½æ•°**ï¼š
```c
void Send_Mac(u8 event, u8 *addr, u8 len)
{
    unsigned char temp[9];
    temp[0] = CMD_CUSTOM_DEAL;    // 0xAA
    temp[1] = event;              // 0x31
    memcpy(&temp[2], addr, 6);    // MACåœ°å€
    // è®¡ç®—æ ¡éªŒå’Œ
    u16 sum = 0;
    for(u8 i=0; i<8; i++) {
        sum += temp[i];
    }
    temp[8] = sum & 0xff;         // æ ¡éªŒå’Œ
    chargestore_api_write(temp, sizeof(temp));
}
```

### 2. æ•°æ®å¤„ç†æµç¨‹

**æ¥æ”¶æ•°æ®å¤„ç†**ï¼š
```c
int user_app_chargestore_data_deal(u8 *buf, u8 len)
{
    switch (buf[0]) {
        case CMD_CUSTOM_DEAL:  // 0xAA
            // æ ¡éªŒå’ŒéªŒè¯
            u16 sum = 0;
            for(u8 i=0; i<len-1; i++) {
                sum += buf[i];
            }
            if(buf[len-1] != (sum&0xFF)) {
                printf("err check\n");
                return 0;
            }
            
            switch (buf[1]) {  // å‘½ä»¤ç±»å‹
                case 0x10:
                    // æ”¶åˆ°MACåœ°å€è¯·æ±‚ï¼Œå‘é€æœ¬æœºMAC
                    Send_Mac(EARPHONE_MAC_MSG, bt_get_mac_addr(), 6);
                    break;
                // ... å…¶ä»–å‘½ä»¤å¤„ç†
            }
            break;
    }
    return 0;
}
```

**æ•°æ®æ¥æ”¶å¤„ç†å‡½æ•°åœ¨ä»€ä¹ˆåœ°æ–¹è¢«è°ƒç”¨**

`apps\earphone\tools\app_testbox.c`

```c
extern int user_app_chargestore_data_deal(u8 *buf, u8 len);
//æ•°æ®æ‰§è¡Œå‡½æ•°,åœ¨ä¸²å£ä¸­æ–­è°ƒç”¨
//å½“è€³æœºå¯¹åº”å¼•è„šæœ‰é«˜ä½ç”µå¹³æ—¶è§¦å‘ä¸­æ–­ï¼Œåœ¨ä¸­æ–­å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨app_testbox_data_handlerå¤„ç†ä¸²å£æ•°æ®
static int app_testbox_data_handler(u8 *buf, u8 len)
{
    u8 send_buf[36];
    send_buf[0] = buf[0];
    //ä¼˜å…ˆå¤„ç†æ¥è‡ª982çš„ä¸²å£æ•°æ®åŒ…
    user_app_chargestore_data_deal(buf,len);
    //æ•°æ®åŒ…å¤´ä¸æ˜¯0XAAçš„è¯å°±ä¼šå°è¯•è¿›å…¥ä¸‹é¢çš„case,å¦‚æœéƒ½ä¸æ˜¯é‚£å°±ä¸å¤„ç†
    switch (buf[0]) {
    case CMD_BOX_MODULE:
        app_testbox_sub_cmd_handle(send_buf, sizeof(send_buf), buf, len);
        break;

    case CMD_BOX_UPDATE:
        __this->testbox_status = 1;
        printf(">>>[test]:buf13 = 0x%x, chip_id = 0x%x\n", buf[13], get_jl_chip_id());
        if (buf[13] == 0xff || buf[13] == get_jl_chip_id() || buf[13] == get_jl_chip_id2()) {
            //è¿›è¡Œä¸²å£å‡çº§æµç¨‹
            //vm_flush2flash();æ—¶é—´å¤„ç†è¾ƒé•¿ï¼Œä¸èƒ½å¤Ÿåœ¨ä¸²å£ä¸­æ–­å¤„åšå¤„ç†ï¼Œéœ€è¦å‘é€åˆ°çº¿ç¨‹è¿›è¡Œå¤„ç†
#if (defined CONFIG_CPU_BR50) || (defined CONFIG_CPU_BR52) || (defined CONFIG_CPU_BR56) // è€³æœºç›®å‰ä»…æ”¯æŒbr50\br52
            if (buf[15]) { // å­˜åœ¨æ–°çš„å‡çº§æµç¨‹
                send_buf[1] = 0xAA;//å›å¤0xAAè¡¨ç¤ºä½¿ç”¨æ–°çš„ä¸²å£å‡çº§æµç¨‹ uart_ota2.bin
                chargestore_api_write(send_buf, 2);
            }
#endif
            testbox_event_to_user(&buf[15], CMD_BOX_UPDATE, 1);
        } else if (buf[13] == 0xff) {
            //è¿›è¡Œç”µé‡æ›´æ–°æµç¨‹,éœ€è¦åŠæ—¶å›å¤
            send_buf[1] = 0xff;
            WRITE_LIT_U32(&send_buf[2], support_update_mask);
            chargestore_api_write(send_buf, 2 + sizeof(support_update_mask));
            log_info("rsp update_mask\n");
        } else {
            send_buf[1] = 0x01;//chip id err
            chargestore_api_write(send_buf, 2);
        }
        break;
    case CMD_BOX_TWS_CHANNEL_SEL:
        __this->testbox_status = 1;
        if (len == 3) {
            __this->keep_tws_conn_flag = buf[2];
            putchar('K');
        }  else {
            __this->keep_tws_conn_flag = 0;
        }
        __this->channel = (buf[1] == TWS_CHANNEL_LEFT) ? 'L' : 'R';
#ifdef UPDATE_VOICE_REMIND
        if (0 == __this->event_hdl_flag || app_var.update_tone_end_flag == 1) {
#else
        if (0 == __this->event_hdl_flag) {
#endif
            testbox_event_to_user(NULL, CMD_BOX_TWS_CHANNEL_SEL, 0);
            __this->event_hdl_flag = 1;
        }
        if (__this->bt_init_ok) {
            len = chargestore_get_tws_remote_info(&send_buf[1]);
            chargestore_api_write(send_buf, len + 1);
        } else {
            send_buf[0] = CMD_UNDEFINE;
            chargestore_api_write(send_buf, 1);
        }
        break;
#if TCFG_USER_TWS_ENABLE
    case CMD_BOX_TWS_REMOTE_ADDR:
        __this->testbox_status = 1;
        testbox_event_to_user((u8 *)&buf[1], buf[0], len - 1);
        chargestore_api_set_timeout(100);
        break;
#endif
    //ä¸æ˜¯æµ‹è¯•ç›’å‘½ä»¤,è¿”å›0,æœªå¤„ç†
    default:
        return 0;
    }
    return 1;
}

CHARGESTORE_HANDLE_REG(testbox, app_testbox_data_handler);
```

### 3.ä¸²å£å‘é€æ•°æ®å‡½æ•°

- `chargestore_api_write`

ä¸ä¸€å®šéƒ½æ˜¯å‘982å‘é€çš„ã€‚è¿˜æœ‰å‘æµ‹è¯•ç›’å‘é€ä¸²å£æ•°æ®çš„åœºæ™¯ã€‚

# å½©å±ä»“çš„è€³æœºç”µé‡æ¥æº

## é€šè¿‡ä¸²å£å‘å……ç”µä»“ï¼ˆå¯èƒ½æ˜¯982ï¼‰å‘é€ç”µé‡ä¿¡æ¯

  **åœºæ™¯ï¼šè€³æœºæ”¾å…¥å……ç”µä»“æ—¶çš„ç‰©ç†æ¥è§¦é€šä¿¡**

- `charge_store.c:789, 802`
- `app_chargestore_data_handler`

```c
static int app_chargestore_data_handler(u8 *buf, u8 len)
{
    //è¿™é‡Œæ˜¯å……ç”µä»“å‘é€è¿‡æ¥çš„æŒ‡ä»¤æ—¶å¯¹åº”çš„å›å¤
    //å‘é€è€³æœºmacåœ°å€å•ç‹¬å†™åœ¨äº†ä¸€ä¸ªæ¨¡å—ä¸­
    u8 send_buf[36];
    /* log_info_hexdump(buf, len); */
    chargestore_shutdown_reset();
    //å–å‡ºæ•°æ®åŒ…å¤´ï¼Œç”¨äºå›å¤æŒ‡ä»¤æ—¶ä½¿ç”¨ç›¸åŒæ•°æ®åŒ…å¤´
    //åŒ…å¤´ä¹Ÿæ˜¯æŒ‡ä»¤ç±»å‹ï¼Œä¸æ˜¯0XAAå°±è¯´æ˜ï¼Œç»ˆç«¯ä¸æ˜¯å½©å±ä»“çš„ä¸»æ§
    //å¯èƒ½å°±æ˜¯æ™®é€šå……ç”µä»“ä¸­ä¹Ÿå¯ä»¥å‘è€³æœºå‘æŒ‡ä»¤
    send_buf[0] = buf[0];
    
//......

  // å¼€ç›–æ—¶å‘é€ç”µé‡
  case CMD_POWER_LEVEL_OPEN:
      send_buf[1] = chargestore_get_vbat_percent();  // ç”µé‡ç™¾åˆ†æ¯”
      send_buf[2] = chargestore_get_det_level(__this->chip_type);
      chargestore_api_write(send_buf, 3);  // é€šè¿‡ä¸²å£å‘é€ç»™982

  // åˆç›–æ—¶å‘é€ç”µé‡
  case CMD_POWER_LEVEL_CLOSE:
      send_buf[1] = chargestore_get_vbat_percent();  // ç”µé‡ç™¾åˆ†æ¯”
      send_buf[2] = chargestore_get_det_level(__this->chip_type);
      chargestore_api_write(send_buf, 3);  // é€šè¿‡ä¸²å£å‘é€ç»™982
```

###   ç”µé‡è·å–å‡½æ•°

```c
u8 chargestore_get_vbat_percent(void)
{
    u8 power;
#if CONFIG_DISPLAY_DETAIL_BAT
    power = get_vbat_percent();//æ˜¾ç¤ºä¸ªä½æ•°çš„ç”µé‡
#else
    power = get_self_battery_level() * 10 + 10; //æ˜¾ç¤º10%~100%
#endif

#if TCFG_CHARGE_ENABLE
    if (get_charge_full_flag()) {
        power = 100;
    } else if (power == 100) {
        power = 99;
    }
    if (get_charge_online_flag()) {
        power |= BIT(7);
    }
#endif
    return power;
}
```



## é€šè¿‡BLEç›´æ¥å‘å½©å±ä»“ä¸»æ§å‘é€ç”µé‡ä¿¡æ¯

- **åœºæ™¯ï¼šè€³æœºä¸å½©å±ä»“BLEè¿æ¥æ—¶çš„å®æ—¶çŠ¶æ€åŒæ­¥**

- å®ç°ä½ç½®ï¼š`sbox_user_app.c:165`

```c
//åŒæ­¥è€³æœºç”µé‡çŠ¶æ€ç»™ä»“
__attribute__((weak))
void custom_sync_vbat_percent_state(void)
{
    u8 bat_state[3];
    u8 channel = tws_api_get_local_channel();

    // byte0:Lè€³æœºç”µé‡---- byte1ï¼šRè€³æœºç”µé‡
    if ('L' == channel) {
        bat_state[0] = 10*(battery_value_to_phone_level()+1);//get_vbat_percent();
        bat_state[1] = get_tws_sibling_bat_persent();
    } else if ('R' == channel) {
        bat_state[0] = get_tws_sibling_bat_persent();
        bat_state[1] = 10*(battery_value_to_phone_level()+1);//get_vbat_percent();
    }else {
        bat_state[0] = 10*(battery_value_to_phone_level()+1);//get_vbat_percent();
        bat_state[1] = 0xff;
    }
    bat_state[2]=bt_get_total_connect_dev(); 
    
    log_info("sscustom_sync_vbat_percent_state bat_states:%x, vbat_percent:%d, tws_vbat_percent:%d", bat_state, get_vbat_percent(), get_tws_sibling_bat_persent());
    sbox_ble_att_send_data(CUSTOM_BLE_BATTERY_STATE_CMD, bat_state, sizeof(bat_state)); //å°†å½“å‰ç”µé‡çŠ¶æ€å›å¤ç»™æ‰‹è¡¨
}
```

  ä¸¤ç§æ–¹å¼çš„å·®å¼‚å¯¹æ¯”

| é¡¹ç›®     | ä¸²å£é€šä¿¡(â†’982)             | BLEé€šä¿¡(â†’å½©å±ä»“ä¸»æ§)              |
| -------- | -------------------------- | --------------------------------- |
| è§¦å‘æ—¶æœº | å¼€ç›–/åˆç›–ç‰©ç†åŠ¨ä½œ          | å®æ—¶çŠ¶æ€å˜åŒ–æ—¶                    |
| æ•°æ®å†…å®¹ | å•è€³æœºç”µé‡+å……ç”µçŠ¶æ€        | åŒè€³ç”µé‡+è¿æ¥çŠ¶æ€                 |
| ä¼ è¾“æ–¹å¼ | chargestore_api_write()    | sbox_ble_att_send_data()          |
| å‘½ä»¤ID   | CMD_POWER_LEVEL_OPEN/CLOSE | CUSTOM_BLE_BATTERY_STATE_CMD(0x3) |
| ç”µé‡æ ¼å¼ | 10%-100%+å……ç”µæ ‡å¿—ä½        | å·¦å³è€³ç‹¬ç«‹ç”µé‡å€¼                  |
| ç”¨é€”     | åŸºç¡€ç”µé‡åŒæ­¥ç»™å……ç”µä»“       | å½©å±å®æ—¶æ˜¾ç¤ºç”µé‡çŠ¶æ€              |

  å®é™…å·¥ä½œæµç¨‹

  1. å…¥ä»“æ—¶ï¼š

    - ç‰©ç†æ¥è§¦è§¦å‘â†’ä¸²å£å‘é€ç”µé‡ç»™982â†’982è½¬å‘ç»™å½©å±ä»“ä¸»æ§
  2. BLEè¿æ¥åï¼š

    - ç”µé‡å˜åŒ–è§¦å‘â†’ç›´æ¥BLEå‘é€ç»™å½©å±ä»“ä¸»æ§â†’å½©å±å®æ—¶æ›´æ–°æ˜¾ç¤º
  3. å‡ºä»“æ—¶ï¼š

    - ç‰©ç†æ–­å¼€è§¦å‘â†’ä¸²å£å‘é€æœ€ç»ˆç”µé‡ç»™982â†’æ–­å¼€BLEè¿æ¥

  è€³æœºSDKé‡‡ç”¨äº†åŒé€šé“ç”µé‡åŒæ­¥æœºåˆ¶ï¼š
  - ä¸²å£é€šé“ï¼šè´Ÿè´£åŸºç¡€çš„ç”µé‡ä¿¡æ¯äº¤æ¢ï¼Œç¡®ä¿å……ç”µä»“äº†è§£è€³æœºç”µé‡çŠ¶æ€
  - BLEé€šé“ï¼šè´Ÿè´£å®æ—¶çš„ç”µé‡çŠ¶æ€æ˜¾ç¤ºï¼Œæ”¯æŒå½©å±ä»“çš„åŠ¨æ€ç”µé‡æ˜¾ç¤ºåŠŸèƒ½

  è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†åŸºæœ¬åŠŸèƒ½çš„å¯é æ€§ï¼ˆä¸²å£ç‰©ç†è¿æ¥ï¼‰ï¼Œåˆæä¾›äº†ä¸°å¯Œçš„ç”¨æˆ·ä½“éªŒï¼ˆBLEå®æ—¶æ˜¾ç¤ºï¼‰ã€‚

### BLEå›è°ƒåŒæ­¥ç”µé‡å‡½æ•°æ—¶æœº

```c
struct s_box_app_cb sbox_cb_func = {
    .sbox_sync_battery_info = custom_sync_vbat_percent_state,
};
static int sbox_app_power_event_handler(int *msg)
{
    //è¿™ä¸ªå¤„ç†å‡½æ•°æ³¨å†Œè¿›ç³»ç»Ÿäº†
    //å½“è€³æœºæœ‰MSG_FROM_BATTERYç±»å‹ä¿¡æ¯æ—¶ï¼Œåº”è¯¥ä¼šè°ƒç”¨ã€‚
    //ä»è€Œé€šè¿‡BLEåŒæ­¥åˆ°å½©å±ä»“
    switch (msg[0]) {
    case POWER_EVENT_SYNC_TWS_VBAT_LEVEL:
        printf("POWER_EVENT_SYNC_TWS_VBAT_LEVEL----update sbox bat");
        sbox_cb_func.sbox_sync_battery_info();
        break;
    case POWER_EVENT_POWER_CHANGE:
        printf("POWER_EVENT_POWER_CHANGE----update sbox bat");
        sbox_cb_func.sbox_sync_battery_info();
        break;
    }
    return 0;
}

APP_MSG_HANDLER(sbox_level_msg_entry) = {
    .owner      = 0xff,
    .from       = MSG_FROM_BATTERY,
    .handler    = sbox_app_power_event_handler,
};
```

### æ€»ç»“

å¯ä»¥åœ¨ä»“è·å–è€³æœºç”µé‡æ—¶åŠ æ‰“å°è¯´æ˜ç”µé‡æ¥æºï¼Œå°±çŸ¥é“åˆ°åº•æ˜¯è€³æœºBLEå‘é€çš„è¿˜æ˜¯982ä¸­è½¬è¿‡æ¥çš„ã€‚

