# 公版实现流程

```shell
[00:21:04.152]online_spp_rx(15) 
[00:21:04.152]tws_online_spp_in_task
[00:21:04.153]ONLINE_SPP_DATA0000
FE DC BA C0 19 00 07 26 01 01 00 3C 00 01 EF 
[00:21:04.156][SNIFF]check_sniff_enable
[00:21:04.157]dual_conn_btstack_event_handler:32
[00:21:04.158][EARPHONE] BT STATUS DEFAULT
[00:21:04.158]ui_bt_stack_msg_handler:32
[00:21:04.159][LED_UI]MSG_FROM_BT_STACK----ui_bt_stack_msg_handler----BT_STATUS_SNIFF_STATE_UPDATE
[00:21:04.161]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 199, sec:3c
3C 00 00 
[00:21:04.163]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 269, flag:1
3C 00 00 00 
[00:21:04.165]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 290, flag:1
3C 00 00 00 
[00:21:04.168]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_device_timeout_handle, 159, find_device_key_flag=1
[00:21:04.170]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
00 01 00 
[00:21:04.188]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 269, flag:2
3C 00 00 00 
[00:21:04.192]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 295, flag:2
3C 00 00 01 
[00:21:04.194]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 233
[00:21:04.196]sys_timeout_del(earphone_mute_timer);
[00:21:04.496]rcsp_find earphone_mute, channel:1, mute:0
[00:21:04.497]rcsp_find earphone_mute, channel:2, mute:0
[00:21:04.498]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 200, way:0, player:1
[00:21:04.501]bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear
[00:21:04.504]tone_player: tone_en/find_ear.*
```

## APP操作后的调用链

```c
收到SPP数据回调函数：
static void online_spp_recieve_cbk(void *hdl, void *remote_addr, u8 *buf, u16 len)
{
    log_info("online_spp_rx(%d) \n", len);
    /* log_info_hexdump(buf, len); */
    tws_online_spp_send(ONLINE_SPP_DATA, buf, len, 1);
}
双耳同步数据：
void tws_online_spp_send(u8 cmd, u8 *_data, u16 len, u8 tx_do_action)
{
    u8 *data = malloc(len + 4 + 4);
    data[0] = cmd;
    data[1] = tx_do_action;
    little_endian_store_16(data, 2, len);
    memcpy(data + 4, _data, len);
#if TCFG_USER_TWS_ENABLE
    if (tws_api_get_role() == TWS_ROLE_SLAVE) {
        // TWS 从机不需要同步给主机
        tws_online_spp_in_task(data);
        return;
    }
    int err = tws_api_send_data_to_sibling(data, len + 4, 0x096A5E82);
    if (err) {
        tws_online_spp_in_task(data);
    } else {
        free(data);
    }
#else
    tws_online_spp_in_task(data);
#endif
}

解析数据：
static void tws_online_spp_in_task(u8 *data)
{
    printf("tws_online_spp_in_task");
    u16 data_len = little_endian_read_16(data, 2);
    switch (data[0]) {
 //...
    case ONLINE_SPP_DATA:
        puts("ONLINE_SPP_DATA0000\n");
        log_info_hexdump(&data[4], data_len);
#if (TCFG_ANC_TOOL_DEBUG_ONLINE && TCFG_AUDIO_ANC_ENABLE)
        if (app_anctool_spp_rx_data(&data[4], data_len)) {
            free(data);
            return;
        }
#endif
#if TCFG_CFG_TOOL_ENABLE
        if (!cfg_tool_combine_rx_data(&data[4], data_len)) {
            free(data);
            return;
        }
#endif
        db_api->packet_handle(&data[4], data_len);

        //loop send data for test
        /* if (online_spp_send_data_check(data_len)) { */
        /*online_spp_send_data(&data[4], data_len);*/
        /* } */
        break;
    }
    free(data);
}
```



