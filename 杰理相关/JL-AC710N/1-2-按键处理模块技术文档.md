# æŒ‰é”®å¤„ç†æ¨¡å—æŠ€æœ¯æ–‡æ¡£

## ç›®å½•
1. [æ¨¡å—æ¦‚è¿°](#æ¨¡å—æ¦‚è¿°)
2. [æŒ‰é”®ç¡¬ä»¶é…ç½®å±‚](#æŒ‰é”®ç¡¬ä»¶é…ç½®å±‚)
3. [æŒ‰é”®é©±åŠ¨å±‚](#æŒ‰é”®é©±åŠ¨å±‚)
4. [æŒ‰é”®äº‹ä»¶å¤„ç†å±‚](#æŒ‰é”®äº‹ä»¶å¤„ç†å±‚)
5. [æŒ‰é”®æ¶ˆæ¯åˆ†å‘å±‚](#æŒ‰é”®æ¶ˆæ¯åˆ†å‘å±‚)
6. [æŒ‰é”®é‡æ˜ å°„å±‚](#æŒ‰é”®é‡æ˜ å°„å±‚)
7. [å®¢æˆ·å·®å¼‚åŒ–é…ç½®](#å®¢æˆ·å·®å¼‚åŒ–é…ç½®)
8. [å®Œæ•´è°ƒç”¨é“¾åˆ†æ](#å®Œæ•´è°ƒç”¨é“¾åˆ†æ)
9. [å¼€å‘è°ƒè¯•æŒ‡å—](#å¼€å‘è°ƒè¯•æŒ‡å—)

---

## æ¨¡å—æ¦‚è¿°

æŒ‰é”®å¤„ç†æ¨¡å—æ˜¯TWSè€³æœºç”¨æˆ·äº¤äº’çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ä»ç¡¬ä»¶æŒ‰é”®è§¦å‘åˆ°åº”ç”¨åŠŸèƒ½æ‰§è¡Œçš„å®Œæ•´æµç¨‹ã€‚æ•´ä¸ªæ¨¡å—é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç¡®ä¿ç¡¬ä»¶æŠ½è±¡ã€äº‹ä»¶å¤„ç†å’ŒåŠŸèƒ½æ˜ å°„çš„æ¸…æ™°åˆ†ç¦»ã€‚

### æ¶æ„å±‚æ¬¡å›¾
```
åº”ç”¨åŠŸèƒ½å±‚
â”œâ”€â”€ éŸ³é‡æ§åˆ¶ (bt_volume_up/down)
â”œâ”€â”€ æ’­æ”¾æ§åˆ¶ (éŸ³ä¹æš‚åœ/æ’­æ”¾)
â”œâ”€â”€ é€šè¯æ§åˆ¶ (æ¥å¬/æŒ‚æ–­)
â””â”€â”€ æ¨¡å¼åˆ‡æ¢ (ANCã€ä½å»¶è¿Ÿç­‰)
        â†‘
æŒ‰é”®é‡æ˜ å°„å±‚ (bt_key_power_msg_remap)
â”œâ”€â”€ å®¢æˆ·å·®å¼‚åŒ–é…ç½®
â”œâ”€â”€ TWSå·¦å³è€³åŒºåˆ†å¤„ç†
â”œâ”€â”€ åœºæ™¯æ¨¡å¼åˆ¤æ–­
â””â”€â”€ æŒ‰é”®åŠ¨ä½œæ˜ å°„
        â†‘
æŒ‰é”®æ¶ˆæ¯åˆ†å‘å±‚ (app_get_message)
â”œâ”€â”€ æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†
â”œâ”€â”€ æ¶ˆæ¯æ‹¦æˆªæœºåˆ¶
â””â”€â”€ æŒ‰é”®äº‹ä»¶è½¬æ¢
        â†‘
æŒ‰é”®äº‹ä»¶å¤„ç†å±‚ (key_event_handler)
â”œâ”€â”€ å¤šå‡»è¯†åˆ« (å•å‡»ã€åŒå‡»ã€ä¸‰å‡»ç­‰)
â”œâ”€â”€ é•¿æŒ‰æ—¶é—´è®¡ç®—
â”œâ”€â”€ TWSåŒæ­¥å¤„ç†
â””â”€â”€ æ¶ˆæ¯å°è£…
        â†‘
æŒ‰é”®é©±åŠ¨å±‚ (key_driver_scan)
â”œâ”€â”€ ç¡¬ä»¶çŠ¶æ€æ‰«æ
â”œâ”€â”€ æŒ‰é”®æ¶ˆæŠ–å¤„ç†
â”œâ”€â”€ äº‹ä»¶ç±»å‹è¯†åˆ«
â””â”€â”€ å®šæ—¶æ‰«ææœºåˆ¶
        â†‘
æŒ‰é”®ç¡¬ä»¶é…ç½®å±‚
â”œâ”€â”€ ADKEY (æ¨¡æ‹ŸæŒ‰é”®)
â”œâ”€â”€ IOKEY (æ•°å­—æŒ‰é”®)  
â”œâ”€â”€ è§¦æ‘¸æŒ‰é”® (Touch Key)
â””â”€â”€ ç¡¬ä»¶å‚æ•°é…ç½®
```

---

## æŒ‰é”®ç¡¬ä»¶é…ç½®å±‚

### 1. æ”¯æŒçš„æŒ‰é”®ç±»å‹

#### ADKEY (æ¨¡æ‹ŸæŒ‰é”®)
é€šè¿‡ADCé‡‡æ ·ä¸åŒç”µé˜»å€¼æ¥åŒºåˆ†æŒ‰é”®ï¼Œé€‚åˆå¤šä¸ªæŒ‰é”®å…±ç”¨ä¸€ä¸ªIOå£çš„åœºæ™¯ã€‚

- å¸¸è§çš„è¿˜æ˜¯IOä½œä¸ºå®ä½“æŒ‰é”®
- ä»¥åŠè§¦æ‘¸æŒ‰é”®ä¸ºä¸»

```c
// æ–‡ä»¶: apps/earphone/board/adkey_config.c
struct adkey_platform_data {
    u8 adkey_pin;           // ADCè¾“å…¥å¼•è„š
    u8 extern_up_en;        // å¤–éƒ¨ä¸Šæ‹‰ä½¿èƒ½
    u8 ad_channel;          // ADCé€šé“å·
    u8 long_press_enable;   // é•¿æŒ‰å¤ä½ä½¿èƒ½
    u8 long_press_time;     // é•¿æŒ‰å¤ä½æ—¶é—´(ç§’)
    u16 ad_value[CONFIG_ADKEY_MAX_NUM];    // ADåˆ¤æ–­é˜ˆå€¼
    u8 key_value[CONFIG_ADKEY_MAX_NUM];    // å¯¹åº”çš„æŒ‰é”®å€¼
};

// ADKEYç”µé˜»è¡¨é…ç½®ç¤ºä¾‹
static const struct adkey_res_value adkey_res_table[] = {
    { .key_value = KEY_AD_NUM0, .res_value = 0 },     // 0æ¬§ç”µé˜»
    { .key_value = KEY_AD_NUM1, .res_value = 2200 },  // 2.2Kæ¬§ç”µé˜»  
    { .key_value = KEY_AD_NUM2, .res_value = 3300 },  // 3.3Kæ¬§ç”µé˜»
    { .key_value = KEY_AD_NUM3, .res_value = 4700 },  // 4.7Kæ¬§ç”µé˜»
    { .key_value = KEY_AD_NUM4, .res_value = 6800 },  // 6.8Kæ¬§ç”µé˜»
};
```

**ADKEYå·¥ä½œåŸç†**ï¼š

1. ä¸Šæ‹‰ç”µé˜»ä¸æŒ‰é”®ç”µé˜»åˆ†å‹
2. ADCé‡‡æ ·åˆ†å‹å€¼
3. æ ¹æ®é‡‡æ ·å€¼èŒƒå›´åˆ¤æ–­å…·ä½“æŒ‰é”®
4. è‡ªåŠ¨è®¡ç®—å¹¶æ’åºADé˜ˆå€¼

#### IOKEY (æ•°å­—æŒ‰é”®)
ç›´æ¥ä½¿ç”¨GPIOçš„é«˜ä½ç”µå¹³æ£€æµ‹ï¼Œæ¯ä¸ªæŒ‰é”®å ç”¨ä¸€ä¸ªIOå£ã€‚

```c
// æ–‡ä»¶: apps/earphone/board/iokey_config.c
struct iokey_platform_data {
    int num;                           // æŒ‰é”®æ•°é‡
    struct iokey_port *port;           // æŒ‰é”®ç«¯å£é…ç½®
    u8 enable;                         // ä½¿èƒ½æ ‡å¿—
    u8 long_press_enable;              // é•¿æŒ‰å¤ä½ä½¿èƒ½
    u8 long_press_time;                // é•¿æŒ‰æ—¶é—´
    u8 long_press_port;                // é•¿æŒ‰æ£€æµ‹ç«¯å£
    u8 long_press_level;               // é•¿æŒ‰æ£€æµ‹ç”µå¹³
};

struct iokey_port {
    u8 connect_way;                    // è¿æ¥æ–¹å¼ (é«˜ç”µå¹³/ä½ç”µå¹³è§¦å‘)
    union {
        struct {
            u8 port;                   // GPIOç«¯å£å·
        } one_io;
    } key_type;
    u8 key_value;                      // æŒ‰é”®å€¼
};

// IOKEYé…ç½®ç¤ºä¾‹
static const struct iokey_info g_iokey_info[] = {
    {
        .key_io = IO_PORTB_03,          // PB3å¼•è„š
        .key_value = KEY_POWER,         // ç”µæºé”®
        .detect = 0,                    // ä½ç”µå¹³è§¦å‘
        .long_press_reset_enable = 1,   // ä½¿èƒ½é•¿æŒ‰å¤ä½
        .long_press_reset_time = 8,     // 8ç§’å¤ä½
    },
};
```

#### Touch Key (è§¦æ‘¸æŒ‰é”®)
æ”¯æŒç”µå®¹è§¦æ‘¸æ£€æµ‹ï¼Œå…·æœ‰æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

```c
// ä½åŠŸè€—è§¦æ‘¸æŒ‰é”®é…ç½®
struct lp_touch_key_platform_data {
    u8 enable;                         // è§¦æ‘¸æŒ‰é”®ä½¿èƒ½
    u8 key_cnt;                        // æŒ‰é”®æ•°é‡
    u8 sensitivity;                    // çµæ•åº¦è®¾ç½®
    u8 press_cfg;                      // æŒ‰å‹é…ç½®
    u8 release_cfg;                    // é‡Šæ”¾é…ç½®
    const struct lp_touch_key_port *port; // è§¦æ‘¸æŒ‰é”®ç«¯å£é…ç½®
};
```

### 2. ç¡¬ä»¶åˆå§‹åŒ–æµç¨‹

```c
// æ–‡ä»¶: apps/earphone/app_main.c:393
void app_task_init() {
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
    
    key_driver_init();  // æŒ‰é”®é©±åŠ¨åˆå§‹åŒ–
    
    // ... åç»­åˆå§‹åŒ–ä»£ç 
}
```

åˆå§‹åŒ–è¿‡ç¨‹è¯¦è§£ï¼š
```c
// æ–‡ä»¶: apps/common/device/key/key_driver.c:156
void key_driver_init(void) {
    const struct key_driver_ops *key;
    
    // éå†æ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
    list_for_each_key(key) {
        if (key->param) {
            key->param->last_key = NO_KEY;  // åˆå§‹åŒ–æŒ‰é”®çŠ¶æ€
        }
        
        if (!key->key_init) {
            continue;
        }
        
        // è°ƒç”¨å…·ä½“æŒ‰é”®ç±»å‹çš„åˆå§‹åŒ–å‡½æ•°
        if ((!key->key_init()) && key->get_value) {
            // æ³¨å†ŒæŒ‰é”®æ‰«æå®šæ—¶å™¨ï¼Œé»˜è®¤æ‰«æå‘¨æœŸ10ms
            sys_s_hi_timer_add((void *)key, key_driver_scan, key->scan_time);
            
            if (key->idle_query_en) {
                g_key_idle_query_en = true;  // å¯ç”¨ä½åŠŸè€—æŸ¥è¯¢
            }
        }
    }
}
```

---

- æ¯ç§æŒ‰é”®ç±»å‹çš„é…ç½®éƒ½åœ¨å¯¹åº”çš„æºæ–‡ä»¶ä¸­
  - `SDK\apps\common\device\key\adkey.c`
  - `SDK\apps\common\device\key\iokey.c`
  - `SDK\apps\common\device\key\touch_key.c`
- è¿™é‡Œè´Ÿè´£å°†å¯¹åº”çš„æŒ‰é”®é…ç½®ä»¥åŠé©±åŠ¨å‡½æ•°æ³¨å†Œè¿›osç³»ç»Ÿï¼Œä¿è¯åº”ç”¨å±‚åŠŸèƒ½ã€‚

## æŒ‰é”®é©±åŠ¨å±‚ï¼ˆé‡è¦ï¼‰

### 1. æŒ‰é”®æ‰«ææœºåˆ¶

æŒ‰é”®é©±åŠ¨é‡‡ç”¨**å®šæ—¶æ‰«æ**æ–¹å¼ï¼Œé»˜è®¤æ¯10msæ‰«æä¸€æ¬¡æ‰€æœ‰æŒ‰é”®çŠ¶æ€ã€‚

```c
// æ–‡ä»¶: apps/common/device/key/key_driver.c:35
/* --------------------------------------------------------------------------*/
/**
 * @brief æŒ‰é”®æ‰«æå‡½æ•°ï¼Œæ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
 *
 * @param key_ops:æŒ‰é”®æ“ä½œå¥æŸ„
 */
/* ----------------------------------------------------------------------------*/
static void key_driver_scan(void *key_ops)
{
    struct key_driver_ops *key_handler = (struct key_driver_ops *)key_ops;
    struct key_driver_para *scan_para = (struct key_driver_para *)key_handler->param;

    u8 key_event = 0;
    u8 cur_key_value = NO_KEY;
    u8 key_value = 0;
    struct key_event key = {0};

    key.init = 1;
    //åŒºåˆ†æŒ‰é”®ç±»å‹
    key.type = key_handler->key_type;

    cur_key_value = key_handler->get_value();

    if (cur_key_value != NO_KEY) {
        //35*10Ms
        g_is_key_active = 35;
    } else if (g_is_key_active) {
        g_is_key_active --;
    }
    //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
    //å½“å‰æŒ‰é”®å€¼ä¸ä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0;
    if (cur_key_value != scan_para->filter_value && key_handler->filter_time) {
        //æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
        scan_para->filter_cnt = 0;
        //è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
        scan_para->filter_value = cur_key_value;
        //ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›ä¸åšå¤„ç†
        return;
    }
    //å½“å‰æŒ‰é”®å€¼ä¸ä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ 
    if (scan_para->filter_cnt < key_handler->filter_time) {
        scan_para->filter_cnt++;
        return;
    }
    //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»å‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOLD)æŠ¬èµ·)

    if (cur_key_value != scan_para->last_key) {
        if (cur_key_value == NO_KEY) {
            //cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
            if (scan_para->press_cnt >= key_handler->long_time) {
                //é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åè¢«æŒ‰é”®æŠ¬èµ·;
                key_event = KEY_ACTION_UP;
                key_value = scan_para->last_key;
                goto __notify;
            } else {
                key_event = KEY_ACTION_CLICK;
                key_value = scan_para->last_key;
                scan_para->click_delay_cnt = 1;
                goto __notify;
            }
        } else {
            //cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
            scan_para->press_cnt = 1;   //ç”¨äºåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
            scan_para->click_delay_cnt = 0;

            key_down_event_handler(cur_key_value);
        }
        //è¿”å›, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
        goto __scan_end;
    } else {
        //cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
        if (cur_key_value == NO_KEY) {
            //last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
            if (scan_para->click_delay_cnt > 0) {
                scan_para->click_delay_cnt++;
                if (scan_para->click_delay_cnt > key_handler->click_delay_time) {
                    key_event = KEY_ACTION_NO_KEY;
                    scan_para->click_delay_cnt = 0;
                    goto __notify;   //æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
                }
            }
            goto __scan_end;     //æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
        } else {
            //last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºåˆ¤æ–­longå’Œhold
            scan_para->press_cnt++;
            if (scan_para->press_cnt == key_handler->long_time) {
                key_event = KEY_ACTION_LONG;
            } else if (scan_para->press_cnt >= key_handler->hold_time) {
                key_event = KEY_ACTION_HOLD;
                scan_para->press_cnt = key_handler->long_time;
            } else {
                goto __scan_end; //press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›
            }
            key_value = cur_key_value;
            goto __notify;
        }
    }

__notify:
    key.event = key_event;
    key.value = key_value;
    key.tmr = jiffies_to_msecs(jiffies);
    /* printf("key_value: 0x%x, event: %d\n", key_value, key_event); */
    key_event_handler(&key);
__scan_end:
    scan_para->last_key = cur_key_value;
    return;
}
```

- è¿™é‡Œå°±æ˜¯ç»è¿‡æŒ‰é”®æ‰«ææ¶ˆæŠ–åï¼Œåˆ¤æ–­ä¸ºæ˜¯ä»€ä¹ˆæŒ‰é”®äº‹ä»¶
- ä¸ŠæŠ¥å‘ç”Ÿçš„å¯¹åº”æŒ‰é”®äº‹ä»¶ï¼Œå¹¶ä¼ é€’ç»™æŒ‰é”®äº‹ä»¶**å¤„ç†å‡½æ•°**ã€‚
- åœ¨å¯¹åº”å¤„ç†å‡½æ•°ä¸­åˆ¤æ–­å¯¹åº”çš„caseæ˜¯ä»€ä¹ˆæŒ‰é”®äº‹ä»¶å°±å¯ä»¥åœ¨caseä¸­å†™å¤„ç†åŠŸèƒ½äº†ã€‚
- è¿™é‡Œåªæ˜¯ä¸ŠæŠ¥åŸºç¡€æŒ‰é”®äº‹ä»¶
  - KEY_ACTION_UP
  - KEY_ACTION_CLICK
  - KEY_ACTION_NO_KEY
  - KEY_ACTION_LONG
  - KEY_ACTION_HOLD


### 2. æŒ‰é”®åŠ¨ä½œç±»å‹å®šä¹‰

```c
// æ–‡ä»¶: apps/common/device/key/key_driver.h
enum key_action {
    KEY_ACTION_CLICK,           // å•å‡» (çŸ­æŒ‰åæŠ¬èµ·)
    KEY_ACTION_LONG,            // é•¿æŒ‰ (æŒ‰ä½è¶…è¿‡long_time)
    KEY_ACTION_HOLD,            // æŒç»­æŒ‰ä½ (è¶…è¿‡hold_timeåæŒç»­è§¦å‘)
    KEY_ACTION_UP,              // æŠ¬èµ· (é•¿æŒ‰åæ¾å¼€)
    KEY_ACTION_DOUBLE_CLICK,    // åŒå‡»
    KEY_ACTION_TRIPLE_CLICK,    // ä¸‰å‡»
    KEY_ACTION_FOURTH_CLICK,    // å››å‡»
    KEY_ACTION_FIRTH_CLICK,     // äº”å‡»
    KEY_ACTION_SEXTUPLE_CLICK,  // å…­å‡»
    KEY_ACTION_SEPTUPLE_CLICK,  // ä¸ƒå‡»
    KEY_ACTION_HOLD_1SEC,       // æŒ‰ä½1ç§’
    KEY_ACTION_HOLD_3SEC,       // æŒ‰ä½3ç§’
    KEY_ACTION_HOLD_5SEC,       // æŒ‰ä½5ç§’
    KEY_ACTION_HOLD_8SEC,       // æŒ‰ä½8ç§’
    KEY_ACTION_HOLD_10SEC,      // æŒ‰ä½10ç§’
    
    // TWSè”åˆæŒ‰é”® (å·¦å³è€³åŒæ—¶æŒ‰ä¸‹)ï¼Œè¿™ä¸ªéœ€è¦å•ç‹¬ä½¿èƒ½TCFG_USER_TWS_ENABLEå’ŒTCFG_TWS_COMBINATIION_KEY_ENABLE
    KEY_ACTION_TWS_CLICK,       // TWSåŒæ—¶å•å‡»
    KEY_ACTION_TWS_DOUBLE_CLICK,// TWSåŒæ—¶åŒå‡»
    // ... å…¶ä»–TWSè”åˆåŠ¨ä½œ
    
    KEY_ACTION_NO_KEY,          // æ— æŒ‰é”® (å¤šå‡»å»¶æ—¶ç»“æŸæ ‡å¿—)
    KEY_ACTION_MAX,
};
```

### 3. æŒ‰é”®å‚æ•°é…ç½®

```c
// å…¸å‹çš„æŒ‰é”®é©±åŠ¨å‚æ•°
struct key_driver_ops {
    u8 key_type;               // æŒ‰é”®ç±»å‹ (ADKEY/IOKEY/TOUCHç­‰)
    u8 scan_time;              // æ‰«æå‘¨æœŸ (å•ä½:10msï¼Œé»˜è®¤1)
    u8 filter_time;            // æ¶ˆæŠ–æ—¶é—´ (å•ä½:æ‰«æå‘¨æœŸï¼Œé»˜è®¤3)
    u8 long_time;              // é•¿æŒ‰åˆ¤æ–­æ—¶é—´ (å•ä½:æ‰«æå‘¨æœŸï¼Œé»˜è®¤75=750ms)
    u8 hold_time;              // Holdåˆ¤æ–­æ—¶é—´ (å•ä½:æ‰«æå‘¨æœŸï¼Œé»˜è®¤150=1.5s)
    u8 click_delay_time;       // å¤šå‡»å»¶æ—¶æ—¶é—´ (å•ä½:æ‰«æå‘¨æœŸï¼Œé»˜è®¤30=300ms)
    u8 idle_query_en;          // ä½åŠŸè€—æŸ¥è¯¢ä½¿èƒ½
    
    int (*key_init)(void);     // æŒ‰é”®åˆå§‹åŒ–å‡½æ•°
    u8 (*get_value)(void);     // è·å–æŒ‰é”®å€¼å‡½æ•°
    struct key_driver_para *param; // æŒ‰é”®é©±åŠ¨å‚æ•°
};
```

---

- è¿™ä¸€äº›é…ç½®éƒ½æ˜¯åœ¨å¯¹åº”æŒ‰é”®ç±»å‹çš„æºæ–‡ä»¶ä¸­èµ‹å€¼å¥½äº†ï¼Œä½¿èƒ½ä¸åŒçš„æŒ‰é”®ç±»å‹ï¼Œä¸åŒçš„é©±åŠ¨å°±ä¼šæ³¨å†Œè¿›OSã€‚

## æŒ‰é”®äº‹ä»¶å¤„ç†å±‚ï¼ˆé‡è¦ï¼‰

- `apps\earphone\message\adapter\key.c`

`key_event_handler`

```c
/* --------------------------------------------------------------------------*/
/**
 * @brief æŒ‰é”®äº‹ä»¶è¿‡æ»¤ã€æ£€æµ‹å’Œå‘é€
 *
 * @param keyï¼šåŸºç¡€æŒ‰é”®åŠ¨ä½œï¼ˆmono_clickã€longã€holdã€upï¼‰å’Œé”®å€¼
 */
/* ----------------------------------------------------------------------------*/
void key_event_handler(struct key_event *key)
{
    const struct key_callback *p;

    /*printf("key_event: %d\n", key->event);*/
	//ä¼˜å…ˆåˆ¤å®šç”±åŸºç¡€æŒ‰é”®ç±»å‹è¡ç”Ÿçš„å¤æ‚æŒ‰é”®äº‹ä»¶
    if (multi_clicks_translate(key)) {
        return;
    }
    
    if (combination_key_translate(key)) {
        return;
    }
    if (key->event == KEY_ACTION_NO_KEY) {
        return;
    }

    //å¤–éƒ¨éœ€è¦æ ¼å¤–åšçš„å¤„ç†æµç¨‹ï¼Œè¯·é€šè¿‡æ³¨å†Œçš„å½¢å¼åœ¨æ­¤å¤„å›è°ƒ
    list_for_each_key_callback(p) {
        if (p->cb_deal == NULL) {
            continue;
        }
        if (p->cb_deal(p->arg)) {
            return;
        }
    }
    int msg[2];
    msg[0] = (key->value << 8) | key->event;
    msg[1] = 0;

    /*printf("key_msg: %d\n", msg[0]);*/

#if TCFG_USER_TWS_ENABLE
    bt_tws_key_msg_sync(msg[0]);
#else
    app_send_message_from(MSG_FROM_KEY, 8, msg);
#endif
}
```

### 1. å¤šå‡»è¯†åˆ«ç®—æ³•

å¤šå‡»è¯†åˆ«æ˜¯æŒ‰é”®å¤„ç†çš„æ ¸å¿ƒç®—æ³•ï¼Œèƒ½å¤ŸåŒºåˆ†å•å‡»ã€åŒå‡»ã€ä¸‰å‡»ç­‰å¤æ‚æŒ‰é”®åºåˆ—ã€‚

- æŒ‰é”®æ‰«æå‡½æ•°åªèƒ½åˆ¤æ–­ä¸€ä¸‹å‡ ç§åŸºç¡€ç±»å‹ï¼Œå¤æ‚çš„æŒ‰é”®ç”±ç®—æ³•æ¥åˆ¤æ–­
  - `key_driver_scan`ä¼ é€’ï¼š
    - `KEY_ACTION_UP`
    - `KEY_ACTION_CLICK`
    - `KEY_ACTION_NO_KEY`
    - `KEY_ACTION_LONG`
    - `KEY_ACTION_HOLD`
  - æ¯”å¦‚æŒ‰é”®æ‰«æä¼ é€’è¿‡æ¥ä¸¤ä¸ªå•å‡»äº‹ä»¶
    - å¦‚æœåˆ¤æ–­ä»–ä»¬æ˜¯åŒå‡»è¿˜æ˜¯åˆ†åˆ«çš„ä¸¤ä¸ªå•å‡»ï¼Ÿ
    - è¿™ä¸ªå°±è¦ç®—æ³•äº†ï¼ŒæŒ‰é”®æ‰«æåªè´Ÿè´£ä¼ é€’åŸºç¡€çš„æŒ‰é”®ç±»å‹ã€‚

```c
// æ–‡ä»¶: apps/earphone/message/adapter/key.c:56
static int multi_clicks_translate(struct key_event *key) {
    static u8 click_cnt;           // å¤šå‡»è®¡æ•°å™¨
    static u8 notify_value = 0xff; // å½“å‰å¤„ç†çš„æŒ‰é”®å€¼
    struct key_hold *hold = get_key_hold(key->value, 0);
    
    // é•¿æŒ‰äº‹ä»¶å¤„ç†
    if (key->event == KEY_ACTION_LONG) {
        hold = get_key_hold(key->value, 1);
        if (hold) {
            hold->start_time = jiffies; // è®°å½•é•¿æŒ‰å¼€å§‹æ—¶é—´ï¼Œåˆ©ç”¨é•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¸ºåŸºç¡€åˆ¤æ–­å…¶ä»–å¤æ‚æŒ‰é”®äº‹ä»¶
        }
    }
    // Holdäº‹ä»¶å¤„ç† - æ ¹æ®æŒç»­æ—¶é—´ç»†åˆ†
    else if (key->event == KEY_ACTION_HOLD) {
        if (hold) {
            int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
            
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD //æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯
            // æŒ‰ä½è¿‡ç¨‹ä¸­åˆ†æ®µå‘é€æ¶ˆæ¯
            if (time_msec >= 1000 && hold->action == 0) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ1s
                key->event = KEY_ACTION_HOLD_1SEC;
            } else if (time_msec >= 3000 && hold->action == KEY_ACTION_HOLD_1SEC) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ3s
                key->event = KEY_ACTION_HOLD_3SEC;
            } else if (time_msec >= 5000 && hold->action == KEY_ACTION_HOLD_3SEC) {
                key->event = KEY_ACTION_HOLD_5SEC;
            } else if (time_msec >= 8000 && hold->action == KEY_ACTION_HOLD_5SEC) {
                key->event = KEY_ACTION_HOLD_8SEC;
            } else if (time_msec >= 10000 && hold->action == KEY_ACTION_HOLD_8SEC) {
                key->event = KEY_ACTION_HOLD_10SEC;
            } else {
                return 0; // ä¸å‘é€é‡å¤æ¶ˆæ¯
            }
            //æœ€é•¿æŒ‰ä½æ¶ˆæ¯ï¼Œä¸€ç›´æŒ‰ä½æŒ‡å®šè§¦å‘é‚£ä¸ªé•¿æŒ‰ä¿æŒäº‹ä»¶
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000) {
                hold->action = KEY_ACTION_HOLD_10SEC;
            } else {
                hold->action = key->event;
            }
#else
            // ä»…åœ¨è¾¾åˆ°æœ€å¤§æ—¶é—´æ—¶å‘é€ä¸€æ¬¡æ¶ˆæ¯
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000 && hold->action == 0) {
                key->event = TCFG_MAX_HOLD_SEC >> 8;
            } else {
                return 0;
            }
            hold->action = key->event;
#endif
        }
    }
    // æŠ¬èµ·äº‹ä»¶å¤„ç†
    else {
        if (hold) {
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD == 0 
			//æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯å®ä¸ä½¿èƒ½çš„è¯ï¼Œé—®é¢˜æ˜¯å®¢æˆ·éœ€è¦æŒ‰ä½è§¦å‘è¿˜æ˜¯æŠ¬èµ·è§¦å‘ï¼ŒæŒ‰é”®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚
            // æŠ¬èµ·æ—¶æ ¹æ®æŒ‰ä½æ€»æ—¶é—´å‘é€å¯¹åº”æ¶ˆæ¯
            if (hold->action == 0) {
                int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
                if (time_msec >= 8000) {
                    key->event = KEY_ACTION_HOLD_8SEC;
                } else if (time_msec >= 5000) {
                    key->event = KEY_ACTION_HOLD_5SEC;
                } else if (time_msec >= 3000) {
                    key->event = KEY_ACTION_HOLD_3SEC;
                } else if (time_msec >= 1000) {
                    key->event = KEY_ACTION_HOLD_1SEC;
                }
            }
#endif
            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
            //å¾—åˆ°å¯¹åº”æŒ‰é”®äº‹ä»¶åï¼ŒæŠŠè®°å½•æ¸…é™¤é¿å…åé¢è¯¯åˆ¤
            hold->value = NO_KEY;
            hold->action = 0;
            hold->start_time = 0;
        }
    }
    
    // è¿™ç§æŒ‰é”®ç±»å‹ï¼Œç®—æ³•ä¸æ”¯æŒåˆ¤æ–­ï¼Œå¯ä»¥è·³è½¬è¿‡å»çœ‹åˆ°æ”¯æŒå¾ˆå¤šæŒ‰é”®é©±åŠ¨ã€‚
    if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
        return 0;
    }
    
    // å¤šå‡»è®¡æ•°é€»è¾‘
    //å‡è®¾æŒ‰é”®æ‰«æå‡½æ•°ä¼ é€’è¿‡æ¥ä¸€ä¸ªå•å‡»æŒ‰é”®äº‹ä»¶ï¼Œè¿™æ—¶å¼€å§‹è®¡æ•°
    //å¦‚æœèŒƒå›´ä¹‹å†…å†ä¼ é€’è¿‡æ¥ä¸€ä¸ªå•å‡»äº‹ä»¶ï¼Œå°±åˆ¤æ–­ä¸ºå¤šå‡»æŒ‰é”®äº‹ä»¶ï¼Œå¦åˆ™åˆ¤å®šå°±æ˜¯åˆ†å¼€çš„ä¸¤ä¸ªå•å‡»æŒ‰é”®
    //è¿™é‡Œæ”¶åˆ°ä¸€ä¸ªå•å‡»äº‹ä»¶ï¼Œè®°å½•æŒ‰é”®å€¼å¹¶é‡ç½®è®¡æ•°ï¼Œå‡è®¾åˆæ¥ä¸€ä¸ªå•å‡»äº‹ä»¶
    //å†é‡ç½®è®¡æ•°ï¼Œå¹¶è®°å½•å•å‡»æ¬¡æ•°
    if (key->event == KEY_ACTION_CLICK) {
        if (key->value != notify_value) {
            click_cnt = 1;              // æ–°æŒ‰é”®ï¼Œé‡ç½®è®¡æ•°
            notify_value = key->value;   // è®°å½•æŒ‰é”®å€¼
        } else {
            click_cnt++;                // ç›¸åŒæŒ‰é”®ï¼Œè®¡æ•°ç´¯åŠ 
        }
        return 1; // æ‹¦æˆªå•å‡»äº‹ä»¶ï¼Œç­‰å¾…å¤šå‡»åˆ¤æ–­å®Œæˆ
    }
    
    // å¤šå‡»å»¶æ—¶ç»“æŸï¼Œå‘é€æœ€ç»ˆäº‹ä»¶
    //å¤šå‡»å»¶æ—¶ç»“æŸä¹‹å‰ï¼Œå±äºå¤šå‡»åˆ¤æ–­æ—¶é—´ã€‚è¿™æ—¶æ‰«æåˆ°å‡ æ¬¡å•å‡»äº‹ä»¶å°±æ˜¯å‡ å‡»æŒ‰é”®äº‹ä»¶
    //å¤šå‡»å»¶æ—¶ç»“æŸä¹‹å,å†ä¼ é€’è¿‡æ¥çš„å•å‡»äº‹ä»¶å°±ä¸ç®—å…¥æ­¤æ¬¡å¤šå‡»åˆ¤æ–­ä¸­ã€‚
    //å¤šå‡»è¯†åˆ«çš„é€Ÿåº¦å°±æ¥è‡ªè¿™ä¸ªå¤šå‡»å»¶æ—¶çš„å‚æ•°å¤§å°ã€‚
    if (key->event == KEY_ACTION_NO_KEY) {
        //å¤šå‡»å»¶æ—¶ç»“æŸåï¼Œæ²¡æœ‰æ‰«æåˆ°æŒ‰é”®äº‹ä»¶äº†ï¼Œå°±è¯†åˆ«ä¸ºå¤šå‡»æŒ‰é”®äº‹ä»¶ã€‚
        if (click_cnt == 1) {
            key->event = KEY_ACTION_CLICK;      // ç¡®è®¤å•å‡»
        } else if (click_cnt <= 7) {
            // æ ¹æ®è®¡æ•°è½¬æ¢ä¸ºå¯¹åº”çš„å¤šå‡»äº‹ä»¶
            key->event = KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2);
        }
        key->value = notify_value;
        click_cnt = 0;
        notify_value = NO_KEY;
    } else if (key->event > KEY_ACTION_CLICK) {
        //è¿™é‡ŒæŒ‡çš„æ˜¯é‚£å‡ ä¸ªåŸºæœ¬æŒ‰é”®äº‹ä»¶ï¼Œåªè¦ä¸æ˜¯å•å‡»å°±æ‰“æ–­
        //å¤šå‡»åˆ¤æ–­æµç¨‹ä¸­ï¼Œåªè¦ä¸æ˜¯å•å‡»äº‹ä»¶ï¼Œæ•´ä¸ªå¤šå‡»åˆ¤æ–­å°±ç»ˆæ­¢ã€‚
        //è¿™æ ·çš„è¯å°±ä¸èƒ½å®ç°å¤šå‡»+é•¿æŒ‰ç»„åˆæŒ‰é”®äº‹ä»¶äº†ï¼Ÿï¼Ÿï¼Ÿ
        //è¿™ä¸ªç®—æ³•è¿‡ç¨‹ä¸­ï¼Œæ‰“æ–­å¤šå‡»åºåˆ—åï¼Œå°±æ˜¯ä»¥æœ€åä¸€æ¬¡æŒ‰é”®äº‹ä»¶ç±»å‹ä¸ŠæŠ¥ï¼Œ
        //ä¸‰å‡»+é•¿æŒ‰ï¼Œæœ€åå°±ä¼šè¿›å…¥é•¿æŒ‰ç±»å‹æŒ‰é”®çš„è¯†åˆ«æµç¨‹ä¸­ã€‚
        //é‚£ä¹ˆå¤šå‡»+é•¿æŒ‰è¿˜æœ‰ä¸æœ‰å¸Œæœ›å®ç°ï¼Ÿï¼Ÿï¼Ÿ
        // é•¿æŒ‰æˆ–å…¶ä»–äº‹ä»¶æ‰“æ–­å¤šå‡»åºåˆ—
        click_cnt = 0;
        notify_value = NO_KEY;
    }
    
    return 0;
}
```

### 2. TWSè”åˆæŒ‰é”®å¤„ç†

è¿™ä¸ªå‡½æ•°æ˜¯ç©ºå®ç°ã€‚

```c
if (combination_key_translate(key)) {
        return;
}
```

TWSè€³æœºæ”¯æŒå·¦å³è€³åŒæ—¶æŒ‰é”®çš„è”åˆæ“ä½œï¼Œé€šè¿‡TWSé“¾è·¯åŒæ­¥æŒ‰é”®äº‹ä»¶ã€‚

- ç»è¿‡ç®—æ³•åˆ¤å®šåè½¬æ¢ä¸ºå¯¹åº”çš„æŒ‰é”®äº‹ä»¶

```c
// æ–‡ä»¶: apps/earphone/message/adapter/key.c:172
/**
 * TWSè”åˆæŒ‰é”®è½¬æ¢å‡½æ•°
 * åŠŸèƒ½ï¼šæ£€æµ‹å¹¶å¤„ç†TWSè€³æœºçš„å·¦å³è€³åŒæ­¥æŒ‰é”®æ“ä½œ
 * 
 * @param msg æŒ‰é”®æ¶ˆæ¯
 * @param rx  æ¥æ”¶æ ‡å¿—
 * @return    è½¬æ¢åçš„æŒ‰é”®æ¶ˆæ¯ï¼ˆè”åˆæŒ‰é”®ï¼‰æˆ–åŸæ¶ˆæ¯
 */
static int tws_combination_key_translate(int msg, int rx) {
    // 1. TWSè¿æ¥çŠ¶æ€æ£€æŸ¥
    if (!(tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED)) {
        return msg;  // TWSæœªè¿æ¥ï¼Œç›´æ¥è¿”å›åŸæ¶ˆæ¯
    }
    
    // 2. å·¦å³è€³æŒ‰é”®ä¸€è‡´æ€§æ£€æŸ¥
    if (g_msg[0] != g_msg[1]) {
        return msg;  // æŒ‰é”®å€¼ä¸åŒï¼Œä¸æ˜¯è”åˆæŒ‰é”®
    }
    if (g_msg[0] == 0) {
        return 0;    // æ¶ˆæ¯ä¸ºç©ºï¼Œè¿”å›0
    }
    
    // 3. æŒ‰é”®æ—¶é—´åŒæ­¥æ€§æ£€æŸ¥ï¼ˆæ ¸å¿ƒåˆ¤æ–­æ¡ä»¶ï¼‰
    // è®¡ç®—å·¦å³è€³æŒ‰é”®çš„æ—¶é—´å·®ï¼Œè¦æ±‚åœ¨Â±200mså†…æ‰è®¤ä¸ºæ˜¯è”åˆæŒ‰é”®
    int msec = jiffies_offset_to_msec(g_time[0], g_time[1]);
    if (msec > 200 || msec < -200) {
        return msg;  // æ—¶é—´å·®è¶…è¿‡Â±200msï¼Œä¸è®¤ä¸ºæ˜¯è”åˆæŒ‰é”®
    }
    
    // 4. æ¸…é™¤ç¼“å­˜çš„æŒ‰é”®æ¶ˆæ¯
    g_msg[0] = 0;
    g_msg[1] = 0;
    
    // 5. è½¬æ¢ä¸ºTWSè”åˆæŒ‰é”®åŠ¨ä½œ
    int action = APP_MSG_KEY_ACTION(msg);
    if (action == KEY_ACTION_CLICK) {
        // å•å‡»è½¬æ¢ä¸ºTWSè”åˆå•å‡»
        action = KEY_ACTION_TWS_CLICK;
    } else if (action >= KEY_ACTION_DOUBLE_CLICK && action <= KEY_ACTION_HOLD_10SEC) {
        // å¤æ‚åŠ¨ä½œï¼ˆåŒå‡»åˆ°é•¿æŒ‰10ç§’ï¼‰éƒ½å¢åŠ TWSåç§»é‡
        action += KEY_ACTION_TWS_DOUBLE_CLICK - KEY_ACTION_DOUBLE_CLICK;
    } else {
        return msg;  // ä¸æ”¯æŒçš„åŠ¨ä½œç±»å‹ï¼Œè¿”å›åŸæ¶ˆæ¯
    }
    
    printf("tws_comb_key: time_diff=%dms, action=%d\n", msec, action);
    return (msg & ~0xff) | action;  // æ›¿æ¢åŠ¨ä½œéƒ¨åˆ†ï¼Œä¿æŒæŒ‰é”®å€¼ä¸å˜
}

/**
 * TWSæŒ‰é”®æ¶ˆæ¯åŒæ­¥å‡½æ•°
 * åŠŸèƒ½ï¼šå°†æœ¬åœ°æŒ‰é”®äº‹ä»¶åŒæ­¥åˆ°å¯¹è€³è®¾å¤‡
 * 
 * @param key_msg æŒ‰é”®æ¶ˆæ¯
 */
void bt_tws_key_msg_sync(int key_msg) {
    int msg[2] = { key_msg, 0 };
    
#if TCFG_TWS_COMBINATIION_KEY_ENABLE
    int action = APP_MSG_KEY_ACTION(key_msg);
    if (action == KEY_ACTION_HOLD) {
        // Holdäº‹ä»¶ä¸éœ€è¦åŒæ­¥ï¼Œç›´æ¥æœ¬åœ°å¤„ç†
        app_send_message_from(MSG_FROM_KEY, 8, msg);
        return;
    }
#endif
    
    // å”¤é†’å¯¹è€³è®¾å¤‡ï¼ˆé€€å‡ºsniffä½åŠŸè€—æ¨¡å¼ï¼‰
    tws_api_tx_unsniff_req();
    
    // é€šè¿‡TWSé“¾è·¯å‘é€æŒ‰é”®äº‹ä»¶åˆ°å¯¹è€³
    int err = tws_api_send_data_to_sibling(&key_msg, 4, 0x8097ADF1);
    if (err) {
        // å‘é€å¤±è´¥æ—¶ï¼Œé™çº§ä¸ºæœ¬åœ°å¤„ç†
        app_send_message_from(MSG_FROM_KEY, 8, msg);
    }
}
```

#### æ—¶é—´åŒæ­¥çª—å£ (Â±200ms)

- **åŸç†**: ä¸¤ä¸ªè€³æœºçš„æŒ‰é”®æ—¶é—´æˆ³å·®å€¼å¿…é¡»åœ¨Â±200mså†…
- **å®ç°**: ä½¿ç”¨ç³»ç»Ÿtickè®¡æ•°å™¨ (`jiffies`) è®¡ç®—æ—¶é—´å·®
- **å®¹å·®è€ƒè™‘**: è€ƒè™‘åˆ°TWSä¼ è¾“å»¶æ—¶ã€ç³»ç»Ÿå¤„ç†å»¶æ—¶ç­‰å› ç´ 

#### æ¶ˆæ¯ç¼“å­˜æœºåˆ¶

```c
// å…¨å±€å˜é‡ä¿å­˜ä¸¤è€³çš„æŒ‰é”®æ¶ˆæ¯å’Œæ—¶é—´æˆ³
static int g_msg[2];      // [0]:æœ¬åœ°æ¶ˆæ¯ [1]:å¯¹ç«¯æ¶ˆæ¯
static u32 g_time[2];     // [0]:æœ¬åœ°æ—¶é—´ [1]:å¯¹ç«¯æ—¶é—´
```

#### è½¬æ¢è§„åˆ™è¡¨

| åŸå§‹åŠ¨ä½œ                | è”åˆåŠ¨ä½œ                    | åç§»é‡   | è¯´æ˜           |
| ----------------------- | --------------------------- | -------- | -------------- |
| KEY_ACTION_CLICK        | KEY_ACTION_TWS_CLICK        | å›ºå®šè½¬æ¢ | å•å‡»           |
| KEY_ACTION_DOUBLE_CLICK | KEY_ACTION_TWS_DOUBLE_CLICK | +19      | åŒå‡»           |
| KEY_ACTION_TRIPLE_CLICK | KEY_ACTION_TWS_TRIPLE_CLICK | +19      | ä¸‰å‡»           |
| KEY_ACTION_LONG         | KEY_ACTION_TWS_LONG         | +19      | é•¿æŒ‰           |
| KEY_ACTION_HOLD         | ä¸è½¬æ¢                      | -        | Holdä¸å‚ä¸è”åˆ |



### 3. æŒ‰é”®äº‹ä»¶å°è£…ä¸å‘é€

```c
// æ–‡ä»¶: apps/earphone/message/adapter/key.c:273
void key_event_handler(struct key_event *key) {
    const struct key_callback *p;
    
    // 1. å¤šå‡»è¯†åˆ«å¤„ç†
    if (multi_clicks_translate(key)) {
        return; // è¢«æ‹¦æˆªï¼Œç­‰å¾…å¤šå‡»åˆ¤æ–­
    }
    
    // 2. è”åˆæŒ‰é”®è¯†åˆ«å¤„ç†----è¿™ä¸ªæ˜¯ç©ºå®ç°ã€‚
    if (combination_key_translate(key)) {
        return; // è¢«æ‹¦æˆª
    }
    
    // 3. è¿‡æ»¤æ— æ•ˆäº‹ä»¶
    if (key->event == KEY_ACTION_NO_KEY) {
        return;
    }
    
    // 4. å¤–éƒ¨å›è°ƒå¤„ç† (å¯é€‰çš„è‡ªå®šä¹‰å¤„ç†)
    list_for_each_key_callback(p) {
        if (p->cb_deal == NULL) {
            continue;
        }
        if (p->cb_deal(p->arg)) {
            return; // è¢«å¤–éƒ¨å›è°ƒæ‹¦æˆª
        }
    }
    
    // 5. å°è£…æŒ‰é”®æ¶ˆæ¯
    int msg[2];
    msg[0] = (key->value << 8) | key->event;  // é«˜8ä½:æŒ‰é”®å€¼ï¼Œä½8ä½:åŠ¨ä½œ
    msg[1] = 0;                               // æ‰©å±•å‚æ•°
    
#if TCFG_USER_TWS_ENABLE
    // 6. TWSæŒ‰é”®åŒæ­¥å¤„ç†
    bt_tws_key_msg_sync(msg[0]);
#else
    // 7. å‘é€åˆ°åº”ç”¨æ¶ˆæ¯é˜Ÿåˆ—
    app_send_message_from(MSG_FROM_KEY, 8, msg);
#endif
}
```

---

## æŒ‰é”®æ¶ˆæ¯åˆ†å‘å±‚ï¼ˆé‡è¦ï¼‰

### 1. æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ

æŒ‰é”®äº‹ä»¶é€šè¿‡**æ“ä½œç³»ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—**ç³»ç»Ÿä¼ é€’åˆ°åº”ç”¨å±‚ã€‚

```c
// æ–‡ä»¶: apps/earphone/message/adapter/app_msg.c:31
void app_send_message_from(int from, int argc, int *msg) {
    // å‘é€æ¶ˆæ¯åˆ°app_coreä»»åŠ¡é˜Ÿåˆ—
    // from: æ¶ˆæ¯æ¥æº (MSG_FROM_KEY)
    // argc: å‚æ•°ä¸ªæ•°
    // msg: æ¶ˆæ¯å†…å®¹
    os_taskq_post_type("app_core", from, (argc + 3) / 4, msg);
}
```

#### TWSæµç¨‹

```c
void bt_tws_key_msg_sync(int key_msg)
{
    int msg[2] = { key_msg, 0 };

#if TCFG_TWS_COMBINATIION_KEY_ENABLE//åŒæ—¶æŒ‰é”®æ¶ˆæ¯ä½¿èƒ½
    int action = APP_MSG_KEY_ACTION(key_msg);
    if (action == KEY_ACTION_HOLD) {
        app_send_message_from(MSG_FROM_KEY, 8, msg);
        return;
    }
#endif
    tws_api_tx_unsniff_req();

    int err = tws_api_send_data_to_sibling(&key_msg, 4, 0x8097ADF1);
    if (err) {
        app_send_message_from(MSG_FROM_KEY, 8, msg);
    }
}
```

### 2. åº”ç”¨å±‚æ¶ˆæ¯è·å–

```c
// æ–‡ä»¶: apps/earphone/app_main.c:443
int app_core_get_message(int *msg, int max_num) {
    while (1) {
        // ä»ä»»åŠ¡é˜Ÿåˆ—è·å–æ¶ˆæ¯
        int res = os_taskq_pend(NULL, msg, max_num);
        if (res != OS_TASKQ) {
            continue;
        }
        
        // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
        if (msg[0] & Q_MSG) {
            return 1;
        }
    }
    return 0;
}

// æ–‡ä»¶: apps/earphone/app_main.c:457
int app_get_message(int *msg, int max_num, const struct key_remap_table *key_table) {
    const struct app_msg_handler *handler;
    
    // 1. è·å–æ ¸å¿ƒæ¶ˆæ¯
    app_core_get_message(msg, max_num);
    
    // 2. æ¶ˆæ¯æ‹¦æˆªå¤„ç† (å¯é€‰)
    for_each_app_msg_prob_handler(handler) {
        if (handler->from == msg[0]) {
            int abandon = handler->handler(msg + 1);
            if (abandon) {
                return 0; // æ¶ˆæ¯è¢«æ‹¦æˆª
            }
        }
    }
    
#if RCSP_ADV_KEY_SET_ENABLE
    // 3. RCSPæŒ‰é”®é‡æ˜ å°„ (å¯é€‰)
    if (msg[0] == MSG_FROM_KEY) {
        int _msg = rcsp_key_event_remap(msg + 1);
        if (_msg != -1) {
            msg[0] = MSG_FROM_APP;
            msg[1] = _msg;
            log_info("rcsp_key_remap: %d\n", _msg);
        }
    }
#endif
    
    // 4. æŒ‰é”®æ¶ˆæ¯é‡æ˜ å°„
    if (msg[0] == MSG_FROM_KEY && key_table) {
        struct app_mode *mode = app_get_current_mode();
        if (mode) {
#if TCFG_AUDIO_WIDE_AREA_TAP_ENABLE
            // å¿½ç•¥å¹¿åŸŸç‚¹å‡»å¹²æ‰°
            audio_wide_area_tap_ignore_flag_set(1, 1000);
#endif
            // è°ƒç”¨æŒ‰é”®é‡æ˜ å°„å‡½æ•°
            int key_msg = app_key_event_remap(key_table, msg + 1);
            log_info(">>>>>key_msg = %d\n", key_msg);
            
            if (key_msg == APP_MSG_NULL) {
                return 1; // æ— æ•ˆæŒ‰é”®ï¼Œä¸¢å¼ƒ
            }
            
            // è½¬æ¢ä¸ºåº”ç”¨æ¶ˆæ¯
            msg[0] = MSG_FROM_APP;
            msg[1] = key_msg;
            
#if TCFG_APP_KEY_DUT_ENABLE
            // äº§æµ‹æ¨¡å¼æŒ‰é”®å¤„ç†
            app_key_dut_msg_handler(key_msg);
#endif
        }
    }
    
    return 1;
}
```

---

## æŒ‰é”®é‡æ˜ å°„å±‚ï¼ˆé‡è¦ï¼‰

### 1. é‡æ˜ å°„è¡¨ç»“æ„

```c
// æŒ‰é”®é‡æ˜ å°„è¡¨ç»“æ„
struct key_remap_table {
    u8 key_value;                    // ç‰©ç†æŒ‰é”®å€¼
    const int *remap_table;          // é™æ€æ˜ å°„è¡¨ (æŒ‰åŠ¨ä½œç´¢å¼•)
    int (*remap_func)(int *event);   // åŠ¨æ€æ˜ å°„å‡½æ•°
};

// åº”ç”¨æ¶ˆæ¯å®å®šä¹‰
#define APP_MSG_KEY_VALUE(msg)   ((msg) >> 8)     // æå–æŒ‰é”®å€¼
#define APP_MSG_KEY_ACTION(msg)  ((msg) & 0xff)   // æå–æŒ‰é”®åŠ¨ä½œ
```

### 2. é‡æ˜ å°„æ‰§è¡Œå‡½æ•°

```c
// æ–‡ä»¶: apps/earphone/message/adapter/app_msg.c:36
int app_key_event_remap(const struct key_remap_table *table, int *event) {
    u8 key_value = APP_MSG_KEY_VALUE(event[0]);   // æå–æŒ‰é”®å€¼
    u8 key_action = APP_MSG_KEY_ACTION(event[0]); // æå–æŒ‰é”®åŠ¨ä½œ
    
    g_printf("%s key_value = %d, key_action = %d\n", __FUNCTION__, key_value, key_action);
    
    if (table) {
        // éå†é‡æ˜ å°„è¡¨
        for (int i = 0; table[i].key_value != 0xff; i++) {
            if (table[i].key_value == key_value) {
                // é™æ€æ˜ å°„è¡¨ä¼˜å…ˆ
                if (table[i].remap_table) {
                    return table[i].remap_table[key_action];
                }
                // åŠ¨æ€æ˜ å°„å‡½æ•°
                if (table[i].remap_func) {
                    return table[i].remap_func(event);
                }
                break;
            }
        }
    }
    
    return APP_MSG_NULL; // æœªæ‰¾åˆ°æ˜ å°„ï¼Œè¿”å›ç©ºæ¶ˆæ¯
}
```

### 3. è“ç‰™æ¨¡å¼æŒ‰é”®æ˜ å°„è¡¨

```c
// æ–‡ä»¶: apps/earphone/mode/bt/bt_key_msg_table.c:515
const struct key_remap_table bt_mode_key_table[] = {
#if TCFG_IOKEY_ENABLE
    { .key_value = KEY_POWER,   .remap_func = bt_key_power_msg_remap },
    //{ .key_value = KEY_NEXT,    .remap_func = bt_key_next_msg_remap },
    //{ .key_value = KEY_PREV,    .remap_func = bt_key_prev_msg_remap },
#endif

#if TCFG_LP_TOUCH_KEY_ENABLE
    { .key_value = KEY_POWER,   .remap_func = bt_key_power_msg_remap },
    { .key_value = KEY_SLIDER,  .remap_func = bt_key_slider_msg_remap },
#endif

#if TCFG_ADKEY_ENABLE
    // ADKEYé™æ€æ˜ å°„è¡¨
    { .key_value = KEY_AD_NUM0, .remap_table = adkey_msg_table[0] },
    { .key_value = KEY_AD_NUM1, .remap_table = adkey_msg_table[1] },
    { .key_value = KEY_AD_NUM2, .remap_table = adkey_msg_table[2] },
    { .key_value = KEY_AD_NUM3, .remap_table = adkey_msg_table[3] },
    { .key_value = KEY_AD_NUM4, .remap_table = adkey_msg_table[4] },
    // ... æ›´å¤šADKEYæ˜ å°„
#endif

    { .key_value = 0xff }  // ç»“æŸæ ‡å¿—
};
```

---

- è¿™é‡Œå°±æ˜¯ä½¿èƒ½ä¸åŒçš„æŒ‰é”®ç±»å‹
- ä½¿èƒ½`TCFG_IOKEY_ENABLE`æŒ‰é”®ï¼Œ`KEY_POWER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_power_msg_remap`
- ä½¿èƒ½`TCFG_LP_TOUCH_KEY_ENABLE`æŒ‰é”®ï¼Œ`KEY_POWER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_power_msg_remap`
  - `KEY_SLIDER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_slider_msg_remap`

---

## å®Œæ•´è°ƒç”¨é“¾åˆ†æ

### 1. ä»ç¡¬ä»¶è§¦å‘åˆ°åº”ç”¨å¤„ç†çš„å®Œæ•´æµç¨‹

```
ç¡¬ä»¶æŒ‰é”®æŒ‰ä¸‹
        â†“
GPIOä¸­æ–­/ADCé‡‡æ · (ç¡¬ä»¶å±‚)
        â†“
key_driver_scan() [apps/common/device/key/key_driver.c:35]
â”œâ”€â”€ è·å–æŒ‰é”®çŠ¶æ€: key_handler->get_value()
â”œâ”€â”€ æŒ‰é”®æ¶ˆæŠ–: filter_cnt è®¡æ•°
â”œâ”€â”€ äº‹ä»¶è¯†åˆ«: CLICK/LONG/HOLD/UP
â””â”€â”€ å°è£…äº‹ä»¶: struct key_event
        â†“
key_event_handler() [apps/earphone/message/adapter/key.c:273]
â”œâ”€â”€ å¤šå‡»è¯†åˆ«: multi_clicks_translate()
â”œâ”€â”€ è”åˆæŒ‰é”®: combination_key_translate()
â”œâ”€â”€ TWSåŒæ­¥: bt_tws_key_msg_sync()
â””â”€â”€ æ¶ˆæ¯å‘é€: app_send_message_from(MSG_FROM_KEY)
        â†“
æ“ä½œç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ— (os_taskq_post_type)
        â†“
app_get_message() [apps/earphone/app_main.c:457]
â”œâ”€â”€ è·å–æ¶ˆæ¯: app_core_get_message()
â”œâ”€â”€ æ¶ˆæ¯æ‹¦æˆª: app_msg_prob_handler (å¯é€‰)
â”œâ”€â”€ RCSPé‡æ˜ å°„: rcsp_key_event_remap() (å¯é€‰)
â””â”€â”€ æŒ‰é”®é‡æ˜ å°„: app_key_event_remap()
        â†“
bt_key_power_msg_remap() [apps/earphone/mode/bt/bt_key_msg_table.c:117]
â”œâ”€â”€ è·å–TWSçŠ¶æ€: tws_api_get_tws_state()
â”œâ”€â”€ è·å–å£°é“ä¿¡æ¯: tws_api_get_local_channel()
â”œâ”€â”€ è·å–é€šè¯çŠ¶æ€: bt_get_phone_state()
â”œâ”€â”€ åœºæ™¯åˆ¤æ–­: é€šè¯/éŸ³ä¹/æœªè¿æ¥
â”œâ”€â”€ å®¢æˆ·å·®å¼‚å¤„ç†: æ¡ä»¶ç¼–è¯‘å®
â””â”€â”€ è¿”å›åº”ç”¨æ¶ˆæ¯: APP_MSG_MUSIC_PP/APP_MSG_VOL_UPç­‰
        â†“
æ¶ˆæ¯è½¬æ¢ (MSG_FROM_KEY -> MSG_FROM_APP)
        â†“
åº”ç”¨æ¶ˆæ¯å¤„ç†å™¨ (bt_earphone_msg_handler)
â”œâ”€â”€ APP_MSG_MUSIC_PP -> éŸ³ä¹æ’­æ”¾/æš‚åœ
â”œâ”€â”€ APP_MSG_VOL_UP -> bt_volume_up()
â”œâ”€â”€ APP_MSG_CALL_HANGUP -> æŒ‚æ–­ç”µè¯
â””â”€â”€ å…¶ä»–åº”ç”¨åŠŸèƒ½...
        â†“
å…·ä½“åŠŸèƒ½æ‰§è¡Œ
â”œâ”€â”€ éŸ³é¢‘æ§åˆ¶: a2dp_player_pp()
â”œâ”€â”€ éŸ³é‡è°ƒèŠ‚: app_audio_volume_up()
â”œâ”€â”€ è“ç‰™å‘½ä»¤: bt_cmd_prepare()
â””â”€â”€ TWSåŒæ­¥: tws_api_send_cmd()
```

### 2. æ—¶åºåˆ†æ

| æ—¶é—´ç‚¹ | åŠ¨ä½œ | è¯´æ˜ |
|--------|------|------|
| T0 | ç”¨æˆ·æŒ‰ä¸‹æŒ‰é”® | ç¡¬ä»¶ç”µå¹³å˜åŒ– |
| T0+0ms | GPIOä¸­æ–­/ADCæ‰«æ | ç¡¬ä»¶æ£€æµ‹åˆ°å˜åŒ– |
| T0+10ms | ç¬¬1æ¬¡æ‰«æ | å¼€å§‹æ¶ˆæŠ–ï¼Œè®°å½•æŒ‰é”®å€¼ |
| T0+20ms | ç¬¬2æ¬¡æ‰«æ | æ¶ˆæŠ–è®¡æ•°+1 |
| T0+30ms | ç¬¬3æ¬¡æ‰«æ | æ¶ˆæŠ–å®Œæˆï¼Œç¡®è®¤æŒ‰é”®æŒ‰ä¸‹ |
| T0+750ms | é•¿æŒ‰æ£€æµ‹ | å¦‚æœä»æŒ‰ä½ï¼Œè§¦å‘LONGäº‹ä»¶ |
| T0+1500ms | Holdæ£€æµ‹ | å¦‚æœä»æŒ‰ä½ï¼Œå¼€å§‹HOLDäº‹ä»¶ |
| T0+æŒ‰é”®é‡Šæ”¾ | æŠ¬èµ·æ£€æµ‹ | æ ¹æ®æŒ‰ä½æ—¶é•¿åˆ¤æ–­äº‹ä»¶ç±»å‹ |
| T0+æŒ‰é”®é‡Šæ”¾+300ms | å¤šå‡»è¶…æ—¶ | å¦‚æœæ— æ–°æŒ‰é”®ï¼Œå‘é€æœ€ç»ˆå¤šå‡»äº‹ä»¶ |

### 3. é”™è¯¯å¤„ç†æœºåˆ¶

```c
// æŒ‰é”®é©±åŠ¨é”™è¯¯å¤„ç†
if (!key_handler->get_value) {
    log_error("Key get_value function is NULL\n");
    return;
}

// TWSåŒæ­¥é”™è¯¯å¤„ç†
int err = tws_api_send_data_to_sibling(&key_msg, 4, 0x8097ADF1);
if (err) {
    // åŒæ­¥å¤±è´¥ï¼Œæœ¬åœ°å¤„ç†
    app_send_message_from(MSG_FROM_KEY, 8, msg);
}

// æ¶ˆæ¯é˜Ÿåˆ—æ»¡å¤„ç†
int ret = os_taskq_post_type("app_core", from, (argc + 3) / 4, msg);
if (ret != OS_NO_ERR) {
    log_error("Message queue full, drop key event\n");
}
```

---

## æ€»ç»“

æŒ‰é”®å¤„ç†æ¨¡å—æ˜¯TWSè€³æœºäººæœºäº¤äº’çš„æ ¸å¿ƒï¼Œé€šè¿‡å…­å±‚æ¶æ„å®ç°äº†ä»ç¡¬ä»¶åˆ°åº”ç”¨çš„å®Œæ•´æŒ‰é”®å¤„ç†é“¾è·¯ï¼š

1. **ç¡¬ä»¶é…ç½®å±‚**ï¼šæ”¯æŒADKEYã€IOKEYã€Touchç­‰å¤šç§æŒ‰é”®ç±»å‹ï¼Œè‡ªåŠ¨é…ç½®ç¡¬ä»¶å‚æ•°
2. **é©±åŠ¨å±‚**ï¼šå®ç°å®šæ—¶æ‰«æã€æ¶ˆæŠ–å¤„ç†ã€äº‹ä»¶è¯†åˆ«ç­‰æ ¸å¿ƒåŠŸèƒ½
3. **äº‹ä»¶å¤„ç†å±‚**ï¼šæä¾›å¤šå‡»è¯†åˆ«ã€é•¿æŒ‰è®¡æ—¶ã€TWSåŒæ­¥ç­‰é«˜çº§åŠŸèƒ½
4. **æ¶ˆæ¯åˆ†å‘å±‚**ï¼šé€šè¿‡æ“ä½œç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥äº‹ä»¶ä¼ é€’
5. **é‡æ˜ å°„å±‚**ï¼šæ”¯æŒé™æ€æ˜ å°„è¡¨å’ŒåŠ¨æ€æ˜ å°„å‡½æ•°ï¼Œå®ç°çµæ´»çš„æŒ‰é”®åŠŸèƒ½å®šåˆ¶
6. **å®¢æˆ·å·®å¼‚åŒ–å±‚**ï¼šé€šè¿‡æ¡ä»¶ç¼–è¯‘å®ç°ä¸åŒå®¢æˆ·çš„æŒ‰é”®è¡Œä¸ºå·®å¼‚

æ•´ä¸ªæ¨¡å—è®¾è®¡è€ƒè™‘äº†æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ï¼Œæ”¯æŒå¤æ‚çš„TWSåœºæ™¯ï¼Œå¦‚å·¦å³è€³åŒºåˆ†ã€è”åˆæŒ‰é”®ã€åœºæ™¯è‡ªé€‚åº”ç­‰ï¼Œä¸ºTWSè€³æœºæä¾›äº†å®Œå–„çš„ç”¨æˆ·äº¤äº’ä½“éªŒã€‚

**ğŸ”‘ å…³é”®è¦ç‚¹**ï¼š
- æŒ‰é”®æ‰«æé‡‡ç”¨10mså®šæ—¶å™¨ï¼Œé€šè¿‡æ¶ˆæŠ–ç¡®ä¿ç¨³å®šæ€§
- å¤šå‡»è¯†åˆ«æ”¯æŒæœ€å¤šä¸ƒå‡»ï¼Œ300msè¶…æ—¶åˆ¤æ–­
- TWSåŒæ­¥æ”¯æŒÂ±200msæ—¶é—´çª—å£å†…çš„è”åˆæŒ‰é”®
- å®¢æˆ·å·®å¼‚åŒ–é€šè¿‡æ¡ä»¶ç¼–è¯‘å®å®ç°ï¼Œæ”¯æŒ6ä¸ªä¸»è¦å®¢æˆ·
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•æœºåˆ¶ï¼Œä¾¿äºé—®é¢˜å®šä½å’Œæ€§èƒ½ä¼˜åŒ–

# æœ‰ç–‘é—®çš„åœ°æ–¹

## å¤šå‡»å»¶æ—¶å‚æ•°åœ¨å“ªé‡Œè®¾ç½®ï¼Ÿ

- æ¯”å¦‚æœ‰å®¢æˆ·è§‰å¾—å¤šå‡»è¯†åˆ«å¯ä»¥æ…¢ä¸€ç‚¹ï¼Œä¸ç„¶å¤šå‡»æ“ä½œå¾ˆéš¾æŒ‰å‡ºæ¥ã€‚

### å‚æ•°å®šä¹‰ä½ç½®

å¤šå‡»å»¶æ—¶å‚æ•°åœ¨å„æŒ‰é”®ç±»å‹çš„é©±åŠ¨æ–‡ä»¶ä¸­å®šä¹‰ï¼š

#### IOæŒ‰é”®å‚æ•° (`apps/common/device/key/iokey.c`)

```c
REGISTER_KEY_OPS(iokey) = {
    .key_type         = KEY_DRIVER_TYPE_IOKEY,
    .scan_time        = 1,      // æ‰«æå‘¨æœŸï¼š1 Ã— 10ms = 10ms
    .filter_time      = 4,      // æ¶ˆæŠ–æ—¶é—´ï¼š4 Ã— 10ms = 40ms  
    .long_time        = 75,     // é•¿æŒ‰æ—¶é—´ï¼š75 Ã— 10ms = 750ms
    .hold_time        = 90,     // Holdæ—¶é—´ï¼š90 Ã— 10ms = 900ms
    .click_delay_time = 20,     // å¤šå‡»å»¶æ—¶ï¼š20 Ã— 10ms = 200ms â­ï¸
    .idle_query_en    = 1,
    .key_init         = iokey_init,
    .get_value        = iokey_get_value,
    .param            = &iokey_param,
};
```

####  è§¦æ‘¸æŒ‰é”®å‚æ•° (`apps/common/device/key/touch_key.c`)

```c
REGISTER_KEY_OPS(touch_key) = {
    .key_type         = KEY_DRIVER_TYPE_CTMU_TOUCH,
    .scan_time        = 1,      // æ‰«æå‘¨æœŸï¼š1 Ã— 10ms = 10ms
    .filter_time      = 1,      // æ¶ˆæŠ–æ—¶é—´ï¼š1 Ã— 10ms = 10ms (è§¦æ‘¸æ›´ç¨³å®š)
    .long_time        = 75,     // é•¿æŒ‰æ—¶é—´ï¼š75 Ã— 10ms = 750ms
    .hold_time        = 90,     // Holdæ—¶é—´ï¼š90 Ã— 10ms = 900ms
    .click_delay_time = 20,     // å¤šå‡»å»¶æ—¶ï¼š20 Ã— 10ms = 200ms â­ï¸
    .idle_query_en    = 1,
    .key_init         = lp_touch_key_init,
    .get_value        = lp_touch_key_get_value,
    .param            = &lp_touch_key_param,
};
```

#### ç”µé˜»æŒ‰é”®å‚æ•° (`apps/common/device/key/adkey.c`)

```c
REGISTER_KEY_OPS(adkey) = {
    .key_type         = KEY_DRIVER_TYPE_ADKEY,
    .scan_time        = 1,      // æ‰«æå‘¨æœŸï¼š1 Ã— 10ms = 10ms
    .filter_time      = 4,      // æ¶ˆæŠ–æ—¶é—´ï¼š4 Ã— 10ms = 40ms
    .long_time        = 75,     // é•¿æŒ‰æ—¶é—´ï¼š75 Ã— 10ms = 750ms
    .hold_time        = 90,     // Holdæ—¶é—´ï¼š90 Ã— 10ms = 900ms
    .click_delay_time = 20,     // å¤šå‡»å»¶æ—¶ï¼š20 Ã— 10ms = 200ms â­ï¸
    .idle_query_en    = 1,
    .key_init         = adkey_init,
    .get_value        = adkey_get_value,
    .param            = &adkey_param,
};
```

#### å®¢æˆ·åŒ–è°ƒæ•´æ–¹æ¡ˆ

```c
// å¯ä»¥åˆ›å»ºå®¢æˆ·ç‰¹å®šçš„å‚æ•°é…ç½®å®
#ifdef CUSTOMER_SLOW_MULTI_CLICK
#define MULTI_CLICK_DELAY_TIME  30  // 300msï¼Œæ›´é€‚åˆæ…¢é€Ÿæ“ä½œç”¨æˆ·
#else
#define MULTI_CLICK_DELAY_TIME  20  // 200msï¼Œé»˜è®¤é…ç½®
#endif

REGISTER_KEY_OPS(iokey) = {
    // ... å…¶ä»–å‚æ•°
    .click_delay_time = MULTI_CLICK_DELAY_TIME,
    // ...
};
```

è¿è¡Œæ—¶è°ƒæ•´æ–¹æ¡ˆ

```c
// åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ¨æ€è°ƒæ•´å‚æ•°
void key_config_customer_init(void) {
    extern struct key_driver_ops *get_iokey_ops(void);
    struct key_driver_ops *iokey_ops = get_iokey_ops();
    
    #if defined(_CUSTOMER_SLOW_CLICK)
    iokey_ops->click_delay_time = 35;  // 350ms
    #elif defined(_CUSTOMER_FAST_CLICK)  
    iokey_ops->click_delay_time = 15;  // 150ms
    #endif
}
```

#### å¤šå‡»å»¶æ—¶ç®—æ³•åˆ†æ

[ä¼ é€é—¨](###1. æŒ‰é”®æ‰«ææœºåˆ¶)

```c
// å¤šå‡»å»¶æ—¶çš„æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ (key_driver.c)
//è¿™æ˜¯åœ¨æŒ‰é”®æ‰«æé‚£ä¸ªåœ°æ–¹
if (scan_para->click_delay_cnt > 0) {
    scan_para->click_delay_cnt++;
    // å»¶æ—¶è®¡æ•°è¾¾åˆ°é˜ˆå€¼ï¼Œå‘é€å¤šå‡»äº‹ä»¶
    if (scan_para->click_delay_cnt > key_handler->click_delay_time) {
        key_event = KEY_ACTION_NO_KEY;  // è§¦å‘å¤šå‡»åˆ¤æ–­å®Œæˆ
        scan_para->click_delay_cnt = 0;
        goto __notify;
    }
}
```

**è®¡ç®—å…¬å¼ï¼š**

- å®é™…å»¶æ—¶ = `click_delay_time` Ã— `scan_time` Ã— 10ms
- é»˜è®¤ï¼š20 Ã— 1 Ã— 10ms = 200ms
- å®¢æˆ·å®šåˆ¶ï¼š30 Ã— 1 Ã— 10ms = 300ms (æ›´å®¹æ˜“è¿å‡»)

**æ¨èé…ç½®å‚æ•°**

| ç”¨æˆ·ç±»å‹ | click_delay_time | å®é™…å»¶æ—¶ | é€‚ç”¨åœºæ™¯         |
| -------- | ---------------- | -------- | ---------------- |
| å¿«é€Ÿç”¨æˆ· | 15               | 150ms    | å¹´è½»ç”¨æˆ·ï¼Œååº”å¿« |
| æ ‡å‡†ç”¨æˆ· | 20               | 200ms    | é»˜è®¤é…ç½®         |
| æ…¢é€Ÿç”¨æˆ· | 30               | 300ms    | è€äººã€å„¿ç«¥ç”¨æˆ·   |
| è¶…æ…¢é€Ÿ   | 40               | 400ms    | ç‰¹æ®Šéœ€æ±‚å®¢æˆ·     |

## æŒ‰é”®äº‹ä»¶å°è£…ä¸å‘é€

### TWSæŒ‰é”®äº‹ä»¶æ¶ˆæ¯å‘é€å’Œä¸ä½¿èƒ½TWSçš„æŒ‰é”®äº‹ä»¶æ¶ˆæ¯å‘é€

```c
#if TCFG_USER_TWS_ENABLE
    // 6. TWSæŒ‰é”®åŒæ­¥å¤„ç†
    bt_tws_key_msg_sync(msg[0]);
#else
    // 7. å‘é€åˆ°åº”ç”¨æ¶ˆæ¯é˜Ÿåˆ—
    app_send_message_from(MSG_FROM_KEY, 8, msg);
#endif
```

- TWSåŒæ­¥å¤„ç†ä¼šä¸ä¼šä¸€ä¸ªæŒ‰é”®äº‹ä»¶è§¦å‘ä¸¤æ¬¡å¯¹åº”çš„å¤„ç†ï¼Ÿ
- TWSæŒ‰é”®äº‹ä»¶æ¶ˆæ¯å‘é€å’Œä¸ä½¿èƒ½TWSçš„æŒ‰é”®äº‹ä»¶æ¶ˆæ¯å‘é€çš„æµç¨‹ä¸ä¸€æ ·ï¼Ÿ
  - é‚£ä»–ä»¬çš„æ¶ˆæ¯å¤„ç†å‡½æ•°æ˜ å°„çš„è¿˜æ˜¯åŒä¸€ä¸ªå‡½æ•°å—ï¼Ÿå¦‚æœæ˜¯ä¸€ä¸ªï¼Œé‚£ä¸¤è€…çš„æ•ˆæœä¸€æ ·çš„è¯ï¼Œè¿˜æœ‰å¿…è¦åˆ†å¼€å—ï¼Ÿ

#### æ¶ˆæ¯å‘é€è·¯å¾„å¯¹æ¯”

éTWSæ¨¡å¼æµç¨‹

```c
ç”¨æˆ·æŒ‰é”® â†’ ç¡¬ä»¶æ£€æµ‹ â†’ æŒ‰é”®é©±åŠ¨æ‰«æ â†’ äº‹ä»¶è¯†åˆ« â†’ å¤šå‡»ç®—æ³• 
    â†“
key_event_handler() â†’ app_send_message_from() â†’ æ“ä½œç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—
    â†“
app_get_message() â†’ æŒ‰é”®é‡æ˜ å°„ â†’ åº”ç”¨åŠŸèƒ½å¤„ç†
```

TWSæ¨¡å¼æµç¨‹

```c
ç”¨æˆ·æŒ‰é”® â†’ ç¡¬ä»¶æ£€æµ‹ â†’ æŒ‰é”®é©±åŠ¨æ‰«æ â†’ äº‹ä»¶è¯†åˆ« â†’ å¤šå‡»ç®—æ³•
    â†“
key_event_handler() â†’ bt_tws_key_msg_sync() â†’ TWSæ•°æ®ä¼ è¾“
    â†“                              â†“
ä¸»æœºæ¥æ”¶å¹¶å¤„ç†                      ä»æœºæ¥æ”¶æ•°æ®
    â†“                              â†“
tws_key_sync_proc() â†’ è”åˆæŒ‰é”®æ£€æµ‹ â†’ app_send_message_from()
    â†“
æ“ä½œç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ— â†’ app_get_message() â†’ æŒ‰é”®é‡æ˜ å°„ â†’ åº”ç”¨åŠŸèƒ½å¤„ç†
```

- åªè¦æ˜¯åŒä¸€ç§æŒ‰é”®ï¼Œè¿˜æ˜¯æ˜ å°„åˆ°åŒä¸€ä¸ªå¤„ç†å‡½æ•°ä¸Šã€‚
- TWSå¤šäº†ä¸€ä¸ªè”åˆæŒ‰é”®æ£€æµ‹æµç¨‹
- tws_key_sync_procæœ‰å¯èƒ½æ˜¯å¹»è§‰ã€‚

#### ä¸»ä»è€³å¤„ç†å·®å¼‚ï¼ˆå¯èƒ½å¹»è§‰ï¼‰

ä¸»è€³(Master)å¤„ç†é€»è¾‘

```c
// ä¸»è€³æ”¶åˆ°æŒ‰é”®äº‹ä»¶æ—¶
void master_key_process(int key_msg) {
    g_msg[0] = key_msg;              // ä¿å­˜æœ¬åœ°æŒ‰é”®
    g_time[0] = jiffies;             // è®°å½•æœ¬åœ°æ—¶é—´
    
    // å‘é€åˆ°å¯¹ç«¯
    tws_api_send_data_to_sibling(&key_msg, 4, 0x8097ADF1);
    
    // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥è”åˆæŒ‰é”®
    // å¦‚æœå¯¹ç«¯ä¹Ÿæœ‰æŒ‰é”®ï¼Œä¼šåœ¨tws_combination_key_translateä¸­å¤„ç†
}
```

ä»è€³(Slave)å¤„ç†é€»è¾‘  

```c
// ä»è€³æ”¶åˆ°å¯¹ç«¯æŒ‰é”®æ•°æ®æ—¶
void tws_key_sync_proc(int msg) {
    g_msg[1] = msg;                  // ä¿å­˜å¯¹ç«¯æŒ‰é”®
    g_time[1] = jiffies;             // è®°å½•æ¥æ”¶æ—¶é—´
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æŒ‰é”®å½¢æˆè”åˆæŒ‰é”®
    int new_msg = tws_combination_key_translate(msg, 1);
    if (new_msg) {
        // åªæœ‰æ£€æµ‹åˆ°è”åˆæŒ‰é”®æ‰å¤„ç†ï¼Œå¦åˆ™å¿½ç•¥å¯¹ç«¯æŒ‰é”®
        app_send_message_from(MSG_FROM_KEY, 8, &new_msg);
    }
}
```

#### äº‹ä»¶è¿‡æ»¤æœºåˆ¶

```c
// TWSä»è€³çš„æŒ‰é”®è¿‡æ»¤é€»è¾‘
void tws_slave_key_filter(int key_msg) {
    char local_channel = tws_api_get_local_channel();
    
    // ä»è€³è¿‡æ»¤å¤§éƒ¨åˆ†æŒ‰é”®ï¼Œé¿å…é‡å¤å¤„ç†
    if (local_channel != 'L') {  // å‡è®¾å·¦è€³ä¸ºä¸»è€³
        // åªæœ‰ç‰¹å®šæŒ‰é”®ç±»å‹å…è®¸ä»è€³å¤„ç†
        int action = APP_MSG_KEY_ACTION(key_msg);
        if (action != KEY_ACTION_EMERGENCY && 
            action != KEY_ACTION_POWER_OFF) {
            return;  // è¿‡æ»¤æ‰æ™®é€šæŒ‰é”®
        }
    }
    
    // ç»§ç»­å¤„ç†æµç¨‹
    app_send_message_from(MSG_FROM_KEY, 8, &key_msg);
}
```

- å¯èƒ½çœŸæ˜¯è¿™æ ·ï¼Œå…³æœºæ—¶ä¸¤ä¸ªæ˜¯ä¸€èµ·å…³æœºçš„ã€‚å…¶ä»–åªæ‰§è¡Œä¸€æ¬¡ã€‚
- å¯ä»¥è·Ÿç€`sys_enter_soft_poweroff`è¿›å»çœ‹çœ‹ã€‚

#### å…³é”®å·®å¼‚æ€»ç»“

| å¤„ç†ç¯èŠ‚ | éTWSæ¨¡å¼    | TWSæ¨¡å¼            | è¯´æ˜            |
| -------- | ------------ | ------------------ | --------------- |
| æ¶ˆæ¯ä¼ è¾“ | ç›´æ¥æœ¬åœ°å¤„ç† | TWSåŒæ­¥åå¤„ç†      | TWSéœ€è¦ç½‘ç»œä¼ è¾“ |
| å¤„ç†å»¶æ—¶ | 0ms          | 10-50ms            | TWSä¼ è¾“å»¶æ—¶     |
| è”åˆæŒ‰é”® | ä¸æ”¯æŒ       | æ”¯æŒÂ±200msçª—å£     | TWSç‹¬æœ‰åŠŸèƒ½     |
| ä¸»ä»åŒºåˆ† | æ—            | ä¸»è€³å¤„ç†ï¼Œä»è€³è¿‡æ»¤ | é¿å…é‡å¤æ‰§è¡Œ    |
| é”™è¯¯å¤„ç† | æ— ç½‘ç»œé—®é¢˜   | éœ€å¤„ç†ä¼ è¾“å¤±è´¥     | TWSé“¾è·¯ä¸ç¨³å®šæ—¶ |

## ä¸åŒçš„æŒ‰é”®å¯¹åº”ä¸åŒçš„æŒ‰é”®æ˜ å°„å¤„ç†å‡½æ•°

- ä½¿èƒ½`TCFG_IOKEY_ENABLE`æŒ‰é”®ï¼Œ`KEY_POWER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_power_msg_remap`
- ä½¿èƒ½`TCFG_LP_TOUCH_KEY_ENABLE`æŒ‰é”®ï¼Œ`KEY_POWER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_power_msg_remap`
  - `KEY_SLIDER`æŒ‰é”®çš„æŒ‰é”®äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º`bt_key_slider_msg_remap`

ä»–ä»¬å¤„ç†å‡½æ•°å…·ä½“æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„ï¼Ÿæ·±åŒ–ä¸€ä¸‹å…·ä½“çš„å¤„ç†æµç¨‹ï¼Ÿ

#### æ˜ å°„å‡½æ•°æ³¨å†Œæœºåˆ¶

```c
// æŒ‰é”®é‡æ˜ å°„è¡¨ç»“æ„
struct key_remap_table {
    u8 key_value;                    // ç‰©ç†æŒ‰é”®å€¼
    const int *remap_table;          // é™æ€æ˜ å°„è¡¨ï¼ˆç®€å•æ˜ å°„ï¼‰
    int (*remap_func)(int *event);   // åŠ¨æ€æ˜ å°„å‡½æ•°ï¼ˆå¤æ‚é€»è¾‘ï¼‰
};

// è“ç‰™æ¨¡å¼ä¸‹çš„æŒ‰é”®æ˜ å°„è¡¨
const struct key_remap_table bt_mode_key_table[] = {
    // IOKEYç±»å‹æŒ‰é”®
    #if TCFG_IOKEY_ENABLE
    { .key_value = KEY_POWER, .remap_func = bt_key_power_msg_remap },
    #endif
    
    // è§¦æ‘¸æŒ‰é”®ç±»å‹
    #if TCFG_LP_TOUCH_KEY_ENABLE  
    { .key_value = KEY_POWER,  .remap_func = bt_key_power_msg_remap },
    { .key_value = KEY_SLIDER, .remap_func = bt_key_slider_msg_remap },
    #endif
    
    // ç”µé˜»æŒ‰é”®ç±»å‹ - ä½¿ç”¨é™æ€æ˜ å°„è¡¨
    #if TCFG_ADKEY_ENABLE
    { .key_value = KEY_AD_NUM0, .remap_table = adkey_msg_table[0] },
    { .key_value = KEY_AD_NUM1, .remap_table = adkey_msg_table[1] },
    { .key_value = KEY_AD_NUM2, .remap_table = adkey_msg_table[2] },
    // ...
    #endif
    
    { .key_value = 0xff }  // ç»“æŸæ ‡å¿—
};
```

#### æ ¸å¿ƒæ˜ å°„æ‰§è¡Œå‡½æ•°

```c
// æŒ‰é”®é‡æ˜ å°„æ‰§è¡Œå‡½æ•°
int app_key_event_remap(const struct key_remap_table *table, int *event) {
    u8 key_value = APP_MSG_KEY_VALUE(event[0]);   // é«˜8ä½ï¼šæŒ‰é”®å€¼
    u8 key_action = APP_MSG_KEY_ACTION(event[0]); // ä½8ä½ï¼šæŒ‰é”®åŠ¨ä½œ
    
    if (table) {
        // éå†æ˜ å°„è¡¨æ‰¾åˆ°åŒ¹é…çš„æŒ‰é”®å€¼
        for (int i = 0; table[i].key_value != 0xff; i++) {
            if (table[i].key_value == key_value) {
                
                // ä¼˜å…ˆä½¿ç”¨é™æ€æ˜ å°„è¡¨ï¼ˆé«˜æ•ˆï¼‰
                if (table[i].remap_table) {
                    return table[i].remap_table[key_action];
                }
                
                // ä½¿ç”¨åŠ¨æ€æ˜ å°„å‡½æ•°ï¼ˆçµæ´»ï¼‰
                if (table[i].remap_func) {
                    return table[i].remap_func(event);
                }
                break;
            }
        }
    }
    
    return APP_MSG_NULL;  // æœªæ‰¾åˆ°æ˜ å°„
}
```

#### ç”µæºé”®æ˜ å°„å‡½æ•°è¯¦è§£

```c
int bt_key_power_msg_remap(int *msg) {
    u8 key_action = APP_MSG_KEY_ACTION(msg[0]);
    char channel = tws_api_get_local_channel();      // 'L' æˆ– 'R'
    int tws_state = tws_api_get_tws_state();
    int app_msg = APP_MSG_NULL;
    
    // è·å–å½“å‰è“ç‰™è®¾å¤‡çŠ¶æ€
    BD_ADDR *active_device = get_current_active_device();     // é€šè¯ä¸­è®¾å¤‡
    BD_ADDR *incoming_device = get_current_incoming_device(); // æ¥ç”µè®¾å¤‡
    
    // === é€šè¯çŠ¶æ€å¤„ç† ===
    if (active_device) {
        switch (key_action) {
        case KEY_ACTION_CLICK:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJç³»åˆ—ï¼šé€šè¯ä¸­å•å‡»æ— åŠ¨ä½œï¼ˆé¿å…è¯¯æ“ä½œï¼‰
            break;
            #endif
            
            #if defined(_GK158_Left) || defined(_GK158_Right)
            // GK158ï¼šé€šè¯ä¸­å•å‡»ä¸ºä¸‰æ–¹é€šè¯
            app_msg = APP_MSG_CALL_THREE_WAY_ANSWER;
            #endif
            break;
            
        case KEY_ACTION_LONG:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJç³»åˆ—ï¼šé€šè¯ä¸­é•¿æŒ‰æŒ‚æ–­
            app_msg = APP_MSG_CALL_HANGUP;
            #endif
            break;
            
        case KEY_ACTION_DOUBLE_CLICK:
            #if defined(_GK158_Left) || defined(_GK158_Right)
            // GK158ï¼šé€šè¯ä¸­åŒå‡»æŒ‚æ–­
            app_msg = APP_MSG_CALL_HANGUP;
            #endif
            break;
        }
    }
    
    // === æ¥ç”µçŠ¶æ€å¤„ç† ===
    else if (incoming_device) {
        switch (key_action) {
        case KEY_ACTION_CLICK:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            app_msg = APP_MSG_CALL_ANSWER;  // å•å‡»æ¥å¬
            #endif
            
            #if defined(_GK158_Left) || defined(_GK158_Right)
            app_msg = APP_MSG_CALL_THREE_WAY_ANSWER2;  // ä¸‰æ–¹é€šè¯æ¥å¬
            #endif
            break;
            
        case KEY_ACTION_LONG:
            // æ‰€æœ‰å®¢æˆ·ï¼šæ¥ç”µé•¿æŒ‰æ‹’æ¥
            app_msg = APP_MSG_CALL_HANGUP;
            break;
            
        case KEY_ACTION_DOUBLE_CLICK:
            #if defined(_GK158_Left) || defined(_GK158_Right)
            app_msg = APP_MSG_CALL_ANSWER;  // GK158åŒå‡»æ¥å¬
            #endif
            break;
        }
    }
    
    // === éŸ³ä¹æ’­æ”¾çŠ¶æ€å¤„ç† ===
    else if (tws_state & TWS_STA_PHONE_CONNECTED) {
        switch (key_action) {
        case KEY_ACTION_CLICK:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            app_msg = APP_MSG_MUSIC_PP;  // æ’­æ”¾/æš‚åœ
            #endif
            
            #if defined(_GK158_Left) || defined(_GK158_Right)
            app_msg = APP_MSG_MUSIC_PP;  // æ’­æ”¾/æš‚åœ
            #endif
            break;
            
        case KEY_ACTION_DOUBLE_CLICK:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJç³»åˆ—ï¼šåŒå‡»éŸ³é‡æ§åˆ¶ï¼ˆå·¦å‡å³åŠ ï¼‰
            if ((channel == 'L' && msg[1] != APP_KEY_MSG_FROM_TWS) ||
                (channel == 'R' && msg[1] == APP_KEY_MSG_FROM_TWS)) {
                app_msg = APP_MSG_VOL_DOWN;  // å·¦è€³éŸ³é‡å‡
            } else {
                app_msg = APP_MSG_VOL_UP;    // å³è€³éŸ³é‡åŠ 
            }
            #else
            // GK158ï¼šåŒå‡»åˆ‡æ­Œæ§åˆ¶ï¼ˆå·¦ä¸Šä¸€æ›²å³ä¸‹ä¸€æ›²ï¼‰
            if ((channel == 'L' && msg[1] != APP_KEY_MSG_FROM_TWS) ||
                (channel == 'R' && msg[1] == APP_KEY_MSG_FROM_TWS)) {
                app_msg = APP_MSG_MUSIC_PREV;  // å·¦è€³ä¸Šä¸€æ›²
            } else {
                app_msg = APP_MSG_MUSIC_NEXT;  // å³è€³ä¸‹ä¸€æ›²
            }
            #endif
            break;
            
        case KEY_ACTION_LONG:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJç³»åˆ—ï¼šé•¿æŒ‰åˆ‡æ­Œï¼ˆå·¦ä¸Šä¸€æ›²å³ä¸‹ä¸€æ›²ï¼‰
            const char *fname = get_tone_files()->normal;
            tws_play_tone_file_alone(fname, 0);  // æ’­æ”¾æç¤ºéŸ³
            
            if ((channel == 'L' && msg[1] != APP_KEY_MSG_FROM_TWS) ||
                (channel == 'R' && msg[1] == APP_KEY_MSG_FROM_TWS)) {
                app_msg = APP_MSG_MUSIC_PREV;
            } else {
                app_msg = APP_MSG_MUSIC_NEXT;
            }
            #endif
            break;
            
        case KEY_ACTION_TRIPLE_CLICK:
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJç³»åˆ—ï¼šä¸‰å‡»åŠŸèƒ½åˆ†é…ï¼ˆå·¦è¯­éŸ³åŠ©æ‰‹å³ä½å»¶è¿Ÿï¼‰
            if (tws_state & TWS_STA_SIBLING_CONNECTED) {
                if ((channel == 'L' && msg[1] != APP_KEY_MSG_FROM_TWS) ||
                    (channel == 'R' && msg[1] == APP_KEY_MSG_FROM_TWS)) {
                    app_msg = APP_MSG_OPEN_SIRI;      // å·¦è€³ï¼šè¯­éŸ³åŠ©æ‰‹
                } else {
                    app_msg = APP_MSG_LOW_LANTECY;    // å³è€³ï¼šä½å»¶è¿Ÿæ¨¡å¼
                }
            }
            #else
            // GK158ï¼šä¸‰å‡»è¯­éŸ³åŠ©æ‰‹
            app_msg = APP_MSG_OPEN_SIRI;
            #endif
            break;
        }
    }
    
    // === é€šç”¨åŠŸèƒ½å¤„ç† ===
    switch (key_action) {
    case KEY_ACTION_HOLD_3SEC:
        // æ‰€æœ‰å®¢æˆ·ï¼š3ç§’é•¿æŒ‰å…³æœº
        app_msg = APP_MSG_TWS_POWER_OFF;
        break;
        
    case KEY_ACTION_FIRTH_CLICK:
        // äº”å‡»åŠŸèƒ½ï¼ˆä»…åœ¨æœªè¿æ¥çŠ¶æ€ï¼‰
        if (tws_state & TWS_STA_PHONE_DISCONNECTED) {
            #if defined(_YYSX_S30_Left) || defined(_YYSX_S30_Right) || \
                defined(_YYSX_H28_Left) || defined(_YYSX_H28_Right) || \
                defined(_YYSX_H20_Left) || defined(_YYSX_H20_Right) || \
                defined(_MKJ_M86_Left) || defined(_MKJ_M86_Right)
            // YYSX/MKJï¼šäº”å‡»æ¢å¤å‡ºå‚è®¾ç½®
            const char *fname = get_tone_files()->normal;
            tws_play_tone_file_alone(fname, 0);
            app_msg = APP_MSG_FACTORY_RESET;
            #else
            // GK158ï¼šäº”å‡»è¿›å…¥äº§æµ‹æ¨¡å¼
            app_msg = APP_MSG_BT_OPEN_DUT;
            #endif
        }
        break;
        
    #if (TCFG_USER_TWS_ENABLE && (CONFIG_TWS_PAIR_MODE == CONFIG_TWS_PAIR_BY_CLICK))
    case KEY_ACTION_FOURTH_CLICK:
        // å››å‡»TWSé…å¯¹ï¼ˆå¦‚æœæ”¯æŒï¼‰
        if (tws_state & TWS_STA_TWS_UNPAIRED) {
            app_msg = APP_MSG_TWS_START_PAIR;
        }
        break;
    #endif
    }
    
    printf("bt_key_msg_remap, key_action: %d, app_msg: %d\n", key_action, app_msg);
    return app_msg;
}
```

#### é™æ€æ˜ å°„è¡¨ï¼ˆADKEYï¼‰

```c
// ç”µé˜»æŒ‰é”®é™æ€æ˜ å°„è¡¨ç¤ºä¾‹
const int adkey_msg_table[10][KEY_ACTION_MAX] = {
    // KEY_AD_NUM0çš„æ˜ å°„è¡¨
    [0] = {
        [KEY_ACTION_CLICK]        = APP_MSG_MUSIC_PP,       // å•å‡»ï¼šæ’­æ”¾æš‚åœ
        [KEY_ACTION_LONG]         = APP_MSG_CALL_HANGUP,    // é•¿æŒ‰ï¼šæŒ‚æ–­ç”µè¯
        [KEY_ACTION_HOLD]         = APP_MSG_NULL,           // HOLDï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_UP]           = APP_MSG_NULL,           // æŠ¬èµ·ï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_DOUBLE_CLICK] = APP_MSG_LOW_LANTECY,    // åŒå‡»ï¼šä½å»¶è¿Ÿæ¨¡å¼
        [KEY_ACTION_TRIPLE_CLICK] = APP_MSG_NULL,           // ä¸‰å‡»ï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_FOURTH_CLICK] = APP_MSG_NULL,           // å››å‡»ï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_FIRTH_CLICK]  = APP_MSG_NULL,           // äº”å‡»ï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_HOLD_1SEC]    = APP_MSG_NULL,           // æŒ‰ä½1ç§’ï¼šæ— åŠ¨ä½œ
        [KEY_ACTION_HOLD_3SEC]    = APP_MSG_POWER_OFF,      // æŒ‰ä½3ç§’ï¼šå…³æœº
        // ... å…¶ä»–åŠ¨ä½œ
    },
    
    // KEY_AD_NUM1çš„æ˜ å°„è¡¨
    [1] = {
        [KEY_ACTION_CLICK]        = APP_MSG_MUSIC_NEXT,     // å•å‡»ï¼šä¸‹ä¸€æ›²
        [KEY_ACTION_LONG]         = APP_MSG_VOL_UP,         // é•¿æŒ‰ï¼šéŸ³é‡åŠ 
        [KEY_ACTION_HOLD]         = APP_MSG_VOL_UP,         // HOLDï¼šæŒç»­éŸ³é‡åŠ 
        // ... å…¶ä»–åŠ¨ä½œ
    },
    
    // KEY_AD_NUM2çš„æ˜ å°„è¡¨
    [2] = {
        [KEY_ACTION_CLICK]        = APP_MSG_MUSIC_PREV,     // å•å‡»ï¼šä¸Šä¸€æ›²
        [KEY_ACTION_LONG]         = APP_MSG_VOL_DOWN,       // é•¿æŒ‰ï¼šéŸ³é‡å‡
        [KEY_ACTION_HOLD]         = APP_MSG_VOL_DOWN,       // HOLDï¼šæŒç»­éŸ³é‡å‡
        // ... å…¶ä»–åŠ¨ä½œ
    },
    
    // ... å…¶ä»–æŒ‰é”®æ˜ å°„
};
```

## æ˜ å°„å‡½æ•°ä¸­çš„å…·ä½“å¤„ç†æµç¨‹

- ä¸ºä»€ä¹ˆä¸çŸ¥é“åœ¨æ˜ å°„å‡½æ•°ä¸­ç›´æ¥å†™å¤„ç†é€»è¾‘ï¼Ÿ
- è¿˜æ˜¯è¦é€šè¿‡`app_msg = APP_MSG_ANC_SWITCH`ï¼Ÿ
- `return app_msg;`è¿”å›çš„å€¼è¢«è°å¤„ç†äº†ï¼Ÿæˆ‘æ²¡çœ‹åˆ°è°ƒç”¨ï¼Œä½ å¯ä»¥æ¨æµ‹ä¸€ä¸‹å—ï¼Ÿè¢«`bt_app_msg_handler`å¤„ç†äº†ï¼Ÿ
- å®é™…ä¸Šå…·ä½“çš„æŒ‰é”®äº‹ä»¶å¤„ç†é€»è¾‘éƒ½åœ¨`bt_app_msg_handler`ä¸­ï¼Ÿ

### æ¶æ„è®¾è®¡åŸç†åˆ†æ

åˆ†å±‚æ¶æ„çš„è®¾è®¡æ€æƒ³

- SDKé‡‡ç”¨**åˆ†å±‚è§£è€¦**çš„è®¾è®¡æ¨¡å¼ï¼Œå°†æŒ‰é”®å¤„ç†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹å±‚æ¬¡ï¼š

```c
åº”ç”¨åŠŸèƒ½å±‚ (bt_app_msg_handler)
        â†‘ APP_MSG_ANC_SWITCH
æŒ‰é”®é‡æ˜ å°„å±‚ (bt_key_power_msg_remap)  
        â†‘ MSG_FROM_KEY â†’ MSG_FROM_APP
æŒ‰é”®æ¶ˆæ¯åˆ†å‘å±‚ (app_get_message)
        â†‘ key_event
æŒ‰é”®äº‹ä»¶å¤„ç†å±‚ (key_event_handler)
        â†‘ ç¡¬ä»¶æŒ‰é”®ä¿¡å·
æŒ‰é”®é©±åŠ¨å±‚
```

è¿™ç§è®¾è®¡çš„**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

- **èŒè´£å•ä¸€**ï¼šæ¯å±‚åªè´Ÿè´£ç‰¹å®šçš„é€»è¾‘å¤„ç†
- **æ˜“äºæ‰©å±•**ï¼šæ–°å¢æŒ‰é”®åŠŸèƒ½åªéœ€ä¿®æ”¹æ˜ å°„è¡¨æˆ–æ˜ å°„å‡½æ•°
- **å®¢æˆ·å®šåˆ¶**ï¼šä¸åŒå®¢æˆ·å¯ä»¥æœ‰ä¸åŒçš„æŒ‰é”®æ˜ å°„é€»è¾‘
- **ä»£ç å¤ç”¨**ï¼šåº•å±‚é©±åŠ¨å¯ä»¥è¢«å¤šä¸ªåº”ç”¨æ¨¡å¼å…±äº«

### ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨æ˜ å°„å‡½æ•°ä¸­å†™å¤„ç†é€»è¾‘ï¼Ÿ

å½“å‰æ¶æ„çš„æ˜ å°„å‡½æ•°è®¾è®¡

```c
int bt_key_power_msg_remap(int *msg) {
    // å¤æ‚çš„åœºæ™¯åˆ¤æ–­é€»è¾‘...
    switch (key_action) {
    case KEY_ACTION_CLICK:
        app_msg = APP_MSG_MUSIC_PP;  // è¿”å›æ¶ˆæ¯ç±»å‹
        break;
    case KEY_ACTION_HOLD_1SEC:
        app_msg = APP_MSG_ANC_SWITCH; // è¿”å›æ¶ˆæ¯ç±»å‹
        break;
    }
    return app_msg; // è¿”å›ç»™ä¸Šå±‚å¤„ç†
}
```

### å¦‚æœç›´æ¥å†™å¤„ç†é€»è¾‘çš„é—®é¢˜

```
// é”™è¯¯çš„è®¾è®¡æ–¹å¼
int bt_key_power_msg_remap(int *msg) {
    switch (key_action) {
    case KEY_ACTION_CLICK:
        bt_music_play_pause(); // ç›´æ¥è°ƒç”¨åŠŸèƒ½å‡½æ•°
        break;
    case KEY_ACTION_HOLD_1SEC:
        anc_mode_switch();     // ç›´æ¥è°ƒç”¨åŠŸèƒ½å‡½æ•°
        break;
    }
    return APP_MSG_NULL;
}
```

**ç›´æ¥å†™å¤„ç†é€»è¾‘çš„ç¼ºé™·**ï¼š

1. **è¿åå•ä¸€èŒè´£åŸåˆ™**
   - æ˜ å°„å‡½æ•°æ‰¿æ‹…äº†"æ˜ å°„"å’Œ"æ‰§è¡Œ"ä¸¤ä¸ªèŒè´£
   - ä»£ç è€¦åˆåº¦é«˜ï¼Œéš¾ä»¥ç»´æŠ¤

2. **æ— æ³•ç»Ÿä¸€ç®¡ç†**
   - åŠŸèƒ½é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæ˜ å°„å‡½æ•°ä¸­
   - æ— æ³•ç»Ÿä¸€è¿›è¡ŒçŠ¶æ€æ£€æŸ¥ã€æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•

3. **æ‰©å±•æ€§å·®**
   - æ–°å¢åŠŸèƒ½éœ€è¦ä¿®æ”¹å¤šä¸ªæ˜ å°„å‡½æ•°
   - å®¢æˆ·å®šåˆ¶åŒ–å›°éš¾

4. **è°ƒè¯•å›°éš¾**
   - æ— æ³•åœ¨ç»Ÿä¸€å…¥å£è¿›è¡Œæ¶ˆæ¯æ‹¦æˆªå’Œè°ƒè¯•
   - éš¾ä»¥è·Ÿè¸ªæ¶ˆæ¯æµè½¬è¿‡ç¨‹

### æ¶ˆæ¯ä¼ é€’æœºåˆ¶çš„å®Œæ•´æµç¨‹

#### ç¬¬ä¸€é˜¶æ®µï¼šæŒ‰é”®äº‹ä»¶ç”Ÿæˆ

```c
// SDK/apps/earphone/message/adapter/key.c:273
void key_event_handler(struct key_event *key) {
    // å¤šå‡»æ£€æµ‹ã€ç»„åˆé”®å¤„ç†ç­‰...
    
    int msg[2];
    msg[0] = (key->value << 8) | key->event; // å°è£…æŒ‰é”®æ¶ˆæ¯
    msg[1] = 0;

    // é€šè¿‡TWSåŒæ­¥æˆ–ç›´æ¥å‘é€
    bt_tws_key_msg_sync(msg[0]); 
    // åº•å±‚æœ€ç»ˆè°ƒç”¨ï¼šapp_send_message_from(MSG_FROM_KEY, 8, msg);
}

void bt_tws_key_msg_sync(int key_msg)
{
    int msg[2] = { key_msg, 0 };

#if TCFG_TWS_COMBINATIION_KEY_ENABLE
    int action = APP_MSG_KEY_ACTION(key_msg);
    if (action == KEY_ACTION_HOLD) {
        app_send_message_from(MSG_FROM_KEY, 8, msg);
        return;
    }
#endif
    tws_api_tx_unsniff_req();

    int err = tws_api_send_data_to_sibling(&key_msg, 4, 0x8097ADF1);
    if (err) {
        app_send_message_from(MSG_FROM_KEY, 8, msg);
    }
}
```

#### ç¬¬äºŒé˜¶æ®µï¼šæ¶ˆæ¯é˜Ÿåˆ—æŠ•é€’

```c
// SDK/apps/earphone/message/adapter/app_msg.c
void app_send_message_from(int from, int argc, int *msg)
{
    os_taskq_post_type("app_core", from, (argc + 3) / 4, msg);
}
```

- æ²¡æœ‰è½¬ç±»å‹å•Šã€‚
- ä¸å¯è§äº†ã€‚

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ¶ˆæ¯æ‹¦æˆªå’Œé‡æ˜ å°„

```c
// SDK/apps/earphone/app_main.c:app_get_message
int app_get_message(int *msg, int max_num, const struct key_remap_table *key_table) {
    app_core_get_message(msg, max_num); // ä»æ¶ˆæ¯é˜Ÿåˆ—å–æ¶ˆæ¯
    
    if (msg[0] == MSG_FROM_KEY && key_table) {
        // æŒ‰é”®æ¶ˆæ¯æ˜ å°„æˆå½“å‰æ¨¡å¼çš„æ¶ˆæ¯
        int key_msg = app_key_event_remap(key_table, msg + 1);
        //                                      â†“ è°ƒç”¨bt_key_power_msg_remap
        if (key_msg == APP_MSG_NULL) {
            return 1; // æ‹¦æˆªæ¶ˆæ¯
        }
        msg[0] = MSG_FROM_APP;    // è½¬æ¢æ¶ˆæ¯ç±»å‹
        msg[1] = key_msg;         // è®¾ç½®åº”ç”¨æ¶ˆæ¯ï¼Œå¦‚APP_MSG_ANC_SWITCH
    }
    return 1;
}
```

- æŒ‰é”®äº‹ä»¶ä¸ŠæŠ¥ç»™OSé˜Ÿåˆ—
- OSä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œè°ƒç”¨å¯¹åº”çš„æ˜ å°„å‡½æ•°ï¼Œè½¬æˆAPPå±‚æ¶ˆæ¯ï¼Œè°ƒç”¨è¿™ä¸ªAPPå±‚å‡½æ•°è¿›è¡Œå¤„ç†`bt_app_msg_handler`

#### ç¬¬å››é˜¶æ®µï¼šåº”ç”¨å±‚æ¶ˆæ¯å¤„ç†

```c
// SDK/apps/earphone/mode/bt/earphone.c
int bt_app_msg_handler(int *msg) {
    switch (msg[0]) {
    case APP_MSG_ANC_SWITCH:
        log_info("APP_MSG_ANC_SWITCH\n");
        anc_mode_switch(); // å®é™…çš„åŠŸèƒ½é€»è¾‘
        break;
    case APP_MSG_MUSIC_PP:
        log_info("APP_MSG_MUSIC_PP\n");
        bt_music_play_pause(); // å®é™…çš„åŠŸèƒ½é€»è¾‘
        break;
    }
    return 0;
}
```

#### ç¬¬äº”é˜¶æ®µï¼šä¸»åº”ç”¨å¾ªç¯è°ƒç”¨

```c
// SDK/apps/earphone/mode/bt/earphone.c
struct app_mode *app_enter_bt_mode(int arg)
{
    int msg[16];
    struct bt_event *event;
    struct app_mode *next_mode;

    bt_mode_init();

    while (1) {
        //é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯æ—¶ï¼Œå¼€å§‹å¾€ä¸‹èµ°ï¼Œä¸ç„¶ä»¥é˜»å¡æ€å¡åœ¨è¿™ç­‰ã€‚ä¸å½±å“å…¶ä»–åŠŸèƒ½ï¼Œ
        if (!app_get_message(msg, ARRAY_SIZE(msg), bt_mode_key_table)) {
            continue;
        }
        next_mode = app_mode_switch_handler(msg);
        if (next_mode) {
            break;
        }

        event = (struct bt_event *)(msg + 1);

        switch (msg[0]) {
#if TCFG_USER_TWS_ENABLE
        case MSG_FROM_TWS:
            bt_tws_connction_status_event_handler(msg + 1);
            break;
#endif
        case MSG_FROM_BT_STACK:
            bt_connction_status_event_handler(event);
#if TCFG_BT_DUAL_CONN_ENABLE
            bt_dual_phone_call_msg_handler(msg + 1);
#endif
            break;
        case MSG_FROM_BT_HCI:
            bt_hci_event_handler(event);
            break;
        case MSG_FROM_APP:
            bt_app_msg_handler(msg + 1);
            break;
        }

        app_default_msg_handler(msg);
    }

    bt_mode_exit();

    return next_mode;
}
```

### å…³é”®å‘ç°ï¼šæ¶ˆæ¯è½¬æ¢æœºåˆ¶

**é‡è¦å‘ç°**ï¼šæ‰€æœ‰çš„æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè¢«è½¬æ¢ä¸º `MSG_FROM_APP` ç±»å‹ã€‚

åœ¨ `app_get_message` å‡½æ•°ä¸­ï¼š

```c
if (msg[0] == MSG_FROM_KEY && key_table) {
    int key_msg = app_key_event_remap(key_table, msg + 1);
    // bt_key_power_msg_remap è¿”å›çš„ APP_MSG_ANC_SWITCH è¢«èµ‹å€¼ç»™ key_msg
    
    msg[0] = MSG_FROM_APP;    // åŸæ¥çš„ MSG_FROM_KEY è¢«æ›¿æ¢
    msg[1] = key_msg;         // APP_MSG_ANC_SWITCH æˆä¸ºæ¶ˆæ¯å‚æ•°
}
```

è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆï¼š

1. `bt_key_power_msg_remap` è¿”å›çš„å€¼æœ€ç»ˆä¼šè¢« `bt_app_msg_handler` å¤„ç†
2. æ˜ å°„å‡½æ•°åªè´Ÿè´£"ç¿»è¯‘"ï¼Œä¸è´Ÿè´£"æ‰§è¡Œ"
3. æ‰€æœ‰çš„å®é™…å¤„ç†é€»è¾‘éƒ½é›†ä¸­åœ¨ `bt_app_msg_handler` ä¸­

### è®¾è®¡æ¨¡å¼åˆ†æ

è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)

```c
ç¡¬ä»¶æŒ‰é”® â†’ é©±åŠ¨å±‚ â†’ äº‹ä»¶å¤„ç†å±‚ â†’ æ¶ˆæ¯åˆ†å‘å±‚ â†’ é‡æ˜ å°„å±‚ â†’ åº”ç”¨å±‚
```

æ¯ä¸€å±‚éƒ½æœ‰ç‰¹å®šçš„èŒè´£ï¼Œæ¶ˆæ¯åœ¨é“¾ä¸­ä¼ é€’å¹¶è¢«é€æ­¥åŠ å·¥ã€‚

#### ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

```c
const struct key_remap_table bt_mode_key_table[] = {
    { .key_value = KEY_POWER, .remap_func = bt_key_power_msg_remap },
    // ä¸åŒçš„æŒ‰é”®å¯ä»¥æœ‰ä¸åŒçš„æ˜ å°„ç­–ç•¥
};
```

ä¸åŒçš„æŒ‰é”®å€¼å¯¹åº”ä¸åŒçš„æ˜ å°„ç­–ç•¥å‡½æ•°ã€‚

#### è§‚å¯Ÿè€…æ¨¡å¼çš„å˜ä½“

æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å®ç°äº†ç”Ÿäº§è€…ï¼ˆæŒ‰é”®äº‹ä»¶ï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆåº”ç”¨å¤„ç†å™¨ï¼‰çš„è§£è€¦ã€‚

ä¸åŒå®¢æˆ·å¯ä»¥æœ‰ä¸åŒçš„æŒ‰é”®æ˜ å°„é€»è¾‘ï¼š

```c
#if defined(_YYSX_S30_Left)
    app_msg = APP_MSG_MUSIC_PP;        // S30å®¢æˆ·ï¼šå•å‡»æ’­æ”¾æš‚åœ
#elif defined(_GK158_Left)
    app_msg = APP_MSG_CALL_ANSWER;     // GK158å®¢æˆ·ï¼šå•å‡»æ¥å¬ç”µè¯
#endif
```

- æ–°å¢æŒ‰é”®åŠŸèƒ½ï¼šåªéœ€åœ¨æ˜ å°„å‡½æ•°ä¸­è¿”å›æ–°çš„æ¶ˆæ¯ç±»å‹ï¼Œåœ¨å¤„ç†å™¨ä¸­æ·»åŠ å¯¹åº”case
- ä¿®æ”¹æŒ‰é”®è¡Œä¸ºï¼šåªéœ€ä¿®æ”¹æ˜ å°„å‡½æ•°çš„è¿”å›å€¼
- è°ƒè¯•é—®é¢˜ï¼šå¯ä»¥åœ¨æ¶ˆæ¯ä¼ é€’çš„å„ä¸ªç¯èŠ‚æ·»åŠ æ—¥å¿—

åº•å±‚çš„æŒ‰é”®é©±åŠ¨å’Œäº‹ä»¶å¤„ç†å¯ä»¥è¢«å¤šä¸ªåº”ç”¨æ¨¡å¼ï¼ˆè“ç‰™æ¨¡å¼ã€éŸ³ä¹æ¨¡å¼ç­‰ï¼‰å…±äº«ã€‚

1. **æ˜ å°„å‡½æ•°èŒè´£å•ä¸€**ï¼šåªè´Ÿè´£å°†ç¡¬ä»¶æŒ‰é”®äº‹ä»¶ç¿»è¯‘æˆåº”ç”¨æ¶ˆæ¯ï¼Œä¸æ‰§è¡Œå…·ä½“åŠŸèƒ½
2. **æ¶ˆæ¯é©±åŠ¨æ¶æ„**ï¼šé€šè¿‡ `APP_MSG_*` æ¶ˆæ¯å®ç°äº†ç¡¬ä»¶å’Œåº”ç”¨çš„è§£è€¦
3. **ç»Ÿä¸€å¤„ç†å…¥å£**ï¼š`bt_app_msg_handler` æ˜¯æ‰€æœ‰åº”ç”¨åŠŸèƒ½çš„ç»Ÿä¸€å…¥å£
4. **è¿”å›å€¼æµå‘æ¸…æ™°**ï¼šæ˜ å°„å‡½æ•°è¿”å›å€¼ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ åº”ç”¨å¤„ç†å™¨

è¿™ç§æ¶æ„è®¾è®¡è™½ç„¶çœ‹èµ·æ¥å¤æ‚ï¼Œä½†å®ç°äº†é«˜åº¦çš„æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦æ”¯æŒå¤šç§å®¢æˆ·å®šåˆ¶åŒ–éœ€æ±‚çš„åµŒå…¥å¼äº§å“å¼€å‘ã€‚

# å¤šå‡»+é•¿æŒ‰çš„æŒ‰é”®äº‹ä»¶ç±»å‹éœ€æ±‚ï¼ˆé€šç”¨æŒ‰é”®ï¼‰

å®¢æˆ·å¾ˆå¤šéƒ½æœ‰è§¦æ‘¸æŒ‰é”®æˆ–è€…IOæŒ‰é”®æ“ä½œä¸­ï¼Œå•å‡»+é•¿æŒ‰ï¼Œä¸‰å‡»+é•¿æŒ‰ã€‚

- æŒ‰ç…§SDKåŸæ¥çš„é€»è¾‘çš„è¯ï¼Œåœ¨å¤šå‡»åˆ¤å®šæµç¨‹ä¸­ï¼Œè§¦å‘å…¶ä»–æŒ‰é”®ä¼šæ‰“æ–­å¤šå‡»åºåˆ—ä»è€Œä»¥æœ€åä¸€æ¬¡æŒ‰é”®äº‹ä»¶ä¸ŠæŠ¥ã€‚
- æ€ä¹ˆå®ç°å¤šå‡»+é•¿æŒ‰çš„éœ€æ±‚ï¼Œä»¥æœ€å°å…¥ä¾µæ–¹å¼å®ç°ï¼Ÿ

## å½“å‰æ¶æ„é™åˆ¶åˆ†æ

```c
// å½“å‰çš„å¤šå‡»è¯†åˆ«é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
static int multi_clicks_translate(struct key_event *key) {
    static u8 click_cnt = 0;
    static u8 notify_value = 0xff;
    
    if (key->event == KEY_ACTION_CLICK) {
        if (key->value != notify_value) {
            click_cnt = 1;              // æ–°æŒ‰é”®åºåˆ—
            notify_value = key->value;
        } else {
            click_cnt++;                // å¤šå‡»è®¡æ•°
        }
        return 1;  // æ‹¦æˆªï¼Œç­‰å¾…å¤šå‡»å®Œæˆ
    }
    
    if (key->event > KEY_ACTION_CLICK) {
        //é—®é¢˜æ‰€åœ¨ï¼šä»»ä½•éå•å‡»äº‹ä»¶éƒ½ä¼šæ‰“æ–­å¤šå‡»åºåˆ—
        click_cnt = 0;              // é‡ç½®è®¡æ•°
        notify_value = NO_KEY;      // æ¸…é™¤çŠ¶æ€
        return 0;  // ç›´æ¥å‘é€å½“å‰äº‹ä»¶ï¼ˆé•¿æŒ‰ã€Holdç­‰ï¼‰
    }
    
    if (key->event == KEY_ACTION_NO_KEY) {
        // å¤šå‡»å»¶æ—¶ç»“æŸï¼Œå‘é€æœ€ç»ˆå¤šå‡»äº‹ä»¶
        if (click_cnt > 0) {
            // è½¬æ¢ä¸ºå¯¹åº”çš„å¤šå‡»äº‹ä»¶
            key->event = KEY_ACTION_CLICK + (click_cnt == 1 ? 0 : click_cnt - 1);
            click_cnt = 0;
            notify_value = NO_KEY;
        }
    }
    
    return 0;
}
```

ç°æœ‰æ¶æ„çš„é—®é¢˜åœ¨äºï¼š

1. **æ‰“æ–­æœºåˆ¶**ï¼šé•¿æŒ‰äº‹ä»¶ä¼šç«‹å³æ‰“æ–­å¤šå‡»åºåˆ—
2. **çŠ¶æ€æ¸…é™¤**ï¼šæ— æ³•è®°å½•å¤šå‡»+é•¿æŒ‰çš„ç»„åˆçŠ¶æ€
3. **äº‹ä»¶å†²çª**ï¼šå¤šå‡»å»¶æ—¶æœŸé—´çš„é•¿æŒ‰ä¼šè¢«ç›´æ¥å‘é€ï¼Œä¸¢å¤±å¤šå‡»ä¿¡æ¯

## æœ€å°å…¥ä¾µæ–¹å¼å®ç°

```c
/* --------------------------------------------------------------------------*/
/**
 * @brief å¤šå‡»æŒ‰é”®åˆ¤æ–­
 *
 * @param keyï¼šåŸºç¡€æŒ‰é”®åŠ¨ä½œï¼ˆmono_clickã€longã€holdã€upï¼‰å’Œé”®å€¼
 *
 * @return 0ï¼šä¸æ‹¦æˆªæŒ‰é”®äº‹ä»¶
 *         1ï¼šæ‹¦æˆªæŒ‰é”®äº‹ä»¶
 */
/* ----------------------------------------------------------------------------*/
static int multi_clicks_translate(struct key_event *key)
{
    static u8 click_cnt;          //å¤šå‡»è®¡æ•°å™¨ï¼Œæ²¡æœ‰æ˜¾å¼èµ‹å€¼ï¼Œåˆå€¼ä¸º 0
    static u8 notify_value = 0xff;//å½“å‰å¤„ç†çš„æŒ‰é”®å€¼
    struct key_hold *hold = get_key_hold(key->value, 0);

    // é•¿æŒ‰äº‹ä»¶å¤„ç†
    if (key->event == KEY_ACTION_LONG) {
        //ä¼˜å…ˆåˆ¤æ–­å¤šå‡»+é•¿æŒ‰äº‹ä»¶ï¼Œé•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¹‹å‰æ˜¯å¦æœ‰å¤šå‡»åˆ¤æ–­è®°å½•
        //åˆ°ç›®å‰ä¸ºæ­¢çš„å¤šå‡»åˆ¤æ–­è®°å½•ï¼Œæœ‰å¯èƒ½å‡ºç°å…¶ä»–æŒ‰é”®äº‹ä»¶æ—¶å…¶å®æ˜¯åœ¨å¤šå‡»åˆ¤æ–­æµç¨‹ä¸­ï¼Œè¿™ä¸ªåºåˆ—å‡ºç°å…¶ä»–æŒ‰é”®äº‹ä»¶å°±ä¼šè¢«æ‰“æ–­å¹¶è¢«æ¸…é™¤ï¼ˆåœ¨åé¢ï¼‰ã€‚
        //ä¸è¿‡è¿™é‡Œåˆ¤æ–­å‡ºæŒ‰é”®äº‹ä»¶åç›´æ¥æ¸…æ¥šäº†ï¼Œä¸å»æ‰§è¡Œåé¢äº†ï¼Œ ä¸ç„¶key->eventå¯èƒ½è¢«è¦†ç›–ã€‚
        switch (click_cnt)
        {
        case 1:
            // å•å‡»+é•¿æŒ‰
            key->event = KEY_ACTION_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        case 2:
            // åŒå‡»+é•¿æŒ‰
            key->event = KEY_ACTION_DOUBLE_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        case 3:
            // ä¸‰å‡»+é•¿æŒ‰
            key->event = KEY_ACTION_TRIPLE_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        default:
            //å•çº¯è·³å‡ºswitchï¼Œæ‰§è¡Œæ­£å¸¸æµç¨‹
            break;
        }
        hold = get_key_hold(key->value, 1);
        if (hold) {
            hold->start_time = jiffies;// å…ˆè§¦å‘longæŒ‰é”®äº‹ä»¶ï¼Œä¸ºäº†ç»™holdè®¡æ—¶ï¼Œå¼€å§‹è®°å½•é•¿æŒ‰å¼€å§‹æ—¶é—´ï¼Œåˆ©ç”¨é•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¸ºåŸºç¡€åˆ¤æ–­å…¶ä»–å¤æ‚æŒ‰é”®äº‹ä»¶
        }
    } else if (key->event == KEY_ACTION_HOLD) {// è§¦å‘longæŒ‰é”®äº‹ä»¶åï¼Œå†è§¦å‘Holdäº‹ä»¶å¤„ç† - æ ¹æ®æŒç»­æ—¶é—´ç»†åˆ†
        if (hold) {
            int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD  //æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯
            // æŒ‰ä½è¿‡ç¨‹ä¸­åˆ†æ®µå‘é€æ¶ˆæ¯
            if (time_msec >= 1000 && hold->action == 0) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ1s
                key->event = KEY_ACTION_HOLD_1SEC;
            } else if (time_msec >= 3000 && hold->action == KEY_ACTION_HOLD_1SEC) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ3s
                key->event = KEY_ACTION_HOLD_3SEC;
            } else if (time_msec >= 5000 && hold->action == KEY_ACTION_HOLD_3SEC) {
                key->event = KEY_ACTION_HOLD_5SEC;
            } else if (time_msec >= 8000 && hold->action == KEY_ACTION_HOLD_5SEC) {
                key->event = KEY_ACTION_HOLD_8SEC;
            } else if (time_msec >= 10000 && hold->action == KEY_ACTION_HOLD_8SEC) {
                key->event = KEY_ACTION_HOLD_10SEC;
            } else {
                return 0;// ä¸å‘é€é‡å¤æ¶ˆæ¯
            }
            //æœ€é•¿æŒ‰ä½æ¶ˆæ¯ï¼Œä¸€ç›´æŒ‰ä½æŒ‡å®šè§¦å‘é‚£ä¸ªé•¿æŒ‰ä¿æŒäº‹ä»¶
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000) {
                hold->action = KEY_ACTION_HOLD_10SEC;
            } else {
                hold->action = key->event;
            }
#else
            // ä»…åœ¨è¾¾åˆ°æœ€å¤§æ—¶é—´æ—¶å‘é€ä¸€æ¬¡æ¶ˆæ¯
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000 && hold->action == 0) {
                key->event = TCFG_MAX_HOLD_SEC >> 8;
            } else {
                return 0;
            }
            hold->action = key->event;
#endif
        }
    } else {
        // æŠ¬èµ·äº‹ä»¶å¤„ç†
        if (hold) {
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD == 0
            //æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯å®ä¸ä½¿èƒ½çš„è¯ï¼Œé—®é¢˜æ˜¯å®¢æˆ·éœ€è¦æŒ‰ä½è§¦å‘è¿˜æ˜¯æŠ¬èµ·è§¦å‘ï¼ŒæŒ‰é”®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚
            // æŠ¬èµ·æ—¶æ ¹æ®æŒ‰ä½æ€»æ—¶é—´å‘é€å¯¹åº”æ¶ˆæ¯
            if (hold->action == 0) {
                int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
                if (time_msec >= 8000) {
                    key->event = KEY_ACTION_HOLD_8SEC;
                } else if (time_msec >= 5000) {
                    key->event = KEY_ACTION_HOLD_5SEC;
                } else if (time_msec >= 3000) {
                    key->event = KEY_ACTION_HOLD_3SEC;
                } else if (time_msec >= 1000) {
                    key->event = KEY_ACTION_HOLD_1SEC;
                }
                if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000) {
                    key->event = TCFG_MAX_HOLD_SEC >> 8;
                }
            }
#endif
            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
            //å¾—åˆ°å¯¹åº”æŒ‰é”®äº‹ä»¶åï¼ŒæŠŠè®°å½•æ¸…é™¤é¿å…åé¢è¯¯åˆ¤
            hold->value = NO_KEY;
            hold->action = 0;
            hold->start_time = 0;
        }
    }
    if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
        return 0;
    }

    if (key->event == KEY_ACTION_CLICK) {
        if (key->value != notify_value) {
            click_cnt = 1;
            notify_value = key->value;
        } else {
            //å¼€å§‹å¤šå‡»è®¡æ•°
            click_cnt++;
        }
        return 1;
    }
    if (key->event == KEY_ACTION_NO_KEY) {
        if (click_cnt == 1) {
            //å¤šå‡»å»¶è¿Ÿåˆ¤æ–­ç»“æŸ
            key->event = KEY_ACTION_CLICK;
        } else if (click_cnt <= 7) {
            //æœ€å¤š7æ¬¡è¿å‡»
            key->event = KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2);
        }
        key->value = notify_value;
        click_cnt = 0;
        notify_value = NO_KEY;
    } else if (key->event > KEY_ACTION_CLICK) {
        //å¤šå‡»åˆ¤æ–­è¿‡ç¨‹ä¸­å‡ºç°å…¶ä»–æŒ‰é”®äº‹ä»¶å°±æ‰“æ–­å¤šå‡»åºåˆ—
        //ç›´æ¥ç»“æŸå¤šå‡»åˆ¤æ–­
        click_cnt = 0;
        notify_value = NO_KEY;
    }
    return 0;
}
```

## æ·»åŠ æŒ‰é”®äº‹ä»¶ç±»å‹

`apps\common\device\key\key_driver.h`

```c
    //å¤šå‡»+é•¿æŒ‰
    KEY_ACTION_CLICK_PLUS_LONG,         // å•å‡»+é•¿æŒ‰
    KEY_ACTION_DOUBLE_CLICK_PLUS_LONG,  // åŒå‡»+é•¿æŒ‰
    KEY_ACTION_TRIPLE_CLICK_PLUS_LONG,  // ä¸‰å‡»+é•¿æŒ‰
    KEY_ACTION_QUAD_CLICK_PLUS_LONG,    // å››å‡»+é•¿æŒ‰

    /*=======æ–°å¢æŒ‰é”®åŠ¨ä½œè¯·åœ¨æ­¤å¤„ä¹‹ä¸Šå¢åŠ ï¼Œä¸å»ºè®®ä¸­é—´æ’å…¥ï¼Œå¯èƒ½å½±å“åŸºäºåç§»é‡è®¡ç®—çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¤šå‡»åˆ¤æ–­æµç¨‹=======*/
    KEY_ACTION_NO_KEY,
    KEY_ACTION_MAX,
```

## åœ¨æŒ‰é”®äº‹ä»¶æ˜ å°„å‡½æ•°ä¸­ä½¿ç”¨

`apps\earphone\mode\bt\bt_key_msg_table.c`

æ·»åŠ caseï¼Œä¸ŠæŠ¥å¯¹åº”çš„å¤„ç†æ¶ˆæ¯å³å¯ã€‚

## ç¼ºé™·

- å¤šå‡»åˆ¤æ–­æœ€å¤šåˆ°7å‡»ï¼Œæ‰€ä»¥æœ€å¤šæ˜¯7å‡»+é•¿æŒ‰ã€‚
- å…¶ä»–é—®é¢˜è¿˜æ²¡å‡ºç°ã€‚

# è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»æµç¨‹æ˜¯å¦å¤–ä¸€å¥—ï¼Ÿ

- å•å‡»åŠ é•¿æŒ‰å¯ä»¥ç›´æ¥åœ¨appæ¶ˆæ¯å¤„ç†ã€‚

- ä½†æ˜¯è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»åªèƒ½ä¸ŠæŠ¥åˆ°5å‡»

ä¸ºå•¥è¿™é‡Œéœ€è¦æ‰‹åŠ¨æ‰©å±•ï¼Ÿ

```c
static void lp_touch_key_short_click_time_out_handle(void *priv)
{
    u32 ch_idx = (u32)priv;
    const struct touch_key_cfg *key_cfg = &(__this->pdata->key_cfg[ch_idx]);
    struct touch_key_arg *arg = &(__this->arg[ch_idx]);

    struct key_event e;
    switch (arg->click_cnt) {
    case 1:
        e.event = KEY_ACTION_CLICK;
        break;
    case 2:
        e.event = KEY_ACTION_DOUBLE_CLICK;
        break;
    case 3:
        e.event = KEY_ACTION_TRIPLE_CLICK;
        break;
    case 4:
        e.event = KEY_ACTION_FOURTH_CLICK;
        break;
    case 5:
        e.event = KEY_ACTION_FIFTH_CLICK;
        break;
    case 6:
        e.event = KEY_ACTION_SEXTUPLE_CLICK;
        break;
    case 7:
        e.event = KEY_ACTION_SEPTUPLE_CLICK;
        break;
    default:
        e.event = KEY_ACTION_NO_KEY;
        break;
    }
    e.value = key_cfg->key_value;

    log_debug("notify key:%d short event, cnt: %d", ch_idx, arg->click_cnt);
    lp_touch_key_notify_key_event(&e, ch_idx);

    arg->short_timer = 0;
    arg->last_key = 0;
    arg->click_cnt = 0;
}
```

## ç»è¿‡æŒ‰é”®è¯†åˆ«ç®—æ³•åçš„æŒ‰é”®äº‹ä»¶ä¼šå‘é€å•Šï¼Ÿ

```c
/* --------------------------------------------------------------------------*/
/**
 * @brief æŒ‰é”®äº‹ä»¶è¿‡æ»¤ã€æ£€æµ‹å’Œå‘é€
 *
 * @param keyï¼šåŸºç¡€æŒ‰é”®åŠ¨ä½œï¼ˆmono_clickã€longã€holdã€upï¼‰å’Œé”®å€¼
 */
/* ----------------------------------------------------------------------------*/
void key_event_handler(struct key_event *key)
{
    const struct key_callback *p;

    /*printf("key_event: %d\n", key->event);*/

    //æŒ‰é”®äº‹ä»¶è¿‡æ»¤ä¸è¯†åˆ«ç®—æ³•ï¼Œå¯ä»¥è¯†åˆ«ç”±åŸºç¡€æŒ‰é”®äº§ç”Ÿçš„å¤æ‚æŒ‰é”®äº‹ä»¶
    if (multi_clicks_translate(key)) {
        return;
    }

    if (combination_key_translate(key)) {
        return;
    }
    
    if (key->event == KEY_ACTION_NO_KEY) {
        return;
    }

    //å¤–éƒ¨éœ€è¦æ ¼å¤–åšçš„å¤„ç†æµç¨‹ï¼Œè¯·é€šè¿‡æ³¨å†Œçš„å½¢å¼åœ¨æ­¤å¤„å›è°ƒ
    list_for_each_key_callback(p) {
        if (p->cb_deal == NULL) {
            continue;
        }
        if (p->cb_deal(p->arg)) {
            return;
        }
    }
    int msg[2];
    msg[0] = (key->value << 8) | key->event;
    msg[1] = 0;

    /*printf("key_msg: %d\n", msg[0]);*/

#if TCFG_USER_TWS_ENABLE
    //å•ä¸ªæŒ‰é”®äº‹ä»¶ä¸¤è¾¹åŒæ­¥
    bt_tws_key_msg_sync(msg[0]);
#else
    app_send_message_from(MSG_FROM_KEY, 8, msg);
#endif
}
```

ç›´æ¥åˆ°æŒ‰é”®æ˜ å°„å±‚ï¼Œæ˜ å°„åˆ°APPæ¶ˆæ¯é€»è¾‘å·²ç»é—­ç¯äº†ã€‚ä¸ºå•¥è¿˜æ˜¯éœ€è¦è§¦æ‘¸æŒ‰é”®å¤šå‡»æ‰©å±•ï¼Ÿï¼Ÿï¼Ÿ

## 13. æŒ‰é”®å¤„ç†æ¶æ„æ·±åº¦åˆ†æä¸è§¦æ‘¸æŒ‰é”®å¤šå‡»æ‰©å±•é—®é¢˜

### 13.1 é—®é¢˜é‡æ–°å®¡è§†

ç†è®ºä¸Šï¼ŒæŒ‰é”®å¤„ç†æ¶æ„åº”è¯¥æ˜¯ç»Ÿä¸€çš„ï¼šä»æŒ‰é”®æ‰«æåˆ°å¤æ‚æŒ‰é”®è¯†åˆ«å¤„ç†å™¨ç”Ÿæˆå…·ä½“æŒ‰é”®äº‹ä»¶åï¼Œæ˜ å°„åˆ°å¯¹åº”çš„APPå±‚å°±å®Œæˆäº†ã€‚ä»æŒ‰é”®äº‹ä»¶è§¦å‘åˆ°æŒ‰é”®äº‹ä»¶çš„å¤„ç†ï¼Œå·²ç»å½¢æˆäº†é€»è¾‘ä¸Šçš„é—­ç¯ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè§¦æ‘¸æŒ‰é”®çš„å…­å‡»å’Œä¸ƒå‡»éœ€è¦æ‰‹åŠ¨æ·»åŠ æšä¸¾å®šä¹‰ï¼Œè€Œå…¶ä»–æŒ‰é”®äº‹ä»¶ä¸éœ€è¦è¿™ä¹ˆåšï¼Ÿ

### 13.2 æŒ‰é”®ç±»å‹å¤„ç†æµç¨‹å®Œæ•´å¯¹æ¯”

é€šè¿‡æ·±å…¥åˆ†æä»£ç å®ç°ï¼Œå‘ç°ç³»ç»Ÿä¸­å­˜åœ¨**ä¸¤å¥—å®Œå…¨ä¸åŒçš„æŒ‰é”®å¤„ç†æ¶æ„**ï¼š

#### 13.2.1 ç®—æ³•è¯†åˆ«æµç¨‹ï¼ˆä¸»æµç¨‹ï¼‰

**é€‚ç”¨æŒ‰é”®ç±»å‹ï¼š**
- `KEY_DRIVER_TYPE_IO` - IOæŒ‰é”®
- `KEY_DRIVER_TYPE_AD` - ADæŒ‰é”®  
- `KEY_DRIVER_TYPE_RTCVDD_AD` - RTCVDD ADæŒ‰é”®
- `KEY_DRIVER_TYPE_IR` - çº¢å¤–æŒ‰é”®
- `KEY_DRIVER_TYPE_TOUCH` - æ™®é€šè§¦æ‘¸æŒ‰é”®
- `KEY_DRIVER_TYPE_RDEC` - æ—‹è½¬ç¼–ç å™¨
- `KEY_DRIVER_TYPE_SLIDEKEY` - æ»‘åŠ¨æŒ‰é”®
- `KEY_DRIVER_TYPE_SOFTKEY` - è½¯ä»¶æŒ‰é”®
- `KEY_DRIVER_TYPE_BRIGHTNESS` - äº®åº¦æŒ‰é”®
- `KEY_DRIVER_TYPE_VOICE` - è¯­éŸ³æŒ‰é”®

**å®Œæ•´å¤„ç†æµç¨‹ï¼š**

```c
ç¡¬ä»¶è§¦å‘ â†’ æŒ‰é”®é©±åŠ¨æ‰«æ â†’ key_event_handler() â†’ multi_clicks_translate() 
â†’ app_send_message_from() â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ æŒ‰é”®æ˜ å°„å±‚ â†’ APPåŠŸèƒ½å¤„ç†
```

**å…³é”®ç‰¹ç‚¹ï¼š**
1. **ç»Ÿä¸€çš„å¤šå‡»è¯†åˆ«ç®—æ³•**ï¼šä½¿ç”¨ `multi_clicks_translate()` è¿›è¡Œå¤šå‡»è¯†åˆ«
2. **åç§»è®¡ç®—æœºåˆ¶**ï¼šé€šè¿‡ `KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2)` åŠ¨æ€è®¡ç®—
3. **æšä¸¾å®¹é”™æ€§**ï¼šå³ä½¿æšä¸¾å€¼ä¸è¿ç»­ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
   1. åªè¦åŒå‡»åœ¨å°±å¯ä»¥ã€‚æ ¹æ®è¿å‡»çš„è®¡æ•°è®¡ç®—ã€‚


**multi_clicks_translate æ ¸å¿ƒç®—æ³• (key.c:182-185)ï¼š**
```c
} else if (click_cnt <= 7) {
    // æœ€å¤š7æ¬¡è¿å‡» - é€šè¿‡åç§»è®¡ç®—ç”Ÿæˆäº‹ä»¶
    key->event = KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2);
}
```

#### 13.2.2 ä¸“å±æµç¨‹ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰

**é€‚ç”¨æŒ‰é”®ç±»å‹ï¼š**
- `KEY_DRIVER_TYPE_CTMU_TOUCH` - å†…ç½®è§¦æ‘¸æŒ‰é”®ï¼ˆå¯¹åº” `TCFG_LP_TOUCH_KEY_ENABLE`ï¼‰

**ä¸“å±å¤„ç†æµç¨‹ï¼š**

```c
è§¦æ‘¸ç¡¬ä»¶æ£€æµ‹ â†’ CTMUé‡‡æ · â†’ lp_touch_key_click.c (ç‹¬ç«‹å¤šå‡»è¯†åˆ«) 
â†’ ç›´æ¥ç”ŸæˆKEY_ACTION_SEXTUPLE_CLICK â†’ lp_touch_key_notify_key_event() 
â†’ key_event_handler() â†’ è·³è¿‡multi_clicks_translate â†’ app_send_message_from() 
â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ æŒ‰é”®æ˜ å°„å±‚ â†’ APPåŠŸèƒ½å¤„ç†
```

**è·³è¿‡ç®—æ³•çš„å…³é”®ä»£ç  (key.c:164-166)ï¼š**
```c
/* --------------------------------------------------------------------------*/
/**
 * @brief å¤šå‡»æŒ‰é”®åˆ¤æ–­
 *
 * @param keyï¼šåŸºç¡€æŒ‰é”®åŠ¨ä½œï¼ˆmono_clickã€longã€holdã€upï¼‰å’Œé”®å€¼
 *
 * @return 0ï¼šä¸æ‹¦æˆªæŒ‰é”®äº‹ä»¶
 *         1ï¼šæ‹¦æˆªæŒ‰é”®äº‹ä»¶
 */
/* ----------------------------------------------------------------------------*/
static int multi_clicks_translate(struct key_event *key)
{
    static u8 click_cnt;          //å¤šå‡»è®¡æ•°å™¨ï¼Œæ²¡æœ‰æ˜¾å¼èµ‹å€¼ï¼Œåˆå€¼ä¸º 0
    static u8 notify_value = 0xff;//å½“å‰å¤„ç†çš„æŒ‰é”®å€¼
    struct key_hold *hold = get_key_hold(key->value, 0);

    // é•¿æŒ‰äº‹ä»¶å¤„ç†
    if (key->event == KEY_ACTION_LONG) {
        //ä¼˜å…ˆåˆ¤æ–­å¤šå‡»+é•¿æŒ‰äº‹ä»¶ï¼Œé•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¹‹å‰æ˜¯å¦æœ‰å¤šå‡»åˆ¤æ–­è®°å½•
        switch (click_cnt)
        {
        case 1:
            // å•å‡»+é•¿æŒ‰
            key->event = KEY_ACTION_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        case 2:
            // åŒå‡»+é•¿æŒ‰
            key->event = KEY_ACTION_DOUBLE_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        case 3:
            // ä¸‰å‡»+é•¿æŒ‰
            key->event = KEY_ACTION_TRIPLE_CLICK_PLUS_LONG;
            //ç›´æ¥æ¸…é™¤å¤šå‡»è®¡æ•°è®°å½•
            click_cnt = 0;
            notify_value = NO_KEY;
            //ä¸ç”¨æ‹¦æˆªæŒ‰é”®äº‹ä»¶äº†ï¼Œä¸‹é¢ä¹Ÿä¸ç”¨æ‰§è¡Œäº†ã€‚
            return 0;
        default:
            //å•çº¯è·³å‡ºswitchï¼Œæ‰§è¡Œæ­£å¸¸æµç¨‹
            break;
        }
        hold = get_key_hold(key->value, 1);
        if (hold) {
            hold->start_time = jiffies;// å…ˆè§¦å‘longæŒ‰é”®äº‹ä»¶ï¼Œä¸ºäº†ç»™holdè®¡æ—¶ï¼Œå¼€å§‹è®°å½•é•¿æŒ‰å¼€å§‹æ—¶é—´ï¼Œåˆ©ç”¨é•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¸ºåŸºç¡€åˆ¤æ–­å…¶ä»–å¤æ‚æŒ‰é”®äº‹ä»¶
        }
    } else if (key->event == KEY_ACTION_HOLD) {// è§¦å‘longæŒ‰é”®äº‹ä»¶åï¼Œå†è§¦å‘Holdäº‹ä»¶å¤„ç† - æ ¹æ®æŒç»­æ—¶é—´ç»†åˆ†
        if (hold) {
            int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD  //æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯
            // æŒ‰ä½è¿‡ç¨‹ä¸­åˆ†æ®µå‘é€æ¶ˆæ¯
            if (time_msec >= 1000 && hold->action == 0) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ1s
                key->event = KEY_ACTION_HOLD_1SEC;
            } else if (time_msec >= 3000 && hold->action == KEY_ACTION_HOLD_1SEC) {
                //å‘ç”Ÿé•¿æŒ‰åï¼Œä¿æŒ3s
                key->event = KEY_ACTION_HOLD_3SEC;
            } else if (time_msec >= 5000 && hold->action == KEY_ACTION_HOLD_3SEC) {
                key->event = KEY_ACTION_HOLD_5SEC;
            } else if (time_msec >= 8000 && hold->action == KEY_ACTION_HOLD_5SEC) {
                key->event = KEY_ACTION_HOLD_8SEC;
            } else if (time_msec >= 10000 && hold->action == KEY_ACTION_HOLD_8SEC) {
                key->event = KEY_ACTION_HOLD_10SEC;
            } else {
                return 0;// ä¸å‘é€é‡å¤æ¶ˆæ¯
            }
            //æœ€é•¿æŒ‰ä½æ¶ˆæ¯ï¼Œä¸€ç›´æŒ‰ä½æŒ‡å®šè§¦å‘é‚£ä¸ªé•¿æŒ‰ä¿æŒäº‹ä»¶
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000) {
                hold->action = KEY_ACTION_HOLD_10SEC;
            } else {
                hold->action = key->event;
            }
#else
            // ä»…åœ¨è¾¾åˆ°æœ€å¤§æ—¶é—´æ—¶å‘é€ä¸€æ¬¡æ¶ˆæ¯
            if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000 && hold->action == 0) {
                key->event = TCFG_MAX_HOLD_SEC >> 8;
            } else {
                return 0;
            }
            hold->action = key->event;
#endif
        }
    } else {
        // æŠ¬èµ·äº‹ä»¶å¤„ç†
        if (hold) {
#if TCFG_SEND_HOLD_SEC_MSG_DURING_HOLD == 0
            //æŒ‰ä½è¿‡ç¨‹ä¸­å‘é€æŒ‰ä½å‡ ç§’æ¶ˆæ¯å®ä¸ä½¿èƒ½çš„è¯ï¼Œé—®é¢˜æ˜¯å®¢æˆ·éœ€è¦æŒ‰ä½è§¦å‘è¿˜æ˜¯æŠ¬èµ·è§¦å‘ï¼ŒæŒ‰é”®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚
            // æŠ¬èµ·æ—¶æ ¹æ®æŒ‰ä½æ€»æ—¶é—´å‘é€å¯¹åº”æ¶ˆæ¯
            if (hold->action == 0) {
                int time_msec = jiffies_offset_to_msec(hold->start_time, jiffies);
                if (time_msec >= 8000) {
                    key->event = KEY_ACTION_HOLD_8SEC;
                } else if (time_msec >= 5000) {
                    key->event = KEY_ACTION_HOLD_5SEC;
                } else if (time_msec >= 3000) {
                    key->event = KEY_ACTION_HOLD_3SEC;
                } else if (time_msec >= 1000) {
                    key->event = KEY_ACTION_HOLD_1SEC;
                }
                if (time_msec >= (TCFG_MAX_HOLD_SEC & 0xff) * 1000) {
                    key->event = TCFG_MAX_HOLD_SEC >> 8;
                }
            }
#endif
            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
            //å¾—åˆ°å¯¹åº”æŒ‰é”®äº‹ä»¶åï¼ŒæŠŠè®°å½•æ¸…é™¤é¿å…åé¢è¯¯åˆ¤
            hold->value = NO_KEY;
            hold->action = 0;
            hold->start_time = 0;
        }
    }
    if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
        //è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»è¯†åˆ«æ˜¯å•ç‹¬çš„æµç¨‹ï¼ï¼ï¼
        //é‚£è¿™ä¹ˆè¯´æˆ‘å‰é¢å†™çš„å¤šå‡»+é•¿æŒ‰æŒ‰é”®äº‹ä»¶å¯¹äºè§¦æ‘¸æŒ‰é”®å°±ä¸ç”Ÿæ•ˆäº†ï¼ï¼ï¼
        return 0;
    }

    if (key->event == KEY_ACTION_CLICK) {
        if (key->value != notify_value) {
            click_cnt = 1;
            notify_value = key->value;
        } else {
            //å¼€å§‹å¤šå‡»è®¡æ•°
            click_cnt++;
        }
        return 1;
    }
    if (key->event == KEY_ACTION_NO_KEY) {
        if (click_cnt == 1) {
            //å¤šå‡»å»¶è¿Ÿåˆ¤æ–­ç»“æŸ
            key->event = KEY_ACTION_CLICK;
        } else if (click_cnt <= 7) {
            //æœ€å¤š7æ¬¡è¿å‡»
            key->event = KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2);
        }
        key->value = notify_value;
        click_cnt = 0;
        notify_value = NO_KEY;
    } else if (key->event > KEY_ACTION_CLICK) {
        //è¿™é‡ŒæŒ‡çš„æ˜¯é‚£å‡ ä¸ªåŸºæœ¬æŒ‰é”®äº‹ä»¶ï¼Œåªè¦ä¸æ˜¯å•å‡»å°±æ‰“æ–­
        //å¤šå‡»åˆ¤æ–­è¿‡ç¨‹ä¸­å‡ºç°å…¶ä»–æŒ‰é”®äº‹ä»¶å°±æ‰“æ–­å¤šå‡»åºåˆ—
        //ç›´æ¥ç»“æŸå¤šå‡»åˆ¤æ–­
        click_cnt = 0;
        notify_value = NO_KEY;
    }
    return 0;
}
```

**ç‹¬ç«‹å¤šå‡»è¯†åˆ«å®ç° (lp_touch_key_click.c)ï¼š**

```c
static void lp_touch_key_short_click_time_out_handle(void *priv) {
    // ...
    switch (arg->click_cnt) {
    case 1:
        e.event = KEY_ACTION_CLICK;
        break;
    case 2:
        e.event = KEY_ACTION_DOUBLE_CLICK;
        break;
    case 3:
        e.event = KEY_ACTION_TRIPLE_CLICK;
        break;
    case 4:
        e.event = KEY_ACTION_FOURTH_CLICK;
        break;
    case 5:
        e.event = KEY_ACTION_FIFTH_CLICK;
        break;
    case 6:
        e.event = KEY_ACTION_SEXTUPLE_CLICK;  // ç›´æ¥å¼•ç”¨æšä¸¾å€¼ï¼
        break;
    case 7:
        e.event = KEY_ACTION_SEPTUPLE_CLICK;  // ç›´æ¥å¼•ç”¨æšä¸¾å€¼ï¼
        break;
    }
    // ...
    lp_touch_key_notify_key_event(&e, ch_idx);  // ç›´æ¥å‘é€äº‹ä»¶
}
```

### 13.3 å†…ç½®è§¦æ‘¸æŒ‰é”®çš„å®Œæ•´æ˜ å°„æµç¨‹

**è¯¦ç»†æµç¨‹è¿½è¸ªï¼š**

1. **ç¡¬ä»¶æ£€æµ‹å±‚**ï¼š
   ```c
   CTMUç¡¬ä»¶é‡‡æ · â†’ lp_touch_key_analyze() â†’ æ£€æµ‹åˆ°è§¦æ‘¸
   ```

2. **äº‹ä»¶è¯†åˆ«å±‚**ï¼š
   
   ```c
   lp_touch_key_short_click_handle() â†’ å¯åŠ¨å¤šå‡»è®¡æ—¶å™¨
   â†’ lp_touch_key_short_click_time_out_handle() â†’ ç‹¬ç«‹å¤šå‡»è¯†åˆ«
   ```
   
3. **äº‹ä»¶ç”Ÿæˆå±‚**ï¼š
   
   ```c
   ç›´æ¥ç”Ÿæˆ KEY_ACTION_SEXTUPLE_CLICK â†’ å°è£… struct key_event
   â†’ event->type = KEY_DRIVER_TYPE_CTMU_TOUCH
   ```
   
4. **äº‹ä»¶é€šçŸ¥å±‚**ï¼š
   ```c
   lp_touch_key_notify_key_event() â†’ key_event_handler()
   ```

5. **ç®—æ³•è·³è¿‡å±‚**ï¼š
   ```c
   multi_clicks_translate() æ£€æµ‹åˆ° KEY_DRIVER_TYPE_CTMU_TOUCH â†’ return 0 (è·³è¿‡)
   ```

6. **æ¶ˆæ¯å‘é€å±‚**ï¼š
   ```c
   app_send_message_from(MSG_FROM_KEY, 8, msg) â†’ æ“ä½œç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—
   ```

7. **æ˜ å°„å¤„ç†å±‚**ï¼š
   ```c
   bt_key_power_msg_remap() â†’ æ ¹æ® KEY_ACTION_SEXTUPLE_CLICK æ˜ å°„åˆ°å…·ä½“APPæ¶ˆæ¯
   ```

8. **APPåŠŸèƒ½å±‚**ï¼š
   ```c
   å¯¹åº”çš„åº”ç”¨åŠŸèƒ½å¤„ç†
   ```

### 13.4 æ¶æ„å·®å¼‚çš„å…·ä½“åˆ†æ

#### 13.4.1 ç®—æ³•è¯†åˆ«æµç¨‹çš„ä¼˜åŠ¿

1. **ç»Ÿä¸€æ€§**ï¼šæ‰€æœ‰æŒ‰é”®ç±»å‹ä½¿ç”¨ç›¸åŒçš„å¤šå‡»è¯†åˆ«é€»è¾‘
2. **æ‰©å±•æ€§**ï¼šæ”¯æŒä»»æ„å¤šå‡»æ¬¡æ•°ï¼Œåªéœ€è°ƒæ•´ `click_cnt <= 7` é™åˆ¶
3. **å®¹é”™æ€§**ï¼šå³ä½¿æšä¸¾å€¼ä¸è¿ç»­ï¼Œåç§»è®¡ç®—ä»èƒ½å·¥ä½œ
4. **ç»´æŠ¤æ€§**ï¼šåªéœ€ç»´æŠ¤ä¸€å¥—å¤šå‡»è¯†åˆ«ä»£ç 

#### 13.4.2 ä¸“å±æµç¨‹çš„ç‰¹æ®Šæ€§

**ä¸ºä»€ä¹ˆå†…ç½®è§¦æ‘¸æŒ‰é”®è¦é‡‡ç”¨ä¸“å±æµç¨‹ï¼Ÿ**

1. **æ—¶åºç²¾ç¡®æ€§**ï¼šè§¦æ‘¸æŒ‰é”®éœ€è¦æ›´ç²¾ç¡®çš„æ—¶åºæ§åˆ¶å’Œé˜²è¯¯è§¦
2. **ç®—æ³•å¤æ‚æ€§**ï¼šéœ€è¦è§¦æ‘¸é˜ˆå€¼ç®—æ³•ã€æ»¤æ³¢ç®—æ³•ç­‰ä¸“é—¨å¤„ç†
3. **åŠŸèƒ½æ‰©å±•æ€§**ï¼šæ”¯æŒæ»‘åŠ¨ã€é•¿æŒ‰å¤ä½ç­‰ç‰¹æ®ŠåŠŸèƒ½
4. **ç¡¬ä»¶ç‰¹æ€§**ï¼šCTMUç¡¬ä»¶ç‰¹æ€§å†³å®šäº†éœ€è¦ä¸“é—¨çš„é‡‡æ ·å’Œå¤„ç†æµç¨‹

**ä¸“å±æµç¨‹çš„ç¼ºé™·ï¼š**
1. **æ¶æ„åˆ†è£‚**ï¼šæ‰“ç ´äº†ç»Ÿä¸€çš„æŒ‰é”®å¤„ç†æ¶æ„
2. **ä»£ç é‡å¤**ï¼šé‡æ–°å®ç°äº†å¤šå‡»è¯†åˆ«é€»è¾‘
3. **æšä¸¾ä¾èµ–**ï¼šç¡¬ä¾èµ–ç‰¹å®šçš„æšä¸¾å€¼å®šä¹‰
4. **ç»´æŠ¤å¤æ‚**ï¼šéœ€è¦åŒæ—¶ç»´æŠ¤ä¸¤å¥—æŒ‰é”®å¤„ç†é€»è¾‘

### 13.5 æ‰‹åŠ¨æ·»åŠ æšä¸¾å€¼çš„æ ¹æœ¬åŸå› 

**æ ¸å¿ƒé—®é¢˜ï¼š**
- ç®—æ³•è¯†åˆ«æµç¨‹ä½¿ç”¨**åç§»è®¡ç®—**ï¼š`KEY_ACTION_DOUBLE_CLICK + (click_cnt - 2)`
- ä¸“å±æµç¨‹ä½¿ç”¨**ç›´æ¥å¼•ç”¨**ï¼š`e.event = KEY_ACTION_SEXTUPLE_CLICK`

**ç¼–è¯‘é…ç½®å·®å¼‚ï¼š**

å½“ `CONFIG_EARPHONE_CASE_ENABLE` æœªå¼€å¯æ—¶ï¼Œæšä¸¾å®šä¹‰ä¸­ç¼ºå°‘ï¼š
```c
KEY_ACTION_SEXTUPLE_CLICK,  // ç¼ºå¤±ï¼
KEY_ACTION_SEPTUPLE_CLICK,  // ç¼ºå¤±ï¼
```

**å¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼š**
```c
case 6:
    e.event = KEY_ACTION_SEXTUPLE_CLICK;  // ç¼–è¯‘é”™è¯¯ï¼šæœªå®šä¹‰çš„æ ‡è¯†ç¬¦
    break;
```

### 13.6 ç»Ÿä¸€åŒ–æ”¹é€ çš„å¯è¡Œæ€§åˆ†æ

#### 13.6.1 æ–¹æ¡ˆä¸€ï¼šå»é™¤è·³è¿‡åˆ¤æ–­ï¼Œèµ°ç»Ÿä¸€æµç¨‹

**ä»£ç ä¿®æ”¹ï¼š**
```c
// åœ¨ key.c ä¸­æ³¨é‡Šæ‰è·³è¿‡é€»è¾‘
/*
if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
    return 0;
}
*/
```

**å¯è¡Œæ€§åˆ†æï¼š**

âœ… **ç†è®ºå¯è¡Œæ€§ï¼š**
- å†…ç½®è§¦æ‘¸æŒ‰é”®å‘é€çš„æ˜¯æ ‡å‡†çš„ `KEY_ACTION_CLICK` äº‹ä»¶
- `multi_clicks_translate` ç®—æ³•å®Œå…¨èƒ½å¤Ÿå¤„ç†è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»

âš ï¸ **æ½œåœ¨é£é™©ï¼š**
1. **æ—¶åºå†²çª**ï¼šè§¦æ‘¸æŒ‰é”®è‡ªå·±çš„å¤šå‡»è¯†åˆ«ä¸ç®—æ³•è¯†åˆ«å¯èƒ½å†²çª
2. **é‡å¤å¤„ç†**ï¼šå¯èƒ½å¯¼è‡´åŒé‡å¤šå‡»è¯†åˆ«ï¼ï¼ï¼ï¼
3. **å»¶æ—¶å·®å¼‚**ï¼šä¸¤å¥—ç®—æ³•çš„å»¶æ—¶å‚æ•°å¯èƒ½ä¸ä¸€è‡´

#### 13.6.2 æ–¹æ¡ˆäºŒï¼šä¿®æ”¹è§¦æ‘¸æŒ‰é”®ï¼Œåªå‘é€åŸºç¡€äº‹ä»¶

**ä»£ç ä¿®æ”¹ï¼š**
```c
// åœ¨ lp_touch_key_click.c ä¸­ç®€åŒ–äº‹ä»¶ç”Ÿæˆ
e.event = KEY_ACTION_CLICK;  // åªå‘é€å•å‡»äº‹ä»¶
// åˆ é™¤å¤šå‡»è¯†åˆ«é€»è¾‘ï¼Œè®©ç»Ÿä¸€ç®—æ³•å¤„ç†
```

**ä¼˜åŠ¿ï¼š**
- å®Œå…¨ç»Ÿä¸€æ¶æ„
- æ¶ˆé™¤ä»£ç é‡å¤
- è§£å†³æšä¸¾ä¾èµ–é—®é¢˜

**é£é™©ï¼š**
- å¯èƒ½å½±å“è§¦æ‘¸æŒ‰é”®çš„ç‰¹æ®ŠåŠŸèƒ½ï¼ˆæ»‘åŠ¨ã€é˜²è¯¯è§¦ç­‰ï¼‰

### 13.7 æ¨èçš„è§£å†³æ–¹æ¡ˆ

#### 13.7.1 çŸ­æœŸæ–¹æ¡ˆï¼ˆä¿æŒç°çŠ¶ï¼‰

ä¿æŒæ‰‹åŠ¨æ·»åŠ æšä¸¾å€¼çš„æ–¹æ¡ˆï¼Œç¡®ä¿ç¼–è¯‘å…¼å®¹æ€§ã€‚

#### 13.7.2 é•¿æœŸæ–¹æ¡ˆï¼ˆæ¶æ„é‡æ„ï¼‰

1. **ä¿ç•™è§¦æ‘¸æŒ‰é”®çš„ç¡¬ä»¶å¤„ç†é€»è¾‘**
2. **ç§»é™¤è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»è¯†åˆ«é€»è¾‘**
3. **è®©è§¦æ‘¸æŒ‰é”®åªå‘é€åŸºç¡€äº‹ä»¶ï¼ˆCLICK/LONG/HOLD/UPï¼‰**
4. **é€šè¿‡ç»Ÿä¸€çš„ `multi_clicks_translate` ç®—æ³•å¤„ç†å¤šå‡»**
5. **å»é™¤ `KEY_DRIVER_TYPE_CTMU_TOUCH` çš„è·³è¿‡åˆ¤æ–­**

### 13.8 ç»“è®º

**è§¦æ‘¸æŒ‰é”®å¤šå‡»æ‰©å±•é—®é¢˜çš„æœ¬è´¨ï¼š**

1. **æ¶æ„åˆ†è£‚**ï¼šç³»ç»Ÿä¸­å­˜åœ¨ä¸¤å¥—å¹¶è¡Œçš„æŒ‰é”®å¤„ç†æ¶æ„
2. **è®¾è®¡æƒè¡¡**ï¼šä¸ºäº†å®ç°è§¦æ‘¸æŒ‰é”®çš„ç‰¹æ®ŠåŠŸèƒ½ï¼Œç‰ºç‰²äº†æ¶æ„ç»Ÿä¸€æ€§
3. **æŠ€æœ¯å€ºåŠ¡**ï¼šä¸“å±æµç¨‹çš„å¼•å…¥äº§ç”Ÿäº†ç»´æŠ¤å’Œæ‰©å±•çš„å¤æ‚æ€§

**å›ç­”åŸå§‹é—®é¢˜ï¼š**
- **å“ªäº›æŒ‰é”®èµ°ç®—æ³•è¯†åˆ«**ï¼šé™¤ `KEY_DRIVER_TYPE_CTMU_TOUCH` å¤–çš„æ‰€æœ‰æŒ‰é”®ç±»å‹
- **è§¦æ‘¸æŒ‰é”®çš„ä¸“å±æµç¨‹**ï¼šç‹¬ç«‹çš„å¤šå‡»è¯†åˆ« + ç›´æ¥äº‹ä»¶ç”Ÿæˆ + è·³è¿‡ç»Ÿä¸€ç®—æ³•
- **ç»Ÿä¸€æµç¨‹çš„å¯è¡Œæ€§**ï¼šç†è®ºå¯è¡Œï¼Œä½†éœ€è¦ä»”ç»†å¤„ç†æ—¶åºå’ŒåŠŸèƒ½å†²çª

**æœ€ç»ˆå»ºè®®ï¼š**
çŸ­æœŸå†…ä¿æŒç°çŠ¶ï¼Œé•¿æœŸè€ƒè™‘æ¶æ„é‡æ„ä»¥å®ç°çœŸæ­£çš„ç»Ÿä¸€åŒ–ã€‚

# è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»+é•¿æŒ‰æŒ‰é”®äº‹ä»¶çš„å®ç°

## é—®é¢˜èƒŒæ™¯

åœ¨åŸæœ‰çš„ `multi_clicks_translate` ç»Ÿä¸€ç®—æ³•ä¸­ï¼Œå·²ç»å®ç°äº†å¤šå‡»+é•¿æŒ‰æŒ‰é”®äº‹ä»¶çš„è¯†åˆ«åŠŸèƒ½ï¼š

```c
// é•¿æŒ‰äº‹ä»¶å¤„ç†
if (key->event == KEY_ACTION_LONG) {
    // ä¼˜å…ˆåˆ¤æ–­å¤šå‡»+é•¿æŒ‰äº‹ä»¶ï¼Œé•¿æŒ‰æŒ‰é”®äº‹ä»¶ä¹‹å‰æ˜¯å¦æœ‰å¤šå‡»åˆ¤æ–­è®°å½•
    switch (click_cnt) {
    case 1:
        // å•å‡»+é•¿æŒ‰
        key->event = KEY_ACTION_CLICK_PLUS_LONG;
        break;
    case 2:
        // åŒå‡»+é•¿æŒ‰
        key->event = KEY_ACTION_DOUBLE_CLICK_PLUS_LONG;
        break;
    case 3:
        // ä¸‰å‡»+é•¿æŒ‰
        key->event = KEY_ACTION_TRIPLE_CLICK_PLUS_LONG;
        break;
    }
}
```

è¯¥ç®—æ³•åœ¨ IO æŒ‰é”®ä¸Šå·²ç»å¾—åˆ°éªŒè¯ã€‚ä½†ç”±äºè§¦æ‘¸æŒ‰é”®é‡‡ç”¨ä¸“å±å¤„ç†æµç¨‹å¹¶è·³è¿‡äº†ç»Ÿä¸€ç®—æ³•ï¼ˆ`if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) { return 0; }`ï¼‰ï¼Œå¯¼è‡´è§¦æ‘¸æŒ‰é”®æ— æ³•äº«å—è¿™ä¸ªåŠŸèƒ½ã€‚

## ä¸ºä»€ä¹ˆè¦èˆå¼ƒä¸“å±çš„å¤šå‡»è¯†åˆ«æµç¨‹

### 1. æ¶æ„è®¾è®¡ä¸Šçš„æ ¹æœ¬ç¼ºé™·

**ä¸“å±æµç¨‹çš„å·¥ä½œåŸç†ï¼š**
```c
// åœ¨ lp_touch_key_short_click_time_out_handle ä¸­
switch (arg->click_cnt) {
case 1:
    e.event = KEY_ACTION_CLICK;
    break;
case 2:
    e.event = KEY_ACTION_DOUBLE_CLICK;
    break;
// ... ç›´åˆ°ä¸ƒå‡»
case 7:
    e.event = KEY_ACTION_SEPTUPLE_CLICK;
    break;
}
```

**è‡´å‘½é—®é¢˜ï¼š**
- **æ—¶åºç‹¬ç«‹æ€§**ï¼šå¤šå‡»è¯†åˆ«å’Œé•¿æŒ‰è¯†åˆ«æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç¡¬ä»¶æ—¶åºè¿‡ç¨‹
- **è°ƒç”¨é“¾åˆ†ç¦»**ï¼šå¤šå‡»é€šè¿‡ `lp_touch_key_short_click_time_out_handle` å¤„ç†ï¼Œé•¿æŒ‰é€šè¿‡ `lp_touch_key_trigger_long_click_event` å¤„ç†
- **çŠ¶æ€æ— å…³è”**ï¼šä¸¤ä¸ªå¤„ç†è·¯å¾„ä¹‹é—´æ²¡æœ‰çŠ¶æ€å…±äº«æœºåˆ¶

### 2. åœ¨ä¸“å±æµç¨‹ä¸­å®ç°å¤šå‡»+é•¿æŒ‰çš„å¼Šç«¯

#### 2.1 æŠ€æœ¯å®ç°å¤æ‚åº¦æé«˜

**éœ€è¦çš„çŠ¶æ€ç®¡ç†ï¼š**

```c
// éœ€è¦åœ¨è§¦æ‘¸æŒ‰é”®æ¨¡å—ä¸­æ·»åŠ å…¨å±€çŠ¶æ€
static u8 touch_click_cnt_for_long = 0;  // ä¸ºé•¿æŒ‰è®°å½•çš„ç‚¹å‡»æ¬¡æ•°
static u32 touch_click_time_for_long = 0; // æœ€åä¸€æ¬¡ç‚¹å‡»çš„æ—¶é—´
```

**æ—¶åºåŒæ­¥éš¾é¢˜ï¼š**

- å¤šå‡»è¶…æ—¶å¤„ç†å’Œé•¿æŒ‰æ£€æµ‹çš„æ—¶åºé‡å 
- éœ€è¦ç²¾ç¡®æ§åˆ¶ä½•æ—¶æ¸…é™¤/ä¿ç•™å¤šå‡»çŠ¶æ€
- é•¿æŒ‰äº‹ä»¶è§¦å‘æ—¶éœ€è¦è¿½æº¯ä¹‹å‰çš„å¤šå‡»å†å²

#### 2.2 ä»£ç é‡å¤å’Œç»´æŠ¤è´Ÿæ‹…

**ç®—æ³•é€»è¾‘é‡å¤ï¼š**
- ç»Ÿä¸€ç®—æ³•ä¸­å·²æœ‰å®Œæ•´çš„å¤šå‡»+é•¿æŒ‰å®ç°
- åœ¨ä¸“å±æµç¨‹ä¸­é‡æ–°å®ç°ç›¸åŒé€»è¾‘
- ä¸¤å¥—ä»£ç éœ€è¦åŒæ­¥ç»´æŠ¤å’Œæµ‹è¯•

**å‚æ•°é…ç½®å¤æ‚ï¼š**
```c
// éœ€è¦ä¸ºè§¦æ‘¸æŒ‰é”®å•ç‹¬é…ç½®
short_click_check_time   // å¤šå‡»åˆ¤æ–­è¶…æ—¶
long_click_check_time    // é•¿æŒ‰åˆ¤æ–­è¶…æ—¶
// è€Œç»Ÿä¸€ç®—æ³•å·²æœ‰è¿™äº›å‚æ•°
```

#### 2.3 åŠŸèƒ½æ‰©å±•å±€é™æ€§

**æ— æ³•äº«å—ç»Ÿä¸€ç®—æ³•çš„å…¶ä»–åŠŸèƒ½ï¼š**
- ç»„åˆæŒ‰é”®è¯†åˆ«ï¼ˆ`combination_key_translate`ï¼‰
- æŒ‰ä½æ—¶é•¿åˆ†æ®µå¤„ç†ï¼ˆHOLD_1SEC/3SEC/5SEC/8SEC/10SECï¼‰
- TWS è”åˆæŒ‰é”®åŠŸèƒ½
- æœªæ¥å¯èƒ½çš„å…¶ä»–æŒ‰é”®å¢å¼ºåŠŸèƒ½

## æ–¹æ¡ˆä¸€çš„å¯è¡Œæ€§åˆ†æ

### 1. æŠ€æœ¯å¯è¡Œæ€§éªŒè¯

#### 1.1 è°ƒç”¨é“¾åˆ†æéªŒè¯

é€šè¿‡è¯¦ç»†çš„ä»£ç è¿½è¸ªï¼Œç¡®è®¤äº†è§¦æ‘¸æŒ‰é”®çš„å®Œæ•´è°ƒç”¨é“¾ï¼š

```
ç¡¬ä»¶ä¸­æ–­
â†“
lp_touch_key_isr_handler()
â†“
lp_touch_key_state_event_deal() [lp_touch_key.c:892]
â†“
lp_touch_key_short_click_handle() [lp_touch_key_click.c:52]
â†“
lp_touch_key_short_click_time_out_handle() [lp_touch_key_click.c:9]
â†“
lp_touch_key_notify_key_event() [lp_touch_key_common.c:53]
â†“
key_event_handler() [key.c:322]
â†“
multi_clicks_translate() [key.c:56]  â† åœ¨è¿™é‡Œè¢«è·³è¿‡ï¼
```

**å…³é”®å‘ç°ï¼š**
- è§¦æ‘¸æŒ‰é”®çš„å¤šå‡»è¯†åˆ«ç¡®å®å‘ç”Ÿåœ¨ `multi_clicks_translate` ä¹‹å‰
- åˆ°è¾¾ç»Ÿä¸€ç®—æ³•æ—¶ï¼Œäº‹ä»¶å·²ç»æ˜¯å®Œæ•´çš„å¤šå‡»äº‹ä»¶ï¼ˆå¦‚ `KEY_ACTION_DOUBLE_CLICK`ï¼‰
- **å› æ­¤å»é™¤è·³è¿‡åˆ¤æ–­ä¸ä¼šé€ æˆåŒé‡è¯†åˆ«é—®é¢˜ï¼**

#### 1.2 äº‹ä»¶ç±»å‹å…¼å®¹æ€§

**è§¦æ‘¸æŒ‰é”®å‘é€çš„äº‹ä»¶ç±»å‹ï¼š**
```c
// åŸºç¡€äº‹ä»¶ï¼ˆæ–¹æ¡ˆä¸€éœ€è¦çš„ï¼‰
KEY_ACTION_CLICK      // å•å‡»
KEY_ACTION_LONG       // é•¿æŒ‰
KEY_ACTION_HOLD       // æŒ‰ä½
KEY_ACTION_UP         // æŠ¬èµ·

// å¤šå‡»äº‹ä»¶ï¼ˆä¸“å±æµç¨‹ç”Ÿæˆçš„ï¼‰
KEY_ACTION_DOUBLE_CLICK
KEY_ACTION_TRIPLE_CLICK
// ...
```

**ç»Ÿä¸€ç®—æ³•çš„å¤„ç†èƒ½åŠ›ï¼š**
- âœ… å®Œå…¨æ”¯æŒæ‰€æœ‰åŸºç¡€äº‹ä»¶çš„å¤„ç†
- âœ… å…·å¤‡å¤šå‡»è®¡æ•°å’ŒçŠ¶æ€ç®¡ç†
- âœ… æ”¯æŒå¤šå‡»+é•¿æŒ‰çš„å¤åˆäº‹ä»¶ç”Ÿæˆ

### 2. å®ç°æ–¹æ¡ˆè®¾è®¡

#### 2.1 ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹äº‹ä»¶ç”Ÿæˆé€»è¾‘

```c
// åœ¨ lp_touch_key_short_click_time_out_handle ä¸­ç®€åŒ–
static void lp_touch_key_short_click_time_out_handle(void *priv)
{
    u32 ch_idx = (u32)priv;
    const struct touch_key_cfg *key_cfg = &(__this->pdata->key_cfg[ch_idx]);
    struct touch_key_arg *arg = &(__this->arg[ch_idx]);

    struct key_event e;
    // åªå‘é€åŸºç¡€çš„å•å‡»äº‹ä»¶ï¼Œè®©ç»Ÿä¸€ç®—æ³•å¤„ç†å¤šå‡»
    e.event = KEY_ACTION_CLICK;
    e.value = key_cfg->key_value;

    log_debug("notify key:%d basic click event", ch_idx);
    lp_touch_key_notify_key_event(&e, ch_idx);

    arg->short_timer = 0;
    arg->last_key = 0;
    arg->click_cnt = 0;  // æ¸…é™¤æœ¬åœ°è®¡æ•°ï¼Œç»Ÿä¸€ç®—æ³•ä¼šå¤„ç†
}
```

#### 2.2 ç¬¬äºŒæ­¥ï¼šå»é™¤è·³è¿‡åˆ¤æ–­

```c
// åœ¨ key.c çš„ multi_clicks_translate ä¸­æ³¨é‡Šæ‰
static int multi_clicks_translate(struct key_event *key)
{
    // ... å…¶ä»–é€»è¾‘

    // æ³¨é‡Šæ‰è§¦æ‘¸æŒ‰é”®çš„è·³è¿‡åˆ¤æ–­
    /*
    if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
        return 0;
    }
    */

    // ... ç»§ç»­ç»Ÿä¸€ç®—æ³•å¤„ç†
}
```

#### 2.3 ç¬¬ä¸‰æ­¥ï¼šä¿ç•™è§¦æ‘¸æŒ‰é”®çš„ç‰¹æ®ŠåŠŸèƒ½

```c
// ä¿ç•™æ»‘åŠ¨ã€é•¿æŒ‰ã€æŒ‰ä½ç­‰ç‰¹æ®Šäº‹ä»¶çš„å¤„ç†
static void lp_touch_key_slide_up_handle(u32 ch_idx)
{
    struct key_event e;
    e.event = KEY_SLIDER_UP;  // è¿™äº›ç‰¹æ®Šäº‹ä»¶ç»§ç»­ç›´æ¥å‘é€
    e.value = __this->pdata->slide_mode_key_value;
    lp_touch_key_notify_key_event(&e, ch_idx);
}
```

### 3. ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Ÿä¸ºä»€ä¹ˆæŠ›å¼ƒä¸“å±æµç¨‹ï¼Ÿ

#### 3.1 æ¶æ„ç»Ÿä¸€çš„ä¼˜åŠ¿

**å•ä¸€èŒè´£åŸåˆ™ï¼š**
- è§¦æ‘¸æŒ‰é”®ä¸“æ³¨äºç¡¬ä»¶ä¿¡å·å¤„ç†å’Œé˜²è¯¯è§¦
- ç»Ÿä¸€ç®—æ³•ä¸“æ³¨äºæŒ‰é”®äº‹ä»¶çš„é€»è¾‘è¯†åˆ«
- æ¸…æ™°çš„èŒè´£åˆ†å·¥ï¼Œé™ä½è€¦åˆåº¦

**ä»£ç å¤ç”¨ï¼š**
- è§¦æ‘¸æŒ‰é”®è‡ªåŠ¨è·å¾—ç»Ÿä¸€ç®—æ³•çš„æ‰€æœ‰åŠŸèƒ½
- æ–°å¢æŒ‰é”®åŠŸèƒ½æ— éœ€åœ¨å¤šå¤„å®ç°
- æµ‹è¯•å’Œç»´æŠ¤æˆæœ¬æ˜¾è‘—é™ä½

#### 3.2 å¤šå‡»è¯†åˆ«ä¸ºä»€ä¹ˆè¿˜èƒ½ä½¿ç”¨é€šç”¨æµç¨‹ï¼Ÿ

**æ—¶åºåˆ†æï¼š**
```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡» -> ç‚¹å‡» -> é•¿æŒ‰
â”œâ”€ è§¦æ‘¸ç¡¬ä»¶ï¼šæ£€æµ‹åˆ°æ¥è§¦å’Œé‡Šæ”¾äº‹ä»¶
â”œâ”€ ä¿®æ”¹åçš„è§¦æ‘¸æµç¨‹ï¼šåªå‘é€ CLICK -> CLICK -> LONG
â””â”€ ç»Ÿä¸€ç®—æ³•ï¼šè®¡æ•°(1) -> è®¡æ•°(2) -> è¯†åˆ«ä¸º DOUBLE_CLICK_PLUS_LONG
```

**å…³é”®ç†å¿µè½¬å˜ï¼š**
- **åŸæ–¹æ¡ˆ**ï¼šè§¦æ‘¸æŒ‰é”®å®Œæˆå…¨éƒ¨è¯†åˆ«ï¼Œç»Ÿä¸€ç®—æ³•è¢«è·³è¿‡
- **æ–°æ–¹æ¡ˆ**ï¼šè§¦æ‘¸æŒ‰é”®æä¾›åŸå§‹äº‹ä»¶ï¼Œç»Ÿä¸€ç®—æ³•å®Œæˆé€»è¾‘è¯†åˆ«

**æŠ€æœ¯å¯è¡Œæ€§ï¼š**
- è§¦æ‘¸æŒ‰é”®çš„ç¡¬ä»¶æ£€æµ‹èƒ½åŠ›ä¿ç•™ï¼ˆé˜²è¯¯è§¦ã€æ»‘åŠ¨ç­‰ï¼‰
- å¤šå‡»çš„é€»è¾‘è¯†åˆ«äº¤ç»™æ›´æˆç†Ÿçš„ç»Ÿä¸€ç®—æ³•
- ä¸¤è€…å„å¸å…¶èŒï¼Œäº’ä¸å†²çª

#### 3.3 å®ç°ç»†èŠ‚è€ƒè™‘

**æ—¶åºå‚æ•°ç»Ÿä¸€ï¼š**
```c
// ä½¿ç”¨ç»Ÿä¸€çš„æ—¶åºé…ç½®
#define MULTI_CLICK_TIMEOUT    800   // å¤šå‡»åˆ¤æ–­è¶…æ—¶
#define LONG_PRESS_THRESHOLD   1000  // é•¿æŒ‰åˆ¤æ–­é˜ˆå€¼
```

**äº‹ä»¶è¿‡æ»¤æœºåˆ¶ï¼š**
```c
// è§¦æ‘¸æŒ‰é”®çš„ç‰¹æ®Šäº‹ä»¶ç›´æ¥é€šè¿‡
if (key->event == KEY_SLIDER_UP || key->event == KEY_SLIDER_DOWN) {
    return 0;  // ä¸ç»è¿‡å¤šå‡»ç®—æ³•å¤„ç†
}
```

**çŠ¶æ€ç®¡ç†ç®€åŒ–ï¼š**
- è§¦æ‘¸æŒ‰é”®æ¨¡å—ä¸å†ç»´æŠ¤å¤šå‡»çŠ¶æ€
- æ‰€æœ‰æŒ‰é”®çŠ¶æ€ç”±ç»Ÿä¸€ç®—æ³•ç®¡ç†
- é¿å…äº†çŠ¶æ€åŒæ­¥é—®é¢˜

## æ–¹æ¡ˆä¸€çš„ä¼˜åŠ¿æ€»ç»“

### 1. åŠŸèƒ½å®Œæ•´æ€§
- âœ… è§¦æ‘¸æŒ‰é”®è·å¾—å¤šå‡»+é•¿æŒ‰åŠŸèƒ½
- âœ… ä¿ç•™è§¦æ‘¸æŒ‰é”®çš„æ‰€æœ‰ç‰¹æ®ŠåŠŸèƒ½
- âœ… æ”¯æŒæœªæ¥çš„æŒ‰é”®åŠŸèƒ½æ‰©å±•

### 2. æ¶æ„ä¼˜é›…æ€§  
- âœ… æ¶ˆé™¤ä»£ç é‡å¤
- âœ… ç»Ÿä¸€äº‹ä»¶å¤„ç†æµç¨‹
- âœ… é™ä½ç³»ç»Ÿå¤æ‚åº¦

### 3. ç»´æŠ¤ä¾¿åˆ©æ€§
- âœ… å•ä¸€ç®—æ³•ç»´æŠ¤
- âœ… ç»Ÿä¸€å‚æ•°é…ç½®
- âœ… ç®€åŒ–æµ‹è¯•æµç¨‹

### 4. æ‰©å±•æ€§
- âœ… æ–°åŠŸèƒ½è‡ªåŠ¨æ”¯æŒæ‰€æœ‰æŒ‰é”®ç±»å‹
- âœ… é…ç½®å‚æ•°å…¨å±€ç»Ÿä¸€
- âœ… ä¾¿äºåŠŸèƒ½å®šåˆ¶å’Œä¼˜åŒ–

## ç»“è®º

é€šè¿‡è¯¦ç»†çš„æŠ€æœ¯åˆ†æå’Œä»£ç éªŒè¯ï¼Œ**æ–¹æ¡ˆä¸€ï¼ˆå»é™¤è·³è¿‡åˆ¤æ–­ï¼Œä½¿ç”¨ç»Ÿä¸€æµç¨‹ï¼‰æ˜¯å®Œå…¨å¯è¡Œçš„**ã€‚å®ƒä¸ä»…è§£å†³äº†è§¦æ‘¸æŒ‰é”®å¤šå‡»+é•¿æŒ‰çš„é—®é¢˜ï¼Œæ›´é‡è¦çš„æ˜¯å®ç°äº†æŒ‰é”®å¤„ç†æ¶æ„çš„çœŸæ­£ç»Ÿä¸€ï¼Œä¸ºç³»ç»Ÿçš„é•¿æœŸç»´æŠ¤å’Œæ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. **ä¸“å±æµç¨‹çš„å¼Šç«¯**ï¼šæ¶æ„åˆ†è£‚ã€ä»£ç é‡å¤ã€æ‰©å±•å›°éš¾
2. **ç»Ÿä¸€æµç¨‹çš„å¯è¡Œæ€§**ï¼šæ—¶åºå…¼å®¹ã€åŠŸèƒ½å®Œæ•´ã€å®ç°ç®€å•
3. **æŠ€æœ¯è½¬å˜çš„æœ¬è´¨**ï¼šä»"ç‰¹æ®ŠåŒ–å¤„ç†"è½¬å‘"èŒè´£åˆ†å·¥"çš„æ¶æ„è®¾è®¡

```c
static void lp_touch_key_short_click_handle(u32 ch_idx)
{
#ifdef TOUCH_KEY_IDENTIFY_ALGO_IN_MSYS
    if (touch_abandon_short_click_once) {
        touch_abandon_short_click_once = 0;
        log_debug("lp touch key abandon the short click!\n");
        return;
    }
#endif

    struct touch_key_arg *arg = &(__this->arg[ch_idx]);
    arg->last_key =  TOUCH_KEY_SHORT_CLICK;
    if (arg->short_timer == 0) {
        arg->click_cnt = 1;
        arg->short_timer = usr_timeout_add((void *)ch_idx, lp_touch_key_short_click_time_out_handle, __this->pdata->short_click_check_time, 1);
    } else {
        arg->click_cnt++;
        usr_timer_modify(arg->short_timer, __this->pdata->short_click_check_time);
    }
}


static void lp_touch_key_short_click_handle(u32 ch_idx)
{
#ifdef TOUCH_KEY_IDENTIFY_ALGO_IN_MSYS
    if (touch_abandon_short_click_once) {
        touch_abandon_short_click_once = 0;
        log_debug("lp touch key abandon the short click!\n");
        return;
    }
#endif

    // ä¿®æ”¹ï¼šæ¯æ¬¡ç‚¹å‡»ç«‹å³å‘é€å•å‡»äº‹ä»¶ï¼Œè®©ç»Ÿä¸€ç®—æ³•å¤„ç†å¤šå‡»è¯†åˆ«
    const struct touch_key_cfg *key_cfg = &(__this->pdata->key_cfg[ch_idx]);
    struct touch_key_arg *arg = &(__this->arg[ch_idx]);
    
    struct key_event e;
    e.event = KEY_ACTION_CLICK;
    e.value = key_cfg->key_value;
    
    log_debug("notify key:%d immediate click event", ch_idx);
    lp_touch_key_notify_key_event(&e, ch_idx);
    
    arg->last_key = TOUCH_KEY_SHORT_CLICK;
    // ä¸å†éœ€è¦å®šæ—¶å™¨å’Œè®¡æ•°ï¼Œç»Ÿä¸€ç®—æ³•ä¼šå¤„ç†å¤šå‡»è¯†åˆ«
}

multi_clicks_translate
    // ç§»é™¤è§¦æ‘¸æŒ‰é”®çš„è·³è¿‡åˆ¤æ–­ï¼Œè®©è§¦æ‘¸æŒ‰é”®ä¹Ÿèƒ½äº«å—ç»Ÿä¸€çš„å¤šå‡»+é•¿æŒ‰ç®—æ³•
    // åŸæ¥è·³è¿‡æ˜¯ä¸ºäº†é¿å…åŒé‡è¯†åˆ«ï¼Œç°åœ¨è§¦æ‘¸æŒ‰é”®åªå‘é€åŸºç¡€äº‹ä»¶ï¼Œä¸ä¼šå†²çª
    /*
    if (key->type == KEY_DRIVER_TYPE_CTMU_TOUCH) {
        return 0;
    }
    */
```

## é—®é¢˜

å¤šå‡»æŒ‰é”®åŠŸèƒ½å¤±æ•ˆäº†ã€‚åˆ†æçš„è°ƒç”¨é“¾å’Œè¿‡ç¨‹æœ‰é—®é¢˜ã€‚è§¦æ‘¸æŒ‰é”®ä¼°è®¡éƒ½ä¸èµ°é€šç”¨æµç¨‹ã€‚ä½†æ˜¯é•¿æŒ‰ä»¥åŠé•¿æŒ‰çš„å¤æ‚æŒ‰é”®äº‹ä»¶è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ã€‚

è¦çŸ¥é“è§¦æ‘¸æŒ‰é”®ä¸é€šç”¨æŒ‰é”®äº‹ä»¶æ˜¯å¦‚ä½•äº¤äº’çš„ä¸å¯¹æ¥çš„ï¼Œé•¿æŒ‰åŠŸèƒ½èµ°é€šç”¨æµç¨‹çš„è¯ï¼Œåº”è¯¥æ˜¯æœ‰ä¼ é€’çš„ã€‚è‡³äºä¸ºå•¥å¤šå‡»å¤±è´¥ï¼Œåº”è¯¥æ˜¯ä¼ é€’é—®é¢˜ã€‚
