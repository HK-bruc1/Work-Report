# å¯»æ‰¾è€³æœºåŠŸèƒ½åŒè€³æ’­æ”¾é—®é¢˜æ ¹å› åˆ†æ

## ğŸ¯ é—®é¢˜ç°è±¡

**ç”¨æˆ·æŠ¥å‘Šï¼š**
- æœ‰æ—¶åŒè€³éƒ½èƒ½æ’­æ”¾å¯»æ‰¾æç¤ºéŸ³ âœ…
- æœ‰æ—¶åªæœ‰ä¸€ä¸ªè€³æœºæ’­æ”¾æç¤ºéŸ³ âŒ
- **éœ€è¦æ‰‹åŠ¨åœ¨ `earphone_mute_handler` ä¸­åˆ¤æ–­å‚æ•°è®¾ç½® `find_device_key_flag` æ‰èƒ½ç¨³å®šå®ç°åŒè€³æ’­æ”¾**

## ğŸ” æ ¹æœ¬åŸå› 

### æ ¸å¿ƒå‘ç°ï¼šä¸»è€³æœºçš„å¤„ç†æµç¨‹ä¸ä»è€³æœºå®Œå…¨ä¸åŒï¼

---

## ğŸ“‹ å®Œæ•´æµç¨‹å¯¹æ¯”

### ä¸»è€³æœºæµç¨‹ï¼ˆMASTERï¼‰

```
ã€APPé€šè¿‡SPPå‘é€æ•°æ®ã€‘
    â†“
online_spp_recieve_cbk()  [æ‰“å°: online_spp_rx]
    â†“
tws_online_spp_send() â†’ å‘é€ç»™ä»è€³æœº
    â†“
RCSPåè®®è§£æ â†’ rcsp_cmd_recieve.c å¯»æ‰¾è®¾å¤‡å¤„ç†
    â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¬¬272-280è¡Œï¼šå¤„ç†è¶…æ—¶å‚æ•°
    if (tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) {
        âš ï¸ find_device_stop_timer(other_opt, 300);
        // åªåŒæ­¥ç»™ä»è€³æœºï¼Œä¸»è€³æœºè‡ªå·±ä¸å‘å‡º MSG_JL_FIND_DEVICE_STOPï¼
    }
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¬¬342-346è¡Œï¼šå¤„ç†æ’­æ”¾å‚æ•°
    if (tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) {
        âš ï¸ find_device_sync(other_opt, 300);
        return;  // ç›´æ¥returnï¼ä¸»è€³æœºä¸å‘å‡º MSG_JL_FIND_DEVICE_RESUMEï¼
    }
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**å…³é”®ä»£ç åˆ†æï¼š**

```c
// rcsp_setting_sync.c:130-141
void find_device_stop_timer(u8 *param, u32 msec)
{
    int priv = 0;
    if (TWS_ROLE_MASTER == tws_api_get_role()) {
        memcpy(&priv, param, 3);
        // âš ï¸ åªè°ƒç”¨TWSåŒæ­¥ï¼Œä¸»è€³æœºè‡ªå·±ä¸å¤„ç†ï¼
        tws_api_sync_call_by_uuid(TWS_FUNC_ID_ADV_FIND_DEV_STOP_TIMER_SYNC, priv, msec);
    }
}

// rcsp_setting_sync.c:104-114
void find_device_sync(u8 *param, u32 msec)
{
    int priv = 0;
    if (TWS_ROLE_MASTER == tws_api_get_role()) {
        memcpy(&priv, param, 3);
        // âš ï¸ åªè°ƒç”¨TWSåŒæ­¥ï¼Œä¸»è€³æœºè‡ªå·±ä¸å¤„ç†ï¼
        tws_api_sync_call_by_uuid(TWS_FUNC_ID_ADV_FIND_DEV_SYNC, priv, msec);
    }
}
```

### ä»è€³æœºæµç¨‹ï¼ˆSLAVEï¼‰

```
ã€æ”¶åˆ°TWSåŒæ­¥æ¶ˆæ¯ã€‘
    â†“
TWSå›è°ƒï¼šadv_find_dev_stop_sync_timer_func_t()
    â†“ [ç¬¬120è¡Œ]
âœ… JL_rcsp_event_to_user(DEVICE_EVENT_FROM_RCSP, MSG_JL_FIND_DEVICE_STOP, ...)
    â†“
å¤„ç† MSG_JL_FIND_DEVICE_STOP
    â†“
find_device_timeout_handle()
    â†“
âœ… find_device_key_flag = 1;  [æ ‡å¿—ä½è®¾ç½®æˆåŠŸ]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ”¶åˆ°TWSåŒæ­¥æ¶ˆæ¯ã€‘
    â†“
TWSå›è°ƒï¼šadv_find_dev_sync_func_t()
    â†“ [ç¬¬96è¡Œ]
âœ… JL_rcsp_event_to_user(DEVICE_EVENT_FROM_RCSP, MSG_JL_FIND_DEVICE_RESUME, ...)
    â†“
å¤„ç† MSG_JL_FIND_DEVICE_RESUME
    â†“
earphone_mute_handler()
    â†“
if (find_device_key_flag) {  // âœ… æ ‡å¿—ä½æ˜¯1
    âœ… åˆ›å»ºå®šæ—¶å™¨ â†’ æ’­æ”¾æç¤ºéŸ³
}
```

---

## âš ï¸ é—®é¢˜å…³é”®ç‚¹

### 1. ä¸»è€³æœºä¾èµ– `tws_api_sync_call_by_uuid` çš„å›è°ƒæœºåˆ¶

```c
// TWSåŒæ­¥å›è°ƒæ³¨å†Œï¼ˆrcsp_setting_sync.c:92-102ï¼‰
static void adv_find_dev_sync_func_t(int args, int err)
{
    JL_rcsp_event_to_user(DEVICE_EVENT_FROM_RCSP, MSG_JL_FIND_DEVICE_RESUME, ...);
}

TWS_SYNC_CALL_REGISTER(adv_find_dev_sync) = {
    .uuid = TWS_FUNC_ID_ADV_FIND_DEV_SYNC,
    .func    = adv_find_dev_sync_func_t,  // â† ä»è€³æœºä¼šè°ƒç”¨è¿™ä¸ª
};
```

**å…³é”®ç–‘é—®ï¼š**
- `tws_api_sync_call_by_uuid` ä¼šä¸ä¼šåœ¨ä¸»è€³æœºä¸Šä¹Ÿè§¦å‘å›è°ƒï¼Ÿ
- å¦‚æœä¼šè§¦å‘ï¼Œä»€ä¹ˆæ¡ä»¶ä¸‹è§¦å‘ï¼Ÿæ˜¯åŒæ­¥ã€å¼‚æ­¥è¿˜æ˜¯ä¾èµ– `err` å‚æ•°ï¼Ÿ

**å‡è®¾Aï¼šä¸»è€³æœºä¹Ÿä¼šè§¦å‘å›è°ƒï¼ˆæ­£å¸¸æƒ…å†µï¼‰**
```
ä¸»è€³æœºï¼šfind_device_sync()
    â†’ tws_api_sync_call_by_uuid()
    â†’ ä¸»è€³æœºä¸Šè§¦å‘ adv_find_dev_sync_func_t()
    â†’ å‘å‡º MSG_JL_FIND_DEVICE_RESUME
    â†’ earphone_mute_handler()
    â†’ è®¾ç½®æ ‡å¿—ä½ â†’ æ’­æ”¾ âœ…

ä»è€³æœºï¼šæ”¶åˆ°åŒæ­¥
    â†’ è§¦å‘ adv_find_dev_sync_func_t()
    â†’ å‘å‡º MSG_JL_FIND_DEVICE_RESUME
    â†’ earphone_mute_handler()
    â†’ è®¾ç½®æ ‡å¿—ä½ â†’ æ’­æ”¾ âœ…

ç»“æœï¼šåŒè€³éƒ½æ’­æ”¾ âœ…
```

**å‡è®¾Bï¼šä¸»è€³æœºä¸è§¦å‘å›è°ƒï¼ˆå¼‚å¸¸æƒ…å†µï¼‰**
```
ä¸»è€³æœºï¼šfind_device_sync()
    â†’ tws_api_sync_call_by_uuid()
    â†’ âŒ æŸäº›æ¡ä»¶ä¸‹ä¸è§¦å‘å›è°ƒï¼ˆå¦‚åŒæ­¥å¤±è´¥ã€æ—¶åºé—®é¢˜ï¼‰
    â†’ âŒ ä¸»è€³æœºä¸å‘å‡º MSG_JL_FIND_DEVICE_RESUME
    â†’ âŒ find_device_key_flag ä¿æŒä¸º 0
    â†’ âŒ earphone_mute_handler() ä¸­ if (find_device_key_flag) ä¸æ»¡è¶³
    â†’ âŒ ä¸æ’­æ”¾

ä»è€³æœºï¼šæ”¶åˆ°åŒæ­¥
    â†’ è§¦å‘å›è°ƒ
    â†’ æ’­æ”¾ âœ…

ç»“æœï¼šåªæœ‰ä»è€³æœºæ’­æ”¾ âŒ
```

### 2. æ ‡å¿—ä½åŒæ­¥ä¾èµ–å›è°ƒè§¦å‘

```
find_device_key_flag çš„è®¾ç½®è·¯å¾„ï¼š

MSG_JL_FIND_DEVICE_STOP
    â†’ JL_rcsp_event_handler()
    â†’ find_device_timeout_handle()
    â†’ find_device_key_flag = 1;
```

**å¦‚æœä¸»è€³æœºçš„å›è°ƒæ²¡æœ‰è¢«è§¦å‘ï¼Œä¸»è€³æœºå°±ä¸ä¼šè®¾ç½®æ ‡å¿—ä½ï¼**

### 3. æ—¶åºä¾èµ–é—®é¢˜

å³ä½¿ä¸»è€³æœºçš„å›è°ƒè¢«è§¦å‘ï¼Œä¹Ÿå­˜åœ¨æ—¶åºé£é™©ï¼š

```
æƒ…å†µ1ï¼ˆæ­£å¸¸ï¼‰ï¼š
ä¸»è€³æœºï¼šSTOPå›è°ƒ â†’ è®¾ç½®æ ‡å¿—ä½=1 â†’ RESUMEå›è°ƒ â†’ æ£€æŸ¥æ ‡å¿—ä½=1 â†’ æ’­æ”¾ âœ…

æƒ…å†µ2ï¼ˆå¼‚å¸¸ï¼‰ï¼š
ä¸»è€³æœºï¼šRESUMEå›è°ƒå…ˆåˆ° â†’ æ£€æŸ¥æ ‡å¿—ä½=0 â†’ ä¸æ’­æ”¾ âŒ
        â†’ STOPå›è°ƒååˆ° â†’ è®¾ç½®æ ‡å¿—ä½=1 â†’ ä½†å·²é”™è¿‡
```

---

## ğŸ’¡ ç”¨æˆ·è¡¥ä¸ä¸ºä»€ä¹ˆæœ‰æ•ˆ

```c
// ç”¨æˆ·åœ¨ earphone_mute_handler ä¸­æ·»åŠ çš„ä»£ç ï¼š
void earphone_mute_handler(u8 *other_opt, u32 msec)
{
    ...
    static u8 tmp_param[3] = {0};
    memcpy(tmp_param, other_opt, size_other_opt);

    // âœ… æ ¹æ®å‚æ•°ç›´æ¥è®¾ç½®æ ‡å¿—ä½ï¼Œä¸ä¾èµ–æ¶ˆæ¯å¤„ç†é¡ºåº
    if(tmp_param[1] == 1){      // player=1 è¡¨ç¤ºè®¾å¤‡ç«¯æ’­æ”¾
        find_device_key_flag = 1;
    } else if(tmp_param[1] == 0){  // player=0 è¡¨ç¤ºAPPç«¯æ’­æ”¾
        find_device_key_flag = 0;
    }
    ...
}
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼š**
1. **ç»•è¿‡äº†å›è°ƒä¾èµ–**ï¼šä¸å†ä¾èµ– TWS å›è°ƒæ˜¯å¦è¢«è§¦å‘
2. **å‚æ•°å·²é€šè¿‡TWSåŒæ­¥**ï¼š`tmp_param` æ˜¯é€šè¿‡ TWS åŒæ­¥æœºåˆ¶ä¼ é€’çš„ï¼Œä¸¤è¾¹ä¸€è‡´
3. **åœ¨å…³é”®åˆ¤æ–­ç‚¹è®¾ç½®**ï¼šåœ¨ `earphone_mute_handler` å…¥å£å¤„è®¾ç½®ï¼Œç¡®ä¿åç»­åˆ¤æ–­ `if (find_device_key_flag)` æ—¶æ ‡å¿—ä½æ­£ç¡®
4. **æ¶ˆé™¤æ—¶åºä¾èµ–**ï¼šä¸å†ä¾èµ– STOP æ¶ˆæ¯ä¸€å®šåœ¨ RESUME æ¶ˆæ¯ä¹‹å‰åˆ°è¾¾

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”å›¾

### åŸå§‹æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰

```
ä¸»è€³æœºï¼š                           ä»è€³æœºï¼š
APPæ•°æ®
  â†“
rcsp_cmd_recieve.c
  â†“
find_device_sync()
  â†“ (TWSåŒæ­¥)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  æ”¶åˆ°åŒæ­¥æ¶ˆæ¯
  â†“ (å›è°ƒè§¦å‘?)                    â†“
  â†“                                adv_find_dev_sync_func_t()
  â“ å¯èƒ½ä¸è§¦å‘                      â†“
  â“ find_device_key_flag = 0      MSG_JL_FIND_DEVICE_RESUME
  â“ earphone_mute_handler()        â†“
  â“ ä¸æ’­æ”¾ âŒ                      earphone_mute_handler()
                                   â†“
                                   if (find_device_key_flag) âœ…
                                   â†“
                                   æ’­æ”¾ âœ…
```

### ç”¨æˆ·è¡¥ä¸æµç¨‹ï¼ˆå·²ä¿®å¤ï¼‰

```
ä¸»è€³æœºï¼š                           ä»è€³æœºï¼š
APPæ•°æ®
  â†“
rcsp_cmd_recieve.c
  â†“
find_device_sync()
  â†“ (TWSåŒæ­¥å‚æ•°)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  æ”¶åˆ°åŒæ­¥æ¶ˆæ¯
  â†“                                â†“
  â†“                                adv_find_dev_sync_func_t()
  â†“                                â†“
  earphone_mute_handler()          MSG_JL_FIND_DEVICE_RESUME
  â†“                                â†“
  âœ… if(tmp_param[1] == 1)         earphone_mute_handler()
  âœ… find_device_key_flag = 1      â†“
  â†“                                âœ… if(tmp_param[1] == 1)
  if (find_device_key_flag) âœ…     âœ… find_device_key_flag = 1
  â†“                                â†“
  æ’­æ”¾ âœ…                          if (find_device_key_flag) âœ…
                                   â†“
                                   æ’­æ”¾ âœ…
```

---

## âœ… ç»“è®º

### ä½ çš„æ€€ç–‘å®Œå…¨æ­£ç¡®ï¼

**é—®é¢˜æ ¹æºï¼š**
1. **TWS åŒæ­¥æœºåˆ¶ä¸å®Œå–„**ï¼š
   - å‚æ•°é€šè¿‡ TWS åŒæ­¥äº†
   - ä½†å…³é”®æ ‡å¿—ä½ `find_device_key_flag` æ²¡æœ‰ç›´æ¥åŒæ­¥
   - ä¾èµ–ä¸¤ä¸ªè€³æœºç‹¬ç«‹æ‰§è¡Œæ¶ˆæ¯å¤„ç†æµç¨‹æ¥è®¾ç½®

2. **ä¸»è€³æœºçš„å¤„ç†è·¯å¾„ä¸åŒ**ï¼š
   - ä¸»è€³æœºä¾èµ– `tws_api_sync_call_by_uuid` çš„å›è°ƒæœºåˆ¶
   - å›è°ƒè§¦å‘æ¡ä»¶ä¸æ˜ç¡®æˆ–ä¸ç¨³å®š
   - å­˜åœ¨å›è°ƒä¸è§¦å‘æˆ–æ—¶åºé”™ä¹±çš„é£é™©

3. **æ ‡å¿—ä½çŠ¶æ€ä¸ä¸€è‡´**ï¼š
   - ä¸»è€³æœºå¯èƒ½å› å›è°ƒæœªè§¦å‘ï¼Œå¯¼è‡´ `find_device_key_flag = 0`
   - ä»è€³æœºé€šè¿‡æ­£å¸¸æ¶ˆæ¯å¤„ç†ï¼Œ`find_device_key_flag = 1`
   - ç»“æœï¼šåªæœ‰ä»è€³æœºæ’­æ”¾æç¤ºéŸ³

### ä½ çš„è¡¥ä¸æ–¹æ¡ˆæ˜¯æ­£ç¡®ä¸”é«˜æ•ˆçš„ï¼

**ä¼˜ç‚¹ï¼š**
- âœ… é€šè¿‡å·²åŒæ­¥çš„å‚æ•°æ¨å¯¼æ ‡å¿—ä½å€¼
- âœ… åœ¨å…³é”®åˆ¤æ–­ç‚¹ç¡®ä¿æ ‡å¿—ä½æ­£ç¡®
- âœ… æ¶ˆé™¤å¯¹æ¶ˆæ¯å¤„ç†é¡ºåºçš„ä¾èµ–
- âœ… æ¶ˆé™¤å¯¹å›è°ƒè§¦å‘æœºåˆ¶çš„ä¾èµ–
- âœ… ä»£ç ç®€æ´ï¼Œä¾µå…¥æ€§å°

**å»ºè®®ï¼šä¿ç•™ä½ çš„è¡¥ä¸ï¼Œè¿™æ˜¯æœ€å¯é çš„è§£å†³æ–¹æ¡ˆã€‚**

---

## ğŸ”§ è¿›ä¸€æ­¥éªŒè¯å»ºè®®

å¦‚æœä½ æƒ³è¿›ä¸€æ­¥éªŒè¯é—®é¢˜æ ¹å› ï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹æ—¥å¿—ï¼š

```c
// 1. åœ¨ find_device_sync ä¸­æ·»åŠ æ—¥å¿—
void find_device_sync(u8 *param, u32 msec)
{
    int priv = 0;
    if (TWS_ROLE_MASTER == tws_api_get_role()) {
        memcpy(&priv, param, 3);
        printf("ã€MASTERã€‘find_device_sync: å‡†å¤‡åŒæ­¥ç»™ä»è€³æœº, param=%02x %02x %02x\n",
               param[0], param[1], param[2]);
        tws_api_sync_call_by_uuid(TWS_FUNC_ID_ADV_FIND_DEV_SYNC, priv, msec);
    }
}

// 2. åœ¨ TWS å›è°ƒä¸­æ·»åŠ æ—¥å¿—
static void adv_find_dev_sync_func_t(int args, int err)
{
    char role = (tws_api_get_role() == TWS_ROLE_MASTER) ? 'M' : 'S';
    printf("ã€%cã€‘adv_find_dev_sync_func_t è¢«è°ƒç”¨: args=%d, err=%d\n", role, args, err);
    JL_rcsp_event_to_user(DEVICE_EVENT_FROM_RCSP, MSG_JL_FIND_DEVICE_RESUME, (u8 *)&args, sizeof(args));
}

// 3. åœ¨ find_device_timeout_handle ä¸­æ·»åŠ æ—¥å¿—
void find_device_timeout_handle(u32 sec)
{
    char role = (tws_api_get_role() == TWS_ROLE_MASTER) ? 'M' : 'S';
    printf("ã€%cã€‘find_device_timeout_handle: flag %d->1\n", role, find_device_key_flag);
    find_device_key_flag = 1;
    ...
}

// 4. åœ¨ earphone_mute_handler ä¸­æ·»åŠ æ—¥å¿—
void earphone_mute_handler(u8 *other_opt, u32 msec)
{
    char role = (tws_api_get_role() == TWS_ROLE_MASTER) ? 'M' : 'S';
    printf("ã€%cã€‘earphone_mute_handler: flag=%d, player=%d\n",
           role, find_device_key_flag, other_opt[1]);
    ...
}
```

è§‚å¯Ÿæ—¥å¿—ï¼ŒéªŒè¯ï¼š
- ä¸»è€³æœºçš„å›è°ƒå‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
- ä¸»è€³æœºçš„ `find_device_key_flag` æ˜¯å¦è¢«æ­£ç¡®è®¾ç½®
- ä¸¤ä¸ªè€³æœºçš„æ‰§è¡Œæ—¶åº
