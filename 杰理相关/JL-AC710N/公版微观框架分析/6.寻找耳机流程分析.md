# 寻找耳机功能流程分析

## 一、原始日志

### 双耳播放寻找耳机与停止

```c
//...寻找耳机
[00:01:19.261]online_spp_rx(15) 
[00:01:19.262]tws_online_spp_in_task
[00:01:19.262]ONLINE_SPP_DATA0000
FE DC BA C0 19 00 07 77 01 01 00 3C 00 01 EF 
[00:01:19.265][EARPHONE] BT STATUS DEFAULT
[00:01:19.266][SNIFF] BT_STATUS_SNIFF_STATE_UPDATE 0
[00:01:19.267][SNIFF]check_sniff_enable
[00:01:19.268]dual_conn_btstack_event_handler:32
[00:01:19.269][EARPHONE] BT STATUS DEFAULT
[00:01:19.270]ui_bt_stack_msg_handler:32
[00:01:19.271][LED_UI]MSG_FROM_BT_STACK----ui_bt_stack_msg_handler----BT_STATUS_SNIFF_STATE_UPDATE
[00:01:19.273]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 199, sec:3c
3C 00 00 
[00:01:19.275]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:1
3C 00 
3C 00 00 00 
[00:01:19.277]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:1
00 00 00 00 
[00:01:19.280]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 304, flag:1
3C 00 00 00 
[00:01:19.282]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_device_timeout_handle, 161, find_device_key_flag=1
[00:01:19.284]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
00 01 00 
[00:01:19.286]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2
00 01 
00 01 00 00 
[00:01:19.288]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2
3C 00 00 00 
[00:01:19.290]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2
3C 00 00 01 
[00:01:19.293]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239
00 01 00 
[00:01:19.295]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 270
T@%
[00:01:19.597]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 205, way:0, player:1
[00:01:19.599]apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 226
[00:01:19.601]bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear
[00:01:19.604]tone_player: tone_en/find_ear.*
[00:01:19.605]pipeline_uuid: 7674

//...停止寻找
[00:02:49.237]online_spp_rx(15) 
[00:02:49.238]tws_online_spp_in_task
[00:02:49.238]ONLINE_SPP_DATA0000
FE DC BA C0 19 00 07 7D 01 00 00 00 00 00 EF 
[00:02:49.240]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, rcsp_find_device_reset, 112, find_device_key_flag=0
[00:02:49.242]avctp_passthrough_rsp:45
[00:02:49.243]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
00 00 00 
[00:02:49.245]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2
00 00 
00 00 00 00 
[00:02:49.248]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2
[00:02:49.249]avctp_passthrough_rsp:c5
3C 00 00 01 
[00:02:49.251]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2
3C 00 00 00 
[00:02:49.253]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239
00 00 00 
[00:02:49.254]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 264
[00:02:49.256]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
00 00 00 
[00:02:49.258]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2
00 00 
00 00 00 00 
[00:02:49.260]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2
3C 00 00 00 
[00:02:49.262]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2
3C 00 00 00 
[00:02:49.264]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239
00 00 00     
```

### 单耳左边寻找与停止

```c
//开始寻找左边
[00:06:00.652]online_spp_rx(15) 
[00:06:00.652]tws_online_spp_in_task
[00:06:00.653]ONLINE_SPP_DATA0000

FE DC BA C0 19 00 07 7E 01 01 00 3C 01 01 EF 
[00:06:00.656]dual_conn_btstack_event_handler:32
[00:06:00.657][EARPHONE] BT STATUS DEFAULT
[00:06:00.658]ui_bt_stack_msg_handler:32
[00:06:00.658][LED_UI]MSG_FROM_BT_STACK----ui_bt_stack_msg_handler----BT_STATUS_SNIFF_STATE_UPDATE
[00:06:00.661]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 199, sec:3c

3C 00 00 
[00:06:00.663]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:1

3C 00 

3C 00 00 00 
[00:06:00.665]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:1

3C 00 00 00 
[00:06:00.667]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 304, flag:1

3C 00 00 00 
[00:06:00.669]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_device_timeout_handle, 161, find_device_key_flag=1
[00:06:00.672]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186

01 01 00 
[00:06:00.673]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

01 01 

01 01 00 00 
[00:06:00.676]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 00 00 
[00:06:00.678]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 01 01 
[00:06:00.682]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

01 01 00 
[00:06:00.684]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 270
[00:06:00.986]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 205, way:1, player:1
[00:06:00.988]apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 226
[00:06:00.990]bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear
[00:06:00.993]tone_player: tone_en/find_ear.*
[00:06:00.994]pipeline_uuid: 7674

//结束左耳寻找
[00:06:54.884]online_spp_rx(15) 
[00:06:54.885]tws_online_spp_in_task
[00:06:54.885]ONLINE_SPP_DATA0000

FE DC BA C0 19 00 07 7F 01 00 00 00 00 00 EF 
[00:06:54.887]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, rcsp_find_device_reset, 112, find_device_key_flag=0
[00:06:54.889][EARPHONE] BT STATUS DEFAULT
[00:06:54.889][SNIFF] BT_STATUS_SNIFF_STATE_UPDATE 0
[00:06:54.890][SNIFF]check_sniff_enable
[00:06:54.890]dual_conn_btstack_event_handler:32
[00:06:54.891][EARPHONE] BT STATUS DEFAULT
[00:06:54.892]ui_bt_stack_msg_handler:32
[00:06:54.893][LED_UI]MSG_FROM_BT_STACK----ui_bt_stack_msg_handler----BT_STATUS_SNIFF_STATE_UPDATE
[00:06:54.894]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
[00:06:54.896]avctp_passthrough_rsp:45

00 00 00 
[00:06:54.897]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

00 00 

00 00 00 00 
[00:06:54.899]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 01 01 
[00:06:54.901]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 00 00 
[00:06:54.902]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

00 00 00 
[00:06:54.905]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 264
[00:06:54.906]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186

00 00 00 
[00:06:54.908]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

00 00 

00 00 00 00 
[00:06:54.909]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 00 00 
[00:06:54.911]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 00 00 
[00:06:54.914]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

00 00 00 
[00:06:54.916]avctp_passthrough_rsp:c5
[00:06:54.987][JLSTREAM]dec_err: 40
U
[00:06:55.008][JLSTREAM]dec_end: 0
[00:06:55.010][DAC]DAV VOL0 : 0x40004000
[00:06:55.061][DAC]Audio DAC Stop
[00:06:55.061][JLSTREAM]send_callback: app_core, event 10, err 0
[00:06:55.062]tone_callback: a, 145
[00:06:55.062][JLSTREAM]free_stream: 41d050
[00:06:55.063][JLSTREAM]decoder_release: 41d134
[00:06:55.064][JLSTREAM]release: jlstream 20
[00:06:55.064]pipeline_uuid: 7674
```



### 单耳右边寻找与停止

```c
//右边开始寻找
[00:09:04.381]online_spp_rx(15) 
[00:09:04.382]tws_online_spp_in_task
[00:09:04.382]ONLINE_SPP_DATA0000

FE DC BA C0 19 00 07 80 01 01 00 3C 02 01 EF 
[00:09:04.386]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 199, sec:3c

3C 00 00 
[00:09:04.388]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:1

3C 00 

3C 00 00 00 
[00:09:04.390]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:1

3C 00 00 00 
[00:09:04.392]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 304, flag:1

3C 00 00 00 
[00:09:04.394]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_device_timeout_handle, 161, find_device_key_flag=1
[00:09:04.396]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186

02 01 00 
[00:09:04.398]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

02 01 

02 01 00 00 
[00:09:04.400]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 00 00 
[00:09:04.403]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 02 01 
[00:09:04.405]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

02 01 00 
[00:09:04.407]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 270
[00:09:04.708]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 205, way:2, player:1
[00:09:04.710]apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 226
[00:09:04.713]bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear
[00:09:04.715]tone_player: tone_en/find_ear.*
[00:09:04.716]pipeline_uuid: 7674

//右边停止寻找
[00:10:04.288]online_spp_rx(15) 
[00:10:04.289]tws_online_spp_in_task
[00:10:04.289]ONLINE_SPP_DATA0000

FE DC BA C0 19 00 07 81 01 00 00 00 00 00 EF 
[00:10:04.291]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, rcsp_find_device_reset, 112, find_device_key_flag=0
[00:10:04.293]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186

00 00 00 
[00:10:04.295]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

00 00 

00 00 00 00 
[00:10:04.297]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 02 01 
[00:10:04.298]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 00 00 
[00:10:04.300]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

00 00 00 
[00:10:04.302]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 264
[00:10:04.303]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186
[00:10:04.304][JLSTREAM]dec_err: 40

00 00 00 
[00:10:04.306]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

00 00 

00 00 00 00 
[00:10:04.308]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 00 00 
[00:10:04.309]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 00 00 
[00:10:04.311]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

00 00 00 
TU
[00:10:04.326][JLSTREAM]dec_end: 0
[00:10:04.330][DAC]DAV VOL0 : 0x40004000
[00:10:04.381][DAC]Audio DAC Stop
[00:10:04.381][JLSTREAM]send_callback: app_core, event 10, err 0
[00:10:04.382]tone_callback: a, 76
[00:10:04.383][JLSTREAM]free_stream: 41d050
[00:10:04.383][JLSTREAM]decoder_release: 41d134
[00:10:04.384][JLSTREAM]release: jlstream 20
[00:10:04.384]pipeline_uuid: 7674
```

### 双耳寻找时关闭其中一边的寻找

```c
//双耳寻找时停止其中一边的寻找
[00:11:05.170]online_spp_rx(15) 
[00:11:05.171]tws_online_spp_in_task
[00:11:05.171]ONLINE_SPP_DATA0000

FE DC BA C0 19 00 07 83 01 01 00 3C 01 01 EF 
[00:11:05.207][DAC]Audio DAC Stop
[00:11:05.208][JLSTREAM]send_callback: app_core, event 10, err 0
[00:11:05.209]avctp_passthrough_rsp:45
[00:11:05.210][EARPHONE] BT STATUS DEFAULT
[00:11:05.210][SNIFF] BT_STATUS_SNIFF_STATE_UPDATE 0
[00:11:05.211][SNIFF]check_sniff_enable
[00:11:05.211]dual_conn_btstack_event_handler:32
[00:11:05.212][EARPHONE] BT STATUS DEFAULT
[00:11:05.212]ui_bt_stack_msg_handler:32
[00:11:05.213][LED_UI]MSG_FROM_BT_STACK----ui_bt_stack_msg_handler----BT_STATUS_SNIFF_STATE_UPDATE
[00:11:05.214]tone_callback: a, 119
[00:11:05.214][JLSTREAM]free_stream: 41d050
[00:11:05.215][JLSTREAM]decoder_release: 41d134
[00:11:05.216][JLSTREAM]release: jlstream 20
[00:11:05.216]pipeline_uuid: 7674

[00:11:05.217][CLOCK]---sys clk set : 192000000
[00:11:05.218][JLSTREAM]create_stream: 41d09c, 0
[00:11:05.219]demuxer_not_match: find_ear.wav
[00:11:05.220][JLSTREAM]jlstream_multi_thread create:jlstream_0
[00:11:05.222][STREAM]format negotiation: suss
  { source,             44100, 2 ch, 16bit }
  { decoder,            44100, 1 ch, 16bit }
  { dac,                44100, 1 ch, 16bit }
[00:11:05.224][JLSTREAM]frame_time: 8, 116,frame_len:1024
[00:11:05.225]vol_dB :16, 0
[00:11:05.226]vol_2_gain: 16, 16, 16384
[00:11:05.226]audio_state:idle->tone,max_vol:16
[00:11:05.227]dvol_max:16384
[00:11:05.227]set_vol[tone]:tone=16
[00:11:05.228]vol_dB :16, 0
[00:11:05.228]vol_2_gain: 16, 16, 16384
[00:11:05.229][fade]state:tone,max_volume:16,cur:16,16
[00:11:05.229]set_vol[tone]:=16
[00:11:05.230][SW_DVOL]Gain:16,AVOL:3,DVOL:16384
[00:11:05.230]convert_data_ioc_start bit_wide, 0 0 15
[00:11:05.232][JLSTREAM]send_callback: app_core, event 8, err 0
[00:11:05.233][DAC]__audio_dac_try_power_on
[00:11:05.244][DAC]delay set : 2204, 108, 880
U
[00:11:05.244][DAC]audio_dac_fifo_start : 0x0, 16, DAC_CON = 0xf802f185
[00:11:05.245][fade]state:tone,max_volume:16,cur:16,16
[00:11:05.246]set_vol[tone]:=16
[00:11:05.246][SW_DVOL]Gain:16,AVOL:3,DVOL:16384
[00:11:05.247]avctp_passthrough_rsp:c5
[00:11:05.249][JLSTREAM]dst_delay: 450, 299
[00:11:05.250]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 199, sec:3c

3C 00 00 
[00:11:05.252]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:1

3C 00 

3C 00 00 00 
[00:11:05.254]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:1

3C 00 00 01 
[00:11:05.255]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 304, flag:1

3C 00 00 01 
[00:11:05.257]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_device_timeout_handle, 161, find_device_key_flag=1
[00:11:05.259]rcsp_find apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c, JL_rcsp_event_handler, 186

01 01 00 
[00:11:05.260]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 280, flag:2

01 01 

01 01 00 00 
[00:11:05.262]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 283, flag:2

3C 00 00 01 
[00:11:05.264]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, find_decice_tws_connect_handle, 309, flag:2

3C 00 01 01 
[00:11:05.267]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

01 01 00 
[00:11:05.269]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 264
[00:11:05.270]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 270
[00:11:05.272]tone_callback: 8, 120
[00:11:05.507][JLSTREAM]dec_err: 40
U
[00:11:05.528][JLSTREAM]dec_end: 0
[00:11:05.530][DAC]DAV VOL0 : 0x40004000
[00:11:05.581][DAC]Audio DAC Stop
[00:11:05.581][JLSTREAM]send_callback: app_core, event 10, err 0
[00:11:05.582]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 205, way:1, player:1
[00:11:05.584]apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_timer_func, 226
[00:11:05.585]bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear
[00:11:05.586]tone_player: tone_en/find_ear.*
[00:11:05.587]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 239

01 01 00 
[00:11:05.588]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 264
[00:11:05.590]rcsp_find apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c, earphone_mute_handler, 270
[00:11:05.591]tone_callback: a, 120
[00:11:05.591][JLSTREAM]free_stream: 41d09c
[00:11:05.592][JLSTREAM]decoder_release: 41d180
[00:11:05.593][JLSTREAM]release: jlstream 20
[00:11:05.593]pipeline_uuid: 7674
```

## 二、RCSP数据包格式解析

### 原始数据包
```
FE DC BA C0 19 00 07 26 01 01 00 3C 00 01 EF
```

### 数据包字段分析
| 字节位置 | 十六进制值 | 说明 |
|---------|-----------|------|
| 0-3 | FE DC BA C0 | RCSP协议头标识 (固定魔数) |
| 4-5 | 19 00 | 数据长度 (0x0019 = 25字节，小端序) |
| 6 | 07 | RCSP命令类型 (0x07 = 设备查找命令) |
| 7 | 26 | 子命令 (0x26 = 寻找设备指令) |
| 8 | 01 | 操作类型 (0x01 = 开始播放) |
| 9 | 01 | 播放设备 (0x01 = 耳机端播放, 0x00 = APP端播放) |
| 10 | 00 | 播放方式 (0x00 = 双耳, 0x01 = 左耳, 0x02 = 右耳) |
| 11-12 | 3C 00 | 超时时间 (0x003C = 60秒，小端序) |
| 13 | 00 | 保留字段 |
| 14 | 01 | 标志位 |
| 15 | EF | 校验和 |

### 关键参数说明
- **超时时间 (0x3C)**: 60秒，日志中显示为 `sec:3c`
- **播放标志 (player:1)**: 设备端播放提示音
- **播放方式 (way:0)**: 双耳同时播放

## 三、完整调用链分析

### 3.1 数据接收层 (Transport Layer)

```
[步骤1] 手机APP通过蓝牙SPP发送RCSP数据包
         ↓
[步骤2] online_spp_recieve_cbk()
         文件：SDK/apps/common/third_party_profile/jieli/online_db/spp_online_db.c:99
         功能：SPP数据接收回调函数
         代码：
         static void online_spp_recieve_cbk(void *hdl, void *remote_addr, u8 *buf, u16 len) {
             log_info("online_spp_rx(%d) \n", len);
             tws_online_spp_send(ONLINE_SPP_DATA, buf, len, 1);  // 同步到TWS对耳
         }
         ↓
[步骤3] tws_online_spp_in_task()
         文件：SDK/apps/common/third_party_profile/jieli/online_db/spp_online_db.c:143
         功能：在任务中处理SPP数据
         代码：
         static void tws_online_spp_in_task(u8 *data) {
             printf("tws_online_spp_in_task");
             u16 data_len = little_endian_read_16(data, 2);
             switch (data[0]) {
                 case ONLINE_SPP_DATA:
                     puts("ONLINE_SPP_DATA0000\n");
                     log_info_hexdump(&data[4], data_len);  // 打印原始数据包
                     db_api->packet_handle(&data[4], data_len);  // 交给数据库API处理
                     break;
             }
         }
```

- 日志只能追溯到这里。。。

### 3.2 RCSP协议解析层 (Protocol Layer)？？？？

```
[步骤4] RCSP协议解析器识别命令类型
         ↓ (解析后生成内部消息)
         消息类型：MSG_JL_FIND_DEVICE_STOP (0x3C 00 00)
         消息类型：MSG_JL_FIND_DEVICE_RESUME (00 01 00)
         ↓
[步骤5] JL_rcsp_event_handler() - 处理 MSG_JL_FIND_DEVICE_STOP
         文件：SDK/apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c:196
         功能：RCSP事件处理器，处理"开始寻找设备"消息
         代码：
         case MSG_JL_FIND_DEVICE_STOP:
             log_info("MSG_JL_FIND_DEVICE_STOP\n");
             u16 sec = *((u16 *)rcsp->args);  // 提取超时时间 0x3C = 60秒
             printf("rcsp_find %s, %s, %d, sec:%x\n", __FILE__, __FUNCTION__, __LINE__, sec);
             put_buf(rcsp->args, 3);  // 日志输出: 3C 00 00

             #if TCFG_USER_TWS_ENABLE
             find_decice_tws_connect_handle(1, rcsp->args);  // TWS同步，flag=1，这个标志位不是决定提示音是否播放的
             #endif
			
			//这里就是为什么寻找耳机提示音播放一段时间没有声音了
			//
             extern void find_device_timeout_handle(u32 sec);
             find_device_timeout_handle(sec);  // 设置超时定时器
             break;
         ↓
[步骤6] find_decice_tws_connect_handle(flag=1, param)
         文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:261
         功能：TWS对耳同步处理（第一次调用）
         代码：
         void find_decice_tws_connect_handle(u8 flag, u8 *param) {
             static u8 sync_param[4] = {0};  // TWS同步参数缓存
             u8 other_opt[3] = {0};

             printf("rcsp_find %s, %s, %d, flag:%d\n", __FILE__, __FUNCTION__, __LINE__, flag);
             put_buf(sync_param, 4);  // 日志输出: 3C 00 00 00

             switch (flag) {
                 case 1:  // 第一阶段：保存超时参数
                     memcpy(sync_param, param, 2);  // 保存 0x3C 00 到 sync_param[0-1]
                     printf("rcsp_find %s, %s, %d, flag:%d\n", __FILE__, __FUNCTION__, __LINE__, flag);
                     put_buf(sync_param, 4);  // 日志输出: 3C 00 00 00
                     break;
             }
         }
         ↓
[步骤7] find_device_timeout_handle(sec=0x3C)
         文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:157
         功能：设置寻找设备超时定时器
         代码：
         void find_device_timeout_handle(u32 sec) {
             printf("rcsp_find %s, %s, %d, find_device_key_flag=1\n", __FILE__, __FUNCTION__, __LINE__);
             find_device_key_flag = 1;  // 标记寻找设备功能已启动,从日志来看标志位首次赋值在这里

             if (sec && (0 == find_device_timer)) {
                 // 创建60秒超时定时器
                 //主要是双耳结束提示音，恢复原样。
                 find_device_timer = sys_timeout_add(NULL, rcsp_stop_find_device, sec * 1000);
             }
			
			//这里似乎只进来一次？设置了最大音量，但是函数中的恢复没有执行
             extern void rcsp_set_vol_for_find_device(u8 vol_flag);
             rcsp_set_vol_for_find_device(find_device_key_flag);  // 调整音量以便寻找
         }
```

设置音量这里有问题：

```c
void rcsp_set_vol_for_find_device(u8 vol_flag)
{
    static u8 vol = 0;
    static u8 state = 0;
    if (state == vol_flag) {
        return ;
    }
    if (vol_flag) {
        // 停止媒体
        vol = app_audio_get_volume(APP_AUDIO_CURRENT_STATE);
        // 最大声
        app_audio_set_volume(app_audio_get_state(), app_audio_volume_max_query(AppVol_BT_MUSIC), 1);

    } else {
        // 恢复
        app_audio_set_volume(app_audio_get_state(), vol, 1);
    }

    rcsp_device_status_update(COMMON_FUNCTION, BIT(RCSP_DEVICE_STATUS_ATTR_TYPE_VOL));
    state = vol_flag;
}
```

之前没有在播放提示音停止音乐的现象是：歌声会增大，也能听见提示音但是很小。

- 这里记录，设置与恢复的应该提示音而不是媒体。
- 可以验证一下。是的有问题

### 3.3 播放控制层 (Playback Control Layer)

```
[步骤8] JL_rcsp_event_handler() - 处理 MSG_JL_FIND_DEVICE_RESUME
         文件：SDK/apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c:184
         功能：处理"开始播放提示音"消息
         代码：
         case MSG_JL_FIND_DEVICE_RESUME:
             log_info("MSG_JL_FIND_DEVICE_RESUME\n");
             printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
             put_buf(rcsp->args, 3);  // 日志输出: 00 01 00 (way=0, player=1, channel=0)

             #if TCFG_USER_TWS_ENABLE
             find_decice_tws_connect_handle(2, rcsp->args);  // TWS同步，flag=2
             #endif

             #if RCSP_MODE == RCSP_MODE_EARPHONE
             extern void earphone_mute_handler(u8 *other_opt, u32 msec);
             earphone_mute_handler(rcsp->args, 300);  // 300ms后播放提示音
             #endif
             break;
         ↓
[步骤9] find_decice_tws_connect_handle(flag=2, param)
         文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:261
         功能：TWS对耳同步处理（第二次调用）
         代码：
         switch (flag) {
             case 2:  // 第二阶段：保存播放参数
                 memcpy(sync_param + 2, param, 2);  // 保存 00 01 到 sync_param[2-3]
                 printf("rcsp_find %s, %s, %d, flag:%d\n", __FILE__, __FUNCTION__, __LINE__, flag);
                 put_buf(sync_param, 4);  // 日志输出: 3C 00 00 01
                 // 现在 sync_param = {0x3C, 0x00, 0x00, 0x01}
                 //                    [超时 60s] [way] [player]
                 break;
         }
         ↓
[步骤10] earphone_mute_handler(other_opt, msec=300)
          文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:231
          功能：耳机静音控制和提示音播放管理器
          代码：
          void earphone_mute_handler(u8 *other_opt, u32 msec) {
              printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
              static u16 earphone_mute_timer = 0;
              static u8 tmp_param[3] = {0};
              int size_other_opt = sizeof(tmp_param);
              memcpy(tmp_param, other_opt, size_other_opt);  // 复制参数 {0x00, 0x01, 0x00}

              #if TCFG_USER_TWS_ENABLE
              // 如果TWS已连接且参数[2]=2，立即播放
              if ((tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) && (2 == tmp_param[2])) {
              	  //特定条件下把find_device_key_flag标志位清除，立马播一次
                  rcsp_find_device_reset();
                  earphone_mute_timer_func(tmp_param);  // 立即播放
              }
              #endif

              // 删除之前的定时器，每一次重复定时器前都要先删除
              if (earphone_mute_timer) {
                  sys_timeout_del(earphone_mute_timer);
                  printf("earphone_mute_timer----sys_timeout_del(earphone_mute_timer);\n");
                  earphone_mute_timer = 0;
              }

              // 如果寻找功能已启动，创建300ms后播放的定时器
              //如果这个标志还在的话，就继续重复。
              if (find_device_key_flag) {
                  earphone_mute_timer = sys_timeout_add(tmp_param, earphone_mute_timer_func, msec);
                  printf("sys_timeout_del(earphone_mute_timer);\n");
              }
          }
```

### 3.4 音频播放层 (Audio Playback Layer)

```
[步骤11] earphone_mute_timer_func(param) - 定时器回调
          文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:193
          功能：实际执行提示音播放和声道静音控制
          代码：
          static void earphone_mute_timer_func(void *param) {
              u8 way = ((u8 *)param)[0];      // 播放方式: 0=双耳, 1=左耳, 2=右耳
              u8 player = ((u8 *)param)[1];   // 播放设备: 0=APP, 1=耳机

              // 首先取消所有声道静音
              earphone_mute('L', 0);  // 左声道取消静音
              earphone_mute('R', 0);  // 右声道取消静音

              printf("rcsp_find %s, %s, %d, way:%d, player:%d\n",
                     __FILE__, __FUNCTION__, __LINE__, way, player);

              #if TCFG_USER_TWS_ENABLE
              // 根据播放方式设置对应声道静音
              if (tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) {
                  switch (way) {
                      case 1:  // 仅左侧播放
                          earphone_mute('R', 1);  // 右声道静音
                          break;
                      case 2:  // 仅右侧播放
                          earphone_mute('L', 1);  // 左声道静音
                          break;
                      // case 0: 双耳播放，不需要静音任何声道
                  }
              }
              #endif

              switch (player) {
                  case 0:
                      // APP端播放，设备端不播放
                      tone_player_stop();
                      break;

                  case 1:
                      // 设备端播放提示音

                      // 先暂停正在播放的音乐，避免被覆盖
                      bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);
                      printf("bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear\n");

                      // 播放"寻找耳机"提示音
                      play_tone_file(get_tone_files()->_TONE_APP_FIND_EAR_NAME);
                      // 实际播放文件："tone_en/find_ear.*" 或 "tone_zh/find_ear.*"

                      // 递归调用，实现重复播放（每300ms重复一次）
                      earphone_mute_handler(param, _TONE_FIND_EAR_REPEAT_TIME);
                      // _TONE_FIND_EAR_REPEAT_TIME = 300ms (定义在 customer.h)
                      break;
              }
          }
          ↓
[步骤12] earphone_mute(channel, mute)
          文件：SDK/apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c:175
          功能：控制左右声道的静音状态
          代码：
          static void earphone_mute(u8 channel, u8 mute) {
              if ('L' == channel) {
                  channel = 1;  // 左声道 = 1
              } else if ('R' == channel) {
                  channel = 2;  // 右声道 = 2
              } else {
                  return;
              }
              printf("rcsp_find %s, channel:%d, mute:%d\n", __FUNCTION__, channel, mute);
              audio_dac_ch_mute(&dac_hdl, channel, mute);  // 调用DAC驱动层静音控制
          }

          日志输出：
          [00:21:04.496] rcsp_find earphone_mute, channel:1, mute:0  // 左声道取消静音
          [00:21:04.497] rcsp_find earphone_mute, channel:2, mute:0  // 右声道取消静音
          ↓
[步骤13] play_tone_file(tone_file_name)
          文件：SDK/apps/earphone/mode/bt/tone.c (推测，通用接口)
          功能：播放提示音文件
          参数：get_tone_files()->_TONE_APP_FIND_EAR_NAME
                ↓ 展开为
                get_tone_files()->find_ear
                ↓ 映射为
                "tone_en/find_ear.*"  (英文提示音)
                或
                "tone_zh/find_ear.*"  (中文提示音)

          代码：
          const struct tone_files *get_tone_files() {
              #if TCFG_TONE_ZH_ENABLE
              if (g_lang_used == TONE_CHINESE) {
                  return &chinese_tone_files;
              }
              #endif
              return &english_tone_files;
          }

          // tone_table.c 中定义
          static const struct tone_files english_tone_files = {
              ...
              .find_ear = "tone_en/find_ear.*",
              ...
          };

          日志输出：
          [00:21:04.504] tone_player: tone_en/find_ear.*
          ↓
[步骤14] 音频引擎播放提示音
          ↓
[步骤15] 300ms后，earphone_mute_handler被再次调用（递归）
          ↓ 循环播放提示音，直到：
          - 用户在APP端停止寻找（发送停止命令）
          - 超时定时器触发（60秒）
          - 手动停止播放
```

## 四、关键数据结构说明

### 4.1 TWS同步参数 (sync_param)

```c
// 文件：rcsp_command.c:264
static u8 sync_param[4] = {0};

// 数据结构：
// sync_param[0-1]: 超时时间 (秒)，小端序
// sync_param[2]:   播放方式 (way)
//                  0x00 = 双耳播放
//                  0x01 = 仅左耳播放
//                  0x02 = 仅右耳播放
// sync_param[3]:   播放设备 (player)
//                  0x00 = APP端播放
//                  0x01 = 耳机端播放

// 日志示例：
// [步骤6] flag=1: 3C 00 00 00  (保存超时时间 60秒)
// [步骤9] flag=2: 3C 00 00 01  (保存播放参数: way=0, player=1)
```

### 4.2 提示音配置 (tone_files)

```c
// 文件：SDK/apps/earphone/include/app_tone.h:13
struct tone_files {
    const char *num[10];
    const char *power_on;
    const char *power_off;
    const char *bt_mode;
    const char *bt_connect;
    const char *bt_disconnect;
    ...
    const char *find_ear;  // 寻找耳机提示音
    ...
};

// 文件：SDK/apps/earphone/audio/tone_table.c:118
static const struct tone_files english_tone_files = {
    ...
    .find_ear = "tone_en/find_ear.*",
    ...
};

// 配置文件：SDK/apps/earphone/board/br56/customer.h:288-289
#define _TONE_FIND_EAR_REPEAT_TIME 300  // 重复播放间隔 300ms
#define _TONE_APP_FIND_EAR_NAME find_ear  // 提示音名称
```

## 五、时序图

```
手机APP                SPP传输层              RCSP协议层              TWS同步              播放控制层              音频层
   |                      |                      |                      |                      |                      |
   |--[寻找耳机]--------->|                      |                      |                      |                      |
   |  (FE DC BA C0...)    |                      |                      |                      |                      |
   |                      |--[接收数据]--------->|                      |                      |                      |
   |                      |  online_spp_rx       |                      |                      |                      |
   |                      |                      |                      |                      |                      |
   |                      |--[TWS同步]---------->|                      |                      |                      |
   |                      |  tws_online_spp_send |                      |                      |                      |
   |                      |                      |                      |                      |                      |
   |                      |                      |--[解析协议]--------->|                      |                      |
   |                      |                      |  MSG_JL_FIND_DEVICE_STOP                     |                      |
   |                      |                      |                      |--[同步参数]--------->|                      |
   |                      |                      |                      |  flag=1, 保存超时    |                      |
   |                      |                      |                      |                      |--[设置定时器]------->|
   |                      |                      |                      |                      |  60秒超时            |
   |                      |                      |                      |                      |                      |
   |                      |                      |--[播放指令]--------->|                      |                      |
   |                      |                      |  MSG_JL_FIND_DEVICE_RESUME                   |                      |
   |                      |                      |                      |--[同步参数]--------->|                      |
   |                      |                      |                      |  flag=2, 保存播放    |                      |
   |                      |                      |                      |                      |                      |
   |                      |                      |                      |                      |--[静音控制]--------->|
   |                      |                      |                      |                      |  earphone_mute       |
   |                      |                      |                      |                      |                      |
   |                      |                      |                      |                      |--[停止音乐]--------->|
   |                      |                      |                      |                      |  bt_cmd STOP         |
   |                      |                      |                      |                      |                      |
   |                      |                      |                      |                      |--[播放提示音]------->|
   |                      |                      |                      |                      |  play_tone_file      |
   |<--[听到提示音]<------<----------------------<----------------------<----------------------<----------------------|
   |  "tone_en/find_ear.*"                      |                      |                      |                      |
   |                      |                      |                      |                      |                      |
   |                      |                      |                      |                      |<--[300ms后重复]------|
   |                      |                      |                      |                      |                      |
   |                      |                      |                      |                      |--[再次播放]--------->|
   |<--[再次听到提示音]<--<----------------------<----------------------<----------------------<----------------------|
   |                      |                      |                      |                      |                      |
   |                      |                      |          ... 循环播放，直到停止或超时 ...    |                      |
   |                      |                      |                      |                      |                      |
   |--[停止寻找]--------->|                      |                      |                      |                      |
   |  (停止命令)          |                      |                      |                      |                      |
   |                      |-------------------->|-------------------->|-------------------->|--[停止播放]--------->|
   |                      |                      |                      |                      |  tone_player_stop    |
```

## 六、关键代码文件索引

| 功能模块 | 文件路径 | 关键函数 | 行号 |
|---------|---------|---------|------|
| SPP数据接收 | apps/common/third_party_profile/jieli/online_db/spp_online_db.c | online_spp_recieve_cbk | 99 |
| 数据任务处理 | apps/common/third_party_profile/jieli/online_db/spp_online_db.c | tws_online_spp_in_task | 143 |
| RCSP事件处理 | apps/common/third_party_profile/jieli/rcsp/rcsp_functions/rcsp_manage.c | JL_rcsp_event_handler | 184, 196 |
| TWS对耳同步 | apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c | find_decice_tws_connect_handle | 261 |
| 超时定时器 | apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c | find_device_timeout_handle | 157 |
| 静音控制 | apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c | earphone_mute_handler | 231 |
| 播放回调 | apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c | earphone_mute_timer_func | 193 |
| 声道静音 | apps/common/third_party_profile/jieli/rcsp/server/rcsp_command.c | earphone_mute | 175 |
| 提示音配置 | apps/earphone/audio/tone_table.c | get_tone_files | 137 |
| 提示音定义 | apps/earphone/include/app_tone.h | struct tone_files | 13 |
| 配置宏定义 | apps/earphone/board/br56/customer.h | _TONE_APP_FIND_EAR_NAME | 288-289 |

## 七、配置参数说明

### 7.1 编译时配置

```c
// 文件：SDK/apps/earphone/board/br56/customer.conf

// 寻找耳机提示音重复间隔（毫秒）
_TONE_FIND_EAR_REPEAT_TIME=300

// 寻找耳机提示音文件名
// 默认是 normal，但音量可能不够
// 可以重命名为 find_ear 并增加音量
_TONE_APP_FIND_EAR_NAME=find_ear

// RCSP功能使能开关
RCSP_ADV_FIND_DEVICE_ENABLE=1  // 寻找设备功能使能

// TWS功能使能开关
TCFG_USER_TWS_ENABLE=1  // TWS对耳功能使能
```

### 7.2 运行时参数

```c
// 寻找设备全局标志
static u8 find_device_key_flag = 0;  // 0=未启动, 1=已启动

// 寻找设备定时器句柄
static u16 find_device_timer = 0;  // 60秒超时定时器

// 耳机静音定时器句柄
static u16 earphone_mute_timer = 0;  // 300ms重复播放定时器

// TWS同步参数
static u8 sync_param[4] = {0};  // {超时秒, 0, 播放方式, 播放设备}
```

## 八、异常处理

### 8.1 超时处理

```c
// 文件：rcsp_command.c:157
void find_device_timeout_handle(u32 sec) {
    find_device_key_flag = 1;
    if (sec && (0 == find_device_timer)) {
        // 创建定时器，60秒后自动停止
        find_device_timer = sys_timeout_add(NULL, rcsp_stop_find_device, sec * 1000);
    }
}

// 超时回调函数
static void rcsp_stop_find_device(void *priv) {
    find_device_key_flag = 0;  // 清除标志
    tone_player_stop();        // 停止播放
    find_device_timer = 0;
}
```

### 8.2 TWS断连处理

```c
// 如果TWS对耳断开连接
// sync_param 参数会被保留
// 主耳机继续播放提示音
// 重新连接后会自动同步状态
```

### 8.3 音乐播放冲突处理

```c
// 文件：rcsp_command.c:223
// 在播放提示音之前，先停止正在播放的音乐
bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);
play_tone_file(get_tone_files()->_TONE_APP_FIND_EAR_NAME);
```

## 九、优化建议

### 9.1 当前实现的优点

1. **递归定时器设计**：通过递归调用 `earphone_mute_handler` 实现重复播放，代码简洁
2. **TWS同步机制**：通过 `find_decice_tws_connect_handle` 两阶段同步，确保主从耳机参数一致
3. **声道独立控制**：支持单耳或双耳播放，通过 `earphone_mute` 精确控制
4. **超时保护**：60秒自动停止，避免耗电

### 9.2 潜在的改进点

1. **提示音音量**：配置文件建议可以创建专用的 `find_ear` 提示音并增加音量
2. **定时器管理**：当前使用静态变量存储定时器句柄，可能存在并发问题
3. **错误恢复**：如果 TWS 同步失败，缺少重试机制
4. **日志优化**：生产环境可以减少 `printf` 调试日志，改用分级日志

### 9.3 调试技巧

```c
// 启用详细日志
#define RCSP_DEBUG 1

// 关键打印点：
printf("rcsp_find %s, %s, %d, sec:%x\n", __FILE__, __FUNCTION__, __LINE__, sec);
put_buf(rcsp->args, 3);  // 打印参数缓冲区

// 查看定时器状态
printf("find_device_key_flag=%d, timer=%d\n", find_device_key_flag, find_device_timer);

// 查看TWS状态
printf("tws_state=0x%x\n", tws_api_get_tws_state());
```

## 十、总结

### 流程概览

1. **APP发送** → 手机APP通过蓝牙SPP发送RCSP查找设备命令
2. **数据接收** → `online_spp_recieve_cbk` 接收数据并同步到TWS对耳
3. **协议解析** → RCSP协议层解析数据包，生成内部消息
4. **TWS同步** → `find_decice_tws_connect_handle` 两阶段同步参数
5. **定时器设置** → `find_device_timeout_handle` 设置60秒超时
6. **静音控制** → `earphone_mute_handler` 根据参数控制声道静音
7. **停止音乐** → 发送AVCTP停止命令，避免冲突
8. **播放提示音** → `play_tone_file` 播放 "tone_en/find_ear.*"
9. **循环播放** → 每300ms递归调用，持续播放提示音
10. **停止播放** → 用户停止或超时后，清除标志并停止播放

### 关键技术点

- **RCSP协议**：杰理自有的远程控制协议，支持设备查找功能
- **TWS同步**：通过两阶段同步确保主从耳机参数一致
- **递归定时器**：巧妙实现重复播放，无需维护复杂状态
- **声道控制**：支持单耳或双耳独立播放
- **音频冲突处理**：播放提示音前先停止音乐

# 补丁

## 设置提示音的最大音量而不是媒体音量

```c
void rcsp_set_vol_for_find_device(u8 vol_flag)
{
    static u8 vol = 0;
    static u8 state = 0;
    if (state == vol_flag) {
        return ;
    }
    if (vol_flag) {
        // 停止媒体
        vol = app_audio_get_volume(APP_AUDIO_STATE_WTONE);
        // 最大声
        //app_audio_set_volume(app_audio_get_state(), app_audio_volume_max_query(SysVol_TONE), 1);
        app_var.wtone_volume=16;
        printf("rcsp_set_vol_for_find_device----set_volume_max----vol_flag=%d----vol=%d\n",vol_flag,vol);

    } else {
        // 恢复
        //app_audio_set_volume(app_audio_get_state(), vol, 1);
        app_var.wtone_volume=vol;
        printf("rcsp_set_vol_for_find_device----reset_volume----vol_flag=%d----vol=%d\n",vol_flag,app_var.wtone_volume);
    }

    rcsp_device_status_update(COMMON_FUNCTION, BIT(RCSP_DEVICE_STATUS_ATTR_TYPE_VOL));
    state = vol_flag;
}
```

- 提示音确实大了！但是我发现APP发送停止寻找时，提示音音量没有恢复！
- 我发现这个函数

## 提示音播放实现准确的左右区分

- 有问题，待修改。

```c
void earphone_mute_handler(u8 *other_opt, u32 msec);
static void earphone_mute_timer_func(void *param)
{
    u8 way = ((u8 *)param)[0];
    u8 player = ((u8 *)param)[1];

    char local_channel = bt_tws_get_local_channel();  // 获取本机声道 'L' 或 'R'
    
    //earphone_mute('L', 0);
    //earphone_mute('R', 0);

    printf("rcsp_find %s, %s, %d, way:%d, player:%d\n", __FILE__, __FUNCTION__, __LINE__, way, player);
#if TCFG_USER_TWS_ENABLE
    if (tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) {
        if (way == 1 && local_channel == 'R') {
            //只有左耳播放，右耳就要停止所有的提示音
            tone_player_stop();
            return ;
        } else if (way == 2 && local_channel == 'L') {
            //只有右耳播放，左耳就要停止所有的提示音
            tone_player_stop();
            return ;
        }
    }
#endif
    switch (player) {
    case 0:
        /* printf("%s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        // app端播放，设备端不播放
        tone_player_stop();
        break;
    case 1:
        /* printf("%s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        // 设备端播放
        //先暂停播放音乐，不然会覆盖
        bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);
        printf("bt_cmd_prepare(USER_CTRL_AVCTP_OPID_STOP, 0, NULL);----app_find_ear\n");
        play_tone_file(get_tone_files()->_TONE_APP_FIND_EAR_NAME);
        earphone_mute_handler(param, _TONE_FIND_EAR_REPEAT_TIME);
        break;
    }
}
```

- 可以区分左右耳分别播放！

## 标志位谁赋值

`earphone_mute_handler`这个函数是递归调用重复实现重复播放。问题是他每调用一次就会清除一次标志位，在`rcsp_find_device_reset();`中会把`find_device_key_flag`清空！那么怎么实现的重复播放？？？

```c
void earphone_mute_handler(u8 *other_opt, u32 msec)
{
    printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
    /* put_buf(other_opt, 3); */
    static u16 earphone_mute_timer = 0;
    static u8 tmp_param[3] = {0};
    int size_other_opt = sizeof(tmp_param);
    memcpy(tmp_param, other_opt, size_other_opt);
#if TCFG_USER_TWS_ENABLE
    if ((tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) && (2 == tmp_param[2])) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        printf("rcsp_find_device_reset()----earphone_mute_timer_func(tmp_param)\n");
        rcsp_find_device_reset();
        earphone_mute_timer_func(tmp_param);
    }
#endif
```

  在 earphone_mute_handler 第246-251行的 rcsp_find_device_reset() 只有在特定条件下才会执行：

  1. 条件1：TWS已连接
  2. 条件2：tmp_param[2] == 2

  这个 tmp_param[2] 的值：
  - 正常播放时：tmp_param[2] = 0（way的值）
  - 停止寻找时：tmp_param[2] = 2（参见 rcsp_stop_find_device:134）

  所以：
  - 正常重复播放时：tmp_param[2] != 2，不会清除标志位，循环继续
  - APP发送停止指令时：tmp_param[2] == 2，清除标志位，循环停止
    - 停止指令后还会再重复一次，这就是为什么停止指令看起来有延迟

### 那么参数谁来赋值

`apps\common\third_party_profile\jieli\rcsp\rcsp_functions\rcsp_manage.c`

```c
#if RCSP_ADV_FIND_DEVICE_ENABLE
    case MSG_JL_FIND_DEVICE_RESUME:
        log_info("MSG_JL_FIND_DEVICE_RESUME\n");
        printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
        put_buf(rcsp->args, 3);
#if TCFG_USER_TWS_ENABLE
        find_decice_tws_connect_handle(2, rcsp->args);
#endif
#if RCSP_MODE == RCSP_MODE_EARPHONE
        extern void earphone_mute_handler(u8 * other_opt, u32 msec);
        earphone_mute_handler(rcsp->args, 300);
#endif
        break;
    case MSG_JL_FIND_DEVICE_STOP:
        log_info("MSG_JL_FIND_DEVICE_STOP\n");
        u16 sec = *((u16 *)rcsp->args);
        printf("rcsp_find %s, %s, %d, sec:%x\n", __FILE__, __FUNCTION__, __LINE__, sec);
        put_buf(rcsp->args, 3);
#if TCFG_USER_TWS_ENABLE
        find_decice_tws_connect_handle(1, rcsp->args);
#endif
        extern void find_device_timeout_handle(u32 sec);
        find_device_timeout_handle(sec);
        break;
#endif
```

- 除了定时器会重复调用之外，每一次APP下发指令后，也会调用一次。超时处理也会调用一次。这样就完成了标志位的状态更新。

## 恢复提示音音量

```c
void earphone_mute_handler(u8 *other_opt, u32 msec)
{
    printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
    /* put_buf(other_opt, 3); */
    static u16 earphone_mute_timer = 0;
    static u8 tmp_param[3] = {0};
    int size_other_opt = sizeof(tmp_param);
    memcpy(tmp_param, other_opt, size_other_opt);
#if TCFG_USER_TWS_ENABLE
    if ((tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) && (2 == tmp_param[2])) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        printf("rcsp_find_device_reset()----earphone_mute_timer_func(tmp_param)\n");
        rcsp_find_device_reset();
        earphone_mute_timer_func(tmp_param);
        //停止寻找后，执行完最后一次，把音量恢复
        extern void rcsp_set_vol_for_find_device(u8 vol_flag);
        //前面rcsp_find_device_reset重置了find_device_key_flag。
    	rcsp_set_vol_for_find_device(find_device_key_flag);
    }
#endif
    if (earphone_mute_timer) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        sys_timeout_del(earphone_mute_timer);
        printf("earphone_mute_timer----sys_timeout_del(earphone_mute_timer);\n");
        earphone_mute_timer = 0;
    }

    if (find_device_key_flag) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        earphone_mute_timer = sys_timeout_add(tmp_param, earphone_mute_timer_func, msec);
        printf("sys_timeout_del(earphone_mute_timer);\n");
    }
}
```

- 这个标志位`find_device_key_flag`只要有一直耳机处于找寻状态，执行流程一定会置1.
  - 当没有耳机处于找寻状态时，会被置0.
- 只要有一直耳机处于找寻状态都会先进入`MSG_JL_FIND_DEVICE_STOP`再进入`MSG_JL_FIND_DEVICE_RESUME`。
- 当没有耳机处于找寻状态时就直接进入`void rcsp_stop_find_device(void *priv)` 函数中就会进入`MSG_JL_FIND_DEVICE_RESUME`
  - 所以不会恢复音量。

### 超时处理时也要恢复音量

```c
void rcsp_stop_find_device(void *priv)
{
    if (!find_device_key_flag) {
        return ;
    }
    printf("rcsp_find %s, %s, %d, find_device_key_flag=0\n", __FILE__, __FUNCTION__, __LINE__);
    find_device_key_flag = 0;
    rcsp_find_device_reset();
    rcsp_send_find_device_stop();

#if RCSP_MODE == RCSP_MODE_EARPHONE
    // 0 - way, 1 - player, 2 - find_device_key_flag
    u8 other_opt[3] = {0};
#if TCFG_USER_TWS_ENABLE && RCSP_ADV_EN
    if (tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) {
        other_opt[2] = 2;
        extern void find_device_sync(u8 * param, u32 msec);
        find_device_sync(other_opt, 300);
        return;
    }
#endif
    JL_rcsp_event_to_user(DEVICE_EVENT_FROM_RCSP, MSG_JL_FIND_DEVICE_RESUME, other_opt, sizeof(other_opt));

#else

    extern void rcsp_set_vol_for_find_device(u8 vol_flag);
    rcsp_set_vol_for_find_device(find_device_key_flag);

#if (RCSP_MODE == RCSP_MODE_WATCH)
    if (!(bt_get_curr_channel_state() & A2DP_CH)) {
        puts("start to connect a2dp ");
        bt_cmd_prepare(USER_CTRL_CONN_A2DP, 0, NULL);
    }
#endif

#endif
}
```

看代码，超时后也会进入一次`MSG_JL_FIND_DEVICE_RESUME`。

## 标志位导致的点击双耳查找耳机大概率只有一个耳机播放时提示音

```c
void earphone_mute_handler(u8 *other_opt, u32 msec)
{
    /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
    /* put_buf(other_opt, 3); */
    static u16 earphone_mute_timer = 0;
    static u8 tmp_param[3] = {0};
    int size_other_opt = sizeof(tmp_param);
    memcpy(tmp_param, other_opt, size_other_opt);

    //置1位操作只在rcsp_manage.c中MSG_JL_FIND_DEVICE_STOP find_device_timeout_handle实现
    //这里根据参数再判断一次，估计这个参数没有同步导致只有一只耳朵播放提示音
    //不加这个，就出现上面说的问题，标志位的同步有问题？
    if(tmp_param[1] == 1){
        find_device_key_flag = 1;
    } else if(tmp_param[1] == 0){
        find_device_key_flag = 0;
    }

#if TCFG_USER_TWS_ENABLE
    if ((tws_api_get_tws_state() & TWS_STA_SIBLING_CONNECTED) && (2 == tmp_param[2])) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        rcsp_find_device_reset();
        earphone_mute_timer_func(tmp_param);//全部停止寻找时没有必要再执行一次了
        extern void rcsp_set_vol_for_find_device(u8 vol_flag);
        rcsp_set_vol_for_find_device(find_device_key_flag);
    }
#endif
    if (earphone_mute_timer) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        sys_timeout_del(earphone_mute_timer);
        earphone_mute_timer = 0;
    }

    if (find_device_key_flag) {
        /* printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__); */
        earphone_mute_timer = sys_timeout_add(tmp_param, earphone_mute_timer_func, msec);
    }
}
```

- 根据文档来看，应该是主机把APP传递的参数传递给从机了。但是`find_device_key_flag`是在同步参数后，主机置1的。如果从机的执行流程不是先`MSG_JL_FIND_DEVICE_STOP`，再`MSG_JL_FIND_DEVICE_RESUME`。`find_device_key_flag`是没法置1的。在关键函数`earphone_mute_handler`中通不过判断：

```c
if (find_device_key_flag) {
        printf("rcsp_find %s, %s, %d\n", __FILE__, __FUNCTION__, __LINE__);
        earphone_mute_timer = sys_timeout_add(tmp_param, earphone_mute_timer_func, msec);
    }
```

导致空有参数但是进不去函数，无法利用参数去播放或停止。
