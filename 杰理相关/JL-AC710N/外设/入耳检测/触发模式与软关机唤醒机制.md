# 触发模式与软关机唤醒机制详解

## 你的理解

> "入耳检测的触发模式在关机时，检测到入耳会自动开机？定时模式在开机时使用，关机无法使用。"

**答案：✅ 基本正确！但需要区分"软关机"和"硬关机"。**

---

## 核心概念：软关机 vs 硬关机

### 1. 软关机（Soft PowerOff / PowerDown）

```c
// 代码中看到的软关机
sys_enter_soft_poweroff(POWEROFF_NORMAL_TWS);
power_set_soft_poweroff();
```

**状态：**
- CPU 停止运行
- 大部分外设断电
- **P33 模块保持供电**（从备用电源/VDDIO）
- 配置的唤醒源仍然工作

**功耗：极低（<100uA）**

**可以唤醒吗？✅ 可以！**

### 2. 硬关机（Hard PowerOff）

**状态：**
- 完全断电（拔掉电池）
- 所有模块停止工作
- 没有任何唤醒源

**功耗：0**

**可以唤醒吗？❌ 不能！**

---

## 触发模式的唤醒能力

### 唤醒原因枚举验证

```c
//  power_wakeup.h:4-39
enum WAKEUP_REASON {
    PWR_WK_REASON_PORT_EDGE,           // 数字IO边沿唤醒**复位**

    PWR_WK_REASON_FALLING_EDGE_0,      // p33 index0 io下降沿唤醒**复位**
    PWR_WK_REASON_FALLING_EDGE_1,      // p33 index1 io下降沿唤醒**复位**
    // ... 省略 index 2-11

    PWR_WK_REASON_RISING_EDGE_0,       // p33 index0 io上升沿唤醒**复位**
    PWR_WK_REASON_RISING_EDGE_1,       // p33 index1 io上升沿唤醒**复位**
    // ... 省略 index 2-11

    PWR_WK_REASON_LPCTMU,              // 触摸唤醒复位
    PWR_WK_REASON_LPNFC,               // NFC唤醒复位
    PWR_RTC_WK_REASON_ALM,             // RTC闹钟唤醒复位
    // ...
};
```

**关键词：唤醒"复位"**

- **复位**意味着系统从**软关机状态重新启动**
- 不是简单的从休眠恢复，而是重新执行启动流程

## 触发模式唤醒流程

### 完整唤醒时序

```
┌─────────────────────────────────────────────────────────┐
│  正常运行                                                │
│  - 蓝牙连接、音乐播放                                    │
│  - 用户长按关机按键                                      │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  进入软关机                                              │
│  sys_enter_soft_poweroff(POWEROFF_NORMAL_TWS)           │
│                                                          │
│  系统状态：                                              │
│  ✅ CPU 停止运行                                         │
│  ✅ 蓝牙关闭                                             │
│  ✅ 大部分外设断电                                       │
│  ✅ P33 IO唤醒模块保持供电 ← 关键！                      │
│  ✅ 配置的唤醒边沿仍然有效                               │
│                                                          │
│  功耗：~50-100uA                                         │
└─────────────────────────────────────────────────────────┘
                    ↓
              (用户戴上耳机)
                    ↓
┌─────────────────────────────────────────────────────────┐
│  IO电平变化：低 → 高（上升沿）                           │
│                                                          │
│  ┌────────────────────────────────────────────┐        │
│  │  P33 IO唤醒模块检测到上升沿                │        │
│  │  - 产生唤醒信号                            │        │
│  │  - 触发PMU唤醒CPU                          │        │
│  │  - 执行系统复位重启                        │        │
│  └────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  系统复位重启                                            │
│  1. PMU 复位 CPU                                         │
│  2. 从 ROM Bootloader 开始执行                           │
│  3. 加载固件到 RAM                                       │
│  4. 执行 main() 函数                                     │
│  5. 初始化各个模块                                       │
│  6. 检测唤醒原因                                         │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  检测唤醒原因                                            │
│  if (is_wakeup_source(PWR_WK_REASON_RISING_EDGE_0)) {   │
│      log_info("Wakeup by in-ear detection");            │
│  }                                                       │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  系统正常启动                                            │
│  - 蓝牙开启，重新连接                                    │
│  - 入耳检测初始化                                        │
│  - 应用层启动                                            │
│  - 检测到入耳状态 → 自动播放音乐                         │
└─────────────────────────────────────────────────────────┘
```

---

## 定时模式 vs 触发模式对比

### 软关机支持能力

| 特性 | 定时模式 (TIMER) | 触发模式 (EDGE) |
|------|------------------|-----------------|
| **依赖模块** | 软件定时器 | P33 硬件唤醒模块 |
| **需要CPU** | ✅ 是（定时器需要CPU运行） | ❌ 否（独立硬件） |
| **软关机唤醒** | ❌ 不支持 | ✅ 支持 |
| **原因** | CPU停止，定时器无法运行 | 硬件模块保持供电 |

### 为什么定时模式无法在软关机时工作？

```c
// 定时模式的检测流程
void __ear_detect_tch_run(void *priv)
{
    // ← 这个函数需要 CPU 执行！
    // ← 需要定时器中断触发！
    // ← 软关机时 CPU 停止，定时器停止
    // ← 无法检测IO状态

    gpio_set_mode(DET_IO, PORT_INPUT_PULLUP_10K);
    u8 state = gpio_read(DET_IO);  // 需要CPU读取
    // ...
}
```

**定时模式依赖：**
- ✅ 系统定时器（需要CPU和时钟）
- ✅ 定时器中断（需要CPU响应）
- ✅ 软件执行（需要CPU运行）

**软关机时：**
- ❌ CPU 停止 → 无法执行代码
- ❌ 定时器停止 → 无法触发中断
- ❌ **完全无法工作**

### 为什么触发模式可以在软关机时工作？

```
触发模式的硬件架构：

┌─────────────────────────────────────────────────────┐
│  主系统电源域 (VBAT)                                 │
│  - CPU (软关机时断电)                                │
│  - 蓝牙 (软关机时断电)                               │
│  - 大部分外设 (软关机时断电)                         │
└─────────────────────────────────────────────────────┘
                    ↓ 软关机时断电

┌─────────────────────────────────────────────────────┐
│  P33 低功耗域 (VDDIO/备用电源)                       │
│  - P33 IO唤醒模块 ✅ 软关机时保持供电                │
│  - RTC模块 ✅ 软关机时保持供电                       │
│  - 触摸检测模块 ✅ 软关机时保持供电                  │
│  - PMU电源管理 ✅ 软关机时保持供电                   │
└─────────────────────────────────────────────────────┘
              ↑ 软关机时仍然工作！

P33模块特点：
- 独立供电，不受主系统断电影响
- 持续监控配置的IO引脚
- 检测到边沿 → 唤醒主系统
```

---

## 实际应用场景

### 场景1：正常使用（系统运行中）

**触发模式：**

```
系统运行 → 用户取下耳机 → IO变化 → 触发中断 → 暂停音乐
                                          ↓
                               系统可进入Sniff休眠或者软关机
                                          ↓
          用户戴上耳机 → IO变化 → 唤醒系统 → 播放音乐
```

**定时模式：**
```
系统运行 → 定时器周期检测 → 检测到离耳 → 暂停音乐
                ↓
          系统无法深度休眠（定时器持续运行）
                ↓
          定时器周期检测 → 检测到入耳 → 播放音乐
```

### 场景2：软关机状态

**触发模式：✅ 支持唤醒开机**

```
软关机状态
    ↓
    ├─ CPU 停止
    ├─ 蓝牙关闭
    └─ P33模块监控IO ← 仍在工作
              ↓
    用户戴上耳机 → IO变化
              ↓
    P33检测到边沿 → 唤醒信号
              ↓
    系统复位重启
              ↓
    检测唤醒原因 → 入耳检测
              ↓
    蓝牙连接 → 自动播放音乐
```

**定时模式：❌ 无法唤醒**
```
软关机状态
    ↓
    ├─ CPU 停止 → 定时器停止
    ├─ 蓝牙关闭
    └─ 无法检测IO状态
              ↓
    用户戴上耳机 → 无响应！
              ↓
    ❌ 系统保持关机状态
              ↓
    必须手动按键开机
```

---

## 软关机唤醒配置

### 触摸按键的软关机唤醒示例

```c
// board_jl709n_demo_cfg.h:139-143
// 是否使能触摸按键可以软关机低功耗唤醒
#define TCFG_LP_TOUCH_KEY0_WAKEUP_EN    0   // 按键0不能唤醒
#define TCFG_LP_TOUCH_KEY1_WAKEUP_EN    1   // 按键1可以唤醒 ✅
#define TCFG_LP_TOUCH_KEY2_WAKEUP_EN    0   // 按键2不能唤醒
#define TCFG_LP_TOUCH_KEY3_WAKEUP_EN    0   // 按键3不能唤醒
#define TCFG_LP_TOUCH_KEY4_WAKEUP_EN    0   // 按键4不能唤醒
```

### 入耳检测的唤醒配置

```c
// power_config.c:41-46
#if (TCFG_EAR_DETECT_TYPE == EAR_DETECT_BY_TOUCH) && (!TCFG_EAR_DETECT_TOUCH_MODE)
struct _p33_io_wakeup_config port2 = {
    .pullup_down_mode = ENABLE,                  // 上拉使能
    .edge             = !TCFG_EAR_DETECT_DET_LEVEL,  // 初始边沿
    .filter           = PORT_FLT_16ms,           // 16ms滤波
    .gpio             = TCFG_EAR_DETECT_DET_IO,  // IO_PORTC_04
};

// 注册到唤醒源列表
static const struct wakeup_param wk_param = {
    .port[0] = &port2,  // ← 系统会自动配置为唤醒源
};
#endif
```

**效果：**
- 软关机后，`IO_PORTC_04` 的边沿变化可以唤醒系统
- 唤醒后系统复位重启
- 应用可以通过 `is_wakeup_source()` 检测是否由入耳检测唤醒

## 功耗对比

### 待机功耗（蓝牙已断开）

| 状态 | 定时模式 | 触发模式 | 节省 |
|------|---------|---------|------|
| **正常待机** | ~1.5mA | ~0.3mA | 80% |
| **Sniff休眠** | ~800uA | ~200uA | 75% |
| **软关机** | ❌ 无法唤醒 | ~50uA | - |

### 电池续航估算（100mAh电池）

| 模式 | 待机电流 | 理论续航 | 实际续航 |
|------|---------|---------|---------|
| **定时模式（无法软关机）** | 1.5mA | 67小时 | ~3天 |
| **触发模式（Sniff）** | 0.3mA | 333小时 | ~14天 |
| **触发模式（软关机）** | 0.05mA | 2000小时 | **~80天** |

---

## 总结

### 关键要点

1. ✅ **触发模式支持软关机唤醒**
   - P33模块独立供电
   - 硬件持续监控IO
   - 检测到边沿 → 唤醒并复位系统

2. ❌ **定时模式不支持软关机唤醒**
   - 依赖CPU和定时器
   - 软关机时CPU停止
   - 无法运行检测代码

3. ⚡ **功耗优势巨大**
   - 正常待机：节省 75-80%
   - 软关机待机：仅 50uA，续航可达 80天

4. 🔋 **实用价值**
   - 用户长时间不用（如出差）可软关机
   - 需要时戴上耳机自动开机
   - 无需手动按键操作
   - 用户体验极佳

### 应用建议

**推荐使用触发模式的场景：**
- ✅ 需要长待机时间的产品
- ✅ 希望支持入耳自动开机
- ✅ TWS耳机（对功耗敏感）
- ✅ 用户可能长时间不用（需要软关机）

**定时模式适用场景：**
- ✅ 不需要软关机唤醒
- ✅ 硬件不支持P33唤醒功能
- ✅ 传感器输出不稳定（触发模式可能误唤醒）
