# 手机设置耳机音量时

`D:\work_project\JL\DHF-AC710N-V300P03\SDK\apps\earphone\audio\vol_sync.c`

```c
//注册给库的回调函数，用户手机设置设备音量
void set_music_device_volume(int volume)
{
    r_printf("set_music_device_volume=%d\n", volume);
#if TCFG_BT_VOL_SYNC_ENABLE
    s16 music_volume;

    //音量同步最大是127，请计数比例
    if (volume > 127) {
        /*log_info("vol %d invalid\n",  volume);*/
#if TCFG_VOL_RESET_WHEN_NO_SUPPORT_VOL_SYNC
        /*不支持音量同步的设备，默认设置到最大值，可以根据实际需要进行修改。
         注意如果不是最大值，设备又没有按键可以调音量到最大，则输出也就达不到最大*/
        music_volume = app_audio_volume_max_query(AppVol_BT_MUSIC);
        log_i("unsupport vol_sync,reset vol:%d\n", music_volume);
        app_audio_set_volume(APP_AUDIO_STATE_MUSIC, music_volume, 1);
#endif
        return;
    }
    if (tone_player_runing() || ring_player_runing() || bt_get_esco_coder_busy_flag()) {
        log_i("It's not smart to sync a2dp vol now\n");
        //app_var.music_volume = vol_sys_tab[(volume + 1) / 8];
        app_var.music_volume = ((volume + 1) * 16) / 127;
        app_var.opid_play_vol_sync = vol_sync_tab[(volume + 1) / 8];
        return;
    }

#if 1
    /*
     *0~16,总共17级
     *这里将手机的0~127的音量值换成实际的dac音量等级
     */
    music_volume = ((volume + 1) * 16) / 127;
#else
    music_volume = vol_sys_tab[(volume + 1) / 8];
#endif
    y_printf("phone_vol:%d,dac_vol:%d", volume, music_volume);
    app_var.opid_play_vol_sync = vol_sync_tab[(volume + 1) / 8];

    app_audio_set_volume(APP_AUDIO_STATE_MUSIC, music_volume, 1);

    app_audio_set_volume_def_state(0);
    
#if TCFG_CHARGESTORE_ENABLE
    #if (THIRD_PARTY_PROTOCOLS_SEL & JL_SBOX_EN)
    	//前面手机已经成功设置耳机音量了
    	//这里再获取耳机音量同步给仓。
        sbox_cb_func.sbox_sync_volume_info();
    #endif
#endif

#endif
}
```

# 耳机按键设置音量

`apps\earphone\mode\bt\earphone.c`

`bt_app_msg_handler`

```c
case APP_MSG_VOL_UP:
        log_info("APP_MSG_VOL_UP\n");
#if (TCFG_LE_AUDIO_APP_CONFIG & LE_AUDIO_AURACAST_SINK_EN)
        app_audio_volume_up(1);
#else
        bt_volume_up(1);
#endif
        bt_tws_sync_volume();
#if ((TCFG_LE_AUDIO_APP_CONFIG & (LE_AUDIO_UNICAST_SINK_EN | LE_AUDIO_JL_UNICAST_SINK_EN)))
        data[0] = CIG_EVENT_OPID_VOLUME_UP;
        le_audio_media_control_cmd(data, 1);
#endif
        return 0;
    case APP_MSG_VOL_DOWN:
        log_info("APP_MSG_VOL_DOWN\n");
#if (TCFG_LE_AUDIO_APP_CONFIG & LE_AUDIO_AURACAST_SINK_EN)
        app_audio_volume_down(1);
#else
		//设置耳机的音量并同步到手机
        bt_volume_down(1);
#endif
		//同步音量给对耳
        bt_tws_sync_volume();
#if ((TCFG_LE_AUDIO_APP_CONFIG & (LE_AUDIO_UNICAST_SINK_EN | LE_AUDIO_JL_UNICAST_SINK_EN)))
        data[0] = CIG_EVENT_OPID_VOLUME_DOWN;
        le_audio_media_control_cmd(data, 1);
#endif
        return 0;
```

- 怎么这里没有同步给仓？

# 仓设置耳机的音量