# 开低功耗

- 功耗不行
  - 先看有没有开低功耗
  - 再看在EQ有没有关
  - 看官方文档

开低功耗可以1mA以下。不开一般5mA以内。

```c
//*********************************************************************************//
//                                  低功耗配置                                     //
//*********************************************************************************//
#define TCFG_LOWPOWER_POWER_SEL				PWR_DCDC15//PWR_LDO15                    //电源模式设置，可选DCDC和LDO
#define TCFG_LOWPOWER_BTOSC_DISABLE			0                            //低功耗模式下BTOSC是否保持
#define TCFG_LOWPOWER_LOWPOWER_SEL			1//0   //芯片是否进入powerdown
/*强VDDIO等级配置,可选：
    VDDIOM_VOL_20V    VDDIOM_VOL_22V    VDDIOM_VOL_24V    VDDIOM_VOL_26V
    VDDIOM_VOL_30V    VDDIOM_VOL_30V    VDDIOM_VOL_32V    VDDIOM_VOL_36V*/
#define TCFG_LOWPOWER_VDDIOM_LEVEL			VDDIOM_VOL_28V
/*弱VDDIO等级配置，可选：
    VDDIOW_VOL_21V    VDDIOW_VOL_24V    VDDIOW_VOL_28V    VDDIOW_VOL_32V*/
#define TCFG_LOWPOWER_VDDIOW_LEVEL			VDDIOW_VOL_26V               //弱VDDIO等级配置
#define TCFG_LOWPOWER_OSC_TYPE              OSC_TYPE_LRC
#define TCFG_LOWPOWER_LIGHT_SLEEP_ATTRIBUTE 	LOWPOWER_LIGHT_SLEEP_ATTRIBUTE_KEEP_CLOCK 		//低功耗LIGHT模式属性, 可以选择是否保持住一些电源和时钟

```

看是否带ANC，可能会影响ANC效果以及灯效。

`apps\earphone\board\br36\board_ac700n_demo_cfg.h`

```c
/**************
 *ANC配置
 *************/
#define TCFG_AUDIO_ANC_ENABLE				CONFIG_ANC_ENABLE		//ANC总使能,根据global_bulid_cfg板级定义
#define TCFG_ANC_TOOL_DEBUG_ONLINE 			1//DISABLE_THIS_MOUDLE		//ANC工具蓝牙spp调试
#define TCFG_ANC_EXPORT_RAM_EN				DISABLE_THIS_MOUDLE		//ANCdebug数据释放RAM使能
#if TCFG_ANC_EXPORT_RAM_EN
#define TCFG_AUDIO_CVP_CODE_AT_RAM			DISABLE_THIS_MOUDLE
#define TCFG_AUDIO_AAC_CODE_AT_RAM			DISABLE_THIS_MOUDLE
#endif/*TCFG_ANC_EXPORT_RAM_EN*/
```

**要保护的IO口**

`apps\earphone\board\br36\board_ac700n_demo.c`

```c
#if TCFG_AUDIO_ANC_ENABLE
	if(anc_status_get() && (!is_softoff)){
		//ANC 低功耗状态下需要保持的IO口
		port_protect(port_group, TCFG_AUDIO_MIC_PWR_PORT); 
	}
#endif/*TCFG_AUDIO_ANC_ENABLE*/
	gpio_set_pull_up(IO_PORT_DP, 0);
    gpio_set_pull_down(IO_PORT_DP, 0);
    gpio_set_die(IO_PORT_DP, 0);
    gpio_set_dieh(IO_PORT_DP, 0);
    gpio_set_direction(IO_PORT_DP, 1);
    //冲突了？保护PC2但是DM脚与它共用？
    //DM的状态有消耗？还是不行。。。
    // gpio_set_pull_up(IO_PORT_DM, 0);
    // gpio_set_pull_down(IO_PORT_DM, 0);
    // gpio_set_die(IO_PORT_DM, 0);
    // gpio_set_dieh(IO_PORT_DM, 0);
    // gpio_set_direction(IO_PORT_DM, 1);
```



## 连接状态进入低功耗后，功耗会跳变

- **公版也会跳动。**

# ANC

## 记忆模式

`cpu\br36\audio\audio_anc.h`

```c
#define ANC_INFO_SAVE_ENABLE	1//0	/*ANC信息记忆:保存上一次关机时所处的降噪模式等等*/
```

## 每次都保存ANC模式

`cpu\br36\audio\audio_anc.c`

```c
/*ANC信息保存*/
void anc_info_save()
{
    if (anc_hdl) {
        anc_info_t anc_info;
        int ret = syscfg_read(CFG_ANC_INFO, &anc_info, sizeof(anc_info));
        if (ret == sizeof(anc_info)) {
#if INEAR_ANC_UI
            if (anc_info.mode == anc_hdl->param.mode && anc_info.inear_tws_mode == inear_tws_ancmode) {
#else
            if (anc_info.mode == anc_hdl->param.mode) {
#endif/*INEAR_ANC_UI*/
                user_anc_log("anc info.mode == cur_anc_mode");
                return;
            }
        } else {
            user_anc_log("read anc_info err");
        }

        user_anc_log("save anc_info");
        //anc_info.mode = anc_hdl->param.mode;//anc_hdl->param.mode = ANC_OFF;
        anc_info.mode = ANC_ON; //打开记忆功能，每次都保存ANC，保证每次开机都是ANC_ON状态
#if INEAR_ANC_UI
        anc_info.inear_tws_mode = inear_tws_ancmode;
#endif/*INEAR_ANC_UI*/
        ret = syscfg_write(CFG_ANC_INFO, &anc_info, sizeof(anc_info));
        if (ret != sizeof(anc_info)) {
            user_anc_log("anc info save err!\n");
        }

    }
}
```

# 音乐整体音量

- 播放整体音量降1db
- 直接在 音乐eq 上去减

![image-20250709164603161](./开发问题.assets/image-20250709164603161.png)

![image-20250709164627274](./开发问题.assets/image-20250709164627274.png)

![image-20250709164718048](./开发问题.assets/image-20250709164718048.png)

- 根据是否开ANC，选择EQ文件进行修改

![image-20250709164802179](./开发问题.assets/image-20250709164802179.png)

![image-20250709164847505](./开发问题.assets/image-20250709164847505.png)

![image-20250709164945597](./开发问题.assets/image-20250709164945597.png)

![image-20250709165045040](./开发问题.assets/image-20250709165045040.png)

**编译后，最终eq会被替换。最明显的标志就是两者的修改时间是一样的。但是这一次校验码没变，不知道为什么。**
