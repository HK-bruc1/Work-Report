# 耳机入仓充电控制优化分析报告

## 一、优化目标

实现**入仓不关机，合盖才关机**的智能电源管理策略，提升用户体验。

## 二、核心改进对比

| 对比项 | 修改前 | 修改后 |
|-------|--------|--------|
| **入仓行为** | 立即关机 ❌ | 继续运行 ✅ |
| **合盖行为** | 立即关机 | 立即关机 |
| **用户体验** | 入仓即中断连接 | 只有合盖才中断 |
| **实现方式** | 充电仓直接输出5V | 充电仓电压分级控制 + 软件标志位 |
| **代码改动** | - | 仅6行关键代码 |

## 三、技术原理

### 3.1 修改前的工作流程

```
用户操作: 耳机放入充电仓（无论是否合盖）
    ↓
充电仓输出: 5V (LDOIN > VBAT)
    ↓
系统检测: LDOIN电压高于电池电压
    ↓
触发事件: CHARGE_EVENT_LDO5V_IN
    ↓
调用函数: charge_ldo5v_in_deal()
    ↓
系统响应: sys_enter_soft_poweroff() 关机 ❌
    ↓
结果: 进入充电状态（IDLE应用）
```

**问题根源**：充电仓硬件在耳机入仓时直接输出5V，无论盖子是否合上，都会触发关机。

---

### 3.2 修改后的工作流程

#### 场景1：入仓开盖

```
用户操作: 耳机放入充电仓（盖子未合）
    ↓
充电仓输出: 合适电压 (0.6V < LDOIN < VBAT，不是5V)
    ↓
系统检测: 维持电压区间
    ↓
触发事件: CHARGE_EVENT_LDO5V_KEEP
    ↓
调用函数: ldo5v_keep_deal()
    ↓
检查标志: user_flag == 1? (拔出时已设置为1)
    ├─ Yes → 清零user_flag，直接return ✅
    │        (不会创建延迟定时器)
    │
    └─ No → 创建250ms延迟定时器
            → ldo5v_keep_delay_deal()
            → 关机
    ↓
结果: 耳机继续运行，保持蓝牙连接 🎵
```

#### 场景2：合盖

```
用户操作: 合上充电仓盖子
    ↓
充电仓升压: 输出5V (LDOIN > VBAT)
    ↓
系统检测: LDOIN电压高于电池电压
    ↓
触发事件: CHARGE_EVENT_LDO5V_IN
    ↓
调用函数: charge_ldo5v_in_deal()
    ↓
系统响应: sys_enter_soft_poweroff() 关机 🔴
    ↓
结果: 断开蓝牙，进入充电状态
```

---

## 四、关键代码实现

### 4.1 拔出事件 - 设置标志位

**文件**: `apps/earphone/power_manage/app_charge.c:454`

```c
void charge_ldo5v_off_deal(void)
{
    log_info("%s\n", __FUNCTION__);

    // ... 其他处理 ...

    // 关键：拔出时设置标志位
    extern bool user_flag;
    user_flag = 1;  // 第470行

    charge_close();
}
```

**触发条件**：LDOIN < 0.6V（耳机从充电仓拔出或从耳中取出）

**作用**：标记耳机已经处于"使用中"状态

---

### 4.2 入仓事件 - 检查标志位（核心逻辑）

**文件**: `apps/earphone/power_manage/app_charge.c:165`

```c
void ldo5v_keep_deal(void)
{
    log_info("%s\n", __func__);

    // 预处理：停止充电、禁用传感器等
    power_event_to_user(POWER_EVENT_POWER_CHANGE);
    charge_close();
    gSensor_wkupup_disable();
    charge_check_and_set_pinr(0);

    // ✅ 核心：检查标志位，决定是否关机
    extern bool user_flag;
    if (user_flag) {
        user_flag = 0;  // 清零标志
        return;         // 直接返回，不关机！(第195-198行)
    }

    // 如果 user_flag == 0，创建250ms延迟定时器
    // （正常首次入仓时，user_flag一定是1，不会执行到这里）
    ldo5v_keep_timer = sys_timeout_add(NULL, ldo5v_keep_delay_deal, 250);
}
```

**触发条件**：0.6V < LDOIN < VBAT（维持电压区间）

**关键点**：
- 如果 `user_flag == 1`：直接返回，**不创建延迟定时器**，不关机
- 如果 `user_flag == 0`：创建延迟定时器，250ms后关机（异常场景）

---

### 4.3 合盖/5V输入事件 - 直接关机

**文件**: `apps/earphone/power_manage/app_charge.c:674`

```c
case CHARGE_EVENT_LDO5V_IN:  // LDOIN > VBAT (5V输入)
    // ... USB OTG处理 ...

    if (get_charge_poweron_en() || (otg_status != SLAVE_MODE)) {
        charge_ldo5v_in_deal();  // 先关机后进入充电模式
    }
    break;
```

**文件**: `apps/earphone/power_manage/app_charge.c:297`

```c
void charge_ldo5v_in_deal(void)
{
    log_info("%s\n", __FUNCTION__);

    // 预处理：同步TWS、禁用传感器等
    power_event_to_user(POWER_EVENT_POWER_CHANGE);
    gSensor_wkupup_disable();
    charge_check_and_set_pinr(0);
    anc_suspend();

    // ... 其他处理 ...

    // 关键：直接关机
    if (app && strcmp(app->name, APP_NAME_IDLE)) {
        sys_enter_soft_poweroff((void *)1);  // 第368/388/391行
    }
}
```

**触发条件**：LDOIN > VBAT（充电仓输出5V）

**作用**：直接关机进入充电状态

---

## 五、硬件配合 - 充电仓电压控制策略

### 5.1 电压分级控制表

| 状态 | 充电仓输出电压 | 系统检测 | 触发事件 | 处理函数 | 是否关机 |
|------|---------------|---------|---------|---------|---------|
| **盖子打开<br>耳机入仓** | 合适电压<br>(0.6V < LDOIN < VBAT) | 维持电压区间 | `CHARGE_EVENT_LDO5V_KEEP` | `ldo5v_keep_deal()` | **否** ✅<br>(user_flag保护) |
| **盖子合上** | **5V**<br>(LDOIN > VBAT) | 高电压输入 | `CHARGE_EVENT_LDO5V_IN` | `charge_ldo5v_in_deal()` | **是** 🔴<br>(直接关机) |

### 5.2 LDOIN电压检测逻辑

**文件**: `cpu/br36/charge.c` (约第499-552行)

```c
void ldo5v_detect(void)
{
    if (LVCMP_DET_GET()) {
        // LDOIN > VBAT - 充电仓输出5V（合盖）
        ldo5v_on_cnt++;
        if (ldo5v_on_cnt >= filter) {
            charge_flag = BIT_LDO5V_IN;
            charge_event_to_user(CHARGE_EVENT_LDO5V_IN);
            // → charge_ldo5v_in_deal()
            // → sys_enter_soft_poweroff() 关机 🔴
        }
    }
    else if (LDO5V_DET_GET() == 0) {
        // LDOIN < 0.6V - 拔出事件
        ldo5v_off_cnt++;
        if (ldo5v_off_cnt >= filter) {
            charge_flag = BIT_LDO5V_OFF;
            charge_event_to_user(CHARGE_EVENT_LDO5V_OFF);
            // → charge_ldo5v_off_deal()
            // → user_flag = 1 ✅
        }
    }
    else {
        // 0.6V < LDOIN < VBAT - 维持电压（入仓开盖）
        ldo5v_keep_cnt++;
        if (ldo5v_keep_cnt >= filter) {
            charge_flag = BIT_LDO5V_KEEP;
            charge_event_to_user(CHARGE_EVENT_LDO5V_KEEP);
            // → ldo5v_keep_deal()
            // → user_flag检查 ✅
        }
    }
}
```

**滤波器**：每2ms检测一次，计数器满后才触发事件，避免电压波动误触发。

---

## 六、状态机转换

```
                    ┌─────────────────┐
                    │   正常运行       │
                    │  user_flag = 1  │
                    └────────┬─────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              │ 入仓开盖                    │ 合盖
              ↓                             ↓
    ┌──────────────────────┐     ┌──────────────────────┐
    │  充电仓输出合适电压   │     │   充电仓输出5V       │
    │ (0.6V<LDOIN<VBAT)   │     │  (LDOIN > VBAT)     │
    └──────────┬───────────┘     └──────────┬───────────┘
               │                             │
               ↓                             ↓
    ┌──────────────────────┐     ┌──────────────────────┐
    │ CHARGE_EVENT_        │     │ CHARGE_EVENT_        │
    │ LDO5V_KEEP           │     │ LDO5V_IN             │
    └──────────┬───────────┘     └──────────┬───────────┘
               │                             │
               ↓                             ↓
    ┌──────────────────────┐     ┌──────────────────────┐
    │ ldo5v_keep_deal()    │     │ charge_ldo5v_in_     │
    │                      │     │ deal()               │
    └──────────┬───────────┘     └──────────┬───────────┘
               │                             │
               ↓                             ↓
    ┌──────────────────────┐     ┌──────────────────────┐
    │ user_flag == 1?      │     │ sys_enter_soft_      │
    │  ├─ Yes → 清零返回   │     │ poweroff()           │
    │  └─ No → 创建定时器  │     │                      │
    └──────────┬───────────┘     └──────────┬───────────┘
               │                             │
               ↓                             ↓
    ┌──────────────────────┐     ┌──────────────────────┐
    │   继续运行 🎵        │     │   关机充电 🔴        │
    │ (保持蓝牙连接)       │     │ (进入IDLE应用)       │
    └──────────────────────┘     └──────────────────────┘
```

---

## 七、测试验证

### 测试场景1：入仓不合盖

```
前提条件：
- 耳机正在播放音乐
- user_flag = 1（已拔出状态）

操作步骤：
1. 将耳机放入充电仓
2. 保持盖子打开
3. 观察耳机状态

预期结果：
✅ 充电仓输出合适电压 (0.6V < LDOIN < VBAT)
✅ 触发 ldo5v_keep_deal()
✅ user_flag == 1，清零并返回
✅ 音乐继续播放
✅ 蓝牙连接保持
✅ 耳机不关机

实际结果：符合预期 ✅
```

### 测试场景2：入仓后合盖

```
前提条件：
- 耳机正在播放音乐
- 耳机已放入充电仓，盖子未合

操作步骤：
1. 确认音乐仍在播放（场景1）
2. 合上充电仓盖子
3. 观察耳机状态

预期结果：
✅ 充电仓升压到5V (LDOIN > VBAT)
✅ 触发 CHARGE_EVENT_LDO5V_IN
✅ 调用 charge_ldo5v_in_deal()
✅ 执行 sys_enter_soft_poweroff()
✅ 音乐停止播放
✅ 蓝牙断开连接
✅ 耳机关机进入充电状态

实际结果：符合预期 ✅
```

### 测试场景3：直接合盖入仓

```
前提条件：
- 充电仓盖子合上

操作步骤：
1. 将耳机直接放入已合盖的充电仓
2. 观察耳机状态

预期结果：
✅ 充电仓输出5V (LDOIN > VBAT)
✅ 触发 CHARGE_EVENT_LDO5V_IN
✅ 直接关机进入充电状态

实际结果：符合预期 ✅
```

---

## 八、技术总结

### 8.1 方案优势

1. **代码改动最小**：仅增加6行核心代码（第195-198行、第470行）
2. **逻辑清晰简单**：单个标志位 + 电压分级控制
3. **用户体验优化**：避免入仓误触发关机，只在明确合盖时才关机
4. **硬件软件配合**：充电仓电压分级输出 + 软件标志位保护

### 8.2 核心机制

#### 软件标志位：`user_flag`

| 事件 | user_flag值 | 作用 |
|-----|------------|------|
| 拔出事件 | `user_flag = 1` | 标记耳机进入"使用中"状态 |
| 入仓开盖 | 检查 `user_flag == 1` → 清零并返回 | 保护：不关机 |
| 入仓开盖 | 检查 `user_flag == 0` → 创建定时器 | 异常场景：准备关机 |

#### 硬件电压控制：充电仓分级输出

| 盖子状态 | 电压输出 | 触发逻辑 | 是否关机 |
|---------|---------|---------|---------|
| **开盖** | 0.6V < LDOIN < VBAT | 维持电压检测 → user_flag保护 | **否** |
| **合盖** | LDOIN > VBAT (5V) | 高电压检测 → 直接关机 | **是** |

### 8.3 关键点总结

1. **修改前**：充电仓始终输出5V → 入仓即关机
2. **修改后**：充电仓电压分级
   - 开盖：输出合适电压 → 触发 `ldo5v_keep_deal()` → user_flag保护 → 不关机
   - 合盖：升压到5V → 触发 `charge_ldo5v_in_deal()` → 直接关机
3. **user_flag作用**：记录"拔出-插入"状态，防止入仓时误关机
4. **不需要LDOIN通信协议**：完全通过电压变化实现开盖/合盖检测

### 8.4 关键文件清单

| 文件路径 | 主要功能 | 关键代码行 |
|---------|---------|-----------|
| `apps/earphone/power_manage/app_charge.c` | 充电控制逻辑 | 195-198: user_flag检查<br>470: user_flag设置<br>297: 5V输入处理 |
| `cpu/br36/charge.c` | LDOIN电压检测 | 499-552: 三段式电压检测 |

---

## 九、总结

本次优化通过**软件标志位**和**充电仓硬件电压分级控制**相结合，成功实现了"入仓不关机，合盖才关机"的智能电源管理策略。

### 核心思路

1. **拔出时**：设置 `user_flag = 1`，标记耳机进入使用状态
2. **入仓开盖**：充电仓输出合适电压 → 触发维持电压检测 → user_flag保护 → **不关机**
3. **合盖**：充电仓升到5V → 触发高电压检测 → **直接关机**

### 方案特点

- ✅ 实现简洁：仅6行关键代码
- ✅ 逻辑清晰：状态机明确，易于理解
- ✅ 易于维护：代码改动最小，不影响其他功能
- ✅ 用户体验优化：避免误触发关机，提升使用便利性

该方案完美解决了原有问题，实现了预期目标。
