# 入耳检测放在开关机功能中

## 使用检测口作为唤醒口

关机后入耳检测的供电口与检测口需要保护。

`apps\earphone\board\br36\board_ac700n_demo.c`

```c
#if TCFG_CHARGE_ENABLE
struct port_wakeup charge_port = {
    .edge               = RISING_EDGE,                       //唤醒方式选择,可选：上升沿\下降沿\双边沿
    .both_edge          = 0,
    .filter             = PORT_FLT_16ms,
    .iomap              = IO_CHGFL_DET,                      //唤醒口选择
};

struct port_wakeup vbat_port = {
    .edge               = BOTH_EDGE,                      //唤醒方式选择,可选：上升沿\下降沿\双边沿
    .both_edge          = 1,
    .filter             = PORT_FLT_16ms,
    .iomap              = IO_VBTCH_DET,                      //唤醒口选择
};

struct port_wakeup ldoin_port = {
    .edge               = BOTH_EDGE,                      //唤醒方式选择,可选：上升沿\下降沿\双边沿
    .both_edge          = 1,
    .filter             = PORT_FLT_16ms,
    .iomap              = IO_LDOIN_DET,                      //唤醒口选择
};
#endif

#if TCFG_EAR_DETECT_ENABLE
    struct port_wakeup port3 = {
        .pullup_down_enable = ENABLE,                            //配置I/O 内部上下拉是否使能
        .edge               = FALLING_EDGE,                      //唤醒方式选择,可选：上升沿\下降沿
        .both_edge          = 0,
        .filter             = PORT_FLT_8ms,
        .iomap 				= TCFG_EAR_DETECT_DET_IO,
    };
#endif

const struct wakeup_param wk_param = {
#if (!(TCFG_LP_TOUCH_KEY_ENABLE && TCFG_LP_TOUCH_KEY1_EN))
	.port[1] = &port0,
#endif
#if (TCFG_TEST_BOX_ENABLE || TCFG_CHARGESTORE_ENABLE || TCFG_ANC_BOX_ENABLE || TCFG_CHARGE_CALIBRATION_ENABLE)
	.port[2] = &port1,
#endif

#if TCFG_CHARGE_ENABLE
    .aport[0] = &charge_port,
    .aport[1] = &vbat_port,
    .aport[2] = &ldoin_port,
#endif

#if TCFG_EAR_DETECT_ENABLE
    #if (TCFG_EAR_DETECT_TYPE == EAR_DETECT_BY_TOUCH) && (!TCFG_EAR_DETECT_TOUCH_MODE)
        .port[3] = &port3,
    #endif
#endif

};

//关机的IO口保护
static void close_gpio(u8 is_softoff)
#if TCFG_AUDIO_ANC_ENABLE
	if(anc_status_get() && (!is_softoff)){
		//ANC 低功耗状态下需要保持的IO口
		port_protect(port_group, TCFG_AUDIO_MIC_PWR_PORT);
	}
#endif/*TCFG_AUDIO_ANC_ENABLE*/

#if TCFG_EAR_DETECT_ENABLE
    if (TCFG_EAR_DETECT_TYPE == EAR_DETECT_BY_TOUCH) {
        port_protect(port_group, TCFG_EAR_POWER_IO);
        port_protect(port_group, TCFG_EAR_DETECT_DET_IO);
    }
#endif
```

开机流程中添加对入耳检测口的判断从而完成开机，上面只是配置
