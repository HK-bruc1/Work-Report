# FN3的介绍

这是一个基于杰理(JL)芯片BR36系列的蓝牙耳机SDK项目,主要特点如下:

1. 项目架构:

   - 基于V138公版软件的定制版本

   - 使用Clang编译器进行开发

   - 主要针对AC700N/AC7003F/AC7006F等型号芯片

2. 主要功能:

   - 蓝牙音频(支持TWS双耳)

   - ANC主动降噪

   - USB音频

   - SD卡播放

   - 触摸按键

   - OTA升级

   - 电池管理和充电

3. 开发工具支持:

   - 提供配置工具(生成cfg_tool.bin)

   - 调音工具(生成eq_cfg_hw.bin)

   - ANC Designer工具(用于ANC调试)

   - SDK工具(用于编辑固件)

4. 系统特点:

   - 多任务系统架构

   - 支持单/双备份升级

   - 支持多种开发板配置(DEMO板、耳机板等)

   - 包含完整的驱动层和应用层代码

这是一个完整的蓝牙音频解决方案,适合开发各类蓝牙耳机产品。

## 快速入门

**这个SDK有UI框架吗？如果我想快速熟悉这个SDK的话，你建议我从哪里开始？**

这个SDK有UI框架。从代码来看,它支持多种UI显示方式。让我为你详细分析:

1. UI框架支持的显示类型 (`enum ui_devices_type`):

   - LED_7 (LED数码管显示)

   - LCD_SEG3X9 (LCD段码屏)

   - TFT_LCD (彩屏)

   - DOT_LCD (点阵屏)

2. UI样式类型 (` app_config.h`):

   - STYLE_JL_WTACH (1) - 彩屏demo

   - STYLE_JL_SOUNDBOX (2) - 点阵屏demo

   - STYLE_JL_CHARGE (3) - 点阵屏充电仓

   - STYLE_JL_LED7 (4) - LED数码管

   - STYLE_UI_SIMPLE (5) - 简单UI(无框架)

### 建议学习路线

1. 首先从

   ` apps/earphone/include/ui/ui_api.h`开始,这是UI的主要API接口文件,包含了:

   - UI初始化接口

   - 显示控制接口

   - 按键消息处理等基础功能

2. 然后根据你的具体显示需求选择对应的demo学习:

   - 如果使用彩屏,可以参考 `STYLE_JL_WTACH` 相关代码

   - 如果使用点阵屏,可以参考 `STYLE_JL_SOUNDBOX` 相关代码

   - 如果是简单显示,可以参考 `STYLE_UI_SIMPLE` 相关代码

3. 重点关注以下文件:

   - ` apps/earphone/ui/lcd_simple/my_demo.c`\- UI示例代码

   - ` include_lib/system/ui/ui/ui.h`\- UI核心功能定义

   - ` apps/common/ui/lcd_simple/ui.c`\- UI基础实现

4. UI框架主要特性:

   - 支持多种显示设备

   - 提供统一的API接口

   - 支持按键和触摸输入

   - 具有菜单系统

   - 支持多语言显示

## 板级配置文件介绍

**他的板级配置文件在哪里？都有以什么什么配置？怎么选择板级配置文件？**

从提供的代码来看，板级配置文件主要在 `apps\earphone\board\br36\`目录下。让我为你详细分析：

1. **主板级配置选择文件**：` apps\earphone\board\br36\board_config.h`中通过宏定义选择具体的板级配置：

```c
#define CONFIG_BOARD_AC700N_DEMO
// #define CONFIG_BOARD_AC7006F_EARPHONE
// #define CONFIG_BOARD_AC700N_SD_PC_DEMO
//#define CONFIG_BOARD_AC7003F_DEMO
// #define CONFIG_BOARD_AC700N_ANC
//#define CONFIG_BOARD_AC700N_DMS
// #define CONFIG_BOARD_AC700N_TEST
// #define CONFIG_BOARD_AC700N_HEARING_AID
//#define CONFIG_BOARD_AC700N_IIS_LINEIN
```

2. **具体的板级配置文件**：

每个板子都有两个主要配置文件：

- `xxx_global_build_cfg.h`: 用于生成 isd_config.ini 的配置
- `xxx_cfg.h`: 板级具体功能配置

3. **现有的板级配置包括**：

​	**a) AC700N_DEMO:**

- 基础演示板配置
- 支持内置触摸和ANC功能

​	**b) AC7006F_EARPHONE:**

- 耳机板配置
- 基础蓝牙功能

​	**c) AC700N_SD_PC_DEMO:**

- SD卡和PC功能演示板
- 支持SPP、HFP、A2DP等蓝牙配置文件

​	**d) AC700N_ANC:**

- 主打ANC降噪功能的板级配置

​	**e) AC700N_TEST:**

- 测试板配置
- 支持ANC+ENC双mic+DNS+AEC+BLE+TWS等功能

​	**f) AC700N_HEARING_AID:**

- 助听器模式板级配置

​	**g) AC700N_IIS_LINEIN:**

- linein ANC板级配置

4. 主要配置项包括：

```c
// 升级相关
CONFIG_DOUBLE_BANK_ENABLE    // 双备份选择
CONFIG_APP_OTA_ENABLE        // RCSP升级支持
CONFIG_UPDATE_JUMP_TO_MASK   // 升级方式配置

// 功能相关
CONFIG_LP_TOUCH_KEY_EN       // 内置触摸
CONFIG_ANC_ENABLE           // ANC降噪
CONFIG_FLASH_SIZE           // FLASH大小配置

// 蓝牙配置文件
USER_SUPPORT_PROFILE_SPP    // SPP支持
USER_SUPPORT_PROFILE_HFP    // HFP支持
USER_SUPPORT_PROFILE_A2DP   // A2DP支持
```

### 如何选择板级配置

1. 在`board_config.h`中只打开一个板级配置的宏定义
2. 根据实际硬件选择对应的板级配置
3. 如果需要自定义板级配置：
   - 复制一份现有的配置文件
   - 修改为新的板级名称
   - 在`board_config.h`中添加新的配置选项
   - 根据需求修改具体配置项

例如，如果你要使用AC700N_DEMO配置：

```c
#define CONFIG_BOARD_AC700N_DEMO    // 只保留这一个，注释掉其他的
```

建议：

1. 先根据你的硬件选择最接近的板级配置
2. 仔细阅读对应的 `xxx_cfg.h` 和 `xxx_global_build_cfg.h` 文件
3. 根据实际需求修改相关配置项
4. 如果现有配置都不满足，可以创建新的板级配置文件

## 配置工具使用

1. 打开 sdk 工程目录， 进入 cbp_out\cpu\br36\tools\AC700N_config_tool 目录：

![image-20250422180346776](./FN3.assets/image-20250422180346776.png)

2. 双击【AC700N-配置工具入口.jlxproj】， 打开【杰理 SDK 工具】  

![image-20250422180440313](./FN3.assets/image-20250422180440313.png)

### 编辑 FW 文件

点击【编辑 FW 文件】， 可对一个 FW 文件的进行编辑， 修改 FW 文件的板级配置、 蓝牙配置， 状态配置和提示音配置， 界面如下： 

![image-20250422180746361](./FN3.assets/image-20250422180746361.png)

点击【恢复默认值】 可以恢复 sdk 发布时的原始配置， 配置完成后， 点击【保存】， 可选择保存路径保存修改过后的 fw 和 ufw 文件；  

![image-20250422180805984](./FN3.assets/image-20250422180805984.png)

编辑 fw 文件有以下几点需要注意：

（1） **板级配置的可配选项取决 cfg_tool.bin 文件**， 也就是说**编译前配置选了什么， 编辑 fw 文件就有什么配置**， 比如说编译前配置是选了 3 个 key， 则编辑 fw 文件的时候也是只有 3 个 key 的选项。

![image-20250422181512563](./FN3.assets/image-20250422181512563.png)

- **还是依赖于代码配置？**

（2） fw 版本号控制， 只有工具和 fw 的版本号对得上， 才能编辑对应的 fw 文件， 版本号在AC697N_config_tool\conf\entry 目录下的 user_cfg.lua 文件下修改， 如下图： 

![image-20250422181031921](./FN3.assets/image-20250422181031921-1745316632781-1.png)

如果版本号提示不对， 请确认版本号。

（3） fw 文件制作： 当 fw 文件测试没有问题后， 想发布一个可编辑的 fw 文件时， 把生成的 fw 文件替换 AC697N_config_tool\conf\output\default 目录下 default_cfg.fw 文件即可

（4） 默认值的制作： 用编译前选项配置好后， 点击保存后会在 AC697N_config_tool\conf\output 生成一个 default_cfg.lua 文件， 把该文件覆盖 AC697N_config_tool\conf\output\default 目录下的default_cfg.lua 文件， 到时在编辑 fw 文件的时候点击恢复默认设置， 就会恢复之前设置的值。 

### 显示原理图

点击【显示原理图】， 可以打开一个 doc 的文件夹， 可以在该文件夹下存放原理图等相关文件；  

### 编译前配置

点击【编译前配置】， 可以在 sdk 代码编译前进行相关配置项配置， 打开界面如下：  

![image-20250422181534970](./FN3.assets/image-20250422181534970.png)

可以在**编译前配置**工具中**进行通用配置、 蓝牙配置、 提示音配置和状态配置**， 点击【恢复默认值】可以恢复 sdk 发布时的原始配置， 配置完成后， 点击【保存】 保存配置， 将会输出 cfg_tools.bin 到下载目录中， 重新编译 sdk 代码可应用该最新配置；  

### 打开下载目录

点击【打开下载目录】， 将会打开 tools 下载目录， cfg_tools.bin 将会输出到该目录下；  

### 检查依赖的软件包是否更新

点击【检查依赖的软件包是否更新】， 将会查检查相关配置工具的版本更新情况， 如有更新， 则下载相应更新即可；  

## 提示音配置

提示音设置在工具的“提示音配置” 选项里面， 点击后如下图所示：

![image-20250422181806190](./FN3.assets/image-20250422181806190.png)

默认是加载 conf\output\extra_tones 下的提示音， 如果有一个新的 tone.cfg 文件， 点击加载按钮可以把该提示音文件加载进来。 如果想更换提示音， 直接把对应的提示音文件拉到对应选项即可。 提示音工具提供 3 种音质提示音格式， 每个提示音均可以单独指定成不同格式， 主要是看 flash 的空间。比如“蓝牙模式” 提示音想音质好点， 可以先选 sbc， 然后把对应提示音文件拉过去即可， 其他格式也是可以这样操作， 每个提示音生成是什么格式取决于拉提示音文件过去的时候选的是什么格式。  

**注意： 报号数字提示音格式一定要选同一种,原始音频数据 sbc 要用 32k 的采样率转， msbc 要用 16k的采样率转才能保证音质。**  

## UI 操作说明  

- 开机
  - 耳机在盒子外， 长按 2s 按键， 耳机开机。
  - 开盖

- 关机
  - 耳机在盒子外， 长按 2s 按键， 耳机开机。
  - 关盖
- 首次开机 TWS配对规则
  - TWS 配对失败 6S 超时， 耳机在和手机配对模式与 TWS 配对之间定时切换, 如果和手机连接成功， 则关掉 TWS 配对模式
  - TWS 配对成功, 主耳进入和手机配对模式
- 非 首 次 开 机（TWS 已 配对）
  - TWS 回连， 回连超时后：
    - 若已和手机有配对记录， 主耳直接回连手机， 回连超时， 在和手机配对状态与 TWS 配对之间定时切换
    - 若和手机无配对记录， 主耳在和手机配对状态与 TWS 配对之间定时切换；
- TWS 已连接，主耳和手机已连接。 主耳走远和对耳超距断开连接， 同时主耳和手机超距断开连接 
  - 主耳回连附耳及手机， 附耳只回连主耳机。
  - 在 3 分钟内若连上了手机， 没有连上对耳， 耳机不会关机； 若 3分钟内没有连上手机， 只连上了对耳， 耳机关机。
  - **怎么有三个角色？耳机，手机，主耳和对耳朵**
- 耳机有 1 个按键
  - 来电响铃中-->单击左耳按键或右耳按键， 接听来电
  - 来电响铃中-->长按左耳按键或右耳按键， 拒接来电
  - 通话中-->单击左耳按键或右耳按键,结束通话
  - 播放音乐中-->单击左耳按键或右耳按键,音乐播放/暂停
  - 开机状态-->长按左耳按键或右耳按键, 关机
  - 关机状态-->长按左耳按键或右耳按键, 开机
  - 长按左耳按键或右耳按键 8 秒, 复位
    - **任何状态下，都会重新开机？**
    - **开机关机的长按是多久？**
- 耳机有 2 个 LED:
  - 蓝色
  - 红色 

详细定义， 请参考以下 LED 灯效和提示音配置表：  

![image-20250422195346406](./FN3.assets/image-20250422195346406.png)

## MIC 配置

在每个 board.c 文件里都有配置 mic 参数的结构体， 如下图所示：

apps\earphone\board\br36\board_ac700n_demo.c

![image-20250422195909137](./FN3.assets/image-20250422195909137.png)

AC697N 系列有两个 mic_in， 默认使用 mic0_in  

**Mic 的偏置方式选择：**

- 省电容模式内部提供偏置， 配合内部偏置电阻， 将 mic 的偏置电压调整到 1.4 到 1.5 之间， 正常工作状态， mic 的电压会收敛稳定在 1.5v 左右。 
- 隔直电容模式（a） MIC_LDO 提供偏置： 配合内部偏置电阻 mic_bias_res， 调整 mic 的偏置电压（b） DACVDD 或者其他电源提供偏置 

主要关注以下变量：  

- mic_capless： 0： 选用不省电容模式 1： 选用省电容模式  
- mic_bias_res： mic_ldo 内部上拉偏置电阻， 使用内部偏置时有效， 选择范围为：  

![image-20250422200145781](./FN3.assets/image-20250422200145781.png)

- mic_ldo_vsel： mic_ldo 的偏置电压， 与偏置电阻共同决定 mic 的偏置， 选择范围为：  

![image-20250422200215230](./FN3.assets/image-20250422200215230.png)

mic_bias_inside： mic 外部电容隔直， 芯片内部提供偏置电压， 当 mic_bias_inside=1， 可以正常使用 mic_bias_res 和 mic_ldo_vsel。

注意： 如果用的是硅 mic 的话要配置成不省电容模式， 并且要 io 口独立给硅 mic 供电。 如果供电的时候硅 mic 的偏置在 0.9v 以上， 则此款硅 mic 不适用于 dac 跑低压的方案。  

## 两个 IO 口推两个灯配置  

在每个 board.c 文件里都有配置 pwmled 参数的结构体， 如下图所示：  

![image-20250422201050144](./FN3.assets/image-20250422201050144.png)

如果需要两个 IO 推灯应用， 需要增加 two_io 结构配置， 如上图红框内增加的配置； 不需要两个 IO推灯的应用， 不需要增加 two_io 结构配置， 板级配置不需要更改。 

**总共几个灯？一个耳机有两个灯？** 

## 是否使用配置文件的参数配置

- **配置文件？那里的配置文件？可视化配置工具生成的配置文件吗？**

- **可视化工具会修改所有的板级配置文件吗？**

- **不想从配置文件读取的的话，就直接去板级文件的实现中修改。**

默认 sdk 是从配置文件读取配置来设置灯状态和提示音， 如果不想从配置文件读取配置， 只需修改 ：

`apps\earphone\user_cfg.c`

![image-20250422201528891](./FN3.assets/image-20250422201528891.png)

即可， 然后默认配置在每个 board.c 里面设置

![image-20250422202603021](./FN3.assets/image-20250422202603021.png)

### **配置文件与板级配置文件的区别？**？？？？

注意： 如果想生成的 fw 文件能单独配置某些选项， 要把对应的宏打开， 如果想全部打开则设置#define USE_CONFIG_BIN_FILE   1  即可 

## 充电仓使用注意点  

目前市面上充电仓芯片主要分为三种：

1、 5v 输出常开

2、 充满 5v 关闭

3、 充满 5v 掉到 3v （如 Sy7628） 

第一种， 样机充满后进入 power off ， 禁能下拉电阻整体功耗大概是 5uA

第二种， 可以正常使用， 但是这种充满电就断了 5v ， 样机就不能做拔出开机快速连接

第三种， 充满后， 5v 变弱驱 3v ， 充满后进入 power off， 功耗和维持电压及下拉电阻设置相关  

## 长按复位设置

新发出的 V0.0.3 以上版本的设置在如下路径...\cpu\br30\tools 的 isd_config.ini 文件设置硬件复位原理都是 IO 口检测对应的电平及持续的时间进行判断， 从而复位芯片。 

- 长按按键后，IO口会出现高低电平持续时间，通过检测这个持续时间。

方式一般有以下两种 ：

- 按键长按复位， 默认配置为 RESET=PB01_08_0; 即 PB1 检测到低电平持续 8s， 就会复位  
  - **没看到有定义？？？**
- LDOIN 入仓复位， 默认配置为 RESET=LDOIN_02_1;即**耳机入仓**之后 LDOIN **引脚检测到高电平持续 2s,就会复位。**（正常运行的耳机入仓会将复位检测电平重新设置为低电平， 出仓之后才设置为 高电平， 所以不用担心正常样机入仓也会复位的情况， 死机的样机入仓不会重新设置检测电平所以会复位） 
  - **没明白这个意思？？？**
  - **什么情况下才需要入仓复位操作？？？**

![image-20250422204511844](./FN3.assets/image-20250422204511844.png)

长按时间有 00、 04、 08、 16 可选， 其他值默认选 08  

- **FN3相同文件中却找不到。**

## 内置触摸按键配置  

