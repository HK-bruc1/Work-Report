# UART串口通信

1. UART是一种异步串行通信协议，数据一位一位按顺序传输，收发双方不共享时钟信号，靠约定好的波特率来同步。
   - 波特率是每秒传输的符号数，单位bps。比如波特率9600，代表每秒传输9600位，每位持续约104微秒。接收方检测到起始位的下降沿后，按波特率定时依次采样后续每一位。**双方波特率必须一致**，否则采样错位导致数据错误。常用波特率有9600、115200等。

2. UART只需要三根线：TX（发送）、RX（接收）、GND（共地）。两个设备之间交叉连接，A的TX接B的RX，A的RX接B的TX。没有时钟线，这是它和SPI、I2C的重要区别。
3. UART有独立的TX和RX两根线，TX专门发送，RX专门接收，两条线互不干扰，因此支持**全双工通信**，即发送和接收可以**同时进行**，不需要像半双工那样分时切换方向。

## 数据帧结构（核心）

UART虽然是一位一位发送二进制数据，但通信过程是**以帧为单位**进行的，一帧就是一次完整的通信单元。

```
空闲状态  起始位   数据位        校验位   停止位   空闲状态
高电平    1bit低  5~9bit(常8)   可选1bit  1~2bit高  高电平
```

**各部分作用：**

- **空闲状态**：总线没有数据传输时保持高电平，接收方处于等待状态
- **起始位**：1位低电平，是一帧的开始标志。接收方检测到总线从高变低，就知道"一帧数据来了"，开始按波特率定时采样
- **数据位**：通常8位，低位（LSB）先发，一位一位串行传输，这8位合在一起才是真正要传的那个字节
- **校验位**：可选，用于简单的错误检测，分奇校验和偶校验，也可以不用
- **停止位**：1位或2位高电平，是一帧的结束标志，告诉接收方"这一帧发完了"，总线回到空闲状态，准备下一帧

**关键理解：**

收发双方每次通信都是以这样一帧为单位进行的。发送方把要传的字节按帧格式打包，一位一位发出去；接收方从起始位开始，按波特率逐位采样，采完停止位后把数据位重新拼成一个字节，完成一次接收。连续传输多个字节就是连续发送多帧。

## 奇偶校验原理

**校验位的计算方式**

以数据位 `01101001` 为例，其中1的个数为4个。

- **奇校验：** 要求数据位+校验位中1的总个数为**奇数**，4个1是偶数，所以校验位填 `1`，凑成5个1（奇数）。

- **偶校验：** 要求数据位+校验位中1的总个数为**偶数**，4个1已经是偶数，所以校验位填 `0`，保持4个1（偶数）。

**接收方怎么验证：**

接收方收到数据位和校验位后，自己数一遍1的个数，看是否符合约定的奇/偶规则。不符合说明传输过程中有某一位发生了翻转，数据出错。

**校验位的局限性：**

值得补充的是，校验位只能检测**奇数个位**发生错误的情况。如果同时有两位翻转，1的个数奇偶不变，校验位无法发现错误。所以UART的校验只是简单的错误检测，可靠性要求高的场合需要上层协议（如CRC校验）来保障。

## 电平标准

UART本身是TTL电平（0V/3.3V或0V/5V），不能直接和PC的RS232连接（RS232是±12V），需要MAX232等芯片转换。现在更常见的是通过CH340、CP2102等芯片转成USB与PC通信。

严格来说TTL电平的判定是这样的：

|              | 发送方输出             | 接收方判定   |
| ------------ | ---------------------- | ------------ |
| **高电平**   | >2.4V                  | >2.0V认为是1 |
| **低电平**   | <0.4V                  | <0.8V认为是0 |
| **噪声容限** | 中间区域属于不确定区域 | 不确定       |

CH340等芯片是USB转UART桥接芯片，做的是协议转换，电平转换只是其中一部分。

**三种接口对比：**

| 接口  | 电平范围 | 需要转换原因            |
| ----- | -------- | ----------------------- |
| RS232 | ±12V     | 电压远超TTL，会烧IO     |
| RS485 | 差分±7V  | 电压超TTL，且是差分信号 |

## RS232和RS485

**RS232和RS485本质上都是基于UART的串口通信**

它们的数据层面和UART完全一样，帧格式、波特率、起始位、数据位、停止位都没有变化。唯一不同的是**物理层的电平标准**：

| 协议      | 物理层电平  | 通信距离       | 设备数量         |
| --------- | ----------- | -------------- | ---------------- |
| UART(TTL) | 0V/3.3V或5V | 几十厘米～几米 | 点对点           |
| RS232     | ±12V        | 约15米         | 点对点           |
| RS485     | 差分±7V     | 约1200米       | 一主多从（32个） |

------

**为什么要升压？**

TTL电平抗干扰能力弱、传输距离短。工业现场噪声大、走线长，所以：

- RS232提高电压幅度来增强抗干扰能力，延长传输距离
- RS485改用差分信号，抗干扰能力更强，传输距离更远，还支持多点通信

MAX232本质是升降压+电平转换，MAX485是单端转差分+电平转换，两者都让单片机内部只需要操作普通UART，外部物理层的电平问题全交给转换芯片处理。

------

**一句话总结：**

> RS232和RS485是UART在物理层的扩展，换了电平标准但串口通信协议本质不变。所以单片机只需要在IO口外面加一颗电平转换芯片，内部还是按普通UART收发数据，完全不需要改代码逻辑。

# I2C通信







# 3.1 常见通信协议对比

### 3.1.1 五种通信协议的工作原理与特点 【问答题】

> **考点**：各总线的线数、速率、拓扑结构、全/半双工、同步/异步等特性对比
> **注意**：串口可以是全双工也可以是半双工或单工，**不要一律说全双工**

请简述以下通信协议的工作原理以及特点：

| 协议       | 线数                    | 同步/异步 | 双工模式           | 关键特性                            |
| ---------- | ----------------------- | --------- | ------------------ | ----------------------------------- |
| **RS-485** | 2线（A/B差分）          | 异步      | 半双工             | 差分信号、多点通信、长距离（1200m） |
| **UART**   | 2线（TX/RX）            | 异步      | **全/半/单工均可** | 起始位/停止位、波特率匹配           |
| **CAN**    | 2线（CANH/CANL）        | 异步      | 半双工             | 差分信号、多主仲裁、错误检测完善    |
| **I2C**    | 2线（SDA+SCL）          | 同步      | 半双工             | 多主多从、7/10位地址寻址            |
| **SPI**    | 4线（MOSI/MISO/SCK/CS） | 同步      | 全双工             | 高速、无地址寻址、主从架构          |

---

### 3.1.2 串口、IIC、SPI 深入理解 【问答题】

> **考点**：三种协议的时序图、数据格式、应用场景选择
> **注意**：串口是异步通信（无时钟线），I2C和SPI是同步通信（有时钟线）

<details><summary>💡 答案提示</summary>
<p>选型参考：</p>
<ul>
<li><b>低速、少量设备、省引脚</b> → I2C</li>
<li><b>高速、实时数据传输</b> → SPI</li>
<li><b>长距离、调试打印</b> → UART</li>
</ul>
</details>


---

## 3.2 GPIO 与 I2C 设备驱动 【问答题】

> **考点**：GPIO的输入/输出/复用模式；I2C设备驱动流程（起始→地址→读写→停止）
> **注意**：I2C需要注意从机地址（7位/10位）、ACK/NACK应答机制

GPIO 功能，驱动一个 I2C 设备的流程。

<details><summary>💡 答案提示</summary>
<p>I2C 通信流程：</p>
<pre><code>主机发送起始信号(START)
    → 发送从机地址 + 读/写位
    → 等待从机 ACK
    → 发送/接收数据字节
    → 每字节后等待 ACK/NACK
    → 发送停止信号(STOP)</code></pre>
</details>